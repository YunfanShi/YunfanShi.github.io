<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jack's Google Warden | V2.2 Ultimate</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        :root {
            --md-primary: #0b57d0;
            --md-on-primary: #ffffff;
            --md-primary-container: #d3e3fd;
            --md-on-primary-container: #041e49;
            --md-secondary: #00639b;
            --md-error: #b3261e;
            --md-surface: #ffffff;
            --md-bg: #f8f9fa;
            --md-outline: #747775;
            --radius-l: 24px;
            --shadow-2: 0 4px 8px 3px rgba(0,0,0,0.15);
        }

        * { box-sizing: border-box; transition: all 0.2s cubic-bezier(0.2, 0, 0, 1); }
        body { margin: 0; font-family: 'Google Sans', 'Roboto', sans-serif; background: var(--md-bg); color: #1f1f1f; height: 100vh; display: flex; overflow: hidden; }

        /* Sidebar */
        aside { width: 380px; background: var(--md-surface); border-right: 1px solid #e0e2e7; display: flex; flex-direction: column; z-index: 20; }
        .chat-header { padding: 16px 24px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; background: #fff; scroll-behavior: smooth; }
        .bubble { max-width: 85%; padding: 12px 18px; border-radius: 20px; font-size: 14px; line-height: 1.6; }
        .bubble.ai { background: #f2f2f2; color: #1f1f1f; align-self: flex-start; border-bottom-left-radius: 4px; }
        .bubble.user { background: var(--md-primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        
        .input-area { padding: 16px; border-top: 1px solid #f0f0f0; display: flex; gap: 10px; align-items: center; background: #fff; }
        .chat-input { flex: 1; padding: 12px 20px; border-radius: 24px; border: 1px solid #ccc; outline: none; font-size: 15px; }
        .chat-input:focus { border-color: var(--md-primary); box-shadow: 0 0 0 2px rgba(11, 87, 208, 0.2); }
        .icon-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: transparent; cursor: pointer; display: flex; justify-content: center; align-items: center; color: #444; }
        .icon-btn:hover { background: #f0f0f0; }
        .icon-btn.recording { color: var(--md-error); background: #fce8e6; animation: pulse 1s infinite; }

        /* Main */
        main { flex: 1; padding: 30px 40px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; position: relative; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .date-badge { background: var(--md-primary-container); color: var(--md-on-primary-container); padding: 8px 16px; border-radius: 12px; font-weight: 500; font-size: 14px; }

        /* Views */
        #view-generator { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .fab-extended { background: var(--md-primary); color: white; padding: 16px 32px; border-radius: 16px; border: none; font-size: 16px; font-weight: 500; cursor: pointer; box-shadow: var(--shadow-2); display: flex; align-items: center; gap: 10px; }
        .fab-extended:hover { transform: translateY(-1px); }

        #view-active { display: none; width: 100%; max-width: 900px; margin: 0 auto; }
        .timer-card { background: white; border-radius: 28px; padding: 40px; text-align: center; box-shadow: var(--shadow-2); margin-bottom: 24px; position: relative; overflow: hidden; border: 1px solid #e0e0e0; }
        .timer-digits { font-size: 96px; font-family: 'Google Sans'; line-height: 1; letter-spacing: -2px; }
        .timer-label { font-size: 24px; color: #444; margin-bottom: 10px; }
        
        .timer-card.buffer-mode { background: #fff8e1; border: 4px solid #ffeb3b; }
        .timer-card.buffer-mode .timer-digits { color: #b06200; }

        .schedule-card { background: white; border-radius: 24px; overflow: hidden; box-shadow: var(--shadow-2); border: 1px solid #e0e0e0; }
        .task-row { display: grid; grid-template-columns: 100px 1fr 100px; padding: 16px 24px; border-bottom: 1px solid #f0f0f0; align-items: center; }
        .task-row.active { background: #e8f0fe; border-left: 5px solid var(--md-primary); }
        .task-row.done { background: #f8f9fa; opacity: 0.6; }
        .task-row.done .task-name { text-decoration: line-through; color: #757575; }
        .task-time { font-family: 'Roboto Mono'; font-size: 13px; color: #5f6368; }
        
        /* Drag Preview */
        .preview-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 8px; cursor: grab; }
        .preview-item.dragging { opacity: 0.5; background: #e8f0fe; }
        .preview-item input { border: none; font-family: 'Roboto Mono'; font-size: 14px; background: transparent; }

        /* Calendar */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-top: 10px; }
        .cal-day { width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; border-radius: 50%; cursor: pointer; font-size: 13px; }
        .cal-day.has-data { background: #c2e7ff; color: #001d33; font-weight: bold; }
        .cal-day:hover { background: #f0f0f0; }

        /* Subtitles */
        #subtitle-box { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: white; padding: 12px 24px; border-radius: 24px; backdrop-filter: blur(4px); font-size: 16px; display: none; z-index: 100; text-align: center; }
        #sub-zh { font-size: 13px; color: #ddd; display: block; margin-top: 4px; font-weight: 400; }

        /* Dialogs */
        dialog { border: none; border-radius: 28px; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); width: 600px; max-width: 90vw; }
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        
        .edge-warning { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:999; color:white; display:flex; flex-direction:column; justify-content:center; align-items:center; }

    </style>
</head>
<body>

<div id="subtitle-box">
    <span id="sub-en"></span>
    <span id="sub-zh"></span>
</div>

<div id="edge-check" class="edge-warning" style="display:none;">
    <span class="material-icons-round" style="font-size:64px; margin-bottom:20px; color:var(--md-primary);">language</span>
    <h2>Required: Microsoft Edge</h2>
    <p>‰∏∫‰∫ÜËé∑ÂæóÊúÄ‰Ω≥ AI ËØ≠Èü≥‰ΩìÈ™åÔºåËØ∑ÂàáÊç¢Ëá≥ Edge ÊµèËßàÂô®„ÄÇ</p>
    <button onclick="document.getElementById('edge-check').style.display='none'" style="margin-top:20px; padding:10px 24px; border-radius:20px; border:none; background:white; cursor:pointer;">ÂøΩÁï•</button>
</div>

<aside>
    <div class="chat-header">
        <div style="display:flex; align-items:center; gap:8px; color:var(--md-primary); font-weight:700;">
            <span class="material-icons-round">security</span> Jack's Warden
        </div>
        <div style="display:flex;">
            <button class="icon-btn" onclick="openArchive()" title="History"><span class="material-icons-round">calendar_month</span></button>
            <button class="icon-btn" onclick="openSettings()" title="Settings"><span class="material-icons-round">settings</span></button>
        </div>
    </div>
    <div class="chat-box" id="chat-history">
        <div class="bubble ai">System Online. Warden V2.2 Ready.<br>Waiting for orders.</div>
    </div>
    <div class="input-area">
        <button id="mic-btn" class="icon-btn" onmousedown="startDictation()" onmouseup="stopDictation()"><span class="material-icons-round">mic</span></button>
        <input type="text" id="user-msg" class="chat-input" placeholder="Say 'Adjust schedule'...">
        <button onclick="sendMsg()" class="icon-btn" style="background:var(--md-primary); color:white;"><span class="material-icons-round">send</span></button>
    </div>
</aside>

<main>
    <header>
        <h2 style="margin:0; font-size:22px;">Dashboard</h2>
        <div class="date-badge" id="clock-display">00:00</div>
    </header>

    <div id="view-generator">
        <div style="margin-bottom:40px;">
            <span class="material-icons-round" style="font-size:80px; color:#e0e0e0;">assignment</span>
        </div>
        <h1 style="font-weight:400; margin-bottom:10px;">No Active Plan</h1>
        <p style="color:#666; margin-bottom:40px;">Select tasks to generate a time-blocked schedule.<br>Unfinished tasks will be auto-imported.</p>
        <button class="fab-extended" onclick="openMatrixSelector()">
            <span class="material-icons-round">add</span> Create Daily Plan
        </button>
    </div>

    <div id="view-active">
        <div class="timer-card" id="main-card">
            <div id="buffer-label" style="display:none; color:#b06200; font-weight:bold; margin-bottom:10px;">‚ö†Ô∏è BUFFER ZONE (10m)</div>
            <div class="timer-label" id="timer-label">Loading...</div>
            <div class="timer-digits" id="timer-display">--:--</div>
            <div style="margin-top:20px; color:#666; font-size:14px;" id="next-task-display">Next: --</div>
            
            <div style="margin-top:30px; display:flex; gap:15px; justify-content:center;">
                <button class="fab-extended" style="background:#e6f4ea; color:#1e8e3e; box-shadow:none; border:1px solid #c6ebd1;" onclick="finishTaskEarly()">
                    <span class="material-icons-round">check</span> Complete
                </button>
                <button class="fab-extended" style="background:white; color:#444; box-shadow:none; border:1px solid #ddd;" onclick="window.open('https://yunfanshi.github.io/Studyplan.html','_blank')">
                    <span class="material-icons-round">launch</span> StudyPlan
                </button>
            </div>
            <div style="position:absolute; bottom:0; left:0; width:100%; height:6px; background:#f0f0f0;">
                <div id="progress-bar" style="height:100%; width:0%; background:var(--md-primary); transition:width 1s linear;"></div>
            </div>
        </div>

        <div class="schedule-card" id="schedule-list"></div>

        <div style="text-align:center; margin-top:30px;">
            <button onclick="resetSchedule()" style="border:none; background:none; color:var(--md-error); cursor:pointer; display:inline-flex; align-items:center; gap:5px;">
                <span class="material-icons-round">restart_alt</span> Reset Day
            </button>
        </div>
    </div>
</main>

<dialog id="matrix-modal">
    <h3 style="margin-top:0;">Select Tasks (Progress Locked)</h3>
    <div id="matrix-rows" style="display:grid; gap:10px; margin:20px 0;"></div>
    <div style="border-top:1px solid #eee; padding-top:15px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <label><input type="checkbox" checked disabled> IELTS Lessons</label>
        <label><input type="checkbox" checked disabled> Vocab</label>
        <label><input type="checkbox" checked disabled> Summer HW (1h)</label>
        <label><input type="checkbox" id="chk-python"> CS50P</label>
        <label><input type="checkbox" id="chk-piano"> Piano</label>
    </div>
    <div style="text-align:right; margin-top:20px;">
        <button onclick="confirmMatrix()" class="fab-extended" style="font-size:14px;">Generate Draft</button>
    </div>
</dialog>

<dialog id="preview-modal">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
        <h3 style="margin:0;">Preview & Edit</h3>
        <button onclick="addDraftTask()" style="background:none; border:1px solid #ddd; border-radius:50%; width:30px; height:30px; cursor:pointer;">+</button>
    </div>
    <div id="preview-list" style="max-height:400px; overflow-y:auto;"></div>
    <div style="text-align:right; margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
        <button onclick="document.getElementById('preview-modal').close()" style="border:none; background:none; cursor:pointer;">Cancel</button>
        <button onclick="commitSchedule()" class="fab-extended" style="font-size:14px; background:#1e8e3e;">Start Day</button>
    </div>
</dialog>

<dialog id="archive-modal">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <button onclick="changeMonth(-1)" style="border:none; background:none; cursor:pointer;">&lt;</button>
        <strong id="cal-month-year"></strong>
        <button onclick="changeMonth(1)" style="border:none; background:none; cursor:pointer;">&gt;</button>
    </div>
    <div class="cal-grid" style="font-weight:bold; color:#888;"><div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div></div>
    <div class="cal-grid" id="cal-days"></div>
    <div id="archive-detail" style="margin-top:20px; border-top:1px solid #eee; padding-top:10px; max-height:200px; overflow-y:auto; font-size:13px;"></div>
    <div style="text-align:right; margin-top:10px;"><button onclick="document.getElementById('archive-modal').close()" style="border:none; background:none; cursor:pointer;">Close</button></div>
</dialog>

<dialog id="settings-modal">
    <h3>Settings</h3>
    <label style="font-size:12px;">API Key</label>
    <input type="password" id="api-key" class="chat-input" style="width:100%; margin-bottom:15px;">
    <label style="font-size:12px;">Model</label>
    <select id="model-select" class="chat-input" style="width:100%; margin-bottom:15px;">
        <option value="deepseek">Deepseek V3</option>
        <option value="qwen">Qwen Plus</option>
    </select>
    <label style="font-size:12px;">TTS Voice</label>
    <div style="display:flex; gap:10px;">
        <select id="voice-select" class="chat-input" style="width:100%;"></select>
        <button onclick="testVoice()" style="border:1px solid #ddd; background:white; border-radius:20px; padding:0 20px; cursor:pointer;">Test</button>
    </div>
    <div style="text-align:right; margin-top:20px;"><button onclick="saveSettings()" class="fab-extended" style="font-size:14px;">Save</button></div>
</dialog>

<script>
    /* ======================== STATE & INIT ======================== */
    const SUBJECTS = ["Math (0580)", "Add Math (0606)", "Biology (0610)", "Chemistry (0620)", "Physics (0625)"];
    let STATE = {
        schedule: JSON.parse(localStorage.getItem('j_sched')) || [],
        backlog: JSON.parse(localStorage.getItem('j_backlog')) || [],
        archive: JSON.parse(localStorage.getItem('j_archive')) || {},
        apiKey: localStorage.getItem('j_key') || '',
        provider: localStorage.getItem('j_prov') || 'deepseek',
        voiceUri: localStorage.getItem('j_voice') || '',
        lastDate: localStorage.getItem('j_date') || '',
        draft: [],
        currentCalDate: new Date(),
        lastBufferTask: null
    };

    window.onload = () => {
        if (!navigator.userAgent.includes("Edg")) document.getElementById('edge-check').style.display = 'flex';
        checkDayReset();
        loadVoices();
        setInterval(tick, 1000);
        
        document.getElementById('api-key').value = STATE.apiKey;
        document.getElementById('model-select').value = STATE.provider;
        
        // Enter Key
        document.getElementById('user-msg').addEventListener('keypress', (e) => { if(e.key==='Enter') sendMsg(); });

        if(STATE.schedule.length > 0) {
            switchView('active');
            renderTable();
        } else {
            if(STATE.backlog.length > 0) addBubble(`Debt from yesterday: ${STATE.backlog.length} tasks.`, 'ai');
        }
    };

    function tick() {
        const now = new Date();
        document.getElementById('clock-display').innerText = now.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
        if(STATE.schedule.length > 0) engineTick(now);
    }

    /* ======================== ENGINE: BUFFER HIJACK ======================== */
    function engineTick(now) {
        const curM = now.getHours()*60 + now.getMinutes();
        let active = null, next = null, idx = -1;

        // Find Active
        for(let i=0; i<STATE.schedule.length; i++) {
            const s = STATE.schedule[i];
            const start = t2m(s.start);
            const end = t2m(s.end);
            
            // 1. Buffer Logic (10 mins before study)
            if(s.type==='study' && !s.done && curM >= start-10 && curM < start) {
                if(STATE.lastBufferTask !== s.task) {
                    STATE.lastBufferTask = s.task;
                    speak(`Warning. 10 minutes to ${s.task}. Drop phone.`, "Ë≠¶Âëä„ÄÇ10ÂàÜÈíüÂêéÂºÄÂßã„ÄÇÊîæ‰∏ãÊâãÊú∫„ÄÇ");
                }
                updateTimerUI("PREPARE: "+s.task, start*60 - (curM*60+now.getSeconds()), 600, true);
                return; // Hijack UI
            }

            if(curM >= start && curM < end) {
                active = s; idx = i;
                if(STATE.schedule[i+1]) next = STATE.schedule[i+1];
                break;
            }
        }

        if(active) {
            const end = t2m(active.end);
            const start = t2m(active.start);
            if(STATE.lastBufferTask === active.task) STATE.lastBufferTask = null; // Clear lock
            updateTimerUI(active.task, end*60 - (curM*60+now.getSeconds()), (end-start)*60, false);
            document.getElementById('next-task-display').innerText = next ? `Next: ${next.task} (${next.start})` : "Next: End of Day";
            
            // Highlight Table
            document.querySelectorAll('.task-row').forEach(r => r.classList.remove('active'));
            const rows = document.querySelectorAll('.task-row');
            if(rows[idx]) rows[idx].classList.add('active');
        } else {
            // Free Time
            document.getElementById('timer-display').innerText = "--:--";
            document.getElementById('timer-label').innerText = "NO ACTIVE TASK";
            document.getElementById('main-card').classList.remove('buffer-mode');
        }
    }

    function updateTimerUI(label, secs, total, isBuf) {
        const m = Math.floor(secs/60).toString().padStart(2,'0');
        const s = (secs%60).toString().padStart(2,'0');
        document.getElementById('timer-display').innerText = `${m}:${s}`;
        document.getElementById('timer-label').innerText = label;
        
        const card = document.getElementById('main-card');
        const bar = document.getElementById('progress-bar');
        
        if(isBuf) {
            card.classList.add('buffer-mode');
            document.getElementById('buffer-label').style.display='block';
            bar.style.background = "#ffeb3b";
        } else {
            card.classList.remove('buffer-mode');
            document.getElementById('buffer-label').style.display='none';
            bar.style.background = "var(--md-primary)";
        }
        let pct = ((total-secs)/total)*100;
        if(pct<0) pct=0; if(pct>100) pct=100;
        bar.style.width = pct + "%";
    }

    /* ======================== GENERATION & PREVIEW ======================== */
    function getStudyPlanProgress(subject) {
        const spData = localStorage.getItem('caie_progress_v2_1');
        if(!spData) return false; 
        const db = JSON.parse(spData);
        return Object.keys(db).some(k => k.startsWith(subject) && k.includes('FINAL|unit_done') && db[k] === true);
    }

    function openMatrixSelector() {
        if(!STATE.apiKey) return document.getElementById('settings-modal').showModal();
        const div = document.getElementById('matrix-rows');
        div.innerHTML = '';
        
        SUBJECTS.forEach((sub, i) => {
            const unlocked = getStudyPlanProgress(sub);
            div.innerHTML += `
                <div style="background:#f8f9fa; padding:10px; border-radius:8px; display:flex; align-items:center; justify-content:space-between;">
                    <span>${sub}</span>
                    <div style="display:flex; gap:10px;">
                        <label style="font-size:12px;"><input type="checkbox" id="xn-${i}"> Note</label>
                        <label style="font-size:12px;">
                            <input type="checkbox" id="mt-${i}" ${unlocked?'':'disabled'}> Mock ${unlocked?'':'üîí'}
                        </label>
                    </div>
                </div>`;
        });
        document.getElementById('matrix-modal').showModal();
    }

    async function confirmMatrix() {
        let pool = [...STATE.backlog, "IELTS Lessons", "Vocab", "Summer Homework"];
        SUBJECTS.forEach((sub, i) => {
            if(document.getElementById(`xn-${i}`).checked) pool.push(`XNotes: ${sub}`);
            if(document.getElementById(`mt-${i}`).checked) pool.push(`Mock: ${sub}`);
        });
        if(document.getElementById('chk-python').checked) pool.push("CS50P");
        if(document.getElementById('chk-piano').checked) pool.push("Piano");

        document.getElementById('matrix-modal').close();
        addBubble("Calculating optimal schedule...", "ai");
        speak("Analyzing task load.", "Ê≠£Âú®ÂàÜÊûêË¥üËΩΩ„ÄÇ");

        const nowH = new Date().getHours();
        const startH = nowH < 10 ? 10 : nowH;
        
        const prompt = `
        Role: Scheduler. Time: ${nowH}:00. Tasks: ${JSON.stringify(pool)}.
        RULES:
        1. Schedule from ${startH}:00 to 22:30.
        2. FILL TIME: If tasks run out, add "Review: Weak Points" or "Pre-read" until 22:30.
        3. Split tasks > 45m (Part 1, Break, Part 2).
        4. Output JSON: [{"start":"HH:MM","end":"HH:MM","task":"Name","type":"study/break/meal"}]
        `;

        try {
            const res = await callLLM(prompt);
            const json = extractJSON(res);
            if(json) {
                STATE.draft = JSON.parse(json);
                renderPreview();
                document.getElementById('preview-modal').showModal();
            }
        } catch(e) { addBubble(e.message, 'error'); }
    }

    // --- PREVIEW DRAG & DROP ---
    function renderPreview() {
        const list = document.getElementById('preview-list');
        list.innerHTML = '';
        STATE.draft.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.draggable = true;
            div.dataset.index = idx;
            
            div.innerHTML = `
                <span class="material-icons-round" style="color:#ccc; cursor:grab;">drag_handle</span>
                <input value="${item.start}" style="width:50px;" onchange="updateDraft(${idx}, 'start', this.value)">
                - <input value="${item.end}" style="width:50px;" onchange="updateDraft(${idx}, 'end', this.value)">
                <input class="p-task" value="${item.task}" onchange="updateDraft(${idx}, 'task', this.value)">
                <span class="material-icons-round" style="color:var(--md-error); cursor:pointer;" onclick="removeDraft(${idx})">remove_circle_outline</span>
            `;
            
            // Native Drag Events
            div.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', idx);
                div.classList.add('dragging');
            });
            div.addEventListener('dragend', () => div.classList.remove('dragging'));
            div.addEventListener('dragover', (e) => e.preventDefault());
            div.addEventListener('drop', (e) => handleDrop(e, idx));
            
            list.appendChild(div);
        });
    }

    function handleDrop(e, targetIdx) {
        e.preventDefault();
        const sourceIdx = parseInt(e.dataTransfer.getData('text/plain'));
        if (sourceIdx !== targetIdx) {
            const item = STATE.draft.splice(sourceIdx, 1)[0];
            STATE.draft.splice(targetIdx, 0, item);
            renderPreview();
        }
    }

    function addDraftTask() { STATE.draft.push({start:"00:00", end:"00:00", task:"New Task", type:"study"}); renderPreview(); }
    function removeDraft(i) { STATE.draft.splice(i, 1); renderPreview(); }
    function updateDraft(i, k, v) { STATE.draft[i][k] = v; }

    function commitSchedule() {
        STATE.schedule = STATE.draft.map(s => ({...s, done: false}));
        // Backlog cleared because we scheduled them
        STATE.backlog = [];
        localStorage.setItem('j_backlog', '[]');
        localStorage.setItem('j_sched', JSON.stringify(STATE.schedule));
        document.getElementById('preview-modal').close();
        switchView('active');
        renderTable();
        speak("Schedule locked. Proceed.", "Êó∂Èó¥Ë°®Â∑≤ÈîÅÂÆö„ÄÇ");
    }

    /* ======================== CHAT & VOICE ======================== */
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'zh-CN';
    recognition.onresult = (e) => {
        document.getElementById('user-msg').value = e.results[0][0].transcript;
        document.querySelector('.icon-btn.recording').classList.remove('recording');
        sendMsg();
    };
    function startDictation() { 
        document.querySelector('#mic-btn').classList.add('recording');
        recognition.start(); 
    }
    function stopDictation() { recognition.stop(); }

    async function sendMsg() {
        const txt = document.getElementById('user-msg').value.trim();
        if(!txt) return;
        addBubble(txt, 'user');
        document.getElementById('user-msg').value = '';

        const prompt = `
        Current Sched: ${JSON.stringify(STATE.schedule)}. User: "${txt}".
        RULES:
        1. Reply in Chinese.
        2. Append [TTS: "English Sentence"].
        3. If editing, append [REGENERATE: JSON].
        4. If denied/postponed, append [BACKLOG: TaskName].
        `;
        
        try {
            const res = await callLLM(prompt);
            let clean = res;
            
            const tts = res.match(/\[TTS:\s*"(.*?)"\]/);
            if(tts) { speak(tts[1], "ÊâßË°å‰∏≠..."); clean = clean.replace(tts[0],''); }
            
            // Backlog
            const bl = res.match(/\[BACKLOG:\s*(.*?)\]/);
            if(bl) {
                STATE.backlog.push(bl[1]);
                localStorage.setItem('j_backlog', JSON.stringify(STATE.backlog));
                clean = clean.replace(bl[0], '');
            }

            const json = extractJSON(res);
            if(json) {
                STATE.schedule = JSON.parse(json);
                localStorage.setItem('j_sched', JSON.stringify(STATE.schedule));
                renderTable();
                clean = clean.replace(/\[REGENERATE:[\s\S]*?\]/,'');
            }
            addBubble(clean, 'ai');
        } catch(e) { addBubble(e.message, 'error'); }
    }

    /* ======================== CALENDAR & UTILS ======================== */
    function finishTaskEarly() {
        const nowM = new Date().getHours()*60 + new Date().getMinutes();
        const taskIdx = STATE.schedule.findIndex(s => {
            const st=t2m(s.start), en=t2m(s.end);
            return nowM>=st && nowM<en;
        });
        
        if(taskIdx > -1) {
            STATE.schedule[taskIdx].done = true;
            localStorage.setItem('j_sched', JSON.stringify(STATE.schedule));
            
            // Visual + Audio
            renderTable(); // This adds .done class
            speak("Task complete. Take a break.", "‰ªªÂä°ÂÆåÊàê„ÄÇ‰ºëÊÅØ‰∏Ä‰∏ã„ÄÇ");
        }
    }

    function checkDayReset() {
        const today = new Date().toDateString();
        if(STATE.lastDate && STATE.lastDate !== today) {
            // Check uncompleted tasks -> Backlog
            STATE.schedule.forEach(s => {
                if(!s.done && s.type === 'study') STATE.backlog.push(s.task);
            });
            // Archive
            if(STATE.schedule.length > 0) {
                STATE.archive[STATE.lastDate] = STATE.schedule;
                localStorage.setItem('j_archive', JSON.stringify(STATE.archive));
            }
            STATE.schedule = [];
            localStorage.setItem('j_sched', '[]');
            localStorage.setItem('j_backlog', JSON.stringify(STATE.backlog));
        }
        STATE.lastDate = today;
        localStorage.setItem('j_date', today);
    }

    function renderTable() {
        const div = document.getElementById('schedule-list');
        div.innerHTML = '';
        STATE.schedule.forEach(s => {
            const row = document.createElement('div');
            row.className = `task-row ${s.type==='study'?'row-study':s.type==='meal'?'row-meal':'row-break'} ${s.done?'done':''}`;
            row.innerHTML = `
                <div class="task-time">${s.start} - ${s.end}</div>
                <div class="task-name">${s.task}</div>
                <div class="task-type" style="font-size:12px; color:#999; text-transform:uppercase;">${s.type}</div>
            `;
            div.appendChild(row);
        });
    }

    // --- Helpers ---
    async function callLLM(prompt) {
        const url = STATE.provider.includes('deepseek') ? 'https://api.deepseek.com/chat/completions' : 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
        const res = await fetch(url, {
            method:'POST',
            headers:{'Content-Type':'application/json','Authorization':`Bearer ${STATE.apiKey}`},
            body:JSON.stringify({model: STATE.provider.includes('deepseek')?'deepseek-chat':'qwen-plus', messages:[{role:'system',content:prompt}]})
        });
        const d = await res.json();
        return d.choices[0].message.content;
    }

    function extractJSON(str) {
        // More robust bracket counting
        const start = str.indexOf("[");
        if(start === -1) return null;
        let count = 0;
        for(let i=start; i<str.length; i++) {
            if(str[i] === '[') count++;
            if(str[i] === ']') count--;
            if(count === 0) return str.substring(start, i+1);
        }
        return null;
    }

    function t2m(t) { const [h,m]=t.split(':').map(Number); return h*60+m; }
    
    function speak(en, zh) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(en);
        u.lang = 'en-US';
        const v = window.speechSynthesis.getVoices().find(v=>v.voiceURI === STATE.voiceUri);
        if(v) u.voice = v;
        window.speechSynthesis.speak(u);
        
        const box = document.getElementById('subtitle-box');
        document.getElementById('sub-en').innerText = en;
        document.getElementById('sub-zh').innerText = zh || "";
        box.style.display = 'block';
        setTimeout(()=>box.style.display='none', 4000);
    }

    function loadVoices() { 
        window.speechSynthesis.onvoiceschanged = () => {
            const sel = document.getElementById('voice-select');
            sel.innerHTML = '';
            window.speechSynthesis.getVoices().filter(v=>v.lang.includes('en')).forEach(v=>{
                const opt = document.createElement('option');
                opt.value = v.voiceURI; opt.innerText = v.name;
                sel.appendChild(opt);
            });
            sel.value = STATE.voiceUri;
        };
    }
    
    function testVoice() { speak("Voice system verified. Ready.", "ËØ≠Èü≥Á≥ªÁªüÊ≠£Â∏∏„ÄÇ"); }
    function addBubble(t,c) { document.getElementById('chat-history').innerHTML += `<div class="bubble ${c}">${t}</div>`; }
    function switchView(v) {
        document.getElementById('view-generator').style.display = v==='generator'?'flex':'none';
        document.getElementById('view-active').style.display = v==='active'?'block':'none';
    }
    function saveSettings() {
        STATE.apiKey = document.getElementById('api-key').value;
        STATE.provider = document.getElementById('model-select').value;
        STATE.voiceUri = document.getElementById('voice-select').value;
        localStorage.setItem('j_key', STATE.apiKey);
        localStorage.setItem('j_prov', STATE.provider);
        localStorage.setItem('j_voice', STATE.voiceUri);
        document.getElementById('settings-modal').close();
    }
    function openSettings() { document.getElementById('settings-modal').showModal(); }
    function resetSchedule() { 
        if(confirm("Reset Day?")) { STATE.schedule=[]; localStorage.setItem('j_sched','[]'); location.reload(); }
    }
    
    // Calendar Logic
    function openArchive() {
        renderCalendar(STATE.currentCalDate);
        document.getElementById('archive-modal').showModal();
    }
    function changeMonth(d) {
        STATE.currentCalDate.setMonth(STATE.currentCalDate.getMonth() + d);
        renderCalendar(STATE.currentCalDate);
    }
    function renderCalendar(date) {
        const y = date.getFullYear(), m = date.getMonth();
        document.getElementById('cal-month-year').innerText = `${y} / ${m+1}`;
        const first = new Date(y, m, 1).getDay();
        const days = new Date(y, m+1, 0).getDate();
        const grid = document.getElementById('cal-days');
        grid.innerHTML = '';
        for(let i=0; i<first; i++) grid.innerHTML += `<div></div>`;
        for(let d=1; d<=days; d++) {
            const ds = new Date(y, m, d).toDateString();
            const hasData = STATE.archive[ds];
            grid.innerHTML += `<div class="cal-day ${hasData?'has-data':''}" onclick="showHistory('${ds}')">${d}</div>`;
        }
    }
    function showHistory(ds) {
        const data = STATE.archive[ds];
        const div = document.getElementById('archive-detail');
        if(!data) { div.innerText = "No data."; return; }
        div.innerHTML = data.map(s => `<div>${s.start}-${s.end} ${s.task} ${s.done?'‚úÖ':'‚ùå'}</div>`).join('');
    }

</script>
</body>
</html>
