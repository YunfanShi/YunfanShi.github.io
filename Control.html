<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jack's Warden | V1.4 Logic Overlord</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        :root {
            --blue: #0b57d0; --red: #b3261e; --yellow: #eac435; --green: #146c2e;
            --surface: #ffffff; --bg: #f3f6fc; --text: #1f1f1f;
            --radius: 24px; --shadow: 0 4px 24px rgba(0,0,0,0.06);
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body { margin: 0; font-family: 'Google Sans', 'Noto Sans SC', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* --- Sidebar --- */
        aside { width: 400px; background: var(--surface); border-right: 1px solid #e0e2e7; display: flex; flex-direction: column; z-index: 20; }
        .chat-header { padding: 20px 24px; border-bottom: 1px solid #e0e2e7; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .chat-title { font-weight: 700; color: var(--blue); font-size: 16px; letter-spacing: 0.5px; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
        .chat-box { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px; background: #fff; scroll-behavior: smooth; }
        .bubble { max-width: 88%; padding: 14px 18px; border-radius: 20px; font-size: 14px; line-height: 1.6; position: relative; word-wrap: break-word; }
        .bubble.ai { background: #f0f4f9; color: #1f1f1f; align-self: flex-start; border-bottom-left-radius: 4px; }
        .bubble.user { background: var(--blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .input-area { padding: 20px; border-top: 1px solid #e0e2e7; display: flex; gap: 12px; background: var(--surface); }
        .chat-input { flex: 1; padding: 14px 20px; border-radius: 30px; border: 1px solid #c4c7c5; outline: none; font-size: 15px; }
        .chat-input:focus { border-color: var(--blue); box-shadow: 0 0 0 2px rgba(11, 87, 208, 0.1); }

        /* --- Main Content --- */
        main { flex: 1; padding: 40px; display: flex; flex-direction: column; gap: 24px; overflow-y: auto; position: relative; }
        header { display: flex; justify-content: space-between; align-items: center; }
        .clock-badge { background: #d3e3fd; color: #041e49; padding: 8px 16px; border-radius: 50px; font-weight: 700; font-family: 'Roboto Mono'; font-size: 16px; }

        /* Generator View */
        #view-generator { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .hero-btn { background: var(--blue); color: white; padding: 20px 48px; border-radius: 50px; border: none; font-size: 18px; font-weight: 600; cursor: pointer; box-shadow: 0 8px 24px rgba(11, 87, 208, 0.25); display: flex; align-items: center; gap: 12px; transition: transform 0.2s; }
        .hero-btn:hover { transform: scale(1.03); }

        /* Active View */
        #view-active { display: none; width: 100%; max-width: 1000px; margin: 0 auto; }
        
        .timer-card { background: white; border-radius: var(--radius); padding: 50px; text-align: center; box-shadow: var(--shadow); margin-bottom: 30px; position: relative; overflow: hidden; border: 1px solid #eff1f4; transition: all 0.5s ease; }
        .timer-digits { font-size: 120px; font-weight: 700; color: var(--text); font-family: 'Roboto Mono', monospace; line-height: 1; letter-spacing: -5px; margin: 20px 0; font-variant-numeric: tabular-nums; }
        .timer-task { font-size: 28px; color: #444746; font-weight: 500; }
        .next-task { font-size: 16px; color: #666; font-weight: 500; margin-top: 10px; }

        /* Buffer Mode Visuals */
        .timer-card.buffer-mode { border: 6px solid var(--yellow); background: #fffdf0; animation: pulse-border 2s infinite; }
        .timer-card.buffer-mode .timer-digits { color: #8c6d0d; }
        .timer-card.buffer-mode .timer-task { color: #8c6d0d; font-weight: 700; }
        
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(234, 196, 53, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(234, 196, 53, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 196, 53, 0); } }

        .progress-line { position: absolute; bottom: 0; left: 0; width: 100%; height: 10px; background: #f0f4f9; }
        .progress-fill { height: 100%; width: 0%; background: var(--blue); transition: width 1s linear; }

        .schedule-table { width: 100%; border-collapse: collapse; background: white; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); border: 1px solid #eff1f4; }
        .schedule-table th { text-align: left; padding: 20px 30px; background: #f8f9fa; color: #444746; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .schedule-table td { padding: 20px 30px; border-top: 1px solid #f0f4f9; font-size: 15px; color: #1f1f1f; }
        
        .row-study { border-left: 6px solid var(--blue); }
        .row-break { border-left: 6px solid var(--green); background: #f8fcf9; }
        .row-meal { border-left: 6px solid var(--yellow); }
        .row-active { background: #e8f0fe !important; font-weight: 700; transform: scale(1.01); box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-top: none; border-bottom: none; }
        .row-done { opacity: 0.4; text-decoration: line-through; background: #f1f3f4; }

        /* Subtitles */
        #subtitle-box { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: white; padding: 16px 32px; border-radius: 16px; text-align: center; z-index: 100; display: none; backdrop-filter: blur(10px); pointer-events: none; width: max-content; max-width: 80%; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
        .sub-en { font-size: 20px; font-weight: 600; color: #fff; margin-bottom: 8px; }
        .sub-zh { font-size: 15px; color: #e3e3e3; font-weight: 400; }

        /* Modal */
        dialog { border: none; border-radius: 28px; padding: 40px; width: 650px; box-shadow: 0 20px 60px rgba(0,0,0,0.25); background: white; }
        dialog::backdrop { background: rgba(0,0,0,0.6); backdrop-filter: blur(6px); }
        
        .matrix-grid { display: grid; gap: 12px; margin: 20px 0; max-height: 400px; overflow-y: auto; }
        .matrix-row { display: grid; grid-template-columns: 2fr 1fr 1fr; align-items: center; padding: 16px; border-radius: 12px; background: #f8f9fa; border: 1px solid #e0e2e7; }
        
        /* Backlog Alert */
        #backlog-alert { background: #fff0f0; color: #b3261e; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #f9dedc; display: none; align-items: center; gap: 10px; font-weight: 600; }
        
        .edge-warning { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:999; color:white; display:flex; flex-direction:column; justify-content:center; align-items:center; }

        .btn-reset { background: transparent; border: 1px solid var(--red); color: var(--red); padding: 10px 24px; border-radius: 50px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-top: 10px; }
        .btn-reset:hover { background: #fff0f0; }

    </style>
</head>
<body>

<div id="subtitle-box">
    <div class="sub-en" id="sub-en"></div>
    <div class="sub-zh" id="sub-zh"></div>
</div>

<div id="edge-check" class="edge-warning" style="display:none;">
    <span class="material-icons-round" style="font-size:64px; margin-bottom:20px; color:var(--blue);">language</span>
    <h2>Warden Protocol Requirement</h2>
    <p>AI ç®¡å®¶éœ€è¦ Microsoft Edge æµè§ˆå™¨çš„ Neural TTS æ”¯æŒä»¥è·å¾—æœ€ä½³å¨æ…‘åŠ›ã€‚</p>
    <button onclick="document.getElementById('edge-check').style.display='none'" style="margin-top:20px; padding:12px 30px; border-radius:24px; border:none; background:white; color:#333; font-weight:600; cursor:pointer;">å¿½ç•¥ (ä½“éªŒé™çº§)</button>
</div>

<aside>
    <div class="chat-header">
        <span class="chat-title"><span class="material-icons-round">security</span> AI WARDEN V1.4</span>
        <button onclick="openSettings()" style="background:none; border:none; cursor:pointer; color:#444746;"><span class="material-icons-round">settings</span></button>
    </div>
    
    <div class="chat-box" id="chat-history">
        <div class="bubble ai">System Online. Buffer Protocol: Frontend Hijack.</div>
    </div>

    <div class="input-area">
        <input type="text" id="user-msg" class="chat-input" placeholder="å‘ç®¡å®¶æ±‡æŠ¥ (e.g. æˆ‘æƒ³æŠŠæ•°å­¦æ¢æˆç‰©ç†)...">
        <button onclick="sendMsg()" style="background:var(--blue); color:white; border:none; border-radius:50%; width:48px; height:48px; cursor:pointer; display:flex; justify-content:center; align-items:center;"><span class="material-icons-round">send</span></button>
    </div>
</aside>

<main>
    <header>
        <h2 style="margin:0; font-family:'Google Sans'; color:var(--text); display:flex; align-items:center; gap:10px;">
            Control Station <span style="font-size:12px; background:#e0e2e7; padding:4px 8px; border-radius:4px;">LOCKED</span>
        </h2>
        <div class="clock-badge" id="clock-display">00:00</div>
    </header>

    <div id="view-generator">
        <div style="background:white; padding:50px; border-radius:50%; margin-bottom:40px; box-shadow:var(--shadow);">
            <span class="material-icons-round" style="font-size:80px; color:var(--blue);">assignment_turned_in</span>
        </div>
        
        <div id="backlog-alert">
            <span class="material-icons-round">warning</span>
            <span id="backlog-text">æ£€æµ‹åˆ°æœªå®Œæˆçš„å€ºåŠ¡...</span>
        </div>

        <h1 style="margin:0 0 10px 0;">ä»Šæ—¥æˆ˜æœ¯è§„åˆ’</h1>
        <p style="color:#444746; margin-bottom:50px; line-height:1.6; max-width:500px;">
            <strong style="color:var(--blue)">è‡ªåŠ¨é‡ç½®å·²å¯ç”¨ã€‚</strong><br>
            ç¼“å†²é€»è¾‘ç”±å‰ç«¯å¼ºåˆ¶æ‰§è¡Œ (æœ€å10åˆ†é’ŸåŠ«æŒ)ã€‚<br>
            é•¿ä»»åŠ¡å¿…é¡»æ‹†åˆ†ã€‚
        </p>
        <button class="hero-btn" onclick="openMatrixSelector()">
            <span class="material-icons-round">add_task</span> å»ºç«‹ä»»åŠ¡çŸ©é˜µ
        </button>
    </div>

    <div id="view-active">
        <div class="timer-card" id="main-card">
            <div id="buffer-badge" style="background:var(--yellow); display:none; padding:8px 20px; border-radius:30px; font-weight:800; margin-bottom:20px; font-size:16px; color:#4a3800;">âš ï¸ BUFFER ZONE (10m)</div>
            <div class="timer-task" id="timer-label">Awaiting Protocol...</div>
            <div class="timer-digits" id="timer-display">--:--</div>
            <div class="next-task" id="next-task-display">Next: --</div>
            
            <div style="margin-top:40px; display:flex; gap:20px; justify-content:center;">
                <button onclick="finishTaskEarly()" style="background:var(--green); color:white; border:none; padding:15px 35px; border-radius:50px; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:10px; font-size:16px; box-shadow:0 8px 20px rgba(20, 108, 46, 0.25);">
                    <span class="material-icons-round">done_all</span> ä»»åŠ¡å®Œæˆ
                </button>
                <button onclick="window.open('https://yunfanshi.github.io/Studyplan.html', '_blank')" style="background:white; border:1px solid #c4c7c5; padding:15px 35px; border-radius:50px; cursor:pointer; font-weight:600; display:flex; align-items:center; gap:10px; font-size:16px;">
                    <span class="material-icons-round">launch</span> æ‰“å¼€ StudyPlan
                </button>
            </div>
            
            <div class="progress-line"><div class="progress-fill" id="progress-bar"></div></div>
        </div>

        <table class="schedule-table">
            <thead><tr><th width="140">Time</th><th>Task</th><th width="120">Type</th></tr></thead>
            <tbody id="schedule-body"></tbody>
        </table>

        <div style="display:flex; justify-content:center; margin-top:30px;">
            <button class="btn-reset" onclick="resetSchedule()">
                <span class="material-icons-round">delete_forever</span> å¼ºåˆ¶é‡ç½® (Reset Table)
            </button>
        </div>
    </div>
</main>

<dialog id="matrix-modal">
    <h3 style="margin-top:0;">æ„å»ºä»Šæ—¥ä»»åŠ¡</h3>
    <p style="font-size:13px; color:#666;">StudyPlan è¿›åº¦é”å·²å¯ç”¨ã€‚</p>
    
    <div class="matrix-grid">
        <div class="matrix-row" style="background:none; border-bottom:2px solid #e0e2e7; font-weight:700;">
            <div>Subject</div><div style="text-align:center;">XNotes</div><div style="text-align:center;">Mock (90m+)</div>
        </div>
        <div id="matrix-rows"></div>
    </div>

    <div style="margin-top:25px; padding-top:20px; border-top:1px solid #e0e2e7;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <label style="display:flex; align-items:center; font-weight:600; color:var(--red);">
                <input type="checkbox" checked disabled style="margin-right:10px;"> æš‘å‡ä½œä¸š (1h)
            </label>
            <label style="display:flex; align-items:center; font-weight:600; color:var(--red);">
                <input type="checkbox" checked disabled style="margin-right:10px;"> å•è¯ (Vocab)
            </label>
            <label style="display:flex; align-items:center; font-weight:600; color:var(--red);">
                <input type="checkbox" id="chk-ielts" checked disabled style="margin-right:10px;"> IELTS Lessons
            </label>
            <label style="display:flex; align-items:center; font-weight:600;">
                <input type="checkbox" id="chk-python"> CS50P Python
            </label>
            <label style="display:flex; align-items:center; font-weight:600;">
                <input type="checkbox" id="chk-piano"> Piano
            </label>
        </div>
    </div>

    <div style="text-align:right; margin-top:30px;">
        <button onclick="confirmMatrix()" class="hero-btn" style="padding:15px 40px; font-size:16px;">ç”Ÿæˆæ—¶é—´è¡¨</button>
    </div>
</dialog>

<dialog id="settings-modal">
    <h3>ç³»ç»Ÿè®¾ç½®</h3>
    <label style="font-size:12px; font-weight:700; color:#5f6368;">API Key</label>
    <input type="password" id="api-key" class="chat-input" style="width:100%; margin:8px 0 20px 0;">
    
    <label style="font-size:12px; font-weight:700; color:#5f6368;">Model Provider</label>
    <select id="model-select" class="chat-input" style="width:100%; margin-bottom:20px;">
        <option value="deepseek">Deepseek V3</option>
        <option value="qwen">Qwen (Aliyun)</option>
    </select>
    
    <label style="font-size:12px; font-weight:700; color:#5f6368;">TTS Voice (English)</label>
    <div style="display:flex; gap:10px; margin-top:8px;">
        <select id="voice-select" class="chat-input">
            <option value="">Loading voices...</option>
        </select>
        <button onclick="testVoice()" style="padding:0 20px; border:1px solid #c4c7c5; border-radius:24px; background:white; cursor:pointer; font-weight:600;">Test</button>
    </div>

    <div style="text-align:right; margin-top:30px;">
        <button onclick="saveSettings()" style="background:var(--blue); color:white; border:none; padding:12px 30px; border-radius:24px; cursor:pointer; font-weight:600;">ä¿å­˜è®¾ç½®</button>
    </div>
</dialog>

<script>
    /* =========================================
       1. DATA & STATE
       ========================================= */
    const SUBJECTS = ["Math (0580)", "Add Math (0606)", "Biology (0610)", "Chemistry (0620)", "Physics (0625)"];
    
    const STATE = {
        schedule: JSON.parse(localStorage.getItem('jack_v1_sched')) || [],
        backlog: JSON.parse(localStorage.getItem('jack_v1_backlog')) || [],
        apiKey: localStorage.getItem('jack_v1_key') || '',
        provider: localStorage.getItem('jack_v1_provider') || 'deepseek',
        voiceUri: localStorage.getItem('jack_v1_voice') || '',
        lastDate: localStorage.getItem('jack_v1_date') || '',
        
        // Runtime States
        lastBufferTask: null, // Lock to prevent repeating TTS for same buffer
        activeTaskIdx: -1
    };

    /* =========================================
       2. INIT & AUTO-WIPE
       ========================================= */
    window.onload = () => {
        if (!navigator.userAgent.includes("Edg")) document.getElementById('edge-check').style.display = 'flex';
        
        checkNewDay(); // Force wipe if new day
        loadVoices(); 
        
        setInterval(updateClock, 1000);
        setInterval(engineTick, 1000); 

        document.getElementById('api-key').value = STATE.apiKey;
        document.getElementById('model-select').value = STATE.provider;

        // Restore View
        if(STATE.schedule.length > 0) {
            switchView('active');
            renderTable();
        } else {
            checkBacklog();
        }

        document.getElementById('user-msg').addEventListener('keypress', (e) => { if(e.key==='Enter') sendMsg(); });
    };

    function updateClock() {
        document.getElementById('clock-display').innerText = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
    }

    function checkNewDay() {
        const today = new Date().toDateString();
        // If last date exists and is not today, wipe schedule
        if (STATE.lastDate && STATE.lastDate !== today) {
            console.log("New Day detected. Wiping schedule.");
            STATE.schedule = [];
            localStorage.setItem('jack_v1_sched', JSON.stringify([]));
            STATE.lastDate = today;
            localStorage.setItem('jack_v1_date', STATE.lastDate);
        } else if (!STATE.lastDate) {
            // First run, set date
            STATE.lastDate = today;
            localStorage.setItem('jack_v1_date', STATE.lastDate);
        }
    }

    function resetSchedule() {
        if(confirm("Confirm: Wipe schedule and restart? Backlog will be preserved.")) {
            STATE.schedule = [];
            localStorage.setItem('jack_v1_sched', JSON.stringify([]));
            location.reload();
        }
    }

    function checkBacklog() {
        if(STATE.backlog.length > 0) {
            const alertBox = document.getElementById('backlog-alert');
            alertBox.style.display = 'flex';
            document.getElementById('backlog-text').innerText = `æ£€æµ‹åˆ° ${STATE.backlog.length} ä¸ªæœªå®Œæˆä»»åŠ¡ (Debt). å°†è¢«å¼ºåˆ¶å®‰æ’ã€‚`;
            addBubble(`Warning. You have ${STATE.backlog.length} unfinished tasks from previous days. They will be prioritized.`, 'ai');
        }
    }

    function getStudyPlanProgress(subject) {
        const spData = localStorage.getItem('caie_progress_v2_1');
        if(!spData) return false; 
        const db = JSON.parse(spData);
        const keys = Object.keys(db);
        const hasProgress = keys.some(k => k.startsWith(subject) && k.includes('FINAL|unit_done') && db[k] === true);
        return hasProgress;
    }

    /* =========================================
       3. GENERATION (CLEAN PROMPT)
       ========================================= */
    function openMatrixSelector() {
        if(!STATE.apiKey) return openSettings();
        const box = document.getElementById('matrix-rows');
        box.innerHTML = '';
        
        SUBJECTS.forEach((sub, i) => {
            const hasNotes = getStudyPlanProgress(sub);
            box.innerHTML += `
                <div class="matrix-row">
                    <div>${sub}</div>
                    <div style="text-align:center;"><input type="checkbox" id="xn-${i}"></div>
                    <div style="text-align:center;">
                        <input type="checkbox" id="mt-${i}" ${hasNotes ? '' : 'disabled'} onchange="checkMockLock('${sub}', this)">
                        ${hasNotes ? '' : '<span style="font-size:10px; color:red; display:block;">Locked</span>'}
                    </div>
                </div>`;
        });
        document.getElementById('matrix-modal').showModal();
    }

    function checkMockLock(sub, el) {
        if(el.checked && !getStudyPlanProgress(sub)) {
            el.checked = false;
            alert(`Permission Denied: Finish ZNotes for ${sub} in StudyPlan first.`);
        }
    }

    async function confirmMatrix() {
        let pool = [...STATE.backlog]; 
        
        if(!pool.includes("IELTS Lessons")) pool.push("IELTS Lessons");
        if(!pool.includes("Vocab")) pool.push("Vocab (15min)");
        if(!pool.includes("Summer Homework")) pool.push("Summer Homework (1h)");

        SUBJECTS.forEach((sub, i) => {
            if(document.getElementById(`xn-${i}`).checked) pool.push(`XNotes: ${sub}`);
            if(document.getElementById(`mt-${i}`).checked) pool.push(`Mock Test: ${sub}`);
        });
        if(document.getElementById('chk-python').checked) pool.push("CS50P Python");
        if(document.getElementById('chk-piano').checked) pool.push("Piano Practice");

        document.getElementById('matrix-modal').close();
        addBubble("Analyzing workload... Enforcing strict split...", 'ai');

        // --- SIMPLIFIED PROMPT (Let AI do normal schedule) ---
        const prompt = `
        Role: Strict AI Warden.
        Time: 10:30 - 22:30. Fixed Meals: 12:00-13:00, 18:00-19:00.
        Tasks: ${JSON.stringify(pool)}.
        
        CRITICAL RULES:
        1. **SEQUENCE**: Arrange tasks continuously (Study -> Break -> Study). DO NOT worry about "buffer gaps" (Frontend will handle it).
        2. **SPLIT LONG TASKS**: Any task > 45 mins MUST be split (e.g. Math Part 1 -> Deep Break -> Math Part 2).
        3. **IGCSE INTENSITY**: Ensure > 3 hours of Science/Math study.
        4. **BACKLOG FIRST**: Prioritize debt tasks.
        
        Output JSON Array ONLY: [{"start":"HH:MM", "end":"HH:MM", "task":"Name", "type":"study|break|meal"}]
        `;

        try {
            const json = await callLLM(prompt, true);
            const sched = JSON.parse(json);
            STATE.schedule = sched.map(s => ({...s, done: false}));
            
            STATE.backlog = []; 
            localStorage.setItem('jack_v1_backlog', JSON.stringify([]));
            localStorage.setItem('jack_v1_sched', JSON.stringify(STATE.schedule));
            
            switchView('active');
            renderTable();
            speak("Schedule locked. Warden logic active. Proceed.", "æ—¶é—´è¡¨å·²é”å®šã€‚ç®¡å®¶é€»è¾‘å·²æ¿€æ´»ã€‚");

        } catch(e) {
            addBubble("Fatal Error: " + e.message, 'error');
        }
    }

    /* =========================================
       4. THE ENGINE (Look-Ahead Hijack)
       ========================================= */
    function engineTick() {
        if(STATE.schedule.length === 0) return;
        const now = new Date();
        const curM = now.getHours() * 60 + now.getMinutes();
        
        let active = null;
        let next = null;
        let idx = -1;
        let hijackBuffer = false; // Is hijack active?

        // 1. Scan for active block normally
        for(let i=0; i<STATE.schedule.length; i++) {
            const s = STATE.schedule[i];
            const start = t2m(s.start);
            const end = t2m(s.end);

            if(curM >= start && curM < end) {
                active = s;
                idx = i;
                if(STATE.schedule[i+1]) next = STATE.schedule[i+1];
                break;
            }
        }

        // 2. HIJACK LOGIC: Check if Next Task is Study and starting within 10 mins
        // OR check if First Task of day is starting within 10 mins
        
        // Case A: First task of day (Pre-start Buffer)
        if(!active) {
            const first = STATE.schedule[0];
            const start = t2m(first.start);
            if(first.type === 'study' && curM >= start - 10 && curM < start) {
                triggerBufferUI(first.task, start*60 - (curM*60 + now.getSeconds()), 600);
                return; // Stop here, don't show "No Active Task"
            }
        }

        // Case B: Mid-day Hijack
        if(next && next.type === 'study') {
            const nextStart = t2m(next.start);
            // If current time is within 10 mins of next start
            if(curM >= nextStart - 10 && curM < nextStart) {
                // HIJACK! Override whatever "active" block is (e.g. Break)
                triggerBufferUI(next.task, nextStart*60 - (curM*60 + now.getSeconds()), 600);
                return; // Stop here, effectively hiding the current 'Break' task
            }
        }

        // 3. Normal Display (If not hijacked)
        if(active) {
            // If we just exited a buffer (started task), clear lock
            if(STATE.lastBufferTask === active.task) STATE.lastBufferTask = null;

            const start = t2m(active.start);
            const end = t2m(active.end);
            updateUI(active.task, end*60 - (curM*60 + now.getSeconds()), (end-start)*60, false, active.type);
            highlightRow(idx);
            document.getElementById('next-task-display').innerText = next ? `Next: ${next.task} (${next.start})` : "Next: End of Day";
        } else {
            // Free time (and not in pre-start buffer)
            document.getElementById('timer-display').innerText = "--:--";
            document.getElementById('timer-label').innerText = "NO ACTIVE TASK";
            document.getElementById('main-card').classList.remove('buffer-mode');
        }
    }

    function triggerBufferUI(taskName, secondsLeft, totalSeconds) {
        // TTS Lock
        if(STATE.lastBufferTask !== taskName) { 
            STATE.lastBufferTask = taskName; 
            speak(`Warning. 10 minutes to ${taskName}. Drop your phone immediately.`, "è­¦å‘Šã€‚10åˆ†é’Ÿåä»»åŠ¡å¼€å§‹ã€‚ç«‹å³æ”¾ä¸‹æ‰‹æœºã€‚");
        }
        updateUI("PREPARE: " + taskName, secondsLeft, totalSeconds, true, 'study');
        // Visual override for table row? Optional.
    }

    function updateUI(label, secs, total, isBuf, type) {
        const m = Math.floor(secs/60).toString().padStart(2,'0');
        const s = (secs%60).toString().padStart(2,'0');
        document.getElementById('timer-display').innerText = `${m}:${s}`;
        document.getElementById('timer-label').innerText = label;
        
        const card = document.getElementById('main-card');
        const bar = document.getElementById('progress-bar');
        const badge = document.getElementById('buffer-badge');
        
        // Progress Bar Math
        let pct = ((total-secs)/total)*100;
        if(pct < 0) pct = 0; if(pct > 100) pct = 100;
        bar.style.width = pct + "%";
        
        if(isBuf) {
            card.classList.add('buffer-mode');
            badge.style.display = 'inline-block';
            bar.style.background = "var(--yellow)";
        } else {
            card.classList.remove('buffer-mode');
            badge.style.display = 'none';
            bar.style.background = type === 'study' ? "var(--blue)" : "var(--green)";
        }
    }

    /* =========================================
       5. CHAT & PROTOCOL (Parsing)
       ========================================= */
    async function sendMsg() {
        const txt = document.getElementById('user-msg').value.trim();
        if(!txt) return;
        addBubble(txt, 'user');
        document.getElementById('user-msg').value = '';

        const prompt = `
        Context: Jack's Schedule (JSON): ${JSON.stringify(STATE.schedule)}.
        User Request: "${txt}"
        PROTOCOL:
        1. Reply in Chinese.
        2. Tag [TTS: "English" | "Chinese"].
        3. IF cancelling task: Output [BACKLOG: TaskName] and [REGENERATE: JSON].
        4. IF swapping time: Output [REGENERATE: JSON].
        5. IF Denied: Output [DENY].
        CRITICAL: RETURN CLEAN JSON.
        `;

        try {
            const res = await callLLM(prompt, false);
            let clean = res;

            const blM = res.match(/\[BACKLOG:\s*(.*?)\]/);
            if(blM) {
                STATE.backlog.push(blM[1]);
                localStorage.setItem('jack_v1_backlog', JSON.stringify(STATE.backlog));
                clean = clean.replace(blM[0], '');
                speak("Task backlog updated. It will return tomorrow.", "ä»»åŠ¡å·²è®°å…¥é»‘è´¦ã€‚æ˜å¤©è§ã€‚");
            }

            const ttsM = res.match(/\[TTS:\s*"(.*?)"\s*\|\s*"(.*?)"\]/);
            if(ttsM) {
                speak(ttsM[1], ttsM[2]);
                clean = clean.replace(ttsM[0], '');
            }

            if(res.includes("[REGENERATE:")) {
                const jsonStr = extractJSON(res);
                if(jsonStr) {
                    try {
                        const newSched = JSON.parse(jsonStr);
                        if(Array.isArray(newSched)) {
                            STATE.schedule = newSched.map(s => ({...s, done: false}));
                            localStorage.setItem('jack_v1_sched', JSON.stringify(STATE.schedule));
                            renderTable();
                            clean = clean.replace(/\[REGENERATE:[\s\S]*?\]/, ''); 
                        }
                    } catch(e){}
                }
            }

            addBubble(clean, 'ai');

        } catch(e) {
            addBubble("Error: " + e.message, 'system');
        }
    }

    function extractJSON(text) {
        const startMarker = "[REGENERATE:";
        const startIdx = text.indexOf(startMarker);
        if (startIdx === -1) return null;
        const jsonStart = text.indexOf("[", startIdx + startMarker.length);
        if (jsonStart === -1) return null;
        let depth = 0; let jsonEnd = -1;
        for (let i = jsonStart; i < text.length; i++) {
            if (text[i] === '[') depth++;
            else if (text[i] === ']') {
                depth--;
                if (depth === 0) { jsonEnd = i; break; }
            }
        }
        return jsonEnd !== -1 ? text.substring(jsonStart, jsonEnd + 1) : null;
    }

    /* =========================================
       6. UTILS
       ========================================= */
    function finishTaskEarly() {
        if(STATE.activeTaskIdx >= 0 && STATE.schedule[STATE.activeTaskIdx]) {
            STATE.schedule[STATE.activeTaskIdx].done = true;
            STATE.schedule[STATE.activeTaskIdx].type = 'break'; 
            STATE.schedule[STATE.activeTaskIdx].task += " (Done)";
            localStorage.setItem('jack_v1_sched', JSON.stringify(STATE.schedule));
            renderTable();
            speak("Task complete. Enjoy the break.", "ä»»åŠ¡å®Œæˆã€‚ä¼‘æ¯ä¸€ä¸‹ã€‚");
        }
    }

    async function callLLM(prompt, jsonMode) {
        const url = STATE.provider === 'deepseek' ? 'https://api.deepseek.com/chat/completions' : 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
        
        const res = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${STATE.apiKey}`},
            body: JSON.stringify({
                model: STATE.provider === 'deepseek' ? 'deepseek-chat' : 'qwen-plus',
                messages: [{role: "system", content: prompt}],
                temperature: 0.7
            })
        });
        const d = await res.json();
        let c = d.choices[0].message.content;
        
        if (jsonMode) {
            const firstBracket = c.indexOf('[');
            const lastBracket = c.lastIndexOf(']');
            if(firstBracket > -1 && lastBracket > -1) return c.substring(firstBracket, lastBracket+1);
            return c;
        }
        return c;
    }

    function speak(en, zh) {
        window.speechSynthesis.cancel();
        
        const box = document.getElementById('subtitle-box');
        document.getElementById('sub-en').innerText = en;
        document.getElementById('sub-zh').innerText = zh;
        box.style.display = 'block';

        const u = new SpeechSynthesisUtterance(en);
        u.lang = 'en-US';
        u.rate = 1.1;
        
        const voices = window.speechSynthesis.getVoices();
        const selVal = document.getElementById('voice-select').value;
        let v = voices.find(v => v.voiceURI === selVal) || voices.find(v => v.voiceURI === STATE.voiceUri);
        
        if(!v) v = voices.find(v => v.name.includes("Natural") && v.lang.startsWith("en"));
        if(v) u.voice = v;

        u.onend = () => setTimeout(() => box.style.display='none', 3000);
        window.speechSynthesis.speak(u);
    }

    function loadVoices() {
        const populate = () => {
            const voices = window.speechSynthesis.getVoices();
            if(voices.length === 0) return;
            const sel = document.getElementById('voice-select');
            sel.innerHTML = '';
            const enVoices = voices.filter(v => v.lang.startsWith('en'));
            enVoices.sort((a,b) => (b.name.includes("Natural") ? 1 : 0) - (a.name.includes("Natural") ? 1 : 0));
            enVoices.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.voiceURI;
                opt.innerText = (v.name.includes("Natural") ? "ğŸŒŸ " : "") + v.name.replace("Microsoft ", "");
                sel.appendChild(opt);
            });
            if(STATE.voiceUri) sel.value = STATE.voiceUri;
        };
        populate();
        if(window.speechSynthesis.onvoiceschanged !== undefined) window.speechSynthesis.onvoiceschanged = populate;
        setTimeout(populate, 1000);
    }

    function testVoice() {
        STATE.voiceUri = document.getElementById('voice-select').value;
        speak("Voice system verified. Warden is listening.", "è¯­éŸ³ç³»ç»Ÿå·²éªŒè¯ã€‚");
    }

    function t2m(t) { const [h,m]=t.split(':').map(Number); return h*60+m; }
    function renderTable() {
        const b = document.getElementById('schedule-body'); b.innerHTML='';
        STATE.schedule.forEach((s,i) => {
            b.innerHTML += `<tr id="row-${i}" class="row-${s.type} ${s.done?'row-done':''}"><td>${s.start}-${s.end}</td><td>${s.task}</td><td>${s.type.toUpperCase()}</td></tr>`;
        });
    }
    function highlightRow(i) {
        document.querySelectorAll('tbody tr').forEach(t=>t.classList.remove('row-active'));
        if(i>=0) document.getElementById(`row-${i}`).classList.add('row-active');
    }
    function addBubble(t,c) {
        const d=document.createElement('div'); d.className=`bubble ${c}`; d.innerText=t;
        const h=document.getElementById('chat-history'); h.appendChild(d); h.scrollTop=h.scrollHeight;
    }
    function switchView(view) {
        document.getElementById('view-generator').style.display = view === 'generator' ? 'flex' : 'none';
        document.getElementById('view-active').style.display = view === 'active' ? 'block' : 'none';
    }
    function saveSettings() {
        STATE.apiKey = document.getElementById('api-key').value;
        STATE.provider = document.getElementById('model-select').value;
        STATE.voiceUri = document.getElementById('voice-select').value;
        localStorage.setItem('jack_v1_key', STATE.apiKey);
        localStorage.setItem('jack_v1_provider', STATE.provider);
        localStorage.setItem('jack_v1_voice', STATE.voiceUri);
        document.getElementById('settings-modal').close();
    }
    function openSettings() { document.getElementById('settings-modal').showModal(); }

</script>
</body>
</html>
