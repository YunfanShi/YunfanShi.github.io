<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jack's Warden | V9.3 CSV</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        :root {
            --md-primary: #c20c0c;
            --md-bg: #f5f5f5;
            --color-study: #333333;
            --color-break: #c20c0c;
            --buffer-bg: #fffbf0;
            --buffer-accent: #ffc107;
            --shadow-2: 0 4px 12px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; transition: background-color 0.4s ease, color 0.2s ease; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--md-bg); color: #1f1f1f; height: 100vh; display: flex; overflow: hidden; }

        body.buffer-active { background-color: var(--buffer-bg) !important; }
        body.buffer-active aside { border-right: 4px solid var(--buffer-accent); }

        /* Sidebar */
        aside { width: 360px; background: #fff; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; z-index: 20; box-shadow: 4px 0 24px rgba(0,0,0,0.02); }
        
        .player-header { padding: 20px; background: #242424; color: white; }
        .player-title { font-weight: bold; font-size: 16px; display:flex; align-items:center; gap:10px; margin-bottom: 10px;}
        
        /* Playlist Selector Area */
        .playlist-control { display: flex; gap: 8px; align-items: center; }
        .playlist-select {
            flex: 1; padding: 8px 12px; border-radius: 6px; border: none;
            background: #333; color: white; font-size: 13px; cursor: pointer;
            outline: none; font-weight: 500;
        }
        .playlist-select:hover { background: #444; }
        .btn-add { 
            width: 32px; height: 32px; border-radius: 6px; border: none; 
            background: var(--md-primary); color: white; cursor: pointer; 
            font-weight: bold; font-size: 18px; display: flex; justify-content: center; align-items: center;
        }
        .btn-add:hover { background: #d31e1e; }

        /* Auto Playing Info */
        .auto-play-info {
            margin-top: 15px; padding: 10px; background: #333; border-radius: 6px;
            font-size: 12px; color: #aaa; text-align: center; display: none;
        }
        .auto-play-info.active { display: block; animation: fadeIn 0.5s; }
        .scrolling-text { color: var(--md-primary); font-weight: bold; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .iframe-container { flex: 1; background: #fff; display: flex; justify-content: center; padding-top: 10px; overflow: hidden; }
        
        /* TTS Settings Area */
        .tts-settings { padding: 15px; background: #f9f9f9; border-top: 1px solid #eee; font-size: 13px; }
        .tts-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; color:#555; font-weight:bold; }
        .tts-select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd; background: white; }

        /* Main */
        main { flex: 1; padding: 30px 40px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; position: relative; }
        header { display: flex; justify-content: space-between; align-items: center; }
        .date-badge { background: #333; color: #fff; padding: 8px 16px; border-radius: 4px; font-family: 'Roboto Mono'; }

        .timer-card { background: white; border-radius: 20px; padding: 40px; text-align: center; box-shadow: var(--shadow-2); border: 1px solid #e0e0e0; position: relative; }
        .timer-digits { font-size: 120px; font-family: 'Inter', sans-serif; font-weight: 900; color: #333; line-height: 0.9; letter-spacing: -4px; font-variant-numeric: tabular-nums; }
        .timer-label { font-size: 24px; color: #666; margin-bottom: 20px; font-weight: 700; text-transform: uppercase; }
        
        .early-finish-btn { position: absolute; right: 20px; top: 20px; background: #e6f4ea; color: #137333; border: 1px solid #c6ebd1; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px; opacity: 0; pointer-events: none; transition: opacity 0.3s; display: flex; align-items: center; gap: 5px; }
        .early-finish-btn.visible { opacity: 1; pointer-events: auto; }

        .schedule-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: var(--shadow-2); border: 1px solid #e0e0e0; max-height: 500px; overflow-y: auto; }
        .task-row { display: grid; grid-template-columns: 50px 80px 1fr 80px; padding: 16px 20px; border-bottom: 1px solid #f0f0f0; align-items: center; }
        .task-row.active { background: #fff0f0; border-left: 6px solid var(--md-primary); }
        .task-row.done { background: #f8f9fa; opacity: 0.5; }
        .task-row.done .task-name { text-decoration: line-through; }
        .checkbox-custom { width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 4px; cursor: pointer; display: grid; place-items: center; color: white; }
        .task-row.done .checkbox-custom { background: var(--color-break); border-color: var(--color-break); }
        .task-time { font-family: 'Roboto Mono'; font-size: 13px; color: #666; }
        .task-type { font-size: 11px; text-transform: uppercase; font-weight: 700; text-align: right; }
        .task-type.study { color: var(--color-study); }
        .task-type.break { color: var(--color-break); }

        /* Alerts */
        #fullscreen-alert { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.4s; }
        #fullscreen-alert.active { opacity: 1; pointer-events: auto; }
        .alert-icon { font-size: 100px; margin-bottom: 16px; }
        .alert-title { font-size: 50px; font-weight: 900; margin: 0; color: #333; }
        .mode-break .alert-title { color: var(--md-primary); }

        /* Start Overlay */
        #start-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; }
        
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    </style>
</head>
<body>

<audio id="bgm-player"></audio>

<div id="start-overlay">
    <span class="material-icons-round" style="font-size: 64px; margin-bottom: 20px;">security</span>
    <h2>Warden V9.3 CSV</h2>
    <p>Schedule: CSV Imported</p>
    <button onclick="initSystem()" style="padding: 15px 40px; font-size: 18px; border-radius: 50px; border: none; background: var(--md-primary); color: white; cursor: pointer; font-weight: bold; margin-top: 20px;">
        Initialize System
    </button>
</div>

<div id="fullscreen-alert">
    <span class="material-icons-round alert-icon" id="alert-icon">notifications</span>
    <h1 class="alert-title" id="alert-text">Alert</h1>
</div>

<aside>
    <div class="player-header">
        <div class="player-title">
            <span class="material-icons-round" style="color:var(--md-primary)">library_music</span>
            SELECT PLAYLIST
        </div>
        <div class="playlist-control">
            <select id="playlist-picker" class="playlist-select" onchange="changePlaylist(this.value)">
                <option value="17723303753">Timetable Pack (Default)</option>
                <option value="17704807303">逆水寒·战斗 (Combat)</option>
                <option value="17672788372">逆水寒·前200 (Top 200)</option>
                <option value="17666278720">逆水长琴 (Zither)</option>
                <option value="17654903028">逆水寒·精选 (Best Of)</option>
            </select>
            <button class="btn-add" onclick="addCustomPlaylist()" title="Add Playlist ID">+</button>
        </div>

        <div id="auto-play-info" class="auto-play-info">
            AUTO-BGM ACTIVE
            <div id="scrolling-song-name" class="scrolling-text">--</div>
        </div>
    </div>

    <div class="iframe-container">
        <iframe id="music-iframe" frameborder="no" border="0" marginwidth="0" marginheight="0" width=340 height=450 src=""></iframe>
    </div>

    <div class="tts-settings">
        <div class="tts-header">
            <span><span class="material-icons-round" style="font-size:14px; vertical-align:middle;">record_voice_over</span> AI Voice</span>
            <button onclick="populateVoiceSelect()" style="border:none; background:transparent; color:var(--md-primary); cursor:pointer; font-size:16px;" title="Refresh Voices">↻</button>
        </div>
        <select id="voice-select" class="tts-select" onchange="testVoice()"></select>
    </div>
</aside>

<main>
    <header>
        <div>
            <h2 style="margin:0; font-size:20px;">Daily Schedule</h2>
            <div id="day-label" style="font-size:14px; color:#666;">Loading...</div>
        </div>
        <div class="date-badge" id="clock-display">00:00</div>
    </header>

    <div class="timer-card" id="main-card">
        <button class="early-finish-btn" id="btn-early" onclick="finishTaskEarly()">
            <span class="material-icons-round">done_all</span> Finish Early
        </button>
        <div class="timer-label" id="timer-label">STANDBY</div>
        <div class="timer-digits" id="timer-display">--:--</div>
        
        <div style="position:absolute; bottom:0; left:0; width:100%; height:6px; background:#f0f0f0;">
            <div id="progress-bar" style="height:100%; width:0%; background:var(--md-primary); transition:width 1s linear;"></div>
        </div>
    </div>

    <div class="schedule-card" id="schedule-list"></div>
</main>

<script>
    /* ======================== 1. MUSIC DATA (With Names) ======================== */
    const AUTO_BGM_LIST = [
        {id: 2640844158, name: "天阙万钧 (九光寒林·战斗)"},
        {id: 3312207342, name: "驭骨掌中 (关山藏锋·米擒负)"},
        {id: 3312206530, name: "红丝魇 (关山藏锋·练小窈)"},
        {id: 3332977605, name: "凭澜引 (怒潮归流·曲河星)"},
        {id: 2119745415, name: "揽月 (谪仙惊涛·李白)"},
        {id: 2119743531, name: "怒涛砥霜剑 (谪仙惊涛·战斗)"},
        {id: 2137411622, name: "星罗棋布 (永夜星都·天弈之墟)"},
        {id: 2137412905, name: "众生如棋 (永夜星都·天弈之墟)"},
        {id: 2137411613, name: "天悬太一 (永夜星都·天极中宫)"},
        {id: 2719266561, name: "无日无更 (无更市)"},
        {id: 864099181,  name: "逆水寒 (河山集)"},
        {id: 2686665002, name: "夕拾谣 (南海乱墟·流珠)"}
    ];

    /* ======================== 2. SCHEDULE DATA (CSV Imported) ======================== */
    // 0:Sun, 1:Mon, ..., 6:Sat
    const SCHEDULE_DATA = {
        "0": [
            {"start": "10:30", "end": "11:10", "task": "Summer HW", "type": "study", "done": false},
            {"start": "11:10", "end": "11:25", "task": "Break", "type": "break", "done": false},
            {"start": "11:25", "end": "12:05", "task": "Math Note", "type": "study", "done": false},
            {"start": "12:05", "end": "13:30", "task": "Lunch", "type": "break", "done": false},
            {"start": "13:30", "end": "14:10", "task": "Vocab", "type": "study", "done": false},
            {"start": "14:10", "end": "14:25", "task": "Break", "type": "break", "done": false},
            {"start": "14:25", "end": "15:05", "task": "Bio Note", "type": "study", "done": false},
            {"start": "15:05", "end": "15:35", "task": "Break", "type": "break", "done": false},
            {"start": "15:35", "end": "16:15", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "16:15", "end": "16:30", "task": "Break", "type": "break", "done": false},
            {"start": "16:30", "end": "17:10", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "17:10", "end": "18:30", "task": "Dinner", "type": "break", "done": false},
            {"start": "18:30", "end": "19:10", "task": "Chem Note", "type": "study", "done": false},
            {"start": "19:10", "end": "19:25", "task": "Break", "type": "break", "done": false},
            {"start": "19:25", "end": "20:05", "task": "Physics Note", "type": "study", "done": false},
            {"start": "20:05", "end": "20:35", "task": "Break", "type": "break", "done": false},
            {"start": "20:35", "end": "21:15", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "21:15", "end": "21:55", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "21:55", "end": "22:35", "task": "CS50P", "type": "study", "done": false}
        ],
        "1": [
            {"start": "10:30", "end": "11:10", "task": "Vocab", "type": "study", "done": false},
            {"start": "11:10", "end": "11:25", "task": "Break", "type": "break", "done": false},
            {"start": "11:25", "end": "12:05", "task": "Bio Note", "type": "study", "done": false},
            {"start": "12:05", "end": "13:30", "task": "Lunch", "type": "break", "done": false},
            {"start": "13:30", "end": "14:10", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "14:10", "end": "14:25", "task": "Break", "type": "break", "done": false},
            {"start": "14:25", "end": "15:05", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "15:05", "end": "15:35", "task": "Break", "type": "break", "done": false},
            {"start": "15:35", "end": "16:15", "task": "Physics Note", "type": "study", "done": false},
            {"start": "16:15", "end": "16:30", "task": "Break", "type": "break", "done": false},
            {"start": "16:30", "end": "17:10", "task": "Piano", "type": "study", "done": false},
            {"start": "17:10", "end": "18:30", "task": "Dinner", "type": "break", "done": false},
            {"start": "18:30", "end": "19:10", "task": "Math Note", "type": "study", "done": false},
            {"start": "19:10", "end": "19:25", "task": "Break", "type": "break", "done": false},
            {"start": "19:25", "end": "20:05", "task": "Math Note", "type": "study", "done": false},
            {"start": "20:05", "end": "20:35", "task": "Break", "type": "break", "done": false},
            {"start": "20:35", "end": "21:15", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "21:15", "end": "21:55", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "21:55", "end": "22:35", "task": "Summer HW", "type": "study", "done": false}
        ],
        "2": [
            {"start": "10:30", "end": "11:10", "task": "Summer HW", "type": "study", "done": false},
            {"start": "11:10", "end": "11:25", "task": "Break", "type": "break", "done": false},
            {"start": "11:25", "end": "12:05", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "12:05", "end": "13:30", "task": "Lunch", "type": "break", "done": false},
            {"start": "13:30", "end": "14:10", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "14:10", "end": "14:25", "task": "Break", "type": "break", "done": false},
            {"start": "14:25", "end": "15:05", "task": "Physics Note", "type": "study", "done": false},
            {"start": "15:05", "end": "15:35", "task": "Break", "type": "break", "done": false},
            {"start": "15:35", "end": "16:15", "task": "Bio Note", "type": "study", "done": false},
            {"start": "16:15", "end": "16:30", "task": "Break", "type": "break", "done": false},
            {"start": "16:30", "end": "17:10", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "17:10", "end": "18:30", "task": "Dinner", "type": "break", "done": false},
            {"start": "18:30", "end": "19:10", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "19:10", "end": "19:25", "task": "Break", "type": "break", "done": false},
            {"start": "19:25", "end": "20:05", "task": "Chem Note", "type": "study", "done": false},
            {"start": "20:05", "end": "20:35", "task": "Break", "type": "break", "done": false},
            {"start": "20:35", "end": "21:15", "task": "Vocab", "type": "study", "done": false},
            {"start": "21:15", "end": "21:55", "task": "CS50P", "type": "study", "done": false},
            {"start": "21:55", "end": "22:35", "task": "Physics Note", "type": "study", "done": false}
        ],
        "3": [
            {"start": "10:30", "end": "11:10", "task": "Summer HW", "type": "study", "done": false},
            {"start": "11:10", "end": "11:25", "task": "Break", "type": "break", "done": false},
            {"start": "11:25", "end": "12:05", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "12:05", "end": "13:30", "task": "Lunch", "type": "break", "done": false},
            {"start": "13:30", "end": "14:10", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "14:10", "end": "14:25", "task": "Break", "type": "break", "done": false},
            {"start": "14:25", "end": "15:05", "task": "Vocab", "type": "study", "done": false},
            {"start": "15:05", "end": "15:35", "task": "Break", "type": "break", "done": false},
            {"start": "15:35", "end": "16:15", "task": "Math Note", "type": "study", "done": false},
            {"start": "16:15", "end": "16:30", "task": "Break", "type": "break", "done": false},
            {"start": "16:30", "end": "17:10", "task": "Chem Note", "type": "study", "done": false},
            {"start": "17:10", "end": "18:30", "task": "Dinner", "type": "break", "done": false},
            {"start": "18:30", "end": "19:10", "task": "Physics Note", "type": "study", "done": false},
            {"start": "19:10", "end": "19:25", "task": "Break", "type": "break", "done": false},
            {"start": "19:25", "end": "20:05", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "20:05", "end": "20:35", "task": "Break", "type": "break", "done": false},
            {"start": "20:35", "end": "21:15", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "21:15", "end": "21:55", "task": "Bio Note", "type": "study", "done": false},
            {"start": "21:55", "end": "22:35", "task": "Piano", "type": "study", "done": false}
        ],
        "4": [
            {"start": "10:30", "end": "11:10", "task": "Physics Note", "type": "study", "done": false},
            {"start": "11:10", "end": "11:25", "task": "Break", "type": "break", "done": false},
            {"start": "11:25", "end": "12:05", "task": "Chem Note", "type": "study", "done": false},
            {"start": "12:05", "end": "13:30", "task": "Lunch", "type": "break", "done": false},
            {"start": "13:30", "end": "14:10", "task": "Physics Note", "type": "study", "done": false},
            {"start": "14:10", "end": "14:25", "task": "Break", "type": "break", "done": false},
            {"start": "14:25", "end": "15:05", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "15:05", "end": "15:35", "task": "Break", "type": "break", "done": false},
            {"start": "15:35", "end": "16:15", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "16:15", "end": "16:30", "task": "Break", "type": "break", "done": false},
            {"start": "16:30", "end": "17:10", "task": "Vocab", "type": "study", "done": false},
            {"start": "17:10", "end": "18:30", "task": "Dinner", "type": "break", "done": false},
            {"start": "18:30", "end": "19:10", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "19:10", "end": "19:25", "task": "Break", "type": "break", "done": false},
            {"start": "19:25", "end": "20:05", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "20:05", "end": "20:35", "task": "Break", "type": "break", "done": false},
            {"start": "20:35", "end": "21:15", "task": "Chem Note", "type": "study", "done": false},
            {"start": "21:15", "end": "21:55", "task": "Summer HW", "type": "study", "done": false},
            {"start": "21:55", "end": "22:35", "task": "CS50P", "type": "study", "done": false}
        ],
        "5": [
            {"start": "10:30", "end": "11:10", "task": "Vocab", "type": "study", "done": false},
            {"start": "11:10", "end": "11:25", "task": "Break", "type": "break", "done": false},
            {"start": "11:25", "end": "12:05", "task": "Chem Note", "type": "study", "done": false},
            {"start": "12:05", "end": "13:30", "task": "Lunch", "type": "break", "done": false},
            {"start": "13:30", "end": "14:10", "task": "Piano", "type": "study", "done": false},
            {"start": "14:10", "end": "14:25", "task": "Break", "type": "break", "done": false},
            {"start": "14:25", "end": "15:05", "task": "Math Note", "type": "study", "done": false},
            {"start": "15:05", "end": "15:35", "task": "Break", "type": "break", "done": false},
            {"start": "15:35", "end": "16:15", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "16:15", "end": "16:30", "task": "Break", "type": "break", "done": false},
            {"start": "16:30", "end": "17:10", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "17:10", "end": "18:30", "task": "Dinner", "type": "break", "done": false},
            {"start": "18:30", "end": "19:10", "task": "Bio Note", "type": "study", "done": false},
            {"start": "19:10", "end": "19:25", "task": "Break", "type": "break", "done": false},
            {"start": "19:25", "end": "20:05", "task": "Summer HW", "type": "study", "done": false},
            {"start": "20:05", "end": "20:35", "task": "Break", "type": "break", "done": false},
            {"start": "20:35", "end": "21:15", "task": "Bio Note", "type": "study", "done": false},
            {"start": "21:15", "end": "21:55", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "21:55", "end": "22:35", "task": "IELTS Lessons", "type": "study", "done": false}
        ],
        "6": [
            {"start": "10:30", "end": "11:10", "task": "Summer HW", "type": "study", "done": false},
            {"start": "11:10", "end": "11:25", "task": "Break", "type": "break", "done": false},
            {"start": "11:25", "end": "12:05", "task": "Chem Note", "type": "study", "done": false},
            {"start": "12:05", "end": "13:30", "task": "Lunch", "type": "break", "done": false},
            {"start": "13:30", "end": "14:10", "task": "Piano", "type": "study", "done": false},
            {"start": "14:10", "end": "14:25", "task": "Break", "type": "break", "done": false},
            {"start": "14:25", "end": "15:05", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "15:05", "end": "15:35", "task": "Break", "type": "break", "done": false},
            {"start": "15:35", "end": "16:15", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "16:15", "end": "16:30", "task": "Break", "type": "break", "done": false},
            {"start": "16:30", "end": "17:10", "task": "Math Note", "type": "study", "done": false},
            {"start": "17:10", "end": "18:30", "task": "Dinner", "type": "break", "done": false},
            {"start": "18:30", "end": "19:10", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "19:10", "end": "19:25", "task": "Break", "type": "break", "done": false},
            {"start": "19:25", "end": "20:05", "task": "IELTS Lessons", "type": "study", "done": false},
            {"start": "20:05", "end": "20:35", "task": "Break", "type": "break", "done": false},
            {"start": "20:35", "end": "21:15", "task": "Vocab", "type": "study", "done": false},
            {"start": "21:15", "end": "21:55", "task": "Math Note", "type": "study", "done": false},
            {"start": "21:55", "end": "22:35", "task": "Bio Note", "type": "study", "done": false}
        ]
    };

    /* ======================== 3. STATE MANAGEMENT ======================== */
    let STATE = {
        schedule: JSON.parse(localStorage.getItem('w3_schedule')) || [],
        voiceUri: localStorage.getItem('w3_voice') || '',
        lastDate: localStorage.getItem('w3_date') || '',
        lastTaskName: null,
        bufferActive: false,
        bgmPlayer: document.getElementById('bgm-player'),
        customPlaylists: JSON.parse(localStorage.getItem('w3_playlists')) || []
    };

    /* ======================== 4. INITIALIZATION ======================== */
    function initSystem() {
        document.getElementById('start-overlay').style.display = 'none';
        
        // Check date reset
        const today = new Date().toDateString();
        if(STATE.lastDate !== today) {
            console.log("New day detected. Loading schedule.");
            loadSchedule();
            localStorage.setItem('w3_date', today);
        } else if (STATE.schedule.length === 0) {
            loadSchedule();
        } else {
            renderTable();
        }

        // Initialize Audio Context
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        new AudioContext().resume();
        
        // Start Loops
        setInterval(tick, 1000);
        populateVoiceSelect();
        window.speechSynthesis.onvoiceschanged = populateVoiceSelect;
        
        // Init BGM & Restore Custom Playlists
        loadCustomPlaylists();
        changePlaylist("17723303753");
        STATE.bgmPlayer.onended = playRandomTrack;

        // Welcome
        speak("Warden V9.3 initialized. CSV schedule loaded.");
    }

    /* ======================== 5. SCHEDULE LOADER (Simplified) ======================== */
    function loadSchedule() {
        const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const todayIdx = new Date().getDay();
        document.getElementById('day-label').innerText = `${days[todayIdx]}'s Schedule`;

        const dailyPlan = SCHEDULE_DATA[todayIdx];

        if (!dailyPlan || dailyPlan.length === 0) {
            STATE.schedule = [];
            document.getElementById('schedule-list').innerHTML = "<div style='padding:20px; text-align:center;'>No classes found for today in CSV data.</div>";
            saveSchedule();
            return;
        }

        // Deep copy to ensure fresh state
        STATE.schedule = JSON.parse(JSON.stringify(dailyPlan));
        saveSchedule();
        renderTable();
    }
    
    function resetToDefault() {
        if(confirm("Reload schedule from CSV data?")) {
            loadSchedule();
            speak("Schedule reloaded.");
        }
    }

    /* ======================== 6. CORE ENGINE (TICK) ======================== */
    function tick() {
        const now = new Date();
        document.getElementById('clock-display').innerText = now.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
        
        if(STATE.schedule.length === 0) return;

        const curM = now.getHours()*60 + now.getMinutes();
        let active = null;

        // 1. Check Buffer (10 mins before Study)
        const nextStudy = STATE.schedule.find(s => s.type === 'study' && !s.done && timeToMinutes(s.start) > curM);
        if (nextStudy && timeToMinutes(nextStudy.start) - curM <= 10 && timeToMinutes(nextStudy.start) > curM) {
            if (!STATE.bufferActive) {
                STATE.bufferActive = true;
                document.body.classList.add('buffer-active');
                speak(`Preparation warning. ${nextStudy.task} begins in 10 minutes.`);
                triggerAlert('warning', `Prepare: ${nextStudy.task}`);
            }
            const secsToStart = timeToMinutes(nextStudy.start)*60 - (curM*60 + now.getSeconds());
            updateTimer(nextStudy.task + " (PREP)", secsToStart, 600, true);
            document.getElementById('btn-early').classList.remove('visible');
            return;
        } else {
            if (STATE.bufferActive) {
                STATE.bufferActive = false;
                document.body.classList.remove('buffer-active');
            }
        }

        // 2. Check Active Task
        active = STATE.schedule.find(s => curM >= timeToMinutes(s.start) && curM < timeToMinutes(s.end));

        if (active) {
            const start = timeToMinutes(active.start);
            const end = timeToMinutes(active.end);
            const totalSecs = (end-start)*60;
            const elapsed = (curM*60 + now.getSeconds()) - start*60;
            const remaining = totalSecs - elapsed;

            // State Transition
            if (STATE.lastTaskName !== active.task) {
                STATE.lastTaskName = active.task;
                
                if (active.type === 'study') {
                    STATE.bgmPlayer.pause();
                    updateAutoPlayInfo("");
                    triggerAlert('school', active.task);
                    speak(`Focus session started: ${active.task}`);
                } else {
                    playRandomTrack();
                    triggerAlert('coffee', active.task); // Use task name for break (Lunch/Dinner)
                    speak(`${active.task} time.`);
                }
                highlightRow(active);
            }
            
            updateTimer(active.task, remaining, totalSecs, false);
            
            // Show early finish button for study tasks
            if (active.type === 'study') {
                document.getElementById('btn-early').classList.add('visible');
            } else {
                document.getElementById('btn-early').classList.remove('visible');
            }
        } else {
            updateTimer("FREE TIME", 0, 100, false);
            STATE.lastTaskName = null;
            document.getElementById('btn-early').classList.remove('visible');
        }
    }

    function updateTimer(label, secs, total, isBuffer) {
        if(secs < 0) secs = 0;
        const m = Math.floor(secs/60).toString().padStart(2,'0');
        const s = (secs%60).toString().padStart(2,'0');
        document.getElementById('timer-display').innerText = `${m}:${s}`;
        document.getElementById('timer-label').innerText = label;
        
        const card = document.getElementById('main-card');
        const bar = document.getElementById('progress-bar');
        
        if (isBuffer) {
            card.classList.add('buffer-mode');
            bar.style.background = "#d69e00";
        } else {
            card.classList.remove('buffer-mode');
            bar.style.background = "var(--md-primary)";
        }
        
        const pct = ((total-secs)/total)*100;
        bar.style.width = pct + "%";
    }

    /* ======================== 7. UI RENDERERS ======================== */
    function renderTable() {
        const div = document.getElementById('schedule-list');
        div.innerHTML = '';
        STATE.schedule.forEach((s, idx) => {
            const row = document.createElement('div');
            row.className = `task-row ${s.done ? 'done' : ''}`;
            row.id = `row-${idx}`;
            row.innerHTML = `
                <div class="checkbox-custom" onclick="toggleTask(${idx})">
                    ${s.done ? '<span class="material-icons-round" style="font-size:16px;">check_circle</span>' : '<span class="material-icons-round" style="font-size:16px; color:#ddd;">radio_button_unchecked</span>'}
                </div>
                <div class="task-time">${s.start} - ${s.end}</div>
                <div class="task-name">${s.task}</div>
                <div class="task-type ${s.type}">${s.type}</div>
            `;
            div.appendChild(row);
        });
    }

    function toggleTask(idx) {
        STATE.schedule[idx].done = !STATE.schedule[idx].done;
        saveSchedule();
        renderTable();
    }

    function highlightRow(activeTask) {
        document.querySelectorAll('.task-row').forEach(r => r.classList.remove('active'));
        const idx = STATE.schedule.indexOf(activeTask);
        if(idx > -1) {
            const el = document.getElementById(`row-${idx}`);
            if(el) {
                el.classList.add('active');
                el.scrollIntoView({behavior: "smooth", block: "center"});
            }
        }
    }

    function finishTaskEarly() {
        const now = new Date();
        const curM = now.getHours()*60 + now.getMinutes();
        const idx = STATE.schedule.findIndex(s => curM >= timeToMinutes(s.start) && curM < timeToMinutes(s.end));
        
        if (idx > -1) {
            STATE.schedule[idx].done = true;
            saveSchedule();
            renderTable();
            speak("Task marked complete.");
        }
    }

    /* ======================== 8. AUDIO & TTS ======================== */
    function changePlaylist(id) {
        document.getElementById('music-iframe').src = `https://music.163.com/outchain/player?type=0&id=${id}&auto=0&height=430`;
    }

    function addCustomPlaylist() {
        const id = prompt("Enter NetEase Playlist ID (e.g., 12345678):");
        if(id && !isNaN(id)) {
            const name = prompt("Enter Playlist Name:", "My Custom List");
            
            // Save to storage
            const playlist = {id: id, name: name || "Custom Playlist"};
            STATE.customPlaylists.push(playlist);
            localStorage.setItem('w3_playlists', JSON.stringify(STATE.customPlaylists));
            
            // Add to dropdown
            const select = document.getElementById('playlist-picker');
            const option = document.createElement('option');
            option.value = id;
            option.innerText = playlist.name;
            select.appendChild(option);
            select.value = id;
            changePlaylist(id);
            
            speak("Custom playlist added and saved.");
        } else if (id) {
            alert("Invalid ID. Please enter numbers only.");
        }
    }

    function loadCustomPlaylists() {
        const select = document.getElementById('playlist-picker');
        STATE.customPlaylists.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.innerText = p.name;
            select.appendChild(option);
        });
    }

    function playRandomTrack() {
        const track = AUTO_BGM_LIST[Math.floor(Math.random() * AUTO_BGM_LIST.length)];
        updateAutoPlayInfo(track.name);
        STATE.bgmPlayer.src = `https://music.163.com/song/media/outer/url?id=${track.id}.mp3`;
        STATE.bgmPlayer.play().catch(e => {
            updateAutoPlayInfo("Auto-play Blocked (Click Page)");
        });
    }

    function updateAutoPlayInfo(text) {
        const infoBox = document.getElementById('auto-play-info');
        const textEl = document.getElementById('scrolling-song-name');
        
        if (text) {
            infoBox.classList.add('active');
            textEl.innerText = "♫ " + text;
        } else {
            infoBox.classList.remove('active');
        }
    }

    function populateVoiceSelect() {
        const sel = document.getElementById('voice-select');
        sel.innerHTML = '';
        const voices = window.speechSynthesis.getVoices().filter(v => v.lang.includes('en'));
        voices.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.voiceURI;
            opt.innerText = v.name;
            sel.appendChild(opt);
        });
        if(STATE.voiceUri) sel.value = STATE.voiceUri;
    }

    function speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        const v = window.speechSynthesis.getVoices().find(v => v.voiceURI === STATE.voiceUri);
        if(v) u.voice = v;
        window.speechSynthesis.speak(u);
    }

    function testVoice() { 
        STATE.voiceUri = document.getElementById('voice-select').value;
        localStorage.setItem('w3_voice', STATE.voiceUri);
        speak("Voice updated successfully."); 
    }

    /* ======================== 9. UTILS ======================== */
    function timeToMinutes(t) { 
        const [h,m] = t.split(':').map(Number); 
        return h*60+m; 
    }
    
    function saveSchedule() { 
        localStorage.setItem('w3_schedule', JSON.stringify(STATE.schedule)); 
    }
    
    function triggerAlert(icon, text) {
        const el = document.getElementById('fullscreen-alert');
        el.classList.add('active');
        document.getElementById('alert-text').innerText = text;
        document.getElementById('alert-icon').innerText = icon;
        setTimeout(() => el.classList.remove('active'), 4000);
    }

</script>
</body>
</html>
