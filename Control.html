<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jack's Warden | V1.0 Ultimate</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        :root {
            --blue: #0b57d0; --red: #b3261e; --yellow: #eac435; --green: #146c2e;
            --surface: #ffffff; --bg: #f3f6fc; --text: #1f1f1f;
            --radius: 24px; --shadow: 0 4px 24px rgba(0,0,0,0.06);
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body { margin: 0; font-family: 'Google Sans', 'Noto Sans SC', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* --- Sidebar --- */
        aside { width: 400px; background: var(--surface); border-right: 1px solid #e0e2e7; display: flex; flex-direction: column; z-index: 20; }
        
        .chat-header { padding: 20px 24px; border-bottom: 1px solid #e0e2e7; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .chat-title { font-weight: 700; color: var(--blue); font-size: 16px; letter-spacing: 0.5px; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
        
        .chat-box { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px; background: #fff; scroll-behavior: smooth; }
        
        .bubble { max-width: 88%; padding: 14px 18px; border-radius: 20px; font-size: 14px; line-height: 1.6; position: relative; }
        .bubble.ai { background: #f0f4f9; color: #1f1f1f; align-self: flex-start; border-bottom-left-radius: 4px; }
        .bubble.user { background: var(--blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .bubble.system { background: #fff0f0; color: var(--red); align-self: center; font-size: 12px; border: 1px solid #ffdad6; font-weight: bold; }

        .input-area { padding: 20px; border-top: 1px solid #e0e2e7; display: flex; gap: 12px; background: var(--surface); }
        .chat-input { flex: 1; padding: 14px 20px; border-radius: 30px; border: 1px solid #c4c7c5; outline: none; font-size: 15px; }
        .chat-input:focus { border-color: var(--blue); box-shadow: 0 0 0 2px rgba(11, 87, 208, 0.1); }

        /* --- Main Content --- */
        main { flex: 1; padding: 40px; display: flex; flex-direction: column; gap: 24px; overflow-y: auto; position: relative; }
        
        header { display: flex; justify-content: space-between; align-items: center; }
        .clock-badge { background: #d3e3fd; color: #041e49; padding: 8px 16px; border-radius: 50px; font-weight: 700; font-family: 'Roboto Mono'; font-size: 16px; }

        /* Generator View */
        #view-generator { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .hero-btn { background: var(--blue); color: white; padding: 20px 48px; border-radius: 50px; border: none; font-size: 18px; font-weight: 600; cursor: pointer; box-shadow: 0 8px 24px rgba(11, 87, 208, 0.25); display: flex; align-items: center; gap: 12px; transition: transform 0.2s; }
        .hero-btn:hover { transform: scale(1.03); }

        /* Active View */
        #view-active { display: none; width: 100%; max-width: 1000px; margin: 0 auto; }
        
        .timer-card { background: white; border-radius: var(--radius); padding: 50px; text-align: center; box-shadow: var(--shadow); margin-bottom: 30px; position: relative; overflow: hidden; border: 1px solid #eff1f4; }
        .timer-digits { font-size: 120px; font-weight: 700; color: var(--text); font-family: 'Roboto Mono', monospace; line-height: 1; letter-spacing: -5px; margin: 20px 0; font-variant-numeric: tabular-nums; }
        .timer-task { font-size: 28px; color: #444746; font-weight: 500; }
        
        /* Buffer Mode Visuals */
        .timer-card.buffer-mode { border: 4px solid var(--yellow); background: #fffdf6; }
        .timer-card.buffer-mode .timer-digits { color: #8c6d0d; }
        
        .progress-line { position: absolute; bottom: 0; left: 0; width: 100%; height: 8px; background: #f0f4f9; }
        .progress-fill { height: 100%; width: 0%; background: var(--blue); transition: width 1s linear; }

        .schedule-table { width: 100%; border-collapse: collapse; background: white; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); border: 1px solid #eff1f4; }
        .schedule-table th { text-align: left; padding: 20px 30px; background: #f8f9fa; color: #444746; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .schedule-table td { padding: 20px 30px; border-top: 1px solid #f0f4f9; font-size: 15px; color: #1f1f1f; }
        
        .row-study { border-left: 6px solid var(--blue); }
        .row-break { border-left: 6px solid var(--green); background: #f8fcf9; }
        .row-meal { border-left: 6px solid var(--yellow); }
        .row-active { background: #e8f0fe !important; font-weight: 700; transform: scale(1.01); box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-top: none; border-bottom: none; }
        .row-done { opacity: 0.4; text-decoration: line-through; background: #f1f3f4; }

        /* Subtitles */
        #subtitle-box { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: white; padding: 16px 32px; border-radius: 16px; text-align: center; z-index: 100; display: none; backdrop-filter: blur(10px); pointer-events: none; width: max-content; max-width: 80%; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
        .sub-en { font-size: 20px; font-weight: 600; color: #fff; margin-bottom: 8px; }
        .sub-zh { font-size: 15px; color: #e3e3e3; font-weight: 400; }

        /* Modal */
        dialog { border: none; border-radius: 28px; padding: 40px; width: 650px; box-shadow: 0 20px 60px rgba(0,0,0,0.25); background: white; }
        dialog::backdrop { background: rgba(0,0,0,0.6); backdrop-filter: blur(6px); }
        
        .matrix-grid { display: grid; gap: 12px; margin: 20px 0; max-height: 400px; overflow-y: auto; }
        .matrix-row { display: grid; grid-template-columns: 2fr 1fr 1fr; align-items: center; padding: 16px; border-radius: 12px; background: #f8f9fa; border: 1px solid #e0e2e7; }
        
        /* Backlog Alert */
        #backlog-alert { background: #fff0f0; color: #b3261e; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #f9dedc; display: none; align-items: center; gap: 10px; font-weight: 600; }
        
        .edge-warning { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:999; color:white; display:flex; flex-direction:column; justify-content:center; align-items:center; }

    </style>
</head>
<body>

<div id="subtitle-box">
    <div class="sub-en" id="sub-en"></div>
    <div class="sub-zh" id="sub-zh"></div>
</div>

<div id="edge-check" class="edge-warning" style="display:none;">
    <span class="material-icons-round" style="font-size:64px; margin-bottom:20px; color:var(--blue);">language</span>
    <h2>Warden Protocol Requirement</h2>
    <p>AI 管家需要 Microsoft Edge 浏览器的 Neural TTS 支持以获得最佳威慑力。</p>
    <button onclick="document.getElementById('edge-check').style.display='none'" style="margin-top:20px; padding:12px 30px; border-radius:24px; border:none; background:white; color:#333; font-weight:600; cursor:pointer;">忽略 (体验降级)</button>
</div>

<aside>
    <div class="chat-header">
        <span class="chat-title"><span class="material-icons-round">security</span> AI WARDEN V1.0</span>
        <button onclick="openSettings()" style="background:none; border:none; cursor:pointer; color:#444746;"><span class="material-icons-round">settings</span></button>
    </div>
    
    <div class="chat-box" id="chat-history">
        <div class="bubble ai">System Online. Warden is watching.</div>
    </div>

    <div class="input-area">
        <input type="text" id="user-msg" class="chat-input" placeholder="向管家汇报 (e.g. 我想把数学换成物理)...">
        <button onclick="sendMsg()" style="background:var(--blue); color:white; border:none; border-radius:50%; width:48px; height:48px; cursor:pointer; display:flex; justify-content:center; align-items:center;"><span class="material-icons-round">send</span></button>
    </div>
</aside>

<main>
    <header>
        <h2 style="margin:0; font-family:'Google Sans'; color:var(--text); display:flex; align-items:center; gap:10px;">
            Control Station <span style="font-size:12px; background:#e0e2e7; padding:4px 8px; border-radius:4px;">LOCKED</span>
        </h2>
        <div class="clock-badge" id="clock-display">00:00</div>
    </header>

    <div id="view-generator">
        <div style="background:white; padding:50px; border-radius:50%; margin-bottom:40px; box-shadow:var(--shadow);">
            <span class="material-icons-round" style="font-size:80px; color:var(--blue);">assignment_turned_in</span>
        </div>
        
        <div id="backlog-alert">
            <span class="material-icons-round">warning</span>
            <span id="backlog-text">检测到未完成的债务...</span>
        </div>

        <h1 style="margin:0 0 10px 0;">今日战术规划</h1>
        <p style="color:#444746; margin-bottom:50px; line-height:1.6; max-width:500px;">
            <strong style="color:var(--blue)">强制规则：</strong><br>
            长任务必须拆分休息。<br>
            前置任务未完成，禁止模考。<br>
            未完成任务将计入债务。
        </p>
        <button class="hero-btn" onclick="openMatrixSelector()">
            <span class="material-icons-round">add_task</span> 建立任务矩阵
        </button>
    </div>

    <div id="view-active">
        <div class="timer-card" id="main-card">
            <div id="buffer-badge" style="background:var(--yellow); display:none; padding:8px 20px; border-radius:30px; font-weight:800; margin-bottom:20px; font-size:16px; color:#4a3800; animation: pulse 2s infinite;">⚠️ BUFFER ZONE (10m)</div>
            <div class="timer-task" id="timer-label">Awaiting Protocol...</div>
            <div class="timer-digits" id="timer-display">--:--</div>
            <div style="font-size:16px; color:#666; font-weight:500; margin-top:10px;" id="next-task-display">Next: --</div>
            
            <div style="margin-top:40px; display:flex; gap:20px; justify-content:center;">
                <button onclick="finishTaskEarly()" style="background:var(--green); color:white; border:none; padding:15px 35px; border-radius:50px; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:10px; font-size:16px; box-shadow:0 8px 20px rgba(20, 108, 46, 0.25);">
                    <span class="material-icons-round">done_all</span> 任务完成
                </button>
                <button onclick="window.open('https://yunfanshi.github.io/Studyplan.html', '_blank')" style="background:white; border:1px solid #c4c7c5; padding:15px 35px; border-radius:50px; cursor:pointer; font-weight:600; display:flex; align-items:center; gap:10px; font-size:16px;">
                    <span class="material-icons-round">launch</span> 打开 StudyPlan
                </button>
            </div>
            
            <div class="progress-line"><div class="progress-fill" id="progress-bar"></div></div>
        </div>

        <table class="schedule-table">
            <thead><tr><th width="140">Time</th><th>Task</th><th width="120">Type</th></tr></thead>
            <tbody id="schedule-body"></tbody>
        </table>
    </div>
</main>

<dialog id="matrix-modal">
    <h3 style="margin-top:0;">构建今日任务</h3>
    <p style="font-size:13px; color:#666;">系统会自动检查 StudyPlan 进度锁。ZNotes 未完成时禁止选择 Mock。</p>
    
    <div class="matrix-grid">
        <div class="matrix-row" style="background:none; border-bottom:2px solid #e0e2e7; font-weight:700;">
            <div>Subject</div><div style="text-align:center;">XNotes</div><div style="text-align:center;">Mock (90m+)</div>
        </div>
        <div id="matrix-rows"></div>
    </div>

    <div style="margin-top:25px; padding-top:20px; border-top:1px solid #e0e2e7;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <label style="display:flex; align-items:center; font-weight:600; color:var(--red);">
                <input type="checkbox" checked disabled style="margin-right:10px;"> 暑假作业 (1h)
            </label>
            <label style="display:flex; align-items:center; font-weight:600; color:var(--red);">
                <input type="checkbox" checked disabled style="margin-right:10px;"> 单词 (Vocab)
            </label>
            <label style="display:flex; align-items:center; font-weight:600; color:var(--red);">
                <input type="checkbox" id="chk-ielts" checked disabled style="margin-right:10px;"> IELTS Lessons
            </label>
            <label style="display:flex; align-items:center; font-weight:600;">
                <input type="checkbox" id="chk-python"> CS50P Python
            </label>
            <label style="display:flex; align-items:center; font-weight:600;">
                <input type="checkbox" id="chk-piano"> Piano
            </label>
        </div>
    </div>

    <div style="text-align:right; margin-top:30px;">
        <button onclick="confirmMatrix()" class="hero-btn" style="padding:15px 40px; font-size:16px;">生成时间表</button>
    </div>
</dialog>

<dialog id="settings-modal">
    <h3>系统设置</h3>
    <label style="font-size:12px; font-weight:700; color:#5f6368;">API Key</label>
    <input type="password" id="api-key" class="chat-input" style="width:100%; margin:8px 0 20px 0;">
    
    <label style="font-size:12px; font-weight:700; color:#5f6368;">Model Provider</label>
    <select id="model-select" class="chat-input" style="width:100%; margin-bottom:20px;">
        <option value="deepseek">Deepseek V3</option>
        <option value="qwen">Qwen (Aliyun)</option>
    </select>
    
    <label style="font-size:12px; font-weight:700; color:#5f6368;">TTS Voice (English)</label>
    <div style="display:flex; gap:10px; margin-top:8px;">
        <select id="voice-select" class="chat-input"></select>
        <button onclick="testVoice()" style="padding:0 20px; border:1px solid #c4c7c5; border-radius:24px; background:white; cursor:pointer; font-weight:600;">Test</button>
    </div>

    <div style="text-align:right; margin-top:30px;">
        <button onclick="saveSettings()" style="background:var(--blue); color:white; border:none; padding:12px 30px; border-radius:24px; cursor:pointer; font-weight:600;">保存设置</button>
    </div>
</dialog>

<script>
    /* =========================================
       1. DATA & STATE
       ========================================= */
    const SUBJECTS = ["Math (0580)", "Add Math (0606)", "Biology (0610)", "Chemistry (0620)", "Physics (0625)"];
    
    const STATE = {
        schedule: JSON.parse(localStorage.getItem('jack_v1_sched')) || [],
        backlog: JSON.parse(localStorage.getItem('jack_v1_backlog')) || [],
        apiKey: localStorage.getItem('jack_v1_key') || '',
        provider: localStorage.getItem('jack_v1_provider') || 'deepseek',
        voiceUri: localStorage.getItem('jack_v1_voice') || '',
        
        // Runtime States
        lastEventTime: 0,
        bufferAlerted: false,
        activeTaskIdx: -1
    };

    /* =========================================
       2. INIT & CROSS-CHECK
       ========================================= */
    window.onload = () => {
        if (!navigator.userAgent.includes("Edg")) document.getElementById('edge-check').style.display = 'flex';
        loadVoices();
        
        setInterval(updateClock, 1000);
        setInterval(engineTick, 1000); // The Heartbeat

        // Load Settings
        document.getElementById('api-key').value = STATE.apiKey;
        document.getElementById('model-select').value = STATE.provider;

        // Restore View
        if(STATE.schedule.length > 0) {
            switchView('active');
            renderTable();
        } else {
            checkBacklog();
        }

        document.getElementById('user-msg').addEventListener('keypress', (e) => { if(e.key==='Enter') sendMsg(); });
    };

    function updateClock() {
        document.getElementById('clock-display').innerText = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
    }

    function checkBacklog() {
        if(STATE.backlog.length > 0) {
            const alertBox = document.getElementById('backlog-alert');
            alertBox.style.display = 'flex';
            document.getElementById('backlog-text').innerText = `检测到 ${STATE.backlog.length} 个未完成任务 (Debt). 将被强制安排。`;
            addBubble(`Warning. You have ${STATE.backlog.length} unfinished tasks from previous days. They will be prioritized.`, 'ai');
        }
    }

    function getStudyPlanProgress(subject) {
        // Read from StudyPlanV1.0.html LocalStorage
        const spData = localStorage.getItem('caie_progress_v2_1');
        if(!spData) return false; // No data found
        const db = JSON.parse(spData);
        
        // Check if ANY unit is done for this subject
        // Key format: "Subject|Unit|FINAL|unit_done"
        const keys = Object.keys(db);
        const hasProgress = keys.some(k => k.startsWith(subject) && k.includes('FINAL|unit_done') && db[k] === true);
        
        return hasProgress;
    }

    /* =========================================
       3. GENERATION & LOGIC
       ========================================= */
    function openMatrixSelector() {
        if(!STATE.apiKey) return openSettings();
        const box = document.getElementById('matrix-rows');
        box.innerHTML = '';
        
        SUBJECTS.forEach((sub, i) => {
            // Check Progress Lock
            const hasNotes = getStudyPlanProgress(sub);
            
            box.innerHTML += `
                <div class="matrix-row">
                    <div>${sub}</div>
                    <div style="text-align:center;"><input type="checkbox" id="xn-${i}"></div>
                    <div style="text-align:center;">
                        <input type="checkbox" id="mt-${i}" ${hasNotes ? '' : 'disabled'} onchange="checkMockLock('${sub}', this)">
                        ${hasNotes ? '' : '<span style="font-size:10px; color:red; display:block;">Locked</span>'}
                    </div>
                </div>`;
        });
        document.getElementById('matrix-modal').showModal();
    }

    function checkMockLock(sub, el) {
        if(el.checked && !getStudyPlanProgress(sub)) {
            el.checked = false;
            alert(`Permission Denied: Finish ZNotes for ${sub} in StudyPlan first.`);
        }
    }

    async function confirmMatrix() {
        let pool = [...STATE.backlog]; // Add debt first
        
        // Mandatory
        if(!pool.includes("IELTS Lessons")) pool.push("IELTS Lessons");
        if(!pool.includes("Vocab")) pool.push("Vocab (15min)");
        if(!pool.includes("Summer Homework")) pool.push("Summer Homework (1h)");

        // Matrix Selection
        SUBJECTS.forEach((sub, i) => {
            if(document.getElementById(`xn-${i}`).checked) pool.push(`XNotes: ${sub}`);
            if(document.getElementById(`mt-${i}`).checked) pool.push(`Mock Test: ${sub}`);
        });
        if(document.getElementById('chk-python').checked) pool.push("CS50P Python");
        if(document.getElementById('chk-piano').checked) pool.push("Piano Practice");

        document.getElementById('matrix-modal').close();
        addBubble("Analyzing workload... Enforcing split rules...", 'ai');

        const prompt = `
        Role: AI Warden (Strict).
        Time: 10:30 - 22:30. Fixed Meals: 12:00-13:00, 18:00-19:00.
        Tasks: ${JSON.stringify(pool)}.
        
        RULES:
        1. IGCSE Subjects > 3 Hours total.
        2. SPLIT RULE: If a task > 45 mins (like Mock Exam or Long Study), DO NOT schedule a single block. 
           - Schedule "Task Part 1 (45m)" -> "Deep Break (30m)" -> "Task Part 2 (45m)".
           - This is mandatory to prevent burnout.
        3. Backlog items (Debt) must be scheduled first.
        4. Mock Test (if present) must be split into two 45m sessions with break.
        5. Output JSON: [{"start":"HH:MM", "end":"HH:MM", "task":"Name", "type":"study|break|meal"}]
        `;

        try {
            const json = await callLLM(prompt, true);
            const sched = JSON.parse(json);
            STATE.schedule = sched.map(s => ({...s, done: false}));
            
            // Clear backlog after scheduling
            STATE.backlog = []; 
            localStorage.setItem('jack_v1_backlog', JSON.stringify([]));
            localStorage.setItem('jack_v1_sched', JSON.stringify(STATE.schedule));
            
            switchView('active');
            renderTable();
            speak("Schedule locked. Long tasks have been split. Proceed.", "时间表已锁定。长任务已拆分。执行。");

        } catch(e) {
            addBubble("Error: " + e.message, 'system');
        }
    }

    /* =========================================
       4. THE HEARTBEAT (Engine)
       ========================================= */
    function engineTick() {
        if(STATE.schedule.length === 0) return;
        const now = new Date();
        const curM = now.getHours() * 60 + now.getMinutes();
        
        let active = null;
        let next = null;
        let idx = -1;

        for(let i=0; i<STATE.schedule.length; i++) {
            const s = STATE.schedule[i];
            const start = t2m(s.start);
            const end = t2m(s.end);

            // BUFFER ZONE LOGIC (10 mins before study)
            if(s.type === 'study' && !s.done && curM >= start - 10 && curM < start) {
                // Trigger Once
                if(STATE.activeTaskIdx !== -99) { // -99 indicates buffer state
                    STATE.activeTaskIdx = -99;
                    speak(`Warning. The next mission is ${s.task}. Ten minutes to drop your phone.`, "警告。下一个任务即将开始。放下手机。");
                }
                updateUI("PREPARE: " + s.task, start*60 - (curM*60 + now.getSeconds()), 600, true, s.type);
                return;
            }

            // ACTIVE TASK
            if(curM >= start && curM < end) {
                active = s;
                idx = i;
                if(STATE.schedule[i+1]) next = STATE.schedule[i+1];
                
                // Trigger Start
                if(STATE.activeTaskIdx !== i) {
                    STATE.activeTaskIdx = i;
                    speak(`Mission Start: ${s.task}. Focus mode engaged.`, "任务开始。专注模式启动。");
                }
                break;
            }
        }

        if(active) {
            const start = t2m(active.start);
            const end = t2m(active.end);
            updateUI(active.task, end*60 - (curM*60 + now.getSeconds()), (end-start)*60, false, active.type);
            highlightRow(idx);
            document.getElementById('next-task-display').innerText = next ? `Next: ${next.task} (${next.start})` : "Next: End of Day";
        } else {
            document.getElementById('timer-display').innerText = "--:--";
            document.getElementById('timer-label').innerText = "NO ACTIVE TASK";
            document.getElementById('main-card').classList.remove('buffer-mode');
        }
    }

    function updateUI(label, secs, total, isBuf, type) {
        const m = Math.floor(secs/60).toString().padStart(2,'0');
        const s = (secs%60).toString().padStart(2,'0');
        document.getElementById('timer-display').innerText = `${m}:${s}`;
        document.getElementById('timer-label').innerText = label;
        
        const card = document.getElementById('main-card');
        const bar = document.getElementById('progress-bar');
        const badge = document.getElementById('buffer-badge');
        
        bar.style.width = ((total-secs)/total)*100 + "%";
        
        if(isBuf) {
            card.classList.add('buffer-mode');
            badge.style.display = 'inline-block';
            bar.style.background = "var(--yellow)";
        } else {
            card.classList.remove('buffer-mode');
            badge.style.display = 'none';
            bar.style.background = type === 'study' ? "var(--blue)" : "var(--green)";
        }
    }

    /* =========================================
       5. CHAT & PROTOCOL
       ========================================= */
    async function sendMsg() {
        const txt = document.getElementById('user-msg').value.trim();
        if(!txt) return;
        addBubble(txt, 'user');
        document.getElementById('user-msg').value = '';

        const prompt = `
        Context: Jack's Schedule (JSON): ${JSON.stringify(STATE.schedule)}.
        User Request: "${txt}"
        
        PROTOCOL:
        1. Reply in Chinese.
        2. Tag [TTS: "English" | "Chinese"].
        3. IF cancelling task: Output [BACKLOG: TaskName] and [REGENERATE].
        4. IF swapping time: Output [REGENERATE: JSON].
        5. IF Denied: Output [DENY].
        `;

        try {
            const res = await callLLM(prompt, false);
            let clean = res;

            // Backlog Logic
            const blM = res.match(/\[BACKLOG:\s*(.*?)\]/);
            if(blM) {
                STATE.backlog.push(blM[1]);
                localStorage.setItem('jack_v1_backlog', JSON.stringify(STATE.backlog));
                clean = clean.replace(blM[0], '');
                speak("Task moved to backlog. You cannot escape.", "任务已记入黑账。你逃不掉的。");
            }

            // TTS Parse
            const ttsM = res.match(/\[TTS:\s*"(.*?)"\s*\|\s*"(.*?)"\]/);
            if(ttsM) {
                speak(ttsM[1], ttsM[2]);
                clean = clean.replace(ttsM[0], '');
            }

            // Regenerate
            const regenM = res.match(/\[REGENERATE:\s*(\[.*?\])\]/s);
            if(regenM) {
                try {
                    STATE.schedule = JSON.parse(regenM[1]);
                    localStorage.setItem('jack_v1_sched', JSON.stringify(STATE.schedule));
                    renderTable();
                    clean = clean.replace(regenM[0], '');
                } catch(e){}
            }

            addBubble(clean, 'ai');

        } catch(e) {
            addBubble("Error: " + e.message, 'system');
        }
    }

    /* =========================================
       6. UTILS
       ========================================= */
    function finishTaskEarly() {
        // ... Logic to mark done ...
        // In V1.0, we just mark current active as done
        if(STATE.activeTaskIdx >= 0 && STATE.schedule[STATE.activeTaskIdx]) {
            STATE.schedule[STATE.activeTaskIdx].done = true;
            STATE.schedule[STATE.activeTaskIdx].type = 'break'; // Convert remainder to break
            STATE.schedule[STATE.activeTaskIdx].task += " (Done)";
            localStorage.setItem('jack_v1_sched', JSON.stringify(STATE.schedule));
            renderTable();
            speak("Task complete. Enjoy the break.", "任务完成。休息一下。");
        }
    }

    async function callLLM(prompt, jsonMode) {
        const url = STATE.provider === 'deepseek' ? 'https://api.deepseek.com/chat/completions' : 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
        const res = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${STATE.apiKey}`},
            body: JSON.stringify({
                model: STATE.provider === 'deepseek' ? 'deepseek-chat' : 'qwen-plus',
                messages: [{role: "system", content: prompt}],
                temperature: 0.7
            })
        });
        const d = await res.json();
        let c = d.choices[0].message.content;
        return jsonMode ? c.replace(/```json|```/g, '').trim() : c;
    }

    function speak(en, zh) {
        window.speechSynthesis.cancel();
        
        const box = document.getElementById('subtitle-box');
        document.getElementById('sub-en').innerText = en;
        document.getElementById('sub-zh').innerText = zh;
        box.style.display = 'block';

        const u = new SpeechSynthesisUtterance(en);
        u.lang = 'en-US';
        u.rate = 1.1;
        
        const voices = window.speechSynthesis.getVoices();
        const selVal = document.getElementById('voice-select').value;
        let v = voices.find(v => v.voiceURI === selVal) || voices.find(v => v.voiceURI === STATE.voiceUri);
        if(v) u.voice = v;

        u.onend = () => setTimeout(() => box.style.display='none', 3000);
        window.speechSynthesis.speak(u);
    }

    function loadVoices() {
        window.speechSynthesis.onvoiceschanged = () => {
            const sel = document.getElementById('voice-select');
            sel.innerHTML = '';
            const voices = window.speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
            voices.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.voiceURI;
                opt.innerText = v.name;
                sel.appendChild(opt);
            });
            if(STATE.voiceUri) sel.value = STATE.voiceUri;
        };
    }

    function testVoice() {
        STATE.voiceUri = document.getElementById('voice-select').value;
        speak("Voice system verified. Warden is listening.", "语音系统已验证。");
    }

    function t2m(t) { const [h,m]=t.split(':').map(Number); return h*60+m; }
    function renderTable() {
        const b = document.getElementById('schedule-body'); b.innerHTML='';
        STATE.schedule.forEach((s,i) => {
            b.innerHTML += `<tr id="row-${i}" class="row-${s.type} ${s.done?'row-done':''}"><td>${s.start}-${s.end}</td><td>${s.task}</td><td>${s.type.toUpperCase()}</td></tr>`;
        });
    }
    function highlightRow(i) {
        document.querySelectorAll('tbody tr').forEach(t=>t.classList.remove('row-active'));
        if(i>=0) document.getElementById(`row-${i}`).classList.add('row-active');
    }
    function addBubble(t,c) {
        const d=document.createElement('div'); d.className=`bubble ${c}`; d.innerText=t;
        const h=document.getElementById('chat-history'); h.appendChild(d); h.scrollTop=h.scrollHeight;
    }
    function switchView(view) {
        document.getElementById('view-generator').style.display = view === 'generator' ? 'flex' : 'none';
        document.getElementById('view-active').style.display = view === 'active' ? 'block' : 'none';
    }
    function saveSettings() {
        STATE.apiKey = document.getElementById('api-key').value;
        STATE.provider = document.getElementById('model-select').value;
        STATE.voiceUri = document.getElementById('voice-select').value;
        localStorage.setItem('jack_v1_key', STATE.apiKey);
        localStorage.setItem('jack_v1_provider', STATE.provider);
        localStorage.setItem('jack_v1_voice', STATE.voiceUri);
        document.getElementById('settings-modal').close();
    }
    function openSettings() { document.getElementById('settings-modal').showModal(); }

</script>
</body>
</html>
