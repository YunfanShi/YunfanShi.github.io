<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>30+ Time Source Diagnostic Tool</title>
    <style>
        :root { --bg: #0f172a; --surface: #1e293b; --border: #334155; --text: #f8fafc; --success: #10b981; --error: #ef4444; --warn: #f59e0b; }
        body { background: var(--bg); color: var(--text); font-family: 'Consolas', monospace; padding: 20px; font-size: 13px; }
        h2 { color: var(--success); border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
        
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 15px; position: relative; overflow: hidden; }
        .card h3 { margin: 0 0 5px 0; font-size: 14px; color: #cbd5e1; display: flex; justify-content: space-between; }
        .card .type-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #334155; }
        
        .stat-row { display: flex; justify-content: space-between; margin-top: 8px; color: #94a3b8; font-size: 12px; }
        .stat-val { font-weight: bold; color: var(--text); }
        
        .status-bar { height: 4px; background: #334155; margin-top: 10px; border-radius: 2px; overflow: hidden; }
        .status-fill { height: 100%; width: 0%; transition: 0.3s; }
        
        .card.success { border-color: var(--success); }
        .card.success .status-fill { background: var(--success); width: 100%; }
        
        .card.fail { border-color: var(--error); opacity: 0.7; }
        .card.fail .status-fill { background: var(--error); width: 100%; }
        
        .card.ntp { border-color: var(--warn); border-style: dashed; opacity: 0.5; }
        
        .btn { cursor: pointer; background: var(--success); color: #000; border: none; padding: 5px 10px; border-radius: 4px; font-weight: bold; }
        .btn:disabled { background: #555; cursor: not-allowed; }
        
        .err-msg { color: var(--error); font-size: 10px; margin-top: 5px; height: 15px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    </style>
</head>
<body>

    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h2>å…¨ç½‘æ—¶é—´æ¥å£è¿é€šæ€§æµ‹è¯• (30 Sources)</h2>
            <p style="color:#94a3b8; font-size:12px;">
                æ³¨æ„ï¼šçº¢è‰²æŠ¥é”™é€šå¸¸æ˜¯å› ä¸ºæµè§ˆå™¨çš„ <b>CORS åŒæºç­–ç•¥</b> æ‹¦æˆªï¼Œå¹¶éæ¥å£æŒ‚äº†ã€‚<br>
                è¦åœ¨é¡¹ç›®é‡Œç”¨ï¼Œ<b>è¯·åªé€‰æ‹©ç»¿è‰²çš„æ¥å£</b>ã€‚
            </p>
        </div>
        <button onclick="testAll()" class="btn" style="height:40px; padding:0 20px;">ğŸš€ å…¨éƒ¨æµ‹è¯•</button>
    </div>

    <div id="container" class="grid"></div>

<script>
    // === æ ¸å¿ƒæ•°æ®æº ===
    const SOURCES = [
        // --- 1. JSONP (æœ€å¼ºæ¨è) ---
        { name: "Taobao (æ·˜å®)", url: "https://api.m.taobao.com/rest/api3.do?api=mtop.common.getTimestamp", type: "JSONP", parser: "taobao" },
        { name: "Suning (è‹å®)", url: "https://f.m.suning.com/api/ct.do", type: "JSONP", parser: "suning" },

        // --- 2. è¿™é‡Œçš„æ ‡å‡† API (æµè§ˆå™¨å¯èƒ½èƒ½é€š) ---
        { name: "WorldTimeAPI", url: "http://worldtimeapi.org/api/timezone/Asia/Shanghai", type: "FETCH_JSON", field: "datetime" },
        { name: "TimeAPI.io", url: "https://timeapi.io/api/Time/current/zone?timeZone=Asia/Shanghai", type: "FETCH_JSON", field: "dateTime" },
        { name: "Bilibili API", url: "https://api.bilibili.com/x/report/click/now", type: "FETCH_JSON", field: "data.now", note: "May block CORS" },
        
        // --- 3. è¿™é‡Œçš„ HEAD è¯·æ±‚ (åˆ©ç”¨ HTTP Date å¤´) ---
        // æ³¨æ„ï¼šè¿™äº›é€šå¸¸ä¼šè¢« CORS æ‹¦æˆªï¼Œé™¤éç›®æ ‡æœåŠ¡å™¨å…è®¸ Access-Control-Allow-Origin: *
        { name: "Baidu (HEAD)", url: "https://www.baidu.com", type: "HEAD" },
        { name: "Tencent (HEAD)", url: "https://www.qq.com", type: "HEAD" },
        { name: "Aliyun (HEAD)", url: "https://www.aliyun.com", type: "HEAD" },
        { name: "Huawei Cloud", url: "https://www.huaweicloud.com", type: "HEAD" },
        { name: "JD.com (HEAD)", url: "https://www.jd.com", type: "HEAD" },
        { name: "Zhihu (HEAD)", url: "https://www.zhihu.com", type: "HEAD" },
        { name: "Github (HEAD)", url: "https://github.com", type: "HEAD" },
        { name: "Apple (CN)", url: "https://www.apple.com.cn", type: "HEAD" },
        { name: "Microsoft", url: "https://www.microsoft.com", type: "HEAD" },
        { name: "Google", url: "https://www.google.com", type: "HEAD" },
        { name: "Cloudflare", url: "https://www.cloudflare.com", type: "HEAD" },
        { name: "Bilibili (Main)", url: "https://www.bilibili.com", type: "HEAD" },
        { name: "163 (NetEase)", url: "https://www.163.com", type: "HEAD" },
        { name: "Sina (New)", url: "https://www.sina.com.cn", type: "HEAD" },
        { name: "Douyin", url: "https://www.douyin.com", type: "HEAD" },
        { name: "Weibo", url: "https://weibo.com", type: "HEAD" },
        { name: "CCTV", url: "https://www.cctv.com", type: "HEAD" },
        { name: "CSDN", url: "https://www.csdn.net", type: "HEAD" },
        
        // --- 4. NTP (æµè§ˆå™¨ä¸å¯ç”¨ï¼Œä»…å±•ç¤º) ---
        { name: "Aliyun NTP", url: "ntp.aliyun.com", type: "NTP" },
        { name: "Tencent NTP", url: "ntp.tencent.com", type: "NTP" },
        { name: "NTSC (å›½å®¶æˆæ—¶)", url: "ntp.ntsc.ac.cn", type: "NTP" },
        { name: "Edu NTP", url: "time.edu.cn", type: "NTP" },
        { name: "Google NTP", url: "time.google.com", type: "NTP" },
        { name: "Apple NTP", url: "time.apple.com", type: "NTP" },
        { name: "Windows NTP", url: "time.windows.com", type: "NTP" },
    ];

    // === æ¸²æŸ“ç•Œé¢ ===
    const container = document.getElementById('container');
    SOURCES.forEach((src, index) => {
        const div = document.createElement('div');
        div.className = `card ${src.type === 'NTP' ? 'ntp' : ''}`;
        div.id = `card-${index}`;
        div.innerHTML = `
            <h3>
                ${src.name}
                <span class="type-tag">${src.type}</span>
            </h3>
            <div class="stat-row">
                <span>RTT:</span>
                <span class="stat-val" id="rtt-${index}">--</span>
            </div>
            <div class="stat-row">
                <span>Offset:</span>
                <span class="stat-val" id="off-${index}">--</span>
            </div>
            <div class="err-msg" id="err-${index}"></div>
            <div class="status-bar"><div class="status-fill" id="fill-${index}"></div></div>
            ${src.type !== 'NTP' ? `<button onclick="runTest(${index})" class="btn" style="margin-top:10px; width:100%; font-size:11px;">Test</button>` : '<div style="margin-top:10px; font-size:10px; text-align:center; color:#666">Browser Incompatible</div>'}
        `;
        container.appendChild(div);
    });

    // === æµ‹è¯•é€»è¾‘ ===
    async function runTest(idx) {
        const src = SOURCES[idx];
        const card = document.getElementById(`card-${idx}`);
        const rttEl = document.getElementById(`rtt-${idx}`);
        const offEl = document.getElementById(`off-${idx}`);
        const errEl = document.getElementById(`err-${idx}`);
        
        // Reset UI
        card.className = "card";
        errEl.innerText = "Testing...";
        rttEl.innerText = "...";
        
        const t0 = performance.now();
        const nowLocal = Date.now();

        try {
            let serverTime = 0;

            // 1. JSONP é€»è¾‘ (é’ˆå¯¹æ·˜å®/è‹å®)
            if (src.type === 'JSONP') {
                serverTime = await jsonpFetch(src);
            } 
            // 2. Fetch JSON é€»è¾‘
            else if (src.type === 'FETCH_JSON') {
                const res = await fetch(src.url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                
                if (src.name.includes("WorldTime")) serverTime = new Date(data.datetime).getTime();
                else if (src.name.includes("TimeAPI")) serverTime = new Date(data.dateTime).getTime();
                else if (src.name.includes("Bilibili")) serverTime = data.data.now * 1000;
            }
            // 3. HEAD é€»è¾‘ (æŠ“å– Date å¤´)
            else if (src.type === 'HEAD') {
                // æ³¨æ„ï¼šè¿™é‡Œå¤§å¤šæ•°ä¼šå› ä¸º CORS å¤±è´¥ï¼Œè¿™æ˜¯é¢„æœŸå†…çš„
                const res = await fetch(src.url, { method: 'HEAD', cache: 'no-store' });
                const dateHeader = res.headers.get('date');
                if (!dateHeader) throw new Error("No Date Header (CORS Blocked?)");
                serverTime = new Date(dateHeader).getTime();
            }

            // è®¡ç®—ç»“æœ
            const tEnd = performance.now();
            const rtt = tEnd - t0;
            const correctedServer = serverTime + (rtt / 2);
            const offset = correctedServer - (nowLocal + rtt); // ç®€å•ä¼°ç®—

            // æ›´æ–° UI - æˆåŠŸ
            card.classList.add('success');
            rttEl.innerText = rtt.toFixed(0) + " ms";
            offEl.innerText = offset.toFixed(0) + " ms";
            errEl.innerText = "";

        } catch (e) {
            // æ›´æ–° UI - å¤±è´¥
            card.classList.add('fail');
            rttEl.innerText = "Err";
            offEl.innerText = "Err";
            
            if (e.message.includes('Failed to fetch')) {
                errEl.innerText = "CORS blocked (Security)";
            } else {
                errEl.innerText = e.message;
            }
        }
    }

    function jsonpFetch(src) {
        return new Promise((resolve, reject) => {
            const cbName = 'cb_' + Math.random().toString(36).substr(2,9);
            const script = document.createElement('script');
            
            window[cbName] = (data) => {
                let time = 0;
                if (src.parser === 'taobao') time = parseInt(data.data.t);
                if (src.parser === 'suning') time = data.currentTime;
                cleanup();
                resolve(time);
            };

            function cleanup() {
                delete window[cbName];
                script.remove();
            }

            script.src = `${src.url}${src.url.includes('?') ? '&' : '?'}callback=${cbName}`;
            script.onerror = () => { cleanup(); reject(new Error("JSONP Load Failed")); };
            document.head.appendChild(script);
        });
    }

    async function testAll() {
        for (let i = 0; i < SOURCES.length; i++) {
            if (SOURCES[i].type !== 'NTP') {
                runTest(i);
                // ç¨å¾®é—´éš”ä¸€ä¸‹ï¼Œé˜²æ­¢å¹¶å‘è¯·æ±‚æŠŠç½‘ç»œå µæ­»å¯¼è‡´ RTT è™šé«˜
                await new Promise(r => setTimeout(r, 200)); 
            }
        }
    }
</script>

</body>
</html>
