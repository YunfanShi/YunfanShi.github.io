<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jack's Warden: Mock Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1A73E8',
            success: '#34A853',
            warning: '#FBBC04',
            danger: '#EA4335',
          }
        }
      }
    };
  </script>
  <style>
    :root {
      --primary: #1A73E8;
      --success: #34A853;
      --warning: #FBBC04;
      --danger: #EA4335;
      --text-main: #202124;
      --text-sub: #5F6368;
      --bg: #F8F9FA;
      --border: #E8EAED;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', 'Roboto', sans-serif;
      background: var(--bg);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .mi { font-family: 'Material Icons Round'; font-style: normal; font-size: 20px;
      line-height: 1; vertical-align: middle; display: inline-block; }

    /* Filter chips */
    .fchip {
      display: inline-flex; align-items: center; gap: 3px;
      padding: 3px 10px; border-radius: 20px; font-size: 12px;
      cursor: pointer; border: 1.5px solid var(--border);
      background: white; color: var(--text-sub);
      transition: all 0.15s ease; user-select: none; white-space: nowrap;
    }
    .fchip:hover { border-color: var(--primary); color: var(--primary); }
    .fchip.on { border-color: var(--primary); background: #E8F0FE; color: var(--primary); font-weight: 600; }

    /* Paper card */
    .pcard {
      background: white; border-radius: 16px;
      border: 2px solid transparent;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08);
      transition: all 0.2s ease; cursor: pointer; position: relative; overflow: hidden;
    }
    .pcard:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.13), 0 4px 8px rgba(0,0,0,0.08); }
    .pcard.sel { border-color: var(--primary) !important; background: #F0F4FF; }
    .pcard.done { border-left: 4px solid var(--success) !important; opacity: 0.88; }
    .pcard.inprog { border-left: 4px solid var(--warning) !important; }

    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 4px;
      padding: 7px 18px; border-radius: 24px; font-size: 13px; font-weight: 500;
      cursor: pointer; border: none; transition: all 0.18s ease;
      user-select: none; font-family: inherit; outline: none; line-height: 1.4;
    }
    .btn:hover { filter: brightness(0.93); transform: translateY(-1px); }
    .btn:active { transform: translateY(0); filter: brightness(0.87); }
    .btn-p { background: var(--primary); color: white; }
    .btn-s { background: var(--success); color: white; }
    .btn-d { background: var(--danger); color: white; }
    .btn-o { background: transparent; border: 1.5px solid var(--border); color: var(--text-sub); }
    .btn-o:hover { border-color: var(--primary); color: var(--primary); background: #E8F0FE; filter: none; transform: none; }
    .btn-g { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .btn:disabled { opacity: 0.45; cursor: not-allowed; pointer-events: none; }

    /* Cart bar */
    #cartBar {
      backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
      background: rgba(255,255,255,0.93);
      border-top: 1px solid rgba(0,0,0,0.07);
      box-shadow: 0 -2px 14px rgba(0,0,0,0.09);
    }
    /* Cart panel */
    #cartPanel {
      position: fixed; bottom: 64px; left: 0; right: 0;
      max-height: 440px; background: white;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -4px 28px rgba(0,0,0,0.15);
      transform: translateY(100%);
      transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
      z-index: 45; overflow: hidden;
    }
    #cartPanel.open { transform: translateY(0); }

    /* Modal */
    .mbg { background: rgba(0,0,0,0.52); backdrop-filter: blur(5px); }

    /* Settings drawer */
    #settingsDr {
      box-shadow: -6px 0 28px rgba(0,0,0,0.16);
      transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
      transform: translateX(100%);
    }
    #settingsDr.open { transform: translateX(0); }

    /* Exam overlay */
    #examOv { background: #0A0A1E; }

    /* Timer */
    .timer-num {
      font-family: 'Roboto Mono', monospace;
      font-size: clamp(80px, 15vw, 160px);
      font-weight: 700; letter-spacing: -0.02em; line-height: 1;
      color: white;
    }
    .timer-warn { color: #F87171 !important; animation: twarn 1s ease-in-out infinite; }
    @keyframes twarn { 0%,100%{opacity:1}50%{opacity:.55} }

    .exam-prog { height: 6px; border-radius: 3px; background: rgba(255,255,255,0.14); overflow: hidden; }
    .exam-prog-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg,#4ade80,#22d3ee,#818cf8); transition: width 1s linear; }

    .wm {
      position: fixed; bottom: 36px; right: 36px;
      font-family: 'Roboto Mono', monospace; font-size: 13px;
      letter-spacing: .14em; opacity: .11; user-select: none;
      pointer-events: none; color: white;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #DADCE0; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #BDC1C6; }

    /* Drag items */
    .cart-row { transition: all 0.15s ease; cursor: grab; }
    .cart-row:active { cursor: grabbing; }
    .cart-row.dragging { opacity: .4; transform: scale(.97); }
    .cart-row.dragover { border-top: 2px solid var(--primary); }

    /* Toast */
    #toast {
      position: fixed; bottom: 88px; left: 50%;
      transform: translateX(-50%) translateY(24px);
      background: #323232; color: white; padding: 10px 20px;
      border-radius: 24px; font-size: 13px; z-index: 400;
      transition: transform 0.28s ease, opacity 0.28s ease;
      opacity: 0; pointer-events: none; white-space: nowrap;
      max-width: 90vw; overflow: hidden; text-overflow: ellipsis;
    }
    #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* Filter section */
    #filterPanel { border-right: 1px solid var(--border); }
    .fsec-hdr { cursor: pointer; user-select: none; transition: background .15s; }
    .fsec-hdr:hover { background: #F8F9FA; }
    .fsec-body { overflow: hidden; transition: max-height 0.3s ease; }

    /* AppBar */
    #appbar { transition: box-shadow 0.3s ease; }
    #appbar.scrolled { box-shadow: 0 4px 12px rgba(0,0,0,0.12); }

    /* Lock box */
    .lock-box { background: white; border: 2px dashed var(--border); border-radius: 16px; padding: 32px; text-align: center; }

    /* Gacha */
    #gachaScroller { height: 68px; overflow: hidden; position: relative; border-radius: 12px; }
    #gachaTrack { position: absolute; width: 100%; transition: transform 2s cubic-bezier(0.25,0.1,0.25,1); }

    /* Summary bar */
    .sum-bar { height: 28px; border-radius: 6px; transition: width .7s ease; min-width: 4px; }

    /* Toggle switch */
    .tgl { width: 44px; height: 24px; border-radius: 12px; background: #DADCE0;
      position: relative; cursor: pointer; transition: background .2s; flex-shrink: 0; }
    .tgl.on { background: var(--primary); }
    .tgl::after { content:''; position:absolute; top:2px; left:2px; width:20px; height:20px;
      border-radius:50%; background:white; box-shadow:0 1px 3px rgba(0,0,0,.2); transition:transform .2s; }
    .tgl.on::after { transform: translateX(20px); }

    /* Mobile */
    @media(max-width:767px) {
      #filterPanel { display: none; }
      #mainContent { margin-left: 0 !important; }
      #mobileFilterBtn { display: flex !important; }
    }

    /* Chip count badge */
    .cbadge { background:#E8EAED; color:var(--text-sub); font-size:10px;
      padding:0 5px; border-radius:10px; font-weight:600; }
    .fchip.on .cbadge { background:rgba(26,115,232,.18); color:var(--primary); }

    /* Gacha count btn */
    .gcnt { width:40px;height:40px;border-radius:12px;border:2px solid var(--border);
      font-weight:700;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;
      font-size:15px;color:var(--text-sub);background:white;font-family:inherit;
    }
    .gcnt.on { border-color:var(--primary);background:var(--primary);color:white; }
    .gcnt:hover { border-color:var(--primary);color:var(--primary); }
    .gcnt.on:hover { color:white; }

    /* Warning banner */
    #warnBanner {
      position:fixed;top:0;left:0;right:0;z-index:200;
      background:#EA4335;color:white;text-align:center;
      padding:10px;font-weight:600;font-size:14px;
      transform:translateY(-100%);transition:transform .3s ease;
    }
    #warnBanner.show { transform:translateY(0); }

    /* Status bar */
    .sbar { height:4px;border-radius:2px;background:#E8EAED;overflow:hidden; }
    .sbar-fill { height:100%;border-radius:2px;transition:width .3s ease; }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header id="appbar" class="fixed top-0 left-0 right-0 z-50 bg-white h-14 flex items-center px-4 gap-3 select-none" style="box-shadow:0 1px 3px rgba(0,0,0,0.12)">
  <span class="mi" style="color:var(--primary);font-size:24px">bolt</span>
  <span class="font-bold text-base" style="color:#202124;letter-spacing:-.3px">Warden Mock</span>
  <div style="flex:1"></div>
  <span id="dateDisp" class="text-xs hidden sm:block" style="color:var(--text-sub)"></span>
  <!-- Circular progress -->
  <div class="relative cursor-pointer" style="width:34px;height:34px" id="progWrap" title="å®Œæˆè¿›åº¦">
    <svg viewBox="0 0 36 36" style="width:34px;height:34px;transform:rotate(-90deg)">
      <circle cx="18" cy="18" r="15.9" fill="none" stroke="#E8EAED" stroke-width="3"/>
      <circle id="progArc" cx="18" cy="18" r="15.9" fill="none" stroke="var(--primary)" stroke-width="3" stroke-dasharray="0 100" stroke-linecap="round" style="transition:stroke-dasharray .5s ease"/>
    </svg>
    <span id="progPct" class="absolute inset-0 flex items-center justify-center font-bold" style="font-size:8px;color:var(--primary)">0%</span>
  </div>
  <button onclick="openSettings()" class="p-2 rounded-full transition-colors hover:bg-gray-100" title="è®¾ç½®" style="border:none;background:transparent;cursor:pointer">
    <span class="mi" style="color:#5F6368">settings</span>
  </button>
  <button id="mobileFilterBtn" onclick="openMobileFilter()" class="p-2 rounded-full transition-colors hover:bg-gray-100" style="display:none;border:none;background:transparent;cursor:pointer" title="ç­›é€‰">
    <span class="mi" style="color:#5F6368">filter_list</span>
  </button>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FILTER PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<aside id="filterPanel" class="fixed left-0 top-14 bottom-0 bg-white z-40 overflow-y-auto" style="width:260px">
  <div class="sticky top-0 bg-white z-10 p-3" style="border-bottom:1px solid var(--border)">
    <button onclick="clearFilters()" class="btn btn-o w-full text-xs" style="padding:7px 10px">
      <span class="mi" style="font-size:16px">clear_all</span> æ¸…é™¤æ‰€æœ‰ç­›é€‰
    </button>
  </div>
  <div id="filterSections"></div>
</aside>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN CONTENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<main id="mainContent" class="pt-14" style="margin-left:260px;padding-bottom:100px">
  <div class="p-4">
    <!-- Action bar -->
    <div class="flex items-center flex-wrap gap-2 mb-4 px-4 py-3 bg-white rounded-2xl" style="box-shadow:0 1px 3px rgba(0,0,0,0.12)">
      <span id="filterCount" class="text-sm font-medium" style="color:#202124">ç­›é€‰åˆ° 0 å¼ å·å­</span>
      <div style="flex:1"></div>
      <select id="sortSel" onchange="applyFilters()" class="text-xs bg-white rounded-xl cursor-pointer focus:outline-none" style="border:1.5px solid var(--border);padding:6px 10px;color:var(--text-sub)">
        <option value="year-desc">å¹´ä»½ â†“ æœ€æ–°</option>
        <option value="year-asc">å¹´ä»½ â†‘ æœ€æ—©</option>
        <option value="dur-asc">æ—¶é•¿ â†‘ çŸ­â†’é•¿</option>
        <option value="dur-desc">æ—¶é•¿ â†“ é•¿â†’çŸ­</option>
        <option value="subj">æŒ‰ç§‘ç›®æ’åº</option>
      </select>
      <button onclick="selectAll()" class="btn btn-o text-xs" style="padding:6px 12px">å…¨é€‰</button>
      <button onclick="invertSel()" class="btn btn-o text-xs" style="padding:6px 12px">åé€‰</button>
      <button onclick="openGacha()" class="btn btn-g text-xs" style="padding:6px 16px">
        <span class="mi" style="font-size:16px">casino</span> éšæœºæŠ½å–
      </button>
    </div>
    <!-- Card grid -->
    <div id="cardGrid" class="grid gap-4" style="grid-template-columns:repeat(auto-fill,minmax(240px,1fr))"></div>
    <!-- Empty state -->
    <div id="emptyState" class="hidden flex-col items-center justify-center py-20 text-center" style="display:none">
      <span class="mi" style="font-size:64px;color:#DADCE0">search_off</span>
      <p class="text-lg mt-4" style="color:#9AA0A6">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å·å­</p>
      <button onclick="clearFilters()" class="btn btn-o mt-4">æ¸…é™¤ç­›é€‰æ¡ä»¶</button>
    </div>
    <!-- Lock prompt -->
    <div id="lockPrompt" class="hidden mt-6 lock-box">
      <span class="mi" style="font-size:48px;color:#DADCE0">lock</span>
      <p class="font-semibold mt-3" style="color:#5F6368">ğŸ”’ å®Œæˆ 2023-2025 çš„å…¨éƒ¨å·å­åè§£é”æ›´æ—©å¹´ä»½</p>
      <p class="text-sm mt-1" style="color:#9AA0A6">æ¯å®Œæˆä¸€ä¸ªç§‘ç›®çš„æ‰€æœ‰è¿‘å¹´å·å­ï¼Œå³å¯è§£é”è¯¥ç§‘ç›®çš„å†å¹´çœŸé¢˜</p>
    </div>
  </div>
</main>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CART PANEL (slide-up) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="cartPanel">
  <div class="flex items-center justify-between px-4 py-3" style="border-bottom:1px solid var(--border)">
    <h3 class="font-semibold text-sm" style="color:#202124">ä»Šæ—¥æ¸…å•</h3>
    <div class="flex gap-2">
      <button onclick="clearCart()" class="btn" style="font-size:12px;padding:5px 12px;border:1.5px solid var(--danger);color:var(--danger);border-radius:24px;background:transparent">æ¸…ç©º</button>
      <button onclick="startExam()" class="btn btn-p" style="font-size:12px;padding:5px 12px">
        <span class="mi" style="font-size:15px">play_arrow</span> å¼€å§‹æ¨¡è€ƒ
      </button>
    </div>
  </div>
  <div id="cartList" class="overflow-y-auto" style="max-height:360px;padding:8px"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CART BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="cartBar" class="fixed bottom-0 left-0 right-0 z-50 flex items-center px-4 gap-3" style="height:64px">
  <button onclick="toggleCartPanel()" class="flex items-center gap-2 transition-colors hover:opacity-80" style="background:none;border:none;cursor:pointer;color:#202124">
    <span class="mi" style="color:var(--primary)">playlist_add_check</span>
    <span class="font-medium text-sm">ä»Šæ—¥æ¸…å•</span>
    <span id="cartCount" class="font-bold text-xs text-white rounded-full px-2 py-0.5" style="background:var(--primary);min-width:20px;text-align:center">0</span>
  </button>
  <div id="cartDots" class="flex gap-1.5 items-center" style="flex:1"></div>
  <span id="cartTime" class="text-xs" style="color:var(--text-sub);white-space:nowrap">é¢„è®¡æ€»æ—¶é•¿: --</span>
  <button onclick="toggleCartPanel()" id="cartExpBtn" style="background:none;border:none;cursor:pointer;padding:6px;border-radius:50%;transition:background .15s" onmouseover="this.style.background='#F1F3F4'" onmouseout="this.style.background='none'">
    <span class="mi" id="cartExpIco" style="color:#5F6368">expand_less</span>
  </button>
  <button onclick="startExam()" id="startExamBtn" class="btn btn-p" disabled style="font-size:13px;padding:8px 20px">
    <span class="mi" style="font-size:16px">play_arrow</span> å¼€å§‹æ¨¡è€ƒ
  </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GACHA MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="gachaModal" class="fixed inset-0 z-50 hidden items-center justify-center mbg" style="display:none">
  <div id="gachaBox" class="bg-white rounded-2xl p-6 mx-4 relative" style="width:440px;max-width:100%;max-height:92vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETTINGS OVERLAY + DRAWER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="settingsOv" class="fixed inset-0 z-50 hidden mbg" onclick="closeSettings()"></div>
<div id="settingsDr" class="fixed top-0 right-0 bottom-0 z-50 bg-white overflow-y-auto" style="width:320px">
  <div class="flex items-center justify-between px-5 py-4" style="border-bottom:1px solid var(--border)">
    <h2 class="font-bold text-base" style="color:#202124">è®¾ç½®</h2>
    <button onclick="closeSettings()" style="background:none;border:none;cursor:pointer;padding:4px;border-radius:50%">
      <span class="mi" style="color:#5F6368">close</span>
    </button>
  </div>
  <div class="p-5 space-y-6">
    <!-- Mode -->
    <div>
      <p class="font-semibold text-sm mb-1" style="color:#202124">è€ƒè¯•æ¨¡å¼</p>
      <p class="text-xs mb-3" style="color:var(--text-sub)">ä¸¥æ ¼æ¨¡å¼ä¸‹ä¸å…è®¸æš‚åœï¼Œé€€å‡ºå…¨å±å°†æ˜¾ç¤ºè­¦å‘Š</p>
      <div class="flex rounded-xl overflow-hidden" style="border:1.5px solid var(--border)">
        <button id="modeStrict" onclick="setMode('strict')" class="flex-1 py-2 text-sm font-medium transition-colors" style="background:var(--primary);color:white;border:none;cursor:pointer">âš¡ ä¸¥æ ¼æ¨¡å¼</button>
        <button id="modePrac" onclick="setMode('practice')" class="flex-1 py-2 text-sm font-medium transition-colors" style="background:white;color:var(--text-sub);border:none;cursor:pointer">ğŸ“ ç»ƒä¹ æ¨¡å¼</button>
      </div>
    </div>
    <!-- Theme -->
    <div class="flex items-center justify-between">
      <div>
        <p class="font-semibold text-sm" style="color:#202124">æ·±è‰²ä¸»é¢˜</p>
        <p class="text-xs" style="color:var(--text-sub)">ï¼ˆå¼€å‘ä¸­ï¼‰</p>
      </div>
      <div class="tgl" id="themeTgl" onclick="toggleTheme()" style="opacity:.45;pointer-events:none"></div>
    </div>
    <!-- Stats -->
    <div style="background:#F8F9FA;border-radius:12px;padding:16px">
      <p class="font-semibold text-sm mb-3" style="color:#202124">å­¦ä¹ ç»Ÿè®¡</p>
      <div class="grid grid-cols-2 gap-3">
        <div class="text-center p-3 bg-white rounded-xl" style="box-shadow:0 1px 3px rgba(0,0,0,.08)">
          <p id="statDone" class="font-bold text-xl" style="color:var(--success)">0</p>
          <p class="text-xs mt-1" style="color:var(--text-sub)">å·²å®Œæˆ</p>
        </div>
        <div class="text-center p-3 bg-white rounded-xl" style="box-shadow:0 1px 3px rgba(0,0,0,.08)">
          <p id="statTotal" class="font-bold text-xl" style="color:var(--primary)">0</p>
          <p class="text-xs mt-1" style="color:var(--text-sub)">æ€»å·æ•°</p>
        </div>
        <div class="text-center p-3 bg-white rounded-xl col-span-2" style="box-shadow:0 1px 3px rgba(0,0,0,.08)">
          <p id="statTime" class="font-bold text-xl" style="color:#9334E8">0h 0min</p>
          <p class="text-xs mt-1" style="color:var(--text-sub)">ç´¯è®¡æ¨¡è€ƒæ—¶é•¿</p>
        </div>
      </div>
    </div>
    <!-- Reset -->
    <div>
      <p class="font-semibold text-sm mb-2" style="color:#202124">å±é™©æ“ä½œ</p>
      <button onclick="confirmReset()" class="btn btn-d w-full" style="justify-content:center">
        <span class="mi" style="font-size:16px">delete_forever</span> é‡ç½®æ‰€æœ‰è¿›åº¦
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EXAM OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="examOv" class="fixed inset-0 z-[100] hidden" style="display:none">
  <div id="warnBanner">âš ï¸ è­¦å‘Šï¼é€€å‡ºå…¨å±è§†ä¸ºä½œå¼Šè¡Œä¸ºï¼è¯·ç«‹åˆ»è¿”å›å…¨å±ï¼</div>
  <div id="examContent" class="flex flex-col items-center justify-center h-full px-8 text-center relative" style="z-index:1"></div>
  <div class="wm" id="examWm"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MOBILE FILTER BOTTOM SHEET â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="mobileFilterOv" class="fixed inset-0 z-50 hidden mbg" onclick="closeMobileFilter()"></div>
<div id="mobileFilterSheet" class="fixed bottom-0 left-0 right-0 z-50 bg-white rounded-t-2xl overflow-y-auto transition-transform" style="max-height:80vh;transform:translateY(100%);box-shadow:0 -4px 24px rgba(0,0,0,.15)">
  <div class="flex items-center justify-between p-4" style="border-bottom:1px solid var(--border)">
    <h3 class="font-semibold">ç­›é€‰</h3>
    <button onclick="closeMobileFilter()" style="background:none;border:none;cursor:pointer">
      <span class="mi">close</span>
    </button>
  </div>
  <div id="mobileFilterSections" class="p-4"></div>
</div>

<script>
// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                   PAPER DATABASE                        â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** ç”Ÿæˆæ‰€æœ‰è¯•å·çš„æ•°æ®åº“ */
function generatePaperDB() {
  const db = [];

  // ç§‘ç›®é…ç½®
  const SUBJECTS = [
    {
      subject: '0580', subjectName: 'Mathematics',
      subjectIcon: 'calculate', subjectColor: '#1A73E8',
      papers: [
        { code: 'P1', full: 'Paper 1', duration: 45,  marks: 40, tier: 'Core' },
        { code: 'P2', full: 'Paper 2', duration: 90,  marks: 70, tier: 'Extended' },
        { code: 'P3', full: 'Paper 3', duration: 120, marks: 80, tier: 'Core' },
        { code: 'P4', full: 'Paper 4', duration: 120, marks: 80, tier: 'Extended' },
      ]
    },
    {
      subject: '0610', subjectName: 'Biology',
      subjectIcon: 'biotech', subjectColor: '#34A853',
      papers: [
        { code: 'P1', full: 'Paper 1', duration: 45,  marks: 40, tier: 'Core/Extended' },
        { code: 'P2', full: 'Paper 2', duration: 90,  marks: 70, tier: 'Extended' },
        { code: 'P4', full: 'Paper 4', duration: 120, marks: 80, tier: 'Extended' },
        { code: 'P6', full: 'Paper 6', duration: 60,  marks: 40, tier: 'Practical' },
      ]
    },
    {
      subject: '0620', subjectName: 'Chemistry',
      subjectIcon: 'science', subjectColor: '#FF6D00',
      papers: [
        { code: 'P1', full: 'Paper 1', duration: 45,  marks: 40, tier: 'Core/Extended' },
        { code: 'P2', full: 'Paper 2', duration: 90,  marks: 70, tier: 'Extended' },
        { code: 'P4', full: 'Paper 4', duration: 120, marks: 80, tier: 'Extended' },
        { code: 'P6', full: 'Paper 6', duration: 60,  marks: 40, tier: 'Practical' },
      ]
    },
    {
      subject: '0625', subjectName: 'Physics',
      subjectIcon: 'bolt', subjectColor: '#9334E8',
      papers: [
        { code: 'P1', full: 'Paper 1', duration: 45,  marks: 40, tier: 'Core/Extended' },
        { code: 'P2', full: 'Paper 2', duration: 90,  marks: 70, tier: 'Extended' },
        { code: 'P4', full: 'Paper 4', duration: 120, marks: 80, tier: 'Extended' },
        { code: 'P6', full: 'Paper 6', duration: 60,  marks: 40, tier: 'Practical' },
      ]
    },
  ];

  for (const subj of SUBJECTS) {
    // è¿‘å¹´å·å­ (2023-2025): ä¸¤ä¸ªè€ƒå­£ï¼Œä¸¤ä¸ªå˜ä½“
    for (const year of [2025, 2024, 2023]) {
      for (const [session, sc] of [['May/June', 'MJ'], ['Oct/Nov', 'ON']]) {
        for (const pt of subj.papers) {
          for (const v of [1, 2]) {
            db.push({
              id: `${subj.subject}-${year}-${sc}-${pt.code}${v}`,
              subject: subj.subject,
              subjectName: subj.subjectName,
              subjectIcon: subj.subjectIcon,
              subjectColor: subj.subjectColor,
              year, paper: `${pt.code}${v}`,
              paperFull: `${pt.full} (Variant ${v})`,
              session, duration: pt.duration,
              totalMarks: pt.marks, tier: pt.tier,
              locked: false,
            });
          }
        }
      }
    }
    // å†å¹´å·å­ (2020-2022): ä»… May/Juneï¼Œä»… P2/P4ï¼Œä¸¤ä¸ªå˜ä½“ï¼ˆé»˜è®¤é”å®šï¼‰
    for (const year of [2022, 2021, 2020]) {
      for (const pt of subj.papers.filter(p => ['P2', 'P4'].includes(p.code))) {
        for (const v of [1, 2]) {
          db.push({
            id: `${subj.subject}-${year}-MJ-${pt.code}${v}`,
            subject: subj.subject,
            subjectName: subj.subjectName,
            subjectIcon: subj.subjectIcon,
            subjectColor: subj.subjectColor,
            year, paper: `${pt.code}${v}`,
            paperFull: `${pt.full} (Variant ${v})`,
            session: 'May/June',
            duration: pt.duration,
            totalMarks: pt.marks, tier: pt.tier,
            locked: true,
          });
        }
      }
    }
  }
  return db;
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                    STATE & STORAGE                      â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const STORAGE_KEY = 'warden_mock_portal_v2';

let paperDB = [];
let filteredPapers = [];
let selectedSet = new Set(); // å¡ç‰‡é€‰ä¸­çŠ¶æ€ï¼ˆç”¨äºæ‰¹é‡æ“ä½œï¼‰

let state = {
  filters: { subjects: [], years: [], papers: [], durations: [], statuses: [], sessions: [] },
  cart: [],           // ä»Šæ—¥æ¸…å•ï¼ˆpaper id æ•°ç»„ï¼‰
  paperStatus: {},    // id -> 'done' | 'inprog'
  paperTimes: {},     // id -> seconds
  settings: { mode: 'strict', theme: 'light' },
};

/** ä» LocalStorage åŠ è½½çŠ¶æ€ */
function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      const s = JSON.parse(raw);
      state.paperStatus = s.paperStatus || {};
      state.paperTimes  = s.paperTimes  || {};
      state.cart        = s.cart        || [];
      if (s.settings) state.settings = { ...state.settings, ...s.settings };
    }
  } catch (e) { console.warn('åŠ è½½çŠ¶æ€å¤±è´¥', e); }
}

/** ä¿å­˜çŠ¶æ€åˆ° LocalStorage */
function saveState() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      paperStatus: state.paperStatus,
      paperTimes:  state.paperTimes,
      cart:        state.cart,
      settings:    state.settings,
    }));
  } catch (e) { console.warn('ä¿å­˜çŠ¶æ€å¤±è´¥', e); }
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                   FILTER PANEL                          â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const FILTER_DEFS = [
  {
    key: 'subjects', label: 'ğŸ“š ç§‘ç›®',
    options: [
      { value: '0580', label: '0580 æ•°å­¦' },
      { value: '0610', label: '0610 ç”Ÿç‰©' },
      { value: '0620', label: '0620 åŒ–å­¦' },
      { value: '0625', label: '0625 ç‰©ç†' },
    ]
  },
  {
    key: 'years', label: 'ğŸ“… å¹´ä»½',
    options: [
      { value: 2025, label: '2025' },
      { value: 2024, label: '2024' },
      { value: 2023, label: '2023' },
      { value: 2022, label: '2022 ğŸ”’', locked: true },
      { value: 2021, label: '2021 ğŸ”’', locked: true },
      { value: 2020, label: '2020 ğŸ”’', locked: true },
    ]
  },
  {
    key: 'papers', label: 'ğŸ“„ å·å‹',
    options: [
      { value: 'P1', label: 'P1 (MCQ)' },
      { value: 'P2', label: 'P2 (ç»“æ„)' },
      { value: 'P3', label: 'P3 (Core)' },
      { value: 'P4', label: 'P4 (Extended)' },
      { value: 'P6', label: 'P6 (å®éªŒ)' },
    ]
  },
  {
    key: 'durations', label: 'â± æ—¶é•¿',
    options: [
      { value: '45',  label: 'â‰¤ 45 min' },
      { value: '90',  label: '46â€“90 min' },
      { value: '120', label: '91â€“120 min' },
    ]
  },
  {
    key: 'statuses', label: 'âœ… çŠ¶æ€',
    options: [
      { value: 'todo',   label: 'æœªåš' },
      { value: 'inprog', label: 'è¿›è¡Œä¸­' },
      { value: 'done',   label: 'å·²å®Œæˆ' },
    ]
  },
  {
    key: 'sessions', label: 'ğŸ—“ è€ƒå­£',
    options: [
      { value: 'May/June', label: 'May/June' },
      { value: 'Oct/Nov',  label: 'Oct/Nov'  },
      { value: 'Feb/Mar',  label: 'Feb/Mar'  },
    ]
  },
];

/** æ¸²æŸ“å·¦ä¾§ç­›é€‰é¢æ¿ */
function renderFilterPanel() {
  const container = document.getElementById('filterSections');
  container.innerHTML = '';
  FILTER_DEFS.forEach((def, i) => {
    const sec = document.createElement('div');
    sec.style.borderBottom = '1px solid var(--border)';
    sec.innerHTML = `
      <div class="fsec-hdr flex items-center justify-between px-4 py-3" onclick="toggleFilterSec(${i})">
        <span class="text-sm font-semibold" style="color:#202124">${def.label}</span>
        <span class="mi" id="fsec-arrow-${i}" style="font-size:18px;color:var(--text-sub);transition:transform .25s">expand_more</span>
      </div>
      <div class="fsec-body" id="fsec-body-${i}" style="max-height:300px">
        <div class="flex flex-wrap gap-2 px-4 pb-3">
          ${def.options.map(opt => `
            <div class="fchip ${state.filters[def.key].includes(opt.value) ? 'on' : ''}"
              id="fc-${def.key}-${opt.value}"
              onclick="toggleFilter('${def.key}', ${typeof opt.value === 'number' ? opt.value : `'${opt.value}'`})">
              ${opt.label}
              <span class="cbadge" id="fcb-${def.key}-${opt.value}">0</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
    container.appendChild(sec);
  });
  updateFilterCounts();
  // åŒæ­¥æ¸²æŸ“ç§»åŠ¨ç«¯ç­›é€‰
  const mob = document.getElementById('mobileFilterSections');
  if (mob) mob.innerHTML = container.innerHTML;
}

/** å±•å¼€/æŠ˜å ç­›é€‰åˆ†åŒº */
function toggleFilterSec(i) {
  const body  = document.getElementById(`fsec-body-${i}`);
  const arrow = document.getElementById(`fsec-arrow-${i}`);
  const open  = body.style.maxHeight !== '0px' && body.style.maxHeight !== '';
  body.style.maxHeight  = open ? '0px' : '300px';
  arrow.style.transform = open ? 'rotate(-90deg)' : '';
}

/** åˆ‡æ¢å•ä¸ªç­›é€‰é¡¹ */
function toggleFilter(key, value) {
  const arr = state.filters[key];
  const idx = arr.indexOf(value);
  if (idx === -1) arr.push(value);
  else arr.splice(idx, 1);
  // åŒæ­¥æ‰€æœ‰ç›¸å…³ chip æ ·å¼
  document.querySelectorAll(`[id^="fc-${key}-"]`).forEach(el => {
    const v = el.id.replace(`fc-${key}-`, '');
    const parsed = isNaN(v) ? v : Number(v);
    el.classList.toggle('on', arr.includes(parsed) || arr.includes(v));
  });
  applyFilters();
}

/** æ¸…é™¤æ‰€æœ‰ç­›é€‰æ¡ä»¶ */
function clearFilters() {
  FILTER_DEFS.forEach(d => { state.filters[d.key] = []; });
  renderFilterPanel();
  applyFilters();
  showToast('ç­›é€‰å·²æ¸…é™¤');
}

/** æ›´æ–°æ¯ä¸ªç­›é€‰é¡¹çš„è®¡æ•°è§’æ ‡ */
function updateFilterCounts() {
  FILTER_DEFS.forEach(def => {
    def.options.forEach(opt => {
      const el = document.getElementById(`fcb-${def.key}-${opt.value}`);
      if (!el) return;
      const count = paperDB.filter(p => {
        if (p.locked && !isSubjectUnlocked(p.subject)) return false;
        if (def.key === 'subjects')  return p.subject === opt.value;
        if (def.key === 'years')     return p.year === opt.value;
        if (def.key === 'papers')    return p.paper.startsWith(opt.value);
        if (def.key === 'durations') {
          if (opt.value === '45')  return p.duration <= 45;
          if (opt.value === '90')  return p.duration > 45 && p.duration <= 90;
          if (opt.value === '120') return p.duration > 90;
        }
        if (def.key === 'statuses') return (state.paperStatus[p.id] || 'todo') === opt.value;
        if (def.key === 'sessions') return p.session === opt.value;
        return false;
      }).length;
      el.textContent = count;
    });
  });
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                  FILTER & SORT LOGIC                    â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** åˆ¤æ–­ä¸€ä¸ªç§‘ç›®çš„å†å¹´å·æ˜¯å¦å·²è§£é” */
function isSubjectUnlocked(subject) {
  const recent = paperDB.filter(p => !p.locked && p.subject === subject);
  return recent.length > 0 && recent.every(p => state.paperStatus[p.id] === 'done');
}

/** åº”ç”¨ç­›é€‰+æ’åºï¼Œå¹¶é‡æ–°æ¸²æŸ“å¡ç‰‡ */
function applyFilters() {
  const { subjects, years, papers, durations, statuses, sessions } = state.filters;
  const sort = document.getElementById('sortSel')?.value || 'year-desc';

  // ç­›é€‰
  let result = paperDB.filter(p => {
    if (p.locked && !isSubjectUnlocked(p.subject)) return false;
    if (subjects.length  && !subjects.includes(p.subject))                         return false;
    if (years.length     && !years.includes(p.year))                               return false;
    if (papers.length    && !papers.some(pt => p.paper.startsWith(pt)))            return false;
    if (durations.length) {
      const inRange = durations.some(d => {
        if (d === '45')  return p.duration <= 45;
        if (d === '90')  return p.duration > 45 && p.duration <= 90;
        if (d === '120') return p.duration > 90;
        return false;
      });
      if (!inRange) return false;
    }
    if (statuses.length && !(statuses.includes(state.paperStatus[p.id] || 'todo'))) return false;
    if (sessions.length && !sessions.includes(p.session))                           return false;
    return true;
  });

  // æ’åº
  result.sort((a, b) => {
    switch (sort) {
      case 'year-asc':  return a.year - b.year  || a.subject.localeCompare(b.subject);
      case 'year-desc': return b.year - a.year  || a.subject.localeCompare(b.subject);
      case 'dur-asc':   return a.duration - b.duration;
      case 'dur-desc':  return b.duration - a.duration;
      case 'subj':      return a.subject.localeCompare(b.subject) || b.year - a.year;
      default:          return 0;
    }
  });

  filteredPapers = result;
  renderCards();
  updateFilterCounts();
  updateProgress();
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                    CARD RENDERING                       â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const STATUS_MAP = {
  todo:   { color: '#9AA0A6', label: 'æœªåš',   bg: '#F1F3F4' },
  inprog: { color: '#FBBC04', label: 'è¿›è¡Œä¸­', bg: '#FEF9E7' },
  done:   { color: '#34A853', label: 'å·²å®Œæˆ', bg: '#E6F4EA' },
};

/** æ¸²æŸ“å…¨éƒ¨å¡ç‰‡ */
function renderCards() {
  const grid      = document.getElementById('cardGrid');
  const empty     = document.getElementById('emptyState');
  const lockEl    = document.getElementById('lockPrompt');
  const countEl   = document.getElementById('filterCount');

  grid.innerHTML = '';
  countEl.textContent = `ç­›é€‰åˆ° ${filteredPapers.length} å¼ å·å­`;

  if (filteredPapers.length === 0) {
    empty.style.display    = 'flex';
    lockEl.classList.add('hidden');
  } else {
    empty.style.display = 'none';
    filteredPapers.forEach(p => grid.appendChild(makeCard(p)));
  }

  // æ˜¾ç¤ºé”å®šæç¤ºï¼ˆæœ‰æœªè§£é”ç§‘ç›®çš„å†å¹´å·æ—¶ï¼‰
  const hasLocked = paperDB.some(p => p.locked && !isSubjectUnlocked(p.subject));
  lockEl.classList.toggle('hidden', !hasLocked);
}

/** åˆ›å»ºå•å¼ å¡ç‰‡ DOM */
function makeCard(p) {
  const status = state.paperStatus[p.id] || 'todo';
  const sc     = STATUS_MAP[status];
  const inCart = state.cart.includes(p.id);
  const isSel  = selectedSet.has(p.id);
  const sCode  = p.session === 'May/June' ? 'M/J' : p.session === 'Oct/Nov' ? 'O/N' : 'F/M';
  const tSec   = state.paperTimes[p.id];
  const tStr   = tSec ? fmtTime(tSec) : null;
  const barPct = status === 'done' ? 100 : status === 'inprog' ? 50 : 0;

  const div = document.createElement('div');
  div.className = `pcard p-4${isSel ? ' sel' : ''}${status === 'done' ? ' done' : status === 'inprog' ? ' inprog' : ''}`;
  div.dataset.id = p.id;

  div.innerHTML = `
    <!-- å¤é€‰æ¡† -->
    <div style="position:absolute;top:12px;left:12px;z-index:1" onclick="event.stopPropagation()">
      <div onclick="toggleSel('${p.id}')" style="width:20px;height:20px;border-radius:5px;border:2px solid ${isSel ? 'var(--primary)' : '#DADCE0'};background:${isSel ? 'var(--primary)' : 'white'};cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s">
        ${isSel ? '<span class="mi" style="font-size:13px;color:white">check</span>' : ''}
      </div>
    </div>

    <!-- é¡¶éƒ¨ä¿¡æ¯ -->
    <div class="flex items-start justify-between pt-5 mb-2">
      <div class="flex items-center gap-2">
        <div style="width:34px;height:34px;border-radius:10px;background:${p.subjectColor}1A;display:flex;align-items:center;justify-content:center;flex-shrink:0">
          <span class="mi" style="color:${p.subjectColor};font-size:18px">${p.subjectIcon}</span>
        </div>
        <div>
          <div class="font-bold text-sm" style="color:${p.subjectColor}">${p.subject}</div>
          <div style="font-size:10px;color:var(--text-sub)">${p.subjectName}</div>
        </div>
      </div>
      <div class="text-right" style="flex-shrink:0">
        <div class="font-semibold text-xs" style="color:var(--text-sub)">${p.year}</div>
        <div style="font-size:10px;color:#9AA0A6">${sCode}</div>
      </div>
    </div>

    <!-- å·å· + å…¨ç§° -->
    <div class="mb-2">
      <div class="font-bold" style="font-size:22px;color:#202124;letter-spacing:-.5px">${p.paper}</div>
      <div style="font-size:11px;color:var(--text-sub)">${p.paperFull}</div>
      <span style="display:inline-block;font-size:10px;padding:2px 8px;border-radius:20px;margin-top:4px;background:${p.subjectColor}15;color:${p.subjectColor}">${p.tier}</span>
    </div>

    <!-- æ—¶é•¿ / åˆ†æ•° -->
    <div class="flex gap-3 mb-2" style="font-size:11px;color:var(--text-sub)">
      <div class="flex items-center gap-1">
        <span class="mi" style="font-size:14px;color:#9AA0A6">timer</span>${p.duration} min
      </div>
      <div class="flex items-center gap-1">
        <span class="mi" style="font-size:14px;color:#9AA0A6">grading</span>${p.totalMarks} åˆ†
      </div>
      ${tStr ? `<div class="flex items-center gap-1 ml-auto"><span class="mi" style="font-size:14px;color:#9AA0A6">history</span>${tStr}</div>` : ''}
    </div>

    <!-- è¿›åº¦æ¡ -->
    <div class="sbar mb-2">
      <div class="sbar-fill" style="width:${barPct}%;background:${sc.color}"></div>
    </div>

    <!-- çŠ¶æ€æ ‡ç­¾ -->
    <div class="mb-3">
      <span style="font-size:11px;padding:3px 10px;border-radius:20px;font-weight:600;background:${sc.bg};color:${sc.color}">${sc.label}</span>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="flex gap-2">
      <button onclick="event.stopPropagation();toggleCart('${p.id}')"
        class="btn ${inCart ? 'btn-p' : 'btn-o'} flex-1" style="font-size:11px;padding:6px 10px">
        <span class="mi" style="font-size:14px">${inCart ? 'playlist_add_check' : 'playlist_add'}</span>
        ${inCart ? 'å·²åŠ å…¥' : 'åŠ å…¥æ¸…å•'}
      </button>
      <button onclick="event.stopPropagation();markDone('${p.id}')"
        class="btn ${status === 'done' ? 'btn-s' : 'btn-o'}" style="font-size:11px;padding:6px 10px">
        <span class="mi" style="font-size:14px">${status === 'done' ? 'check_circle' : 'check'}</span>
        ${status === 'done' ? 'å®Œæˆ' : 'æ ‡è®°'}
      </button>
    </div>
  `;

  // ç‚¹å‡»å¡ç‰‡ï¼ˆéæŒ‰é’®åŒºåŸŸï¼‰åˆ‡æ¢é€‰ä¸­
  div.addEventListener('click', e => {
    if (!e.target.closest('button') && !e.target.closest('[onclick]')) {
      toggleSel(p.id);
    }
  });

  return div;
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                   SELECTION LOGIC                       â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** åˆ‡æ¢å¡ç‰‡é€‰ä¸­çŠ¶æ€ */
function toggleSel(id) {
  if (selectedSet.has(id)) selectedSet.delete(id);
  else selectedSet.add(id);
  // åªåˆ·æ–°è¯¥å¡ç‰‡
  const el = document.querySelector(`[data-id="${id}"]`);
  if (el) {
    const p = paperDB.find(x => x.id === id);
    if (p) {
      const newCard = makeCard(p);
      el.replaceWith(newCard);
    }
  }
}

/** å…¨é€‰å½“å‰ç­›é€‰åˆ°çš„å¡ç‰‡ */
function selectAll() {
  filteredPapers.forEach(p => selectedSet.add(p.id));
  renderCards();
  showToast(`å·²é€‰ä¸­ ${selectedSet.size} å¼ å·å­`);
}

/** åé€‰å½“å‰ç­›é€‰åˆ°çš„å¡ç‰‡ */
function invertSel() {
  filteredPapers.forEach(p => {
    if (selectedSet.has(p.id)) selectedSet.delete(p.id);
    else selectedSet.add(p.id);
  });
  renderCards();
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                     CART LOGIC                          â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let cartPanelOpen = false;

/** åˆ‡æ¢ä»Šæ—¥æ¸…å•ä¸­çš„æŸå¼ å·å­ */
function toggleCart(id) {
  const idx = state.cart.indexOf(id);
  if (idx === -1) { state.cart.push(id); showToast('å·²åŠ å…¥ä»Šæ—¥æ¸…å•'); }
  else { state.cart.splice(idx, 1); showToast('å·²ä»æ¸…å•ç§»é™¤'); }
  saveState();
  updateCartBar();
  // åˆ·æ–°è¯¥å¡ç‰‡æŒ‰é’®
  const el = document.querySelector(`[data-id="${id}"]`);
  if (el) { const p = paperDB.find(x => x.id === id); if (p) el.replaceWith(makeCard(p)); }
}

/** ä»æ¸…å•ä¸­åˆ é™¤ */
function removeFromCart(id) {
  state.cart = state.cart.filter(x => x !== id);
  saveState();
  updateCartBar();
  renderCartList();
  // åˆ·æ–°å¡ç‰‡æŒ‰é’®
  const el = document.querySelector(`[data-id="${id}"]`);
  if (el) { const p = paperDB.find(x => x.id === id); if (p) el.replaceWith(makeCard(p)); }
}

/** æ¸…ç©ºæ¸…å• */
function clearCart() {
  const ids = [...state.cart];
  state.cart = [];
  saveState();
  updateCartBar();
  renderCartList();
  ids.forEach(id => {
    const el = document.querySelector(`[data-id="${id}"]`);
    if (el) { const p = paperDB.find(x => x.id === id); if (p) el.replaceWith(makeCard(p)); }
  });
  showToast('æ¸…å•å·²æ¸…ç©º');
}

/** æ›´æ–°åº•éƒ¨ cart bar */
function updateCartBar() {
  const n = state.cart.length;
  document.getElementById('cartCount').textContent = n;

  // é¢„è®¡æ—¶é•¿
  const total = state.cart.reduce((s, id) => {
    const p = paperDB.find(x => x.id === id);
    return s + (p ? p.duration : 0);
  }, 0);
  document.getElementById('cartTime').textContent =
    n ? `é¢„è®¡æ€»æ—¶é•¿: ${fmtDuration(total * 60)}` : 'é¢„è®¡æ€»æ—¶é•¿: --';

  // ç§‘ç›®è‰²ç‚¹
  const dotsEl = document.getElementById('cartDots');
  const subjColors = [...new Set(state.cart.map(id => {
    const p = paperDB.find(x => x.id === id);
    return p ? p.subjectColor : null;
  }).filter(Boolean))];
  const max = 8;
  dotsEl.innerHTML = subjColors.slice(0, max).map(c =>
    `<div style="width:10px;height:10px;border-radius:50%;background:${c};flex-shrink:0"></div>`
  ).join('') + (subjColors.length > max ?
    `<span style="font-size:10px;color:var(--text-sub)">+${subjColors.length - max}</span>` : '');

  // å¼€å§‹æ¨¡è€ƒæŒ‰é’®
  const btn = document.getElementById('startExamBtn');
  btn.disabled = n === 0;
}

/** å±•å¼€/æ”¶èµ·æ¸…å•é¢æ¿ */
function toggleCartPanel() {
  cartPanelOpen = !cartPanelOpen;
  document.getElementById('cartPanel').classList.toggle('open', cartPanelOpen);
  document.getElementById('cartExpIco').textContent = cartPanelOpen ? 'expand_more' : 'expand_less';
  if (cartPanelOpen) renderCartList();
}

/** æ¸²æŸ“æ¸…å•åˆ—è¡¨ï¼ˆæ”¯æŒæ‹–æ‹½æ’åºï¼‰ */
function renderCartList() {
  const list = document.getElementById('cartList');
  list.innerHTML = '';
  if (state.cart.length === 0) {
    list.innerHTML = '<p class="text-center py-8 text-sm" style="color:#9AA0A6">æ¸…å•ä¸ºç©ºï¼Œè¯·ä»ä¸Šæ–¹å¡ç‰‡åŠ å…¥å·å­</p>';
    return;
  }
  state.cart.forEach((id, i) => {
    const p = paperDB.find(x => x.id === id);
    if (!p) return;
    const row = document.createElement('div');
    row.className = 'cart-row flex items-center gap-3 p-3 rounded-xl mb-1';
    row.draggable = true;
    row.dataset.id = id;
    row.style.background = '#F8F9FA';
    row.style.border = '1.5px solid var(--border)';
    row.innerHTML = `
      <span class="mi" style="color:#9AA0A6;font-size:18px;cursor:grab">drag_indicator</span>
      <div style="width:30px;height:30px;border-radius:8px;background:${p.subjectColor}1A;display:flex;align-items:center;justify-content:center;flex-shrink:0">
        <span class="mi" style="color:${p.subjectColor};font-size:16px">${p.subjectIcon}</span>
      </div>
      <div style="flex:1;min-width:0">
        <div class="font-semibold text-sm" style="color:#202124">${p.subject} ${p.paper}</div>
        <div style="font-size:11px;color:var(--text-sub)">${p.year} ${p.session === 'May/June' ? 'M/J' : 'O/N'} Â· ${p.duration}min Â· ${p.totalMarks}åˆ†</div>
      </div>
      <button onclick="removeFromCart('${id}')" style="background:none;border:none;cursor:pointer;padding:4px;border-radius:50%" title="ç§»é™¤">
        <span class="mi" style="font-size:18px;color:#9AA0A6">close</span>
      </button>
    `;
    // æ‹–æ‹½äº‹ä»¶
    row.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', id);
      row.classList.add('dragging');
    });
    row.addEventListener('dragend',  () => row.classList.remove('dragging'));
    row.addEventListener('dragover', e => { e.preventDefault(); row.classList.add('dragover'); });
    row.addEventListener('dragleave',() => row.classList.remove('dragover'));
    row.addEventListener('drop', e => {
      e.preventDefault();
      row.classList.remove('dragover');
      const fromId = e.dataTransfer.getData('text/plain');
      const fromIdx = state.cart.indexOf(fromId);
      const toIdx   = state.cart.indexOf(id);
      if (fromIdx !== -1 && toIdx !== -1 && fromIdx !== toIdx) {
        state.cart.splice(fromIdx, 1);
        state.cart.splice(toIdx, 0, fromId);
        saveState();
        renderCartList();
        updateCartBar();
      }
    });
    list.appendChild(row);
  });
}

/** æ ‡è®°ä¸€å¼ å·å­ä¸ºå®Œæˆ */
function markDone(id) {
  const cur = state.paperStatus[id] || 'todo';
  state.paperStatus[id] = cur === 'done' ? 'todo' : 'done';
  saveState();
  // åˆ·æ–°å¡ç‰‡
  const el = document.querySelector(`[data-id="${id}"]`);
  if (el) { const p = paperDB.find(x => x.id === id); if (p) el.replaceWith(makeCard(p)); }
  updateProgress();
  updateFilterCounts();
  showToast(state.paperStatus[id] === 'done' ? 'âœ… å·²æ ‡è®°ä¸ºå®Œæˆ' : 'â†© å·²å–æ¶ˆå®Œæˆæ ‡è®°');
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                   PROGRESS CIRCLE                       â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** æ›´æ–°é¡¶éƒ¨åœ†å½¢è¿›åº¦æ¡ */
function updateProgress() {
  const total = paperDB.filter(p => !p.locked || isSubjectUnlocked(p.subject)).length;
  const done  = Object.values(state.paperStatus).filter(v => v === 'done').length;
  const pct   = total ? Math.round((done / total) * 100) : 0;
  document.getElementById('progArc').setAttribute('stroke-dasharray', `${pct} 100`);
  document.getElementById('progPct').textContent = pct + '%';
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                    GACHA SYSTEM                         â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let gachaCount = 3;
let lastGachaResults = [];

/** æ‰“å¼€éšæœºæŠ½å–å¼¹çª— */
function openGacha() {
  const modal = document.getElementById('gachaModal');
  modal.style.display = 'flex';
  renderGachaConfig();
}

/** å…³é—­éšæœºæŠ½å–å¼¹çª— */
function closeGacha() {
  document.getElementById('gachaModal').style.display = 'none';
}

/** æ¸²æŸ“æŠ½å–é…ç½®ç•Œé¢ */
function renderGachaConfig() {
  const box = document.getElementById('gachaBox');
  box.innerHTML = `
    <div class="flex items-center justify-between mb-5">
      <h2 class="font-bold text-lg" style="color:#202124">ğŸ² éšæœºæŠ½å–</h2>
      <button onclick="closeGacha()" style="background:none;border:none;cursor:pointer;padding:4px;border-radius:50%">
        <span class="mi" style="color:#5F6368">close</span>
      </button>
    </div>

    <!-- ç§‘ç›® -->
    <div class="mb-4">
      <p class="text-sm font-semibold mb-2" style="color:#202124">ç§‘ç›®</p>
      <div class="flex flex-wrap gap-2" id="gSubj">
        ${[['0580','æ•°å­¦'],['0610','ç”Ÿç‰©'],['0620','åŒ–å­¦'],['0625','ç‰©ç†']].map(([v,l]) =>
          `<div class="fchip on" data-v="${v}" onclick="this.classList.toggle('on')">${v} ${l}</div>`
        ).join('')}
      </div>
    </div>

    <!-- æ•°é‡ -->
    <div class="mb-4">
      <p class="text-sm font-semibold mb-2" style="color:#202124">æŠ½å–æ•°é‡</p>
      <div class="flex gap-2">
        ${[1,2,3,4,5].map(n =>
          `<button class="gcnt${n===gachaCount?' on':''}" onclick="setGachaCount(${n})" id="gcnt${n}">${n}</button>`
        ).join('')}
      </div>
    </div>

    <!-- å¹´ä»½ -->
    <div class="mb-4">
      <p class="text-sm font-semibold mb-2" style="color:#202124">å¹´ä»½èŒƒå›´</p>
      <div class="flex flex-wrap gap-2" id="gYear">
        ${[2025,2024,2023].map(y =>
          `<div class="fchip on" data-v="${y}" onclick="this.classList.toggle('on')">${y}</div>`
        ).join('')}
      </div>
    </div>

    <!-- å·å‹ -->
    <div class="mb-4">
      <p class="text-sm font-semibold mb-2" style="color:#202124">å·å‹</p>
      <div class="flex flex-wrap gap-2" id="gPaper">
        ${['P1','P2','P3','P4','P6'].map(p =>
          `<div class="fchip on" data-v="${p}" onclick="this.classList.toggle('on')">${p}</div>`
        ).join('')}
      </div>
    </div>

    <!-- åªæŠ½æœªåš -->
    <div class="flex items-center gap-3 mb-6">
      <div class="tgl on" id="gOnlyTodo" onclick="this.classList.toggle('on')"></div>
      <span class="text-sm" style="color:#202124">åªä» <b>æœªåš</b> çš„å·å­ä¸­æŠ½å–</span>
    </div>

    <button onclick="runGacha()" class="btn btn-p w-full" style="padding:12px;font-size:15px;justify-content:center">
      <span class="mi" style="font-size:18px">casino</span>&nbsp;å¼€å§‹æŠ½å–ï¼
    </button>
  `;
}

/** è®¾ç½®æŠ½å–æ•°é‡ */
function setGachaCount(n) {
  gachaCount = n;
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById(`gcnt${i}`);
    if (el) el.classList.toggle('on', i === n);
  }
}

/** æ‰§è¡ŒæŠ½å–ï¼ˆå…ˆåŠ¨ç”»ï¼Œå†æ˜¾ç¤ºç»“æœï¼‰*/
function runGacha() {
  const box = document.getElementById('gachaBox');

  // è¯»å–é…ç½®
  const subjects  = [...document.querySelectorAll('#gSubj .fchip.on')].map(e => e.dataset.v);
  const years     = [...document.querySelectorAll('#gYear .fchip.on')].map(e => Number(e.dataset.v));
  const papers    = [...document.querySelectorAll('#gPaper .fchip.on')].map(e => e.dataset.v);
  const onlyTodo  = document.getElementById('gOnlyTodo')?.classList.contains('on');

  // æ„å»ºå€™é€‰æ± 
  let pool = paperDB.filter(p => {
    if (p.locked && !isSubjectUnlocked(p.subject)) return false;
    if (!subjects.includes(p.subject))             return false;
    if (!years.includes(p.year))                   return false;
    if (!papers.some(pt => p.paper.startsWith(pt))) return false;
    if (onlyTodo && state.paperStatus[p.id] === 'done') return false;
    return true;
  });

  if (pool.length === 0) { showToast('ğŸ˜¢ æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å·å­ï¼'); return; }

  // éšæœºæ‰“ä¹±
  pool = pool.sort(() => Math.random() - 0.5);
  lastGachaResults = pool.slice(0, Math.min(gachaCount, pool.length));

  // æ˜¾ç¤ºæ»šåŠ¨åŠ¨ç”»
  const allShuffled = [...paperDB].sort(() => Math.random() - 0.5);
  const scrollItems = [...allShuffled.slice(0, 24), ...lastGachaResults];
  const itemH = 68;

  box.innerHTML = `
    <div class="flex items-center justify-between mb-5">
      <h2 class="font-bold text-lg" style="color:#202124">ğŸ° æŠ½å–ä¸­â€¦</h2>
    </div>
    <div id="gachaScroller" style="height:${itemH}px;overflow:hidden;border-radius:12px;border:2px solid var(--border);background:#F8F9FA">
      <div id="gachaTrack" style="transition:transform 0s">
        ${scrollItems.map(p => `
          <div class="flex items-center gap-3 px-4" style="height:${itemH}px;border-bottom:1px solid var(--border)">
            <div style="width:36px;height:36px;border-radius:10px;background:${p.subjectColor}1A;display:flex;align-items:center;justify-content:center;flex-shrink:0">
              <span class="mi" style="color:${p.subjectColor};font-size:18px">${p.subjectIcon}</span>
            </div>
            <div>
              <div class="font-bold text-sm" style="color:#202124">${p.subject} Â· ${p.paper}</div>
              <div style="font-size:11px;color:var(--text-sub)">${p.year} ${p.session==='May/June'?'M/J':'O/N'} Â· ${p.duration}min</div>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
    <p class="text-center text-sm mt-4" style="color:var(--text-sub)">æ­£åœ¨ä¸ºä½ éšæœºæŠ½å–â€¦</p>
  `;

  // åŠ¨ç”»ï¼šå¿«é€Ÿæ»šåŠ¨åˆ°æ¥è¿‘æœ«å°¾
  const track = document.getElementById('gachaTrack');
  const endY   = -(scrollItems.length - lastGachaResults.length) * itemH;

  requestAnimationFrame(() => {
    track.style.transition = 'transform 2s cubic-bezier(0.25,0.1,0.25,1)';
    track.style.transform  = `translateY(${endY}px)`;
  });

  setTimeout(() => showGachaResults(), 2300);
}

/** æ˜¾ç¤ºæŠ½å–ç»“æœ */
function showGachaResults() {
  const box = document.getElementById('gachaBox');
  box.innerHTML = `
    <div class="flex items-center justify-between mb-4">
      <div>
        <p style="font-size:36px;line-height:1">ğŸ‰</p>
        <h2 class="font-bold text-lg mt-1" style="color:#202124">æŠ½å–ç»“æœ</h2>
        <p style="font-size:12px;color:var(--text-sub)">å…±æŠ½å– ${lastGachaResults.length} å¼ å·å­</p>
      </div>
      <button onclick="closeGacha()" style="background:none;border:none;cursor:pointer;padding:4px;border-radius:50%">
        <span class="mi" style="color:#5F6368">close</span>
      </button>
    </div>
    <div class="space-y-2 mb-5">
      ${lastGachaResults.map(p => `
        <div class="flex items-center gap-3 p-3 rounded-xl" style="background:#F8F9FA;border:1.5px solid var(--border)">
          <div style="width:38px;height:38px;border-radius:10px;background:${p.subjectColor}1A;display:flex;align-items:center;justify-content:center;flex-shrink:0">
            <span class="mi" style="color:${p.subjectColor}">${p.subjectIcon}</span>
          </div>
          <div style="flex:1">
            <div class="font-bold text-sm" style="color:#202124">${p.subject} Â· ${p.paper}</div>
            <div style="font-size:11px;color:var(--text-sub)">${p.paperFull} Â· ${p.year} ${p.session==='May/June'?'M/J':'O/N'} Â· ${p.duration}min</div>
          </div>
        </div>
      `).join('')}
    </div>
    <div class="flex gap-2">
      <button onclick="addGachaToCart()" class="btn btn-p flex-1" style="justify-content:center;padding:10px">
        <span class="mi" style="font-size:16px">playlist_add</span>&nbsp;åŠ å…¥æ¸…å•
      </button>
      <button id="gachaRedrawBtn" class="btn btn-o flex-1" style="justify-content:center;padding:10px">
        <span class="mi" style="font-size:16px">refresh</span>&nbsp;é‡æ–°æŠ½å–
      </button>
    </div>
  `;
  // ç”¨ id ç²¾ç¡®ç»‘å®šé‡æ–°æŠ½å–æŒ‰é’®ï¼Œé¿å…æ­§ä¹‰é€‰æ‹©å™¨
  document.getElementById('gachaRedrawBtn').addEventListener('click', renderGachaConfig);
}

/** å°†æŠ½å–ç»“æœåŠ å…¥æ¸…å• */
function addGachaToCart() {
  let added = 0;
  lastGachaResults.forEach(p => {
    if (!state.cart.includes(p.id)) { state.cart.push(p.id); added++; }
  });
  saveState();
  updateCartBar();
  renderCards();
  closeGacha();
  showToast(`âœ… å·²åŠ å…¥ ${added} å¼ å·å­åˆ°æ¸…å•`);
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                    EXAM TIMER                           â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let examState = {
  queue: [], currentIdx: 0,
  timer: null, timeLeft: 0, totalTime: 0,
  paused: false, results: [],
};

/** å¼€å§‹æ¨¡è€ƒï¼ˆä»æ¸…å•å¯åŠ¨ï¼‰ */
function startExam() {
  if (state.cart.length === 0) { showToast('æ¸…å•ä¸ºç©ºï¼'); return; }
  examState.queue      = [...state.cart];
  examState.currentIdx = 0;
  examState.results    = [];
  examState.paused     = false;

  // å…³é—­æ¸…å•é¢æ¿
  if (cartPanelOpen) toggleCartPanel();

  // è¿›å…¥å…¨å±ï¼Œå¤±è´¥æ—¶æç¤ºç”¨æˆ·
  document.documentElement.requestFullscreen?.().catch(err => {
    console.warn('å…¨å±è¯·æ±‚å¤±è´¥:', err);
    showToast('âš ï¸ å…¨å±å¤±è´¥ï¼Œå»ºè®®æ‰‹åŠ¨æŒ‰ F11');
  });

  showExamOverlay();
  loadExamPaper();
}

/** æ˜¾ç¤ºè€ƒè¯•é®ç½© */
function showExamOverlay() {
  const ov = document.getElementById('examOv');
  ov.style.display = 'flex';
  ov.style.flexDirection = 'column';
  ov.style.alignItems = 'center';
  ov.style.justifyContent = 'center';

  // å…¨å±é€€å‡ºç›‘å¬
  document.addEventListener('fullscreenchange', onFSChange);
}

/** åŠ è½½å½“å‰è¯•å· */
function loadExamPaper() {
  const id = examState.queue[examState.currentIdx];
  const p  = paperDB.find(x => x.id === id);
  if (!p) { endAllExams(); return; }

  examState.timeLeft  = p.duration * 60;
  examState.totalTime = p.duration * 60;
  examState.paused    = false;

  // æ ‡è®°ä¸ºè¿›è¡Œä¸­
  state.paperStatus[id] = 'inprog';
  saveState();

  // æ°´å°
  document.getElementById('examWm').textContent = id;

  renderExamUI(p);

  // å¯åŠ¨è®¡æ—¶å™¨
  clearInterval(examState.timer);
  examState.timer = setInterval(examTick, 1000);
}

/** æ¸²æŸ“è€ƒè¯•ç•Œé¢ */
function renderExamUI(p) {
  const isStrict = state.settings.mode === 'strict';
  const content  = document.getElementById('examContent');
  const sCode    = p.session === 'May/June' ? 'May/June' : p.session === 'Oct/Nov' ? 'Oct/Nov' : p.session;

  content.innerHTML = `
    <!-- ç§‘ç›®ä¿¡æ¯ -->
    <div class="flex items-center gap-3 mb-4">
      <div style="width:48px;height:48px;border-radius:14px;background:${p.subjectColor}22;display:flex;align-items:center;justify-content:center">
        <span class="mi" style="color:${p.subjectColor};font-size:26px">${p.subjectIcon}</span>
      </div>
      <div class="text-left">
        <div class="font-bold text-lg" style="color:${p.subjectColor}">${p.subject} Â· ${p.paper}</div>
        <div style="font-size:13px;color:rgba(255,255,255,.55)">${p.subjectName} Â· ${sCode} ${p.year}</div>
      </div>
    </div>

    <!-- è¯•å·è¯¦æƒ… -->
    <div style="font-size:14px;color:rgba(255,255,255,.45);margin-bottom:24px">
      ${p.paperFull} &nbsp;Â·&nbsp; ${p.totalMarks} åˆ†
    </div>

    <!-- å¤§è®¡æ—¶å™¨ -->
    <div class="timer-num" id="timerDisp">--:--</div>

    <!-- è¿›åº¦æ¡ -->
    <div class="exam-prog mt-6 mb-4" style="width:min(480px,80vw)">
      <div class="exam-prog-fill" id="examProgFill" style="width:100%"></div>
    </div>

    <!-- å‰©ä½™å¼ æ•° -->
    <div style="font-size:13px;color:rgba(255,255,255,.4);margin-bottom:28px">
      ç¬¬ ${examState.currentIdx + 1} / ${examState.queue.length} å¼  &nbsp;Â·&nbsp; ${p.duration} min
    </div>

    <!-- æ“ä½œæŒ‰é’®ï¼ˆä¸¥æ ¼æ¨¡å¼éšè—æš‚åœï¼‰-->
    <div class="flex gap-3">
      ${!isStrict ? `
        <button id="pauseBtn" onclick="togglePause()" class="btn" style="background:rgba(255,255,255,.12);color:white;padding:10px 24px">
          <span class="mi" style="font-size:18px">pause</span>&nbsp;æš‚åœ
        </button>
        <button onclick="resetTimer()" class="btn" style="background:rgba(255,255,255,.12);color:white;padding:10px 24px">
          <span class="mi" style="font-size:18px">replay</span>&nbsp;é‡ç½®
        </button>
      ` : ''}
      <button onclick="skipPaper()" class="btn" style="background:rgba(255,255,255,.08);color:rgba(255,255,255,.55);padding:10px 20px;font-size:12px">
        è·³è¿‡
      </button>
      <button onclick="confirmExitExam()" class="btn" style="background:rgba(234,67,53,.25);color:#F87171;padding:10px 20px;font-size:12px">
        ç»“æŸæ¨¡è€ƒ
      </button>
    </div>
  `;
  updateTimerDisplay();
}

/** è®¡æ—¶å™¨ tickï¼ˆæ¯ç§’æ‰§è¡Œï¼‰*/
function examTick() {
  if (examState.paused) return;
  examState.timeLeft--;
  updateTimerDisplay();

  if (examState.timeLeft <= 0) {
    clearInterval(examState.timer);
    onTimeUp();
  }
}

/** æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º */
function updateTimerDisplay() {
  const el = document.getElementById('timerDisp');
  const pb = document.getElementById('examProgFill');
  if (!el) return;

  el.textContent = fmtTime(examState.timeLeft);
  if (examState.timeLeft <= 60)  el.classList.add('timer-warn');
  else                            el.classList.remove('timer-warn');

  if (pb) {
    const pct = examState.totalTime > 0 ? (examState.timeLeft / examState.totalTime) * 100 : 0;
    pb.style.width = pct + '%';
  }
}

/** æš‚åœ/æ¢å¤ï¼ˆç»ƒä¹ æ¨¡å¼ï¼‰ */
function togglePause() {
  examState.paused = !examState.paused;
  const btn = document.getElementById('pauseBtn');
  if (btn) btn.innerHTML = examState.paused
    ? '<span class="mi" style="font-size:18px">play_arrow</span>&nbsp;ç»§ç»­'
    : '<span class="mi" style="font-size:18px">pause</span>&nbsp;æš‚åœ';
}

/** é‡ç½®å½“å‰è¯•å·è®¡æ—¶å™¨ */
function resetTimer() {
  const id = examState.queue[examState.currentIdx];
  const p  = paperDB.find(x => x.id === id);
  if (!p) return;
  examState.timeLeft = p.duration * 60;
  examState.paused   = false;
  updateTimerDisplay();
}

/** æ—¶é—´åˆ° */
function onTimeUp() {
  playBeep();
  const id = examState.queue[examState.currentIdx];
  const p  = paperDB.find(x => x.id === id);
  const spent = p ? p.duration * 60 : 0;
  recordResult(id, spent);

  // æ˜¾ç¤ºç»¿è‰²åº†ç¥
  const content = document.getElementById('examContent');
  content.innerHTML = `
    <div style="font-size:72px;animation:twarn 0s">âœ…</div>
    <h2 class="font-bold mt-4" style="font-size:32px;color:#4ade80">Time's Up!</h2>
    <p style="color:rgba(255,255,255,.55);margin-top:8px">${p?.subject} ${p?.paper} å®Œæˆï¼</p>
  `;

  setTimeout(() => nextPaper(), 2200);
}

/** è®°å½•ç»“æœ */
function recordResult(id, timeSpent) {
  state.paperStatus[id] = 'done';
  state.paperTimes[id]  = timeSpent;
  examState.results.push({ id, timeSpent });
  saveState();
}

/** è·³è¿‡å½“å‰è¯•å· */
function skipPaper() {
  const id = examState.queue[examState.currentIdx];
  const spent = examState.totalTime - examState.timeLeft;
  recordResult(id, spent);
  clearInterval(examState.timer);
  nextPaper();
}

/** ä¸‹ä¸€å¼ è¯•å· */
function nextPaper() {
  examState.currentIdx++;
  if (examState.currentIdx >= examState.queue.length) {
    endAllExams();
  } else {
    loadExamPaper();
  }
}

/** å…¨éƒ¨å®Œæˆï¼Œæ˜¾ç¤ºæ±‡æ€» */
function endAllExams() {
  clearInterval(examState.timer);
  document.removeEventListener('fullscreenchange', onFSChange);
  showSummary();
}

/** æ˜¾ç¤ºæ±‡æ€»é¡µ */
function showSummary() {
  const ov = document.getElementById('examOv');
  const content = document.getElementById('examContent');
  const totalSec = examState.results.reduce((s, r) => s + r.timeSpent, 0);

  content.innerHTML = `
    <div style="font-size:56px;margin-bottom:16px">ğŸ†</div>
    <h1 class="font-bold mb-1" style="font-size:28px;color:white">æ¨¡è€ƒå®Œæˆï¼</h1>
    <p style="color:rgba(255,255,255,.5);margin-bottom:32px;font-size:14px">
      å…±å®Œæˆ ${examState.results.length} å¼ å·å­ &nbsp;Â·&nbsp; ç´¯è®¡ ${fmtDuration(totalSec)}
    </p>

    <!-- æ¡å½¢å›¾ -->
    <div style="width:min(520px,90vw);margin-bottom:32px">
      ${examState.results.map(r => {
        const p   = paperDB.find(x => x.id === r.id);
        const pct = p ? Math.min(Math.round((r.timeSpent / (p.duration * 60)) * 100), 100) : 0;
        return `
          <div class="flex items-center gap-3 mb-3">
            <div class="text-right font-mono" style="width:72px;font-size:12px;color:rgba(255,255,255,.5);flex-shrink:0">${p?.subject} ${p?.paper}</div>
            <div style="flex:1;background:rgba(255,255,255,.1);border-radius:6px;height:28px;overflow:hidden">
              <div style="height:100%;border-radius:6px;width:${pct}%;background:${p?.subjectColor || '#1A73E8'};transition:width .7s ease"></div>
            </div>
            <div style="width:52px;font-size:11px;color:rgba(255,255,255,.45);flex-shrink:0">${fmtTime(r.timeSpent)}</div>
          </div>
        `;
      }).join('')}
    </div>

    <button onclick="closeExam()" class="btn btn-p" style="padding:12px 36px;font-size:15px">
      <span class="mi" style="font-size:18px">home</span>&nbsp;è¿”å›ä¸»é¡µ
    </button>
  `;
}

/** ç»“æŸæ¨¡è€ƒï¼Œé€€å‡ºå…¨å± */
function closeExam() {
  clearInterval(examState.timer);
  document.removeEventListener('fullscreenchange', onFSChange);
  document.getElementById('examOv').style.display = 'none';
  document.exitFullscreen?.().catch(err => { console.warn('é€€å‡ºå…¨å±å¤±è´¥:', err); });
  // æ¸…ç©ºæ¸…å•
  state.cart = [];
  saveState();
  updateCartBar();
  renderCards();
  updateProgress();
}

/** ç¡®è®¤é€€å‡º */
function confirmExitExam() {
  if (confirm('ç¡®å®šè¦æå‰ç»“æŸæ¨¡è€ƒå—ï¼Ÿå½“å‰è¿›åº¦å°†è¢«ä¿å­˜ã€‚')) {
    clearInterval(examState.timer);
    // ä¿å­˜å½“å‰æœªå®Œæˆçš„
    const id = examState.queue[examState.currentIdx];
    if (id) {
      const spent = examState.totalTime - examState.timeLeft;
      recordResult(id, spent);
    }
    endAllExams();
  }
}

/** ç›‘å¬å…¨å±å˜åŒ–ï¼ˆä¸¥æ ¼æ¨¡å¼è­¦å‘Šï¼‰ */
function onFSChange() {
  if (!document.fullscreenElement && state.settings.mode === 'strict') {
    const banner = document.getElementById('warnBanner');
    banner.classList.add('show');
    setTimeout(() => banner.classList.remove('show'), 5000);
  }
}

/** Web Audio API ç”Ÿæˆæç¤ºéŸ³ */
function playBeep() {
  try {
    const ctx  = new (window.AudioContext || window.webkitAudioContext)();
    const osc  = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.type = 'sine';
    osc.frequency.setValueAtTime(880, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.8);
    gain.gain.setValueAtTime(0.5, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.2);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 1.2);
  } catch (e) { console.warn('Web Audio æç¤ºéŸ³å¤±è´¥:', e); }
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                     SETTINGS                            â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** æ‰“å¼€è®¾ç½®æŠ½å±‰ */
function openSettings() {
  document.getElementById('settingsDr').classList.add('open');
  document.getElementById('settingsOv').classList.remove('hidden');
  updateSettingsUI();
}

/** å…³é—­è®¾ç½®æŠ½å±‰ */
function closeSettings() {
  document.getElementById('settingsDr').classList.remove('open');
  document.getElementById('settingsOv').classList.add('hidden');
}

/** åŒæ­¥è®¾ç½®ç•Œé¢çŠ¶æ€ */
function updateSettingsUI() {
  const mode = state.settings.mode;
  const ms   = document.getElementById('modeStrict');
  const mp   = document.getElementById('modePrac');
  if (ms && mp) {
    ms.style.background = mode === 'strict'   ? 'var(--primary)' : 'white';
    ms.style.color      = mode === 'strict'   ? 'white'          : 'var(--text-sub)';
    mp.style.background = mode === 'practice' ? 'var(--primary)' : 'white';
    mp.style.color      = mode === 'practice' ? 'white'          : 'var(--text-sub)';
  }
  // ç»Ÿè®¡æ•°å­—
  const done = Object.values(state.paperStatus).filter(v => v === 'done').length;
  const ttl  = paperDB.length;
  const secs = Object.values(state.paperTimes).reduce((a, b) => a + b, 0);
  const el1  = document.getElementById('statDone');
  const el2  = document.getElementById('statTotal');
  const el3  = document.getElementById('statTime');
  if (el1) el1.textContent = done;
  if (el2) el2.textContent = ttl;
  if (el3) el3.textContent = fmtDuration(secs);
}

/** åˆ‡æ¢è€ƒè¯•æ¨¡å¼ */
function setMode(m) {
  state.settings.mode = m;
  saveState();
  updateSettingsUI();
  showToast(m === 'strict' ? 'âš¡ ä¸¥æ ¼æ¨¡å¼å·²å¯ç”¨' : 'ğŸ“ ç»ƒä¹ æ¨¡å¼å·²å¯ç”¨');
}

/** åˆ‡æ¢ä¸»é¢˜ï¼ˆå ä½ï¼‰ */
function toggleTheme() {}

/** ç¡®è®¤é‡ç½®è¿›åº¦ */
function confirmReset() {
  if (confirm('âš ï¸ ç¡®å®šè¦é‡ç½®æ‰€æœ‰è¿›åº¦å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
    state.paperStatus = {};
    state.paperTimes  = {};
    state.cart        = [];
    saveState();
    updateCartBar();
    renderCards();
    updateProgress();
    updateSettingsUI();
    closeSettings();
    showToast('âœ… æ‰€æœ‰è¿›åº¦å·²é‡ç½®');
  }
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                  MOBILE FILTER SHEET                    â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openMobileFilter() {
  document.getElementById('mobileFilterOv').classList.remove('hidden');
  const sheet = document.getElementById('mobileFilterSheet');
  sheet.style.transform = 'translateY(0)';
  // æ¸²æŸ“ç­›é€‰é€‰é¡¹åˆ°ç§»åŠ¨ç«¯é¢æ¿
  const mob = document.getElementById('mobileFilterSections');
  mob.innerHTML = document.getElementById('filterSections').innerHTML;
  // é‡æ–°ç»‘å®šäº‹ä»¶ï¼ˆé€šè¿‡ onclick å±æ€§å·²å†…è”ï¼Œæ— éœ€é¢å¤–ç»‘å®šï¼‰
}

function closeMobileFilter() {
  document.getElementById('mobileFilterOv').classList.add('hidden');
  document.getElementById('mobileFilterSheet').style.transform = 'translateY(100%)';
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                    UTILITIES                            â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** æ ¼å¼åŒ–ç§’æ•°ä¸º MM:SS */
function fmtTime(sec) {
  if (sec < 0) sec = 0;
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

/** æ ¼å¼åŒ–ç§’æ•°ä¸º Xh Ymin */
function fmtDuration(sec) {
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  return h > 0 ? `${h}h ${m}min` : `${m}min`;
}

/** åŠ¨æ€è·å–å¹¶æ˜¾ç¤ºå½“å‰æ—¥æœŸ */
function updateDate() {
  const now = new Date();
  const opts = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' };
  document.getElementById('dateDisp').textContent = now.toLocaleDateString('zh-CN', opts);
}

/** Toast æç¤º */
let toastTimer = null;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2400);
}

/** AppBar æ»šåŠ¨é˜´å½± */
function initScrollShadow() {
  window.addEventListener('scroll', () => {
    document.getElementById('appbar').classList.toggle('scrolled', window.scrollY > 4);
  }, { passive: true });
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                   INITIALIZATION                        â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function init() {
  paperDB = generatePaperDB();    // ç”Ÿæˆè¯•å·æ•°æ®åº“
  loadState();                    // ä» LocalStorage åŠ è½½çŠ¶æ€
  updateDate();                   // æ›´æ–°æ—¥æœŸ
  renderFilterPanel();            // æ¸²æŸ“ç­›é€‰é¢æ¿
  applyFilters();                 // é¦–æ¬¡æ¸²æŸ“å¡ç‰‡
  updateCartBar();                // åˆå§‹åŒ– cart bar
  updateProgress();               // æ›´æ–°è¿›åº¦åœ†ç¯
  initScrollShadow();             // ç»‘å®šæ»šåŠ¨äº‹ä»¶

  // æ¢å¤æ¸…å•ï¼ˆè‹¥é¡µé¢åˆ·æ–°å cart éç©ºï¼‰
  if (state.cart.length > 0) {
    showToast(`ğŸ“‹ æ¸…å•ä¸­è¿˜æœ‰ ${state.cart.length} å¼ å·å­`);
  }

  // Gacha å…³é—­ç‚¹å‡»å¤–éƒ¨
  document.getElementById('gachaModal').addEventListener('click', e => {
    if (e.target === document.getElementById('gachaModal')) closeGacha();
  });
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
