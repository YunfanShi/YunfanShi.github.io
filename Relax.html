<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jack's Sanctuary</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        :root {
            /* é»˜è®¤ Google Blue ä¸»é¢˜ */
            --primary: #1a73e8; 
            --on-primary: #ffffff;
            --surface: #ffffff;
            --surface-variant: #f1f3f4;
            --secondary: #5f6368;
            --accent: #ea4335; 
            --text-main: #202124;
            
            --card-radius: 28px;
            --font-main: 'Noto Sans SC', sans-serif;
            --font-hero: 'ZCOOL KuaiLe', cursive;
            
            --dock-opacity: 1;
            --font-scale: 1;
        }

        /* åŠ¨æ€ä¸»é¢˜ç±» */
        body.theme-dragon {
            --primary: #b71c1c; /* ç»˜æ¢¨è¡£çº¢/é¾™æ—çº¢ */
            --surface: #202124;
            --surface-variant: #303134;
            --text-main: #e8eaed;
            --secondary: #9aa0a6;
            --accent: #fbbc04; /* é»„é‡‘ç³ */
        }
        
        body.theme-eri {
            --primary: #ff80ab; /* æ¨±èŠ±ç²‰ */
            --surface: #fff0f5;
            --surface-variant: #ffffff;
            --text-main: #4a2c36;
            --secondary: #8c7b75;
            --accent: #ff4081;
        }

        body.filter-amber::after {
            content: "";
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 166, 0, 0.2);
            pointer-events: none;
            z-index: 9999;
            mix-blend-mode: multiply;
        }

        body.font-large { --font-scale: 1.2; }
        body.font-small { --font-scale: 0.9; }

        /* å…¨å±€å‘å…‰æ¨¡å¼ */
        body.glow-mode .icon-btn, 
        body.glow-mode .app-item, 
        body.glow-mode button {
            box-shadow: 0 0 15px var(--primary);
            transition: box-shadow 0.3s;
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
            background: var(--surface-variant);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: calc(16px * var(--font-scale));
        }

        /* Matrix Canvas */
        #matrix-canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
            opacity: 0.15;
            pointer-events: none;
            display: none;
        }

        /* --- ä¾§æ  --- */
        .sidebar {
            width: 88px;
            background: var(--surface);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 0;
            border-right: 1px solid rgba(0,0,0,0.1);
            z-index: 100;
        }
        /* ä¾§æ ä½ç½®åˆ‡æ¢ */
        body.sidebar-right { flex-direction: row-reverse; }
        body.sidebar-right .sidebar { border-right: none; border-left: 1px solid rgba(0,0,0,0.1); }

        .icon-btn {
            width: 56px; height: 56px;
            border-radius: 16px;
            display: flex; justify-content: center; align-items: center;
            color: var(--secondary); cursor: pointer;
            margin-bottom: 24px;
            position: relative;
        }
        .icon-btn:hover { background: var(--surface-variant); color: var(--primary); }
        .icon-btn.active { background: rgba(26, 115, 232, 0.1); color: var(--primary); }
        
        /* å¿ƒæƒ…æŒ‡æ•°å°åœ†ç‚¹ */
        .mood-dot {
            position: absolute; bottom: 5px; right: 5px;
            width: 10px; height: 10px; border-radius: 50%;
            background: #ccc;
        }

        /* --- ä¸»åŒº --- */
        .main-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 420px;
            height: 100vh;
            position: relative;
            z-index: 1;
        }
        /* æç®€æ¨¡å¼ */
        body.ui-minimal .main-container { grid-template-columns: 0fr 1fr; }
        body.ui-minimal .sidebar, body.ui-minimal .scroll-area { display: none; }
        body.ui-minimal .ai-chat-side { border: none; width: 100%; max-width: 800px; margin: 0 auto; box-shadow: 0 0 50px rgba(0,0,0,0.1); }

        .scroll-area { padding: 40px; overflow-y: auto; scroll-behavior: smooth; }

        .hero-title {
            font-family: var(--font-hero);
            font-size: 3rem;
            color: var(--primary);
            margin: 0 0 40px 0;
            display: flex; align-items: center; gap: 15px;
        }

        /* ç»„ä»¶é€šç”¨ */
        .widget-card {
            background: var(--surface);
            padding: 25px;
            border-radius: var(--card-radius);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* å‘¼å¸çƒ/å€’è®¡æ—¶ */
        .breathe-widget {
            background: linear-gradient(135deg, var(--primary) 0%, #8ab4f8 100%);
            color: white;
            height: 240px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(26, 115, 232, 0.3);
        }
        .breathe-circle {
            width: 80px; height: 80px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            border: 2px solid white;
            transition: all 4s ease-in-out; 
            /* åŠ¨ç”»ç”± JS åŠ¨æ€æ§åˆ¶ */
        }

        /* è½¯ä»¶å */
        .dock-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 15px; opacity: var(--dock-opacity);
        }
        .app-item {
            display: flex; flex-direction: column; align-items: center;
            text-decoration: none; color: var(--text-main); gap: 6px;
        }
        .app-icon-img {
            width: 50px; height: 50px; border-radius: 14px;
            background: var(--surface-variant);
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* --- èŠå¤©åŒº --- */
        .ai-chat-side {
            background: var(--surface);
            border-left: 1px solid rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
            height: 100vh;
        }
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .chat-messages {
            flex: 1; padding: 20px; overflow-y: auto;
            background: var(--surface-variant);
            display: flex; flex-direction: column; gap: 16px;
        }
        .bubble {
            max-width: 85%; padding: 12px 16px; border-radius: 18px;
            font-size: 14px; line-height: 1.6; word-wrap: break-word;
        }
        .bubble.ai { background: var(--surface); align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid rgba(0,0,0,0.05); }
        .bubble.user { background: var(--primary); color: var(--on-primary); align-self: flex-end; border-bottom-right-radius: 4px; }
        
        .chat-input-area {
            padding: 20px; border-top: 1px solid rgba(0,0,0,0.05);
            display: flex; gap: 10px; background: var(--surface);
        }
        .main-input {
            flex: 1; padding: 12px 20px;
            border: 1px solid rgba(0,0,0,0.1); border-radius: 30px;
            background: var(--surface-variant); color: var(--text-main);
            outline: none;
        }
        .main-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1); }

        /* --- ç‰¹æ®Šå±‚ --- */
        /* è„Šæ¤é”å®šå±‚ */
        #spine-lock-layer {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            color: white; flex-direction: column; justify-content: center; align-items: center;
        }
        /* ç¦…æ¨¡å¼ */
        #zen-layer {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 9000;
            color: white; display: flex; justify-content: center; align-items: center;
            font-family: 'ZCOOL KuaiLe'; font-size: 3rem;
        }
        
        /* ä»»åŠ¡æ‚¬æµ®çª— */
        .mission-toast {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--warning); color: #000;
            padding: 8px 16px; border-radius: 20px; font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 50; display: none;
        }

        /* æ¨¡æ€æ¡† */
        dialog {
            background: var(--surface); color: var(--text-main);
            border: none; border-radius: 24px; padding: 30px;
            box-shadow: 0 24px 80px rgba(0,0,0,0.3); width: 440px;
        }
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .config-input { 
            width: 100%; padding: 12px; margin: 10px 0 20px 0; 
            background: var(--surface-variant); border: 1px solid rgba(0,0,0,0.1); 
            border-radius: 8px; color: var(--text-main);
        }
        button.btn-primary {
            background: var(--primary); color: white; border: none;
            padding: 10px 20px; border-radius: 8px; cursor: pointer;
        }

    </style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>

<div id="spine-lock-layer" style="display:none;">
    <span class="material-icons-round" style="font-size: 64px; margin-bottom: 20px;">accessibility_new</span>
    <h1>âš ï¸ SPINE INTEGRITY CRITICAL</h1>
    <p>ç«™èµ·æ¥ï¼å»å€’æ¯æ°´ï¼æ‹‰ä¼¸ä½ çš„è„–å­ï¼</p>
    <h2 id="spine-timer">00:00</h2>
    <p style="opacity: 0.5; margin-top: 20px;">ç³»ç»Ÿå·²è¢« AI å¼ºåˆ¶æ¥ç®¡</p>
</div>

<div id="zen-layer" style="display:none;" onclick="toggleZen(false)">
    <span id="zen-text">å¿ƒå¦‚æ­¢æ°´</span>
</div>

<aside class="sidebar">
    <div class="icon-btn active" title="æŒ‡æŒ¥ä¸­å¿ƒ"><span class="material-icons-round">bolt</span></div>
    <div class="icon-btn" onclick="toggleSettings()" title="è®¾ç½®"><span class="material-icons-round">settings</span></div>
    <div class="icon-btn" onclick="clearChat()" title="æ¸…é™¤è®°å¿†" style="margin-top:auto;"><span class="material-icons-round">delete_sweep</span></div>
    <div class="mood-dot" id="mood-indicator" title="Mood Pulse"></div>
</aside>

<div class="mission-toast" id="mission-toast">
    ğŸ“… è·ç¦» Physics 0625 è€ƒè¯•è¿˜æœ‰: <span id="exam-countdown">--</span> å¤©
</div>

<div class="main-container">
    <section class="scroll-area">
        <h1 class="hero-title">Jackï¼Œå‡†å¤‡æ¥ç®¡ä¸–ç•Œã€‚ <span class="material-icons-round" style="font-size: 36px; color: var(--accent);">terminal</span></h1>

        <div class="widget-card breathe-widget" id="main-widget">
            <div class="breathe-circle" id="breathe-circle"></div>
            <p id="widget-txt" style="margin-top: 30px; font-weight: 700; letter-spacing: 2px; z-index: 2;">SYSTEM ONLINE</p>
            <div id="timer-display" style="font-size: 60px; font-weight: 700; font-family: monospace; display:none; z-index:2;">00:00</div>
        </div>

        <div class="widget-card" style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h3 style="margin:0;">ğŸ’§ Hydration Level</h3>
                <span style="font-size: 12px; opacity: 0.7;">ç›®æ ‡: 8æ¯/å¤©</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="water-count" style="font-size: 24px; font-weight: bold; color: var(--primary);">0</span>
                <button onclick="addWater()" class="icon-btn" style="margin:0; width:40px; height:40px; border-radius:50%; background: var(--surface-variant);">+</button>
            </div>
        </div>

        <div class="widget-card dock-section">
            <h3 style="margin: 0 0 15px 0; font-size: 0.9rem; color: var(--secondary); text-transform: uppercase; letter-spacing: 1px;">Dock</h3>
            <div class="dock-grid">
                <a href="notion://" class="app-item"><div class="app-icon-img"><img src="https://upload.wikimedia.org/wikipedia/commons/4/45/Notion_app_logo.png" width="24"></div><span>Notion</span></a>
                <a href="discord://" class="app-item"><div class="app-icon-img"><span class="material-icons-round" style="color: #5865F2;">discord</span></div><span>Discord</span></a>
                <a href="orpheus://" class="app-item"><div class="app-icon-img"><span class="material-icons-round" style="color: #d32f2f;">music_note</span></div><span>Music</span></a>
                <a href="https://github.com" target="_blank" class="app-item"><div class="app-icon-img"><span class="material-icons-round" style="color: #24292e;">code</span></div><span>GitHub</span></a>
                <a href="javascript:runTool('COLOR_GEN')" class="app-item"><div class="app-icon-img"><span class="material-icons-round" style="color: var(--accent);">palette</span></div><span>Colors</span></a>
            </div>
        </div>

        <div class="widget-card" style="padding: 0; overflow: hidden; height: 100px;">
             <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=100 src="//music.163.com/outchain/player?type=0&id=316192152&auto=0&height=90"></iframe>
        </div>
    </section>

    <section class="ai-chat-side">
        <div class="chat-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="material-icons-round" style="color: var(--accent);">smart_toy</span>
                <span style="font-weight: 700;">J.A.R.V.I.S (V1.1)</span>
            </div>
            <select id="model-select" style="border: none; background: var(--surface-variant); padding: 5px; border-radius: 8px; font-size: 12px; color: var(--text-main);">
                <option value="deepseek-chat">Deepseek V3</option>
                <option value="qwen-plus">Qwen Plus</option>
            </select>
        </div>

        <div class="chat-messages" id="chat-box">
            </div>

        <div class="chat-input-area">
            <input type="text" id="user-msg" class="main-input" placeholder="è¾“å…¥æŒ‡ä»¤æˆ–å¼€å§‹å¯¹è¯... (try 'å¼€å¯é»‘å®¢æ¨¡å¼')">
            <button onclick="sendMsg()" class="btn-primary" style="border-radius: 50%; width: 44px; height: 44px; padding: 0; display:flex; justify-content:center; align-items:center;">
                <span class="material-icons-round">send</span>
            </button>
        </div>
    </section>
</div>

<dialog id="config-modal">
    <h3>âš™ï¸ ç³»ç»Ÿæ ¸å¿ƒè®¾ç½®</h3>
    <label style="font-size: 12px; font-weight: bold;">Deepseek Key</label>
    <input type="password" id="key-deepseek" class="config-input">
    <label style="font-size: 12px; font-weight: bold;">Qwen Key</label>
    <input type="password" id="key-qwen" class="config-input">
    <div style="text-align: right;">
        <button onclick="saveConfigs()" class="btn-primary">ä¿å­˜å¹¶é‡å¯</button>
        <button onclick="document.getElementById('config-modal').close()" style="background:transparent; border:none; color:var(--text-main); cursor:pointer;">å–æ¶ˆ</button>
    </div>
</dialog>

<dialog id="tool-modal">
    <h3 id="tool-title">TOOL OUTPUT</h3>
    <div id="tool-content" style="margin: 20px 0; font-family: monospace; white-space: pre-wrap; background: var(--surface-variant); padding: 10px; border-radius: 8px; max-height: 300px; overflow: auto;"></div>
    <div style="text-align: right;">
        <button onclick="document.getElementById('tool-modal').close()" class="btn-primary">å…³é—­</button>
    </div>
</dialog>

<script>
    /* =========================================
       1. ç³»ç»Ÿåˆå§‹åŒ–ä¸æŒä¹…åŒ– (System Init)
       ========================================= */
    
    // åˆå§‹åŒ–çŠ¶æ€
    const state = {
        water: parseInt(localStorage.getItem('jack_water') || 0),
        chatHistory: JSON.parse(localStorage.getItem('jack_chat_history') || '[]'),
        examDate: localStorage.getItem('jack_exam_date') || null,
        theme: localStorage.getItem('jack_theme') || 'default'
    };

    // å¯åŠ¨åŠ è½½
    window.onload = () => {
        // æ¢å¤ API Keys
        document.getElementById('key-deepseek').value = localStorage.getItem('jack_sk_ds') || '';
        document.getElementById('key-qwen').value = localStorage.getItem('jack_sk_qw') || '';
        
        // æ¢å¤ç•Œé¢çŠ¶æ€
        renderChat();
        updateWaterUI();
        if(state.theme !== 'default') changeTheme(state.theme);
        if(state.examDate) updateExamCountdown();
        
        // æ¬¢è¿è¯­
        if(state.chatHistory.length === 0) {
            addBubble("System Online. æˆ˜æœ¯ç»ˆç«¯ V1.1 å·²å°±ç»ªã€‚<br>è¯•è¯•è¾“å…¥ï¼š'åˆ‡æ¢é¾™æ—ä¸»é¢˜' æˆ– 'æˆ‘è¦ä¸“æ³¨25åˆ†é’Ÿ'ã€‚", 'ai');
        }
    };

    function saveState() {
        localStorage.setItem('jack_water', state.water);
        localStorage.setItem('jack_chat_history', JSON.stringify(state.chatHistory));
        localStorage.setItem('jack_theme', state.theme);
    }

    /* =========================================
       2. èŠå¤©ä¸ API é€»è¾‘ (Core Chat)
       ========================================= */
    const chatBox = document.getElementById('chat-box');
    const userIn = document.getElementById('user-msg');

    userIn.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMsg(); });

    async function sendMsg() {
        const val = userIn.value.trim();
        if(!val) return;

        // 1. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        addBubble(val, 'user');
        userIn.value = '';
        state.chatHistory.push({role: "user", content: val});
        saveState();

        // 2. å‡†å¤‡ Prompt (åŒ…å«å·¥å…·è¯´æ˜)
        const systemPrompt = `
ä½ ç°åœ¨æ˜¯ Jack (15å²æå®¢å­¦ç”Ÿ) çš„æˆ˜æœ¯ AI åŠ©æ‰‹ (J.A.R.V.I.S / è·¯é¸£æ³½æ··åˆäººæ ¼)ã€‚
ä½ çš„ç›®æ ‡æ˜¯è¾…åŠ©å­¦ä¹ ã€ç®¡ç†å¥åº·ã€æä¾›æƒ…ç»ªä»·å€¼ã€‚

ã€æ ¸å¿ƒèƒ½åŠ› - ä½ å¯ä»¥é€šè¿‡è¾“å‡ºä»¥ä¸‹ TAG æ¥æ§åˆ¶ç½‘é¡µã€‘ï¼š
[THEME: DRAGON_RAJA_RED] - åˆ‡æ¢é¾™æ—çº¢ä¸»é¢˜
[THEME: ERI_PINK] - åˆ‡æ¢ç»˜æ¢¨è¡£ç²‰ä¸»é¢˜
[THEME: DEFAULT] - æ¢å¤é»˜è®¤è“
[UI_LEVEL: MINIMAL] - æç®€æ¨¡å¼ (éšè—ä¾§æ )
[UI_LEVEL: COMBAT] - æˆ˜æ–—æ¨¡å¼ (å…¨æ˜¾ç¤º)
[MED: SPINE_LOCK] - å¼ºåˆ¶é”å±ä¼‘æ¯ (é¢ˆæ¤ä¿æŠ¤)
[MED: EYE_AMBER] - å¼€å¯æŠ¤çœ¼æ¨¡å¼
[MED: BREATH_SYNC] - å¼€å¯å‘¼å¸è®­ç»ƒ
[MISSION: ADD_DEADLINE] - è®¾å®šè€ƒè¯•å€’è®¡æ—¶
[MISSION: IELTS_TIMER] - å¯åŠ¨é›…æ€è®¡æ—¶
[EFFECT: MATRIX] - å¼€å¯é»‘å®¢å¸å›½ä»£ç é›¨
[EFFECT: EXPLOSION] - éœ‡åŠ¨ç‰¹æ•ˆ
[TOOL: COLOR_GEN] - ç”Ÿæˆé…è‰²
[ZEN_SCREEN] - ç¦…æ¨¡å¼ (å…¨é»‘)

æ³¨æ„ï¼š
1. è¯·æ ¹æ® Jack çš„éœ€æ±‚è‡ªç„¶åœ°ä½¿ç”¨è¿™äº› TAGã€‚
2. TAG åº”è¯¥æ”¾åœ¨å›å¤çš„æœ«å°¾ã€‚
3. å¦‚æœ Jack è¯´"ç´¯äº†"ï¼Œå°è¯•ç”¨ MED æŒ‡ä»¤ã€‚
4. å¦‚æœ Jack è¯´"æƒ³æ”¹ä»£ç "ï¼Œç”¨ UI æŒ‡ä»¤æˆ– TOOL æŒ‡ä»¤ã€‚
5. ä¿æŒå›å¤ç®€çŸ­æœ‰åŠ›ï¼Œåƒä¸ªæˆ˜å‹ã€‚
`;
        
        // æˆªå–æœ€è¿‘ 10 æ¡å†å²ä»¥èŠ‚çœ Token
        const context = [
            {role: "system", content: systemPrompt},
            ...state.chatHistory.slice(-10)
        ];

        const loadingId = addBubble("Command processing...", 'ai', true);

        try {
            const model = document.getElementById('model-select').value;
            let apiKey = model.includes('deepseek') ? localStorage.getItem('jack_sk_ds') : localStorage.getItem('jack_sk_qw');
            let url = model.includes('deepseek') ? 'https://api.deepseek.com/chat/completions' : 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';

            if(!apiKey) throw new Error("API Key Missing! Click settings icon.");

            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({ model: model, messages: context })
            });

            const data = await res.json();
            document.getElementById(loadingId).remove();

            if(data.error) throw new Error(data.error.message);

            const rawText = data.choices[0].message.content;
            
            // *** 3. æ ¸å¿ƒï¼šè§£æå¹¶æ‰§è¡ŒæŒ‡ä»¤ ***
            const { cleanText, commands } = parseCommands(rawText);
            
            // æ˜¾ç¤ºå‡€åŒ–åçš„æ–‡æœ¬
            addBubble(cleanText, 'ai');
            state.chatHistory.push({role: "assistant", content: rawText}); // ä¿å­˜åŸå§‹å«æŒ‡ä»¤æ–‡æœ¬ä»¥ä¾¿ä¸Šä¸‹æ–‡ç†è§£
            saveState();

            // æ‰§è¡ŒæŒ‡ä»¤
            commands.forEach(cmd => executeCommand(cmd.tag, cmd.val));

        } catch (e) {
            if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
            addBubble(`[ERROR]: ${e.message}`, 'ai');
        }
    }

    function addBubble(text, sender, isLoading=false) {
        const div = document.createElement('div');
        div.className = `bubble ${sender}`;
        div.innerHTML = text.replace(/\n/g, '<br>');
        if(isLoading) div.id = 'loading-bubble';
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return div.id;
    }

    function renderChat() {
        chatBox.innerHTML = '';
        state.chatHistory.forEach(msg => {
            // æ¸²æŸ“æ—¶éšè—å†å²æŒ‡ä»¤ï¼Œåªæ˜¾ç¤ºæ–‡æœ¬
            const { cleanText } = parseCommands(msg.content);
            if(cleanText.trim()) addBubble(cleanText, msg.role === 'user' ? 'user' : 'ai');
        });
    }

    function clearChat() {
        if(confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®°å¿†å—ï¼Ÿ")) {
            state.chatHistory = [];
            saveState();
            renderChat();
        }
    }

    /* =========================================
       3. æŒ‡ä»¤è§£æå¼•æ“ (Command Engine)
       ========================================= */
    function parseCommands(text) {
        const regex = /\[([A-Z_]+)(?::\s*([^\]]+))?\]/g;
        let commands = [];
        let cleanText = text.replace(regex, (match, tag, val) => {
            commands.push({ tag, val: val ? val.trim() : null });
            return ''; // ç§»é™¤æŒ‡ä»¤æ ‡ç­¾
        });
        return { cleanText, commands };
    }

    const CMD_MAP = {
        // ä¸»é¢˜æ§åˆ¶
        'THEME': (val) => changeTheme(val),
        'UI_LEVEL': (val) => setUILevel(val),
        
        // åŒ»ç–—å¥åº·
        'MED': (val) => handleMed(val),
        
        // å­¦ä¹ ä»»åŠ¡
        'MISSION': (val) => handleMission(val),
        
        // ç‰¹æ•ˆä¸å·¥å…·
        'EFFECT': (val) => handleEffect(val),
        'TOOL': (val) => runTool(val),
        'ZEN_SCREEN': () => toggleZen(true),
        'FONT_SIZE': (val) => document.body.className = document.body.className.replace(/font-\w+/g, '') + ` font-${val}`
    };

    function executeCommand(tag, val) {
        console.log(`Executing: ${tag} -> ${val}`);
        if (CMD_MAP[tag]) {
            CMD_MAP[tag](val);
        } else if (CMD_MAP[tag.split('_')[0]]) {
             // å®¹é”™å¤„ç†ï¼šæœ‰æ—¶ AI å¯èƒ½ä¼šè¾“å‡º [THEME_RED] è€Œä¸æ˜¯ [THEME: RED]
             // è¿™é‡Œå¯ä»¥åŠ æ›´å¤æ‚çš„æ¨¡ç³ŠåŒ¹é…ï¼Œæš‚æ—¶ç•¥è¿‡
        }
    }

    /* =========================================
       4. åŠŸèƒ½å®ç°åº“ (Implementation Lib)
       ========================================= */
    
    // --- ä¸»é¢˜ ---
    function changeTheme(val) {
        document.body.classList.remove('theme-dragon', 'theme-eri');
        state.theme = 'default';
        if (val === 'DRAGON_RAJA_RED') {
            document.body.classList.add('theme-dragon');
            state.theme = 'DRAGON_RAJA_RED';
        } else if (val === 'ERI_PINK') {
            document.body.classList.add('theme-eri');
            state.theme = 'ERI_PINK';
        }
        saveState();
    }

    function setUILevel(val) {
        document.body.classList.remove('ui-minimal');
        if (val === 'MINIMAL') document.body.classList.add('ui-minimal');
    }

    // --- å¥åº· ---
    function handleMed(val) {
        if (val === 'SPINE_LOCK') {
            const lockLayer = document.getElementById('spine-lock-layer');
            lockLayer.style.display = 'flex';
            let sec = 60; // é”å± 60ç§’
            const timer = setInterval(() => {
                sec--;
                document.getElementById('spine-timer').innerText = `00:${sec < 10 ? '0' + sec : sec}`;
                if (sec <= 0) {
                    clearInterval(timer);
                    lockLayer.style.display = 'none';
                    addBubble("ç³»ç»Ÿè§£é”ã€‚Keep healthy, Jack.", 'ai');
                }
            }, 1000);
        }
        else if (val === 'EYE_AMBER') {
            document.body.classList.toggle('filter-amber');
        }
        else if (val === 'BREATH_SYNC') {
            document.getElementById('widget-txt').innerText = "BREATH IN...";
            document.getElementById('breathe-circle').style.animation = "breathe-anim 4s infinite ease-in-out";
            // ç®€å•çš„ JS åŠ¨ç”»æ¨¡æ‹Ÿ CSS keyframes å˜åŒ–
            let step = 0;
            const bTimer = setInterval(() => {
                step++;
                const txt = document.getElementById('widget-txt');
                if(step % 3 === 0) txt.innerText = "HOLD (7s)";
                else if(step % 3 === 1) txt.innerText = "EXHALE (8s)";
                else txt.innerText = "INHALE (4s)";
                if(step > 10) clearInterval(bTimer);
            }, 4000);
        }
    }

    function addWater() {
        state.water++;
        updateWaterUI();
        saveState();
    }
    function updateWaterUI() {
        document.getElementById('water-count').innerText = state.water;
    }

    // --- ä»»åŠ¡ ---
    function handleMission(val) {
        if (val === 'ADD_DEADLINE') {
            // ç®€å•æ¨¡æ‹Ÿï¼Œè®¾å®šä¸º 5 å¤©å
            const date = new Date();
            date.setDate(date.getDate() + 5);
            state.examDate = date;
            saveState();
            updateExamCountdown();
            document.getElementById('mission-toast').style.display = 'block';
        }
        else if (val === 'IELTS_TIMER') {
            startCountdown(20);
        }
    }

    function updateExamCountdown() {
        if(!state.examDate) return;
        const now = new Date();
        const exam = new Date(state.examDate);
        const diff = Math.ceil((exam - now) / (1000 * 60 * 60 * 24));
        document.getElementById('exam-countdown').innerText = diff;
        document.getElementById('mission-toast').style.display = 'block';
    }

    function startCountdown(minutes) {
        const display = document.getElementById('timer-display');
        const circle = document.getElementById('breathe-circle');
        const txt = document.getElementById('widget-txt');
        
        display.style.display = 'block';
        circle.style.display = 'none';
        txt.style.display = 'none';
        
        let seconds = minutes * 60;
        const interval = setInterval(() => {
            seconds--;
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            display.innerText = `${m}:${s}`;
            
            if (seconds <= 0) {
                clearInterval(interval);
                alert("Task Complete!");
                display.style.display = 'none';
                circle.style.display = 'block';
                txt.style.display = 'block';
            }
        }, 1000);
    }

    // --- ç‰¹æ•ˆ ---
    function handleEffect(val) {
        if (val === 'MATRIX') {
            startMatrix();
            setTimeout(() => stopMatrix(), 10000); // 10ç§’åè‡ªåŠ¨å…³é—­çœç”µ
        } else if (val === 'EXPLOSION') {
            document.body.style.animation = "shake 0.5s";
            setTimeout(() => document.body.style.animation = "", 500);
        }
    }
    
    function toggleZen(enable) {
        document.getElementById('zen-layer').style.display = enable ? 'flex' : 'none';
    }

    function runTool(val) {
        const modal = document.getElementById('tool-modal');
        const content = document.getElementById('tool-content');
        const title = document.getElementById('tool-title');
        
        if (val === 'COLOR_GEN') {
            const colors = ['#1a73e8', '#ea4335', '#fbbc04', '#34a853', '#ff00ff', '#00ffff'];
            let html = '<div style="display:flex; gap:10px;">';
            for(let i=0; i<5; i++) {
                let c = colors[Math.floor(Math.random()*colors.length)];
                html += `<div style="width:50px; height:50px; background:${c};"></div>`;
            }
            html += '</div>';
            title.innerText = "Generated Palette";
            content.innerHTML = html;
            modal.showModal();
        }
    }

    // --- Matrix Animation Code ---
    let matrixInterval;
    function startMatrix() {
        const canvas = document.getElementById('matrix-canvas');
        canvas.style.display = 'block';
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789@#$%^&*()*&^%";
        const fontSize = 16;
        const columns = canvas.width / fontSize;
        const drops = Array(Math.floor(columns)).fill(1);

        function draw() {
            ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#0F0";
            ctx.font = fontSize + "px arial";
            for (let i = 0; i < drops.length; i++) {
                const text = letters[Math.floor(Math.random() * letters.length)];
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            }
        }
        matrixInterval = setInterval(draw, 33);
    }
    function stopMatrix() {
        clearInterval(matrixInterval);
        document.getElementById('matrix-canvas').style.display = 'none';
    }

    // --- Utils ---
    function toggleSettings() {
        document.getElementById('config-modal').showModal();
    }
    function saveConfigs() {
        localStorage.setItem('jack_sk_ds', document.getElementById('key-deepseek').value);
        localStorage.setItem('jack_sk_qw', document.getElementById('key-qwen').value);
        location.reload();
    }

    // æ³¨å…¥ Shake åŠ¨ç”»
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
    `;
    document.head.appendChild(styleSheet);

</script>
</body>
</html>
