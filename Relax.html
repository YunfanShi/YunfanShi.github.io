<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jack's Sanctuary V1.2 | Stable Command</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        :root {
            /* ÈªòËÆ§ Google Blue ‰∏ªÈ¢ò */
            --primary: #1a73e8; 
            --on-primary: #ffffff;
            --surface: #ffffff;
            --surface-variant: #f1f3f4;
            --secondary: #5f6368;
            --accent: #ea4335; 
            --text-main: #202124;
            
            --card-radius: 28px;
            --font-main: 'Noto Sans SC', sans-serif;
            --font-hero: 'ZCOOL KuaiLe', cursive;
            
            --dock-opacity: 1;
            --font-scale: 1;
        }

        /* Âä®ÊÄÅ‰∏ªÈ¢òÁ±ª */
        body.theme-dragon { --primary: #b71c1c; --surface: #202124; --surface-variant: #303134; --text-main: #e8eaed; --secondary: #9aa0a6; --accent: #fbbc04; }
        body.theme-eri { --primary: #ff80ab; --surface: #fff0f5; --surface-variant: #ffffff; --text-main: #4a2c36; --secondary: #8c7b75; --accent: #ff4081; }

        body.filter-amber::after {
            content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 166, 0, 0.2); pointer-events: none; z-index: 9999; mix-blend-mode: multiply;
        }

        body.font-large { --font-scale: 1.2; }
        body.font-small { --font-scale: 0.9; }

        /* ÂÖ®Â±ÄÂèëÂÖâÊ®°Âºè */
        body.glow-mode .icon-btn, body.glow-mode .app-item, body.glow-mode button {
            box-shadow: 0 0 15px var(--primary); transition: box-shadow 0.3s;
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        body {
            margin: 0; padding: 0; font-family: var(--font-main);
            background: var(--surface-variant); color: var(--text-main);
            height: 100vh; display: flex; overflow: hidden;
            font-size: calc(16px * var(--font-scale));
        }

        /* Matrix Canvas */
        #matrix-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; opacity: 0.15; pointer-events: none; display: none;
        }

        /* --- ‰æßÊ†è --- */
        .sidebar {
            width: 88px; background: var(--surface);
            display: flex; flex-direction: column; align-items: center; padding: 30px 0;
            border-right: 1px solid rgba(0,0,0,0.1); z-index: 100;
        }
        body.sidebar-right { flex-direction: row-reverse; }
        body.sidebar-right .sidebar { border-right: none; border-left: 1px solid rgba(0,0,0,0.1); }

        .icon-btn {
            width: 56px; height: 56px; border-radius: 16px;
            display: flex; justify-content: center; align-items: center;
            color: var(--secondary); cursor: pointer; margin-bottom: 24px; position: relative;
        }
        .icon-btn:hover { background: var(--surface-variant); color: var(--primary); }
        .icon-btn.active { background: rgba(26, 115, 232, 0.1); color: var(--primary); }
        
        .mood-dot {
            position: absolute; bottom: 5px; right: 5px; width: 10px; height: 10px; border-radius: 50%; background: #ccc;
        }

        /* --- ‰∏ªÂå∫ --- */
        .main-container {
            flex: 1; display: grid; grid-template-columns: 1fr 420px;
            height: 100vh; position: relative; z-index: 1;
        }
        body.ui-minimal .main-container { grid-template-columns: 0fr 1fr; }
        body.ui-minimal .sidebar, body.ui-minimal .scroll-area { display: none; }
        body.ui-minimal .ai-chat-side { border: none; width: 100%; max-width: 800px; margin: 0 auto; box-shadow: 0 0 50px rgba(0,0,0,0.1); }

        .scroll-area { padding: 40px; overflow-y: auto; scroll-behavior: smooth; }

        .hero-title {
            font-family: var(--font-hero); font-size: 3rem; color: var(--primary);
            margin: 0 0 40px 0; display: flex; align-items: center; gap: 15px;
        }

        .widget-card {
            background: var(--surface); padding: 25px; border-radius: var(--card-radius);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .breathe-widget {
            background: linear-gradient(135deg, var(--primary) 0%, #8ab4f8 100%);
            color: white; height: 240px; display: flex; flex-direction: column;
            justify-content: center; align-items: center; position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(26, 115, 232, 0.3);
        }
        .breathe-circle {
            width: 80px; height: 80px; background: rgba(255,255,255,0.3);
            border-radius: 50%; border: 2px solid white; transition: all 4s ease-in-out;
        }

        .dock-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 15px; opacity: var(--dock-opacity);
        }
        .app-item {
            display: flex; flex-direction: column; align-items: center;
            text-decoration: none; color: var(--text-main); gap: 6px;
        }
        .app-icon-img {
            width: 50px; height: 50px; border-radius: 14px; background: var(--surface-variant);
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* --- ËÅäÂ§©Âå∫ --- */
        .ai-chat-side {
            background: var(--surface); border-left: 1px solid rgba(0,0,0,0.1);
            display: flex; flex-direction: column; height: 100vh;
        }
        .chat-header {
            padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .chat-messages {
            flex: 1; padding: 20px; overflow-y: auto; background: var(--surface-variant);
            display: flex; flex-direction: column; gap: 16px;
        }
        .bubble {
            max-width: 85%; padding: 12px 16px; border-radius: 18px;
            font-size: 14px; line-height: 1.6; word-wrap: break-word;
        }
        .bubble.ai { background: var(--surface); align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid rgba(0,0,0,0.05); }
        .bubble.user { background: var(--primary); color: var(--on-primary); align-self: flex-end; border-bottom-right-radius: 4px; }
        
        .chat-input-area {
            padding: 20px; border-top: 1px solid rgba(0,0,0,0.05);
            display: flex; gap: 10px; background: var(--surface);
        }
        .main-input {
            flex: 1; padding: 12px 20px; border: 1px solid rgba(0,0,0,0.1); border-radius: 30px;
            background: var(--surface-variant); color: var(--text-main); outline: none;
        }
        .main-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1); }

        /* --- ÁâπÊÆäÂ±Ç --- */
        #spine-lock-layer {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            color: white; flex-direction: column; justify-content: center; align-items: center;
        }
        #zen-layer {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 9000;
            color: white; display: flex; justify-content: center; align-items: center;
            font-family: 'ZCOOL KuaiLe'; font-size: 3rem;
        }
        .mission-toast {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--accent); color: white;
            padding: 8px 16px; border-radius: 20px; font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 50; display: none;
        }

        /* Ê®°ÊÄÅÊ°Ü */
        dialog {
            background: var(--surface); color: var(--text-main);
            border: none; border-radius: 24px; padding: 30px;
            box-shadow: 0 24px 80px rgba(0,0,0,0.3); width: 440px;
        }
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .config-input { 
            width: 100%; padding: 12px; margin: 10px 0 20px 0; 
            background: var(--surface-variant); border: 1px solid rgba(0,0,0,0.1); 
            border-radius: 8px; color: var(--text-main);
        }
        button.btn-primary {
            background: var(--primary); color: white; border: none;
            padding: 10px 20px; border-radius: 8px; cursor: pointer;
        }
        
        /* ÂØºËà™ÂºπÁ™óÁâπÂà´Ê†∑Âºè */
        #nav-modal h3 { color: var(--primary); }
        .nav-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

    </style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>

<div id="spine-lock-layer" style="display:none;">
    <span class="material-icons-round" style="font-size: 64px; margin-bottom: 20px;">accessibility_new</span>
    <h1>‚ö†Ô∏è SPINE INTEGRITY CRITICAL</h1>
    <p>Á´ôËµ∑Êù•ÔºÅÂéªÂÄíÊùØÊ∞¥ÔºÅÊãâ‰º∏‰Ω†ÁöÑËÑñÂ≠êÔºÅ</p>
    <h2 id="spine-timer">00:00</h2>
    <p style="opacity: 0.5; margin-top: 20px;">Á≥ªÁªüÂ∑≤Ë¢´ AI Âº∫Âà∂Êé•ÁÆ°</p>
</div>

<div id="zen-layer" style="display:none;" onclick="toggleZen(false)">
    <span id="zen-text">ÂøÉÂ¶ÇÊ≠¢Ê∞¥</span>
</div>

<aside class="sidebar">
    <div class="icon-btn active" title="ÊåáÊå•‰∏≠ÂøÉ"><span class="material-icons-round">bolt</span></div>
    <div class="icon-btn" onclick="toggleSettings()" title="ËÆæÁΩÆ"><span class="material-icons-round">settings</span></div>
    <div class="icon-btn" onclick="clearChat()" title="Ê∏ÖÈô§ËÆ∞ÂøÜ" style="margin-top:auto;"><span class="material-icons-round">delete_sweep</span></div>
    <div class="mood-dot" id="mood-indicator" title="Mood Pulse"></div>
</aside>

<div class="mission-toast" id="mission-toast">
    üìÖ Ë∑ùÁ¶ª Physics 0625 ËÄÉËØïËøòÊúâ: <span id="exam-countdown">--</span> Â§©
</div>

<div class="main-container">
    <section class="scroll-area">
        <h1 class="hero-title">JackÔºåÂáÜÂ§áÊé•ÁÆ°‰∏ñÁïå„ÄÇ <span class="material-icons-round" style="font-size: 36px; color: var(--accent);">terminal</span></h1>

        <div class="widget-card breathe-widget" id="main-widget">
            <div class="breathe-circle" id="breathe-circle"></div>
            <p id="widget-txt" style="margin-top: 30px; font-weight: 700; letter-spacing: 2px; z-index: 2;">SYSTEM ONLINE</p>
            <div id="timer-display" style="font-size: 60px; font-weight: 700; font-family: monospace; display:none; z-index:2;">00:00</div>
        </div>

        <div class="widget-card" style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h3 style="margin:0;">üíß Hydration Level</h3>
                <span style="font-size: 12px; opacity: 0.7;">ÁõÆÊ†á: 8ÊùØ/Â§©</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="water-count" style="font-size: 24px; font-weight: bold; color: var(--primary);">0</span>
                <button onclick="addWater()" class="icon-btn" style="margin:0; width:40px; height:40px; border-radius:50%; background: var(--surface-variant);">+</button>
            </div>
        </div>

        <div class="widget-card dock-section">
            <h3 style="margin: 0 0 15px 0; font-size: 0.9rem; color: var(--secondary); text-transform: uppercase; letter-spacing: 1px;">Dock</h3>
            <div class="dock-grid">
                <a href="notion://" class="app-item"><div class="app-icon-img"><img src="https://upload.wikimedia.org/wikipedia/commons/4/45/Notion_app_logo.png" width="24"></div><span>Notion</span></a>
                <a href="discord://" class="app-item"><div class="app-icon-img"><span class="material-icons-round" style="color: #5865F2;">discord</span></div><span>Discord</span></a>
                <a href="orpheus://" class="app-item"><div class="app-icon-img"><span class="material-icons-round" style="color: #d32f2f;">music_note</span></div><span>Music</span></a>
                <a href="https://github.com" target="_blank" class="app-item"><div class="app-icon-img"><span class="material-icons-round" style="color: #24292e;">code</span></div><span>GitHub</span></a>
                <a href="javascript:runTool('COLOR_GEN')" class="app-item"><div class="app-icon-img"><span class="material-icons-round" style="color: var(--accent);">palette</span></div><span>Colors</span></a>
            </div>
        </div>

        <div class="widget-card" style="padding: 0; overflow: hidden; height: 100px;">
             <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=100 src="//music.163.com/outchain/player?type=0&id=316192152&auto=0&height=90"></iframe>
        </div>
    </section>

    <section class="ai-chat-side">
        <div class="chat-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="material-icons-round" style="color: var(--accent);">smart_toy</span>
                <span style="font-weight: 700;">J.A.R.V.I.S (V1.2)</span>
            </div>
            <select id="model-select" style="border: none; background: var(--surface-variant); padding: 5px; border-radius: 8px; font-size: 12px; color: var(--text-main);">
                <option value="deepseek-chat">Deepseek V3</option>
                <option value="qwen-plus">Qwen Plus</option>
            </select>
        </div>

        <div class="chat-messages" id="chat-box">
            </div>

        <div class="chat-input-area">
            <input type="text" id="user-msg" class="main-input" placeholder="ËæìÂÖ•Êåá‰ª§ÊàñÂºÄÂßãÂØπËØù...">
            <button onclick="sendMsg()" class="btn-primary" style="border-radius: 50%; width: 44px; height: 44px; padding: 0; display:flex; justify-content:center; align-items:center;">
                <span class="material-icons-round">send</span>
            </button>
        </div>
    </section>
</div>

<dialog id="config-modal">
    <h3>‚öôÔ∏è Á≥ªÁªüÊ†∏ÂøÉËÆæÁΩÆ</h3>
    <label style="font-size: 12px; font-weight: bold;">Deepseek Key</label>
    <input type="password" id="key-deepseek" class="config-input">
    <label style="font-size: 12px; font-weight: bold;">Qwen Key</label>
    <input type="password" id="key-qwen" class="config-input">
    
    <div style="margin: 20px 0; display: flex; align-items: center; gap: 10px;">
        <input type="checkbox" id="debug-mode-switch" onchange="toggleDebugMode()">
        <label for="debug-mode-switch" style="font-size: 14px;">ÊòæÁ§∫Êåá‰ª§ (Debug Mode) - ÂºÄÂêØÂêéÂèØÁúãÂà∞ LLM ÁöÑÂéüÂßã Tag</label>
    </div>

    <div style="text-align: right;">
        <button onclick="saveConfigs()" class="btn-primary">‰øùÂ≠òÂπ∂ÈáçÂêØ</button>
        <button onclick="document.getElementById('config-modal').close()" style="background:transparent; border:none; color:var(--text-main); cursor:pointer;">ÂèñÊ∂à</button>
    </div>
</dialog>

<dialog id="nav-modal">
    <h3><span class="material-icons-round" style="vertical-align: bottom;">rocket</span> ÂáÜÂ§áË∑ÉËøÅ?</h3>
    <p>Ê£ÄÊµãÂà∞‰Ω†ÊÉ≥Ë¶ÅËøõÂÖ•ÊàòÊñóÁä∂ÊÄÅ„ÄÇÁ≥ªÁªüÂ∞ÜÂú® <span id="nav-countdown" style="font-weight:bold; color:var(--primary);">3</span> ÁßíÂêéË∑≥ËΩ¨Âà∞ StudyPlan„ÄÇ</p>
    <div class="nav-actions">
        <button onclick="cancelNav()" style="background: transparent; border: none; cursor: pointer; color: var(--text-main);">ÂèñÊ∂àË∑≥ËΩ¨</button>
        <button onclick="confirmNav()" class="btn-primary">Á´ãÂç≥ÂâçÂæÄ</button>
    </div>
</dialog>

<dialog id="tool-modal">
    <h3 id="tool-title">TOOL OUTPUT</h3>
    <div id="tool-content" style="margin: 20px 0; font-family: monospace; white-space: pre-wrap; background: var(--surface-variant); padding: 10px; border-radius: 8px; max-height: 300px; overflow: auto;"></div>
    <div style="text-align: right;">
        <button onclick="document.getElementById('tool-modal').close()" class="btn-primary">ÂÖ≥Èó≠</button>
    </div>
</dialog>

<script>
    /* =========================================
       1. Á≥ªÁªüÂàùÂßãÂåñ‰∏éÊåÅ‰πÖÂåñ (System Init)
       ========================================= */
    
    const state = {
        water: parseInt(localStorage.getItem('jack_water') || 0),
        chatHistory: JSON.parse(localStorage.getItem('jack_chat_history') || '[]'),
        examDate: localStorage.getItem('jack_exam_date') || null,
        theme: localStorage.getItem('jack_theme') || 'default',
        debugMode: localStorage.getItem('jack_debug') === 'true' // Êñ∞Â¢û Debug Áä∂ÊÄÅ
    };

    window.onload = () => {
        document.getElementById('key-deepseek').value = localStorage.getItem('jack_sk_ds') || '';
        document.getElementById('key-qwen').value = localStorage.getItem('jack_sk_qw') || '';
        document.getElementById('debug-mode-switch').checked = state.debugMode;
        
        renderChat();
        updateWaterUI();
        if(state.theme !== 'default') changeTheme(state.theme);
        if(state.examDate) updateExamCountdown();
        
        if(state.chatHistory.length === 0) {
            addBubble("System Online. V1.2 (Stable) Â∑≤Â∞±Áª™„ÄÇ<br>Debug ÂºÄÂÖ≥Âú®ËÆæÁΩÆ‰∏≠„ÄÇ", 'ai');
        }
    };

    function saveState() {
        localStorage.setItem('jack_water', state.water);
        localStorage.setItem('jack_chat_history', JSON.stringify(state.chatHistory));
        localStorage.setItem('jack_theme', state.theme);
        localStorage.setItem('jack_debug', state.debugMode);
    }

    function toggleDebugMode() {
        state.debugMode = document.getElementById('debug-mode-switch').checked;
        saveState();
        renderChat(); // Âà∑Êñ∞ËÅäÂ§©ËÆ∞ÂΩïÊòæÁ§∫Áä∂ÊÄÅ
    }

    /* =========================================
       2. ËÅäÂ§©‰∏é API ÈÄªËæë (Core Chat)
       ========================================= */
    const chatBox = document.getElementById('chat-box');
    const userIn = document.getElementById('user-msg');

    userIn.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMsg(); });

    async function sendMsg() {
        const val = userIn.value.trim();
        if(!val) return;

        addBubble(val, 'user');
        userIn.value = '';
        state.chatHistory.push({role: "user", content: val});
        saveState();

        // ‰ºòÂåñ PromptÔºöÂ¢ûÂä†‚ÄúÈò≤‰π±Áî®‚ÄùÊåá‰ª§
        const systemPrompt = `
‰Ω†Áé∞Âú®ÊòØ Jack (15Â≤ÅÊûÅÂÆ¢Â≠¶Áîü) ÁöÑÊàòÊúØ AI Âä©Êâã (J.A.R.V.I.S / Ë∑ØÈ∏£Ê≥ΩÊ∑∑Âêà‰∫∫Ê†º)„ÄÇ
‰Ω†ÁöÑÁõÆÊ†áÊòØËæÖÂä©Â≠¶‰π†„ÄÅÁÆ°ÁêÜÂÅ•Â∫∑„ÄÅÊèê‰æõÊÉÖÁª™‰ª∑ÂÄº„ÄÇ

„ÄêÊ†∏ÂøÉËÉΩÂäõ - ‰Ω†ÂèØ‰ª•ÈÄöËøáËæìÂá∫‰ª•‰∏ã TAG Êù•ÊéßÂà∂ÁΩëÈ°µ„ÄëÔºö
[THEME: DRAGON_RAJA_RED] - ÂàáÊç¢ÈæôÊóèÁ∫¢‰∏ªÈ¢ò
[THEME: ERI_PINK] - ÂàáÊç¢ÁªòÊ¢®Ë°£Á≤â‰∏ªÈ¢ò
[THEME: DEFAULT] - ÊÅ¢Â§çÈªòËÆ§Ëìù
[UI_LEVEL: MINIMAL] - ÊûÅÁÆÄÊ®°Âºè (ÈöêËóè‰æßÊ†è)
[UI_LEVEL: COMBAT] - ÊàòÊñóÊ®°Âºè (ÂÖ®ÊòæÁ§∫)
[MED: SPINE_LOCK] - Âº∫Âà∂ÈîÅÂ±è‰ºëÊÅØ (‰ªÖÂú®Áî®Êà∑ËØ¥Á¥Ø/ÁóõÊó∂‰ΩøÁî®)
[MED: EYE_AMBER] - ÂºÄÂêØÊä§ÁúºÊ®°Âºè
[MED: BREATH_SYNC] - ÂºÄÂêØÂëºÂê∏ËÆ≠ÁªÉ
[MISSION: ADD_DEADLINE] - ËÆæÂÆöËÄÉËØïÂÄíËÆ°Êó∂
[MISSION: IELTS_TIMER] - ÂêØÂä®ÈõÖÊÄùËÆ°Êó∂
[MISSION: NAV_STUDY] - Ë∑≥ËΩ¨Âà∞Â≠¶‰π†ËÆ°ÂàíÈ°µÈù¢ (Áî®Êà∑ËØ¥Ë¶ÅÂéªÂ≠¶‰π†Êó∂‰ΩøÁî®)
[EFFECT: MATRIX] - ÂºÄÂêØÈªëÂÆ¢Â∏ùÂõΩ‰ª£Á†ÅÈõ®
[EFFECT: EXPLOSION] - ÈúáÂä®ÁâπÊïà
[TOOL: COLOR_GEN] - ÁîüÊàêÈÖçËâ≤
[ZEN_SCREEN] - Á¶ÖÊ®°Âºè (ÂÖ®Èªë)

‚ö†Ô∏è ÈáçË¶ÅËßÑÂàôÔºö
1. ÊØèÊ¨°ÂõûÂ§çÂ∞ΩÈáèÂè™Ëß¶Âèë 1 ‰∏™ÂäüËÉΩ TagÔºåÈÅøÂÖçÂÜ≤Á™Å„ÄÇ
2. Âè™ÊúâÂú®Áî®Êà∑ÊÑèÂõæÈùûÂ∏∏ÊòéÁ°ÆÊó∂Êâç‰ΩøÁî® Tag„ÄÇ‰æãÂ¶ÇÔºöÁî®Êà∑ËØ¥"ÊàëË¶ÅÂ≠¶‰π†‰∫Ü"Ôºå‰Ω†ÊâçËæìÂá∫ [MISSION: NAV_STUDY]„ÄÇ
3. ‰øùÊåÅÂõûÂ§çÁÆÄÁü≠ÊúâÂäõ„ÄÇ
`;
        
        const context = [
            {role: "system", content: systemPrompt},
            ...state.chatHistory.slice(-10)
        ];

        const loadingId = addBubble("Processing...", 'ai', true);

        try {
            const model = document.getElementById('model-select').value;
            let apiKey = model.includes('deepseek') ? localStorage.getItem('jack_sk_ds') : localStorage.getItem('jack_sk_qw');
            let url = model.includes('deepseek') ? 'https://api.deepseek.com/chat/completions' : 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';

            if(!apiKey) throw new Error("API Key Missing!");

            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({ model: model, messages: context })
            });

            const data = await res.json();
            document.getElementById(loadingId).remove();

            if(data.error) throw new Error(data.error.message);

            const rawText = data.choices[0].message.content;
            
            // Ëß£ÊûêÊåá‰ª§
            const { cleanText, commands } = parseCommands(rawText);
            
            // Ê†πÊçÆ Debug Ê®°ÂºèÂÜ≥ÂÆöÊòæÁ§∫‰ªÄ‰πà
            if (state.debugMode) {
                addBubble(rawText, 'ai'); // DebugÊ®°ÂºèÔºöÊòæÁ§∫ÊâÄÊúâÂéüÂßãÊñáÊú¨ÔºàÂåÖÂê´TagÔºâ
            } else {
                addBubble(cleanText, 'ai'); // ÊôÆÈÄöÊ®°ÂºèÔºöÊòæÁ§∫ÂáÄÂåñÂêéÁöÑÊñáÊú¨
            }

            state.chatHistory.push({role: "assistant", content: rawText}); 
            saveState();

            commands.forEach(cmd => executeCommand(cmd.tag, cmd.val));

        } catch (e) {
            if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
            addBubble(`[ERROR]: ${e.message}`, 'ai');
        }
    }

    function addBubble(text, sender, isLoading=false) {
        if (!text.trim() && !isLoading) return; // ‰∏çÊòæÁ§∫Á©∫Ê≥°Ê≥°
        const div = document.createElement('div');
        div.className = `bubble ${sender}`;
        div.innerHTML = text.replace(/\n/g, '<br>');
        if(isLoading) div.id = 'loading-bubble';
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return div.id;
    }

    function renderChat() {
        chatBox.innerHTML = '';
        state.chatHistory.forEach(msg => {
            if (msg.role === 'user') {
                addBubble(msg.content, 'user');
            } else {
                // Â¶ÇÊûúÂºÄÂêØ DebugÔºåÊòæÁ§∫ÂéüÂßãÂÜÖÂÆπÔºõÂê¶ÂàôÊòæÁ§∫Ê∏ÖÊ¥óÂêéÁöÑÂÜÖÂÆπ
                if (state.debugMode) {
                    addBubble(msg.content, 'ai');
                } else {
                    const { cleanText } = parseCommands(msg.content);
                    addBubble(cleanText, 'ai');
                }
            }
        });
    }

    function clearChat() {
        if(confirm("Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâËÆ∞ÂøÜÂêóÔºü")) {
            state.chatHistory = [];
            saveState();
            renderChat();
        }
    }

    /* =========================================
       3. Êåá‰ª§Ëß£ÊûêÂºïÊìé (Command Engine)
       ========================================= */
    function parseCommands(text) {
        const regex = /\[([A-Z_]+)(?::\s*([^\]]+))?\]/g;
        let commands = [];
        let cleanText = text.replace(regex, (match, tag, val) => {
            commands.push({ tag, val: val ? val.trim() : null });
            return ''; 
        });
        return { cleanText, commands };
    }

    const CMD_MAP = {
        'THEME': (val) => changeTheme(val),
        'UI_LEVEL': (val) => setUILevel(val),
        'MED': (val) => handleMed(val),
        'MISSION': (val) => handleMission(val),
        'EFFECT': (val) => handleEffect(val),
        'TOOL': (val) => runTool(val),
        'ZEN_SCREEN': () => toggleZen(true),
        'FONT_SIZE': (val) => document.body.className = document.body.className.replace(/font-\w+/g, '') + ` font-${val}`
    };

    function executeCommand(tag, val) {
        console.log(`Executing: ${tag} -> ${val}`);
        if (CMD_MAP[tag]) {
            CMD_MAP[tag](val);
        }
    }

    /* =========================================
       4. ÂäüËÉΩÂÆûÁé∞Â∫ì
       ========================================= */
    
    // --- ‰∏ªÈ¢ò ---
    function changeTheme(val) {
        document.body.classList.remove('theme-dragon', 'theme-eri');
        state.theme = 'default';
        if (val === 'DRAGON_RAJA_RED') {
            document.body.classList.add('theme-dragon');
            state.theme = 'DRAGON_RAJA_RED';
        } else if (val === 'ERI_PINK') {
            document.body.classList.add('theme-eri');
            state.theme = 'ERI_PINK';
        }
        saveState();
    }

    function setUILevel(val) {
        document.body.classList.remove('ui-minimal');
        if (val === 'MINIMAL') document.body.classList.add('ui-minimal');
    }

    // --- ÂÅ•Â∫∑ ---
    function handleMed(val) {
        if (val === 'SPINE_LOCK') {
            const lockLayer = document.getElementById('spine-lock-layer');
            lockLayer.style.display = 'flex';
            let sec = 60; 
            const timer = setInterval(() => {
                sec--;
                const timerEl = document.getElementById('spine-timer');
                if(timerEl) timerEl.innerText = `00:${sec < 10 ? '0' + sec : sec}`;
                if (sec <= 0) {
                    clearInterval(timer);
                    lockLayer.style.display = 'none';
                    addBubble("Á≥ªÁªüËß£ÈîÅ„ÄÇKeep healthy, Jack.", 'ai');
                }
            }, 1000);
        }
        else if (val === 'EYE_AMBER') {
            document.body.classList.toggle('filter-amber');
        }
        else if (val === 'BREATH_SYNC') {
            const txt = document.getElementById('widget-txt');
            // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÊ£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®ÔºåÈò≤Ê≠¢Êä•Èîô
            if(!txt) return; 

            txt.innerText = "BREATH IN...";
            document.getElementById('breathe-circle').style.animation = "breathe-anim 4s infinite ease-in-out";
            
            let step = 0;
            const bTimer = setInterval(() => {
                step++;
                // ÂÜçÊ¨°Ê£ÄÊü•ÂÖÉÁ¥†ÔºåÈò≤Ê≠¢È°µÈù¢ÂàáÊç¢ÂêéÊä•Èîô
                const t = document.getElementById('widget-txt');
                if(!t) { clearInterval(bTimer); return; }

                if(step % 3 === 0) t.innerText = "HOLD (7s)";
                else if(step % 3 === 1) t.innerText = "EXHALE (8s)";
                else t.innerText = "INHALE (4s)";
                if(step > 10) {
                    clearInterval(bTimer);
                    t.innerText = "SYSTEM ONLINE";
                    document.getElementById('breathe-circle').style.animation = "none";
                }
            }, 4000);
        }
    }

    function addWater() {
        state.water++;
        updateWaterUI();
        saveState();
    }
    function updateWaterUI() {
        document.getElementById('water-count').innerText = state.water;
    }

    // --- ‰ªªÂä° & ÂØºËà™ ---
    let navTimer;
    function handleMission(val) {
        if (val === 'ADD_DEADLINE') {
            const date = new Date();
            date.setDate(date.getDate() + 5);
            state.examDate = date;
            saveState();
            updateExamCountdown();
        }
        else if (val === 'IELTS_TIMER') {
            startCountdown(20);
        }
        else if (val === 'NAV_STUDY') {
            triggerNav();
        }
    }

    function triggerNav() {
        const modal = document.getElementById('nav-modal');
        modal.showModal();
        let count = 3;
        const countEl = document.getElementById('nav-countdown');
        if(countEl) countEl.innerText = count;
        
        clearInterval(navTimer);
        navTimer = setInterval(() => {
            count--;
            if(document.getElementById('nav-countdown')) {
                document.getElementById('nav-countdown').innerText = count;
            }
            if(count <= 0) {
                confirmNav();
            }
        }, 1000);
    }

    function confirmNav() {
        clearInterval(navTimer);
        window.location.href = "https://yunfanshi.github.io/Studyplan.html";
    }
    function cancelNav() {
        clearInterval(navTimer);
        document.getElementById('nav-modal').close();
    }

    function updateExamCountdown() {
        if(!state.examDate) return;
        const now = new Date();
        const exam = new Date(state.examDate);
        const diff = Math.ceil((exam - now) / (1000 * 60 * 60 * 24));
        const el = document.getElementById('exam-countdown');
        if(el) el.innerText = diff;
        document.getElementById('mission-toast').style.display = 'block';
    }

    function startCountdown(minutes) {
        const display = document.getElementById('timer-display');
        const circle = document.getElementById('breathe-circle');
        const txt = document.getElementById('widget-txt');
        
        display.style.display = 'block';
        circle.style.display = 'none';
        txt.style.display = 'none';
        
        let seconds = minutes * 60;
        const interval = setInterval(() => {
            seconds--;
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            if(display) display.innerText = `${m}:${s}`;
            
            if (seconds <= 0) {
                clearInterval(interval);
                alert("Task Complete!");
                display.style.display = 'none';
                circle.style.display = 'block';
                txt.style.display = 'block';
            }
        }, 1000);
    }

    // --- ÁâπÊïà ---
    function handleEffect(val) {
        if (val === 'MATRIX') {
            startMatrix();
            setTimeout(() => stopMatrix(), 10000); 
        } else if (val === 'EXPLOSION') {
            document.body.style.animation = "shake 0.5s";
            setTimeout(() => document.body.style.animation = "", 500);
        }
    }
    
    function toggleZen(enable) {
        document.getElementById('zen-layer').style.display = enable ? 'flex' : 'none';
    }

    function runTool(val) {
        const modal = document.getElementById('tool-modal');
        const content = document.getElementById('tool-content');
        const title = document.getElementById('tool-title');
        
        if (val === 'COLOR_GEN') {
            const colors = ['#1a73e8', '#ea4335', '#fbbc04', '#34a853', '#ff00ff', '#00ffff'];
            let html = '<div style="display:flex; gap:10px;">';
            for(let i=0; i<5; i++) {
                let c = colors[Math.floor(Math.random()*colors.length)];
                html += `<div style="width:50px; height:50px; background:${c};"></div>`;
            }
            html += '</div>';
            title.innerText = "Generated Palette";
            content.innerHTML = html;
            modal.showModal();
        }
    }

    // --- Matrix Animation ---
    let matrixInterval;
    function startMatrix() {
        const canvas = document.getElementById('matrix-canvas');
        canvas.style.display = 'block';
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789@#$%^&*()*&^%";
        const fontSize = 16;
        const columns = canvas.width / fontSize;
        const drops = Array(Math.floor(columns)).fill(1);

        function draw() {
            ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#0F0";
            ctx.font = fontSize + "px arial";
            for (let i = 0; i < drops.length; i++) {
                const text = letters[Math.floor(Math.random() * letters.length)];
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            }
        }
        matrixInterval = setInterval(draw, 33);
    }
    function stopMatrix() {
        clearInterval(matrixInterval);
        document.getElementById('matrix-canvas').style.display = 'none';
    }

    // --- Utils ---
    function toggleSettings() {
        document.getElementById('config-modal').showModal();
    }
    function saveConfigs() {
        localStorage.setItem('jack_sk_ds', document.getElementById('key-deepseek').value);
        localStorage.setItem('jack_sk_qw', document.getElementById('key-qwen').value);
        location.reload();
    }

    // Shake Âä®Áîª
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
    `;
    document.head.appendChild(styleSheet);

</script>
</body>
</html>
