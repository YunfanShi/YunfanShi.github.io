<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAIE ËÄÉËØïÂ±Ä | Jack's Dashboard</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        :root {
            /* Google Material 3 Colors */
            --primary: #00639b;
            --on-primary: #ffffff;
            --primary-container: #cce5ff;
            --secondary: #535f70;
            --surface: #f8f9ff;
            --surface-variant: #e1e2ec;
            --outline: #74777f;
            --error: #ba1a1a;
            --tertiary: #efb8c8;
            
            --bg-color: #fdfcff;
            --card-bg: #ffffff;
            
            --radius-l: 24px;
            --radius-m: 16px;
            --radius-s: 8px;
            
            --font-main: 'Roboto', 'Noto Sans SC', sans-serif;
            --font-mono: 'Roboto Mono', monospace;
        }

        * { box-sizing: border-box; transition: all 0.2s ease-in-out; }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: #1a1c1e;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- Sidebar Navigation --- */
        aside {
            width: 320px;
            background: #f0f4f8;
            height: 100%;
            border-right: 1px solid var(--surface-variant);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            user-select: none;
        }

        .brand {
            padding: 24px;
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .nav-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* Subject Item */
        .nav-subject {
            margin-bottom: 5px;
        }

        .nav-subject-header {
            padding: 12px 16px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .nav-subject-header:hover { background: rgba(0,0,0,0.05); }
        .nav-subject-header.active { background: var(--primary-container); color: #001d33; }

        /* Unit List (Level 2) */
        .nav-units {
            display: none;
            padding-left: 12px;
            margin-top: 4px;
        }
        .nav-subject-header.active + .nav-units { display: block; }

        .nav-unit-item {
            padding: 8px 16px;
            border-left: 2px solid var(--surface-variant);
            margin-left: 12px;
            font-size: 14px;
            cursor: pointer;
            color: #444;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .nav-unit-item:hover { color: var(--primary); border-left-color: var(--primary); }
        .nav-unit-item.completed { color: #2e7d32; text-decoration: line-through; opacity: 0.7; }

        /* --- Main Content Area --- */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Top Bar: Time & Global Stats */
        .top-bar {
            padding: 16px 32px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .time-warning {
            background: #fff0f0;
            color: var(--error);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(186, 26, 26, 0.1);
        }

        /* Dashboard Content */
        .content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            scroll-behavior: smooth;
        }

        /* Cards */
        .section-header {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--secondary);
        }

        .quest-container {
            display: grid;
            gap: 24px;
            max-width: 900px;
            margin: 0 auto;
        }

        /* RPG Task Card */
        .quest-card {
            background: white;
            border-radius: var(--radius-l);
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.04);
            border: 1px solid #edf2f7;
            position: relative;
            overflow: hidden;
        }

        .quest-card.locked {
            filter: grayscale(1);
            opacity: 0.6;
            pointer-events: none;
            background: #f5f5f5;
        }
        
        /* Urgent Mission Card */
        .quest-card.urgent {
            border: 2px solid var(--error);
            background: #fff8f8;
        }
        .quest-card.urgent .quest-breadcrumbs { color: var(--error); font-weight: bold; }

        /* Koolearn Card */
        .quest-card.koolearn {
            background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
            border: 2px solid #2196f3;
        }
        .quest-card.koolearn .quest-breadcrumbs { color: #1976d2; font-weight: bold; }

        .quest-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
        }

        .quest-breadcrumbs {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--secondary);
            margin-bottom: 5px;
        }

        .quest-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a1c1e;
        }

        /* The Chain Steps */
        .chain-steps {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            position: relative;
        }
        
        /* Connecting line */
        .chain-steps::before {
            content: '';
            position: absolute;
            top: 18px;
            left: 20px;
            right: 20px;
            height: 2px;
            background: #e0e2ec;
            z-index: 0;
        }

        .step-node {
            position: relative;
            z-index: 1;
            background: white;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            opacity: 0.5;
            pointer-events: none;
        }

        .step-node.active {
            opacity: 1;
            pointer-events: all;
            transform: scale(1.05);
        }
        .step-node.done {
            opacity: 1;
            color: #2e7d32;
        }

        .step-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f0f4f8;
            border: 2px solid #e0e2ec;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--secondary);
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .step-node.active .step-icon {
            background: var(--primary-container);
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 99, 155, 0.3);
        }

        .step-node.done .step-icon {
            background: #e8f5e9;
            border-color: #2e7d32;
            color: #2e7d32;
        }

        .step-label {
            font-size: 12px;
            font-weight: 500;
        }

        /* Action Area */
        .quest-action {
            margin-top: 24px;
            background: #f8f9ff;
            border-radius: var(--radius-m);
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px dashed var(--outline);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            padding: 10px 24px;
            border-radius: 50px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary:hover { background: #004a77; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
        }

        /* --- Mock Exam Styles --- */
        #mock-zone-container {
            margin-top: 60px;
            border-top: 2px dashed #ddd;
            padding-top: 40px;
        }
        
        .mock-record {
            background: #fcfcfc;
            border: 1px solid #eee;
            border-radius: var(--radius-m);
            padding: 20px;
            margin-bottom: 15px;
        }

        .mock-meta {
            display: flex;
            justify-content: space-between;
            font-family: var(--font-mono);
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .mock-checklist {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            padding: 6px 12px;
            background: #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
        }
        .check-item.checked {
            background: #e6f4ea;
            color: #1e8e3e;
            font-weight: bold;
        }

        .mock-score-area {
            display: flex;
            gap: 10px;
            align-items: center;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        /* Full Screen Overlay */
        #mock-fs-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            color: white;
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        #mock-fs-header {
            position: absolute;
            top: 30px; left: 40px;
            font-size: 14px;
            opacity: 0.5;
            letter-spacing: 2px;
        }
        
        #mock-fs-code {
            position: absolute;
            top: 30px; width: 100%;
            text-align: center;
            font-family: var(--font-mono);
            font-size: 24px;
            letter-spacing: 2px;
            color: #aaa;
        }

        #mock-fs-exit {
            position: absolute;
            top: 30px; right: 40px;
            background: none;
            border: 1px solid #555;
            color: #555;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        #mock-timer-display {
            font-size: 15vw;
            font-family: var(--font-mono);
            font-weight: 300;
            font-variant-numeric: tabular-nums;
            line-height: 1;
        }

        #mock-controls {
            margin-top: 50px;
            display: flex;
            gap: 40px;
        }
        
        .mock-ctrl-btn {
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .mock-ctrl-btn:hover { background: white; color: black; }

        /* Settings Modal */
        dialog {
            border: none;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 500px;
            max-width: 90vw;
        }
        dialog::backdrop { background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); }
        
        input, select, textarea {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 5px;
            font-family: var(--font-main);
        }

    </style>
</head>
<body>

<!-- Sidebar -->
<aside>
    <div class="brand">
        <span class="material-icons-round">account_balance</span>
        CAIE ËÄÉËØïÂ±Ä
    </div>
    
    <!-- Dynamic Syllabus Tree -->
    <div class="nav-scroll" id="sidebar-content">
        <!-- Injected via JS -->
    </div>

    <!-- Extra Links -->
    <div style="padding: 20px; border-top: 1px solid #ddd;">
        <div class="nav-subject-header" onclick="window.open('https://www.youtube.com/watch?v=nLRL_NcnK-4', '_blank')">
            <span>üêç CS50P Python</span>
            <span class="material-icons-round" style="font-size:16px;">open_in_new</span>
        </div>
        <!-- Secret debug for testing -->
        <button onclick="debugUnlockAll()" style="margin-top:10px; font-size:10px; color:#aaa; background:none; border:none;">DEBUG: Unlock All</button>
    </div>
</aside>

<!-- Main Content -->
<main>
    <div class="top-bar">
        <div>
            <h2 style="margin:0; font-size:18px;">Welcome back, Scholar.</h2>
            <div style="font-size:12px; color:var(--secondary);">Process is everything.</div>
        </div>
        
        <div class="time-warning" id="deadline-timer">
            <span class="material-icons-round">hourglass_empty</span>
            <span id="time-left-text">Calculating...</span> until 11:00 PM
        </div>

        <button onclick="document.getElementById('settings-modal').showModal()" style="background:none; border:none; cursor:pointer;">
            <span class="material-icons-round" style="color:var(--secondary);">settings</span>
        </button>
    </div>

    <div class="content-scroll" id="main-view">
        
        <!-- Smart Recommendation -->
        <div class="quest-container">
            <div class="section-header">
                <span class="material-icons-round">auto_awesome</span>
                Priority Tasks (ÂøÖÂÅö)
            </div>
            
            <div id="daily-quest-area">
                <!-- Dynamically populated -->
            </div>

            <!-- Current Subject View -->
            <div class="section-header" style="margin-top: 40px;">
                <span class="material-icons-round">map</span>
                Active Syllabus Questline
            </div>
            <div id="active-subject-area">
                <div style="text-align:center; color:#888; padding:40px;">
                    Select a subject and unit from the sidebar to view tasks.<br>
                    ËØ∑Âú®Â∑¶‰æßÈÄâÊã©ÁßëÁõÆÂíåÂçïÂÖÉ‰ª•Âä†ËΩΩ‰ªªÂä°Èìæ„ÄÇ
                </div>
            </div>
        </div>

    </div>
</main>

<!-- Full Screen Mock Exam Overlay -->
<div id="mock-fs-overlay">
    <div id="mock-fs-header">CAIE EXAM BOARD // SESSION ACTIVE</div>
    <div id="mock-fs-code">CODE: 0000/00/X/X/XX</div>
    <button id="mock-fs-exit" onclick="exitMockMode()">EXIT</button>
    
    <div id="mock-timer-display">00:00:00</div>
    
    <div id="mock-controls">
        <button class="mock-ctrl-btn" id="mock-btn-toggle" onclick="toggleMockTimer()">Start</button>
        <button class="mock-ctrl-btn" style="border-color:#ba1a1a; color:#ba1a1a;" onclick="finishMockExam()">Submit Paper</button>
    </div>
</div>

<!-- Settings Modal -->
<dialog id="settings-modal">
    <h3>‚öôÔ∏è Settings & Emergency</h3>
    
    <div style="margin-bottom:20px;">
        <h4>Basic Info</h4>
        <label>School Start (ÂºÄÂ≠¶)</label>
        <input type="date" id="date-school">
        <label>IGCSE Exam (Â§ßËÄÉ)</label>
        <input type="date" id="date-exam">
    </div>

    <div style="border-top:1px solid #eee; padding-top:10px; margin-bottom:20px;">
        <h4 style="color:var(--error); display:flex; align-items:center; gap:5px;">
            <span class="material-icons-round">warning</span> Emergency Mission (‰∏¥Êó∂Ë¶ÅÊ±Ç)
        </h4>
        <p style="font-size:12px; color:#666;">Set a high-priority task that must be done immediately.</p>
        
        <label>Subject</label>
        <select id="urgent-subject">
            <option value="0580 Math">0580 Math</option>
            <option value="0606 Add Math">0606 Add Math</option>
            <option value="0625 Physics">0625 Physics</option>
            <option value="0620 Chemistry">0620 Chemistry</option>
            <option value="0610 Biology">0610 Biology</option>
        </select>
        
        <label>Task Type</label>
        <select id="urgent-type">
            <option value="Revision">Revision (Notes/Topical)</option>
            <option value="Mock">Mock Exam (Past Paper)</option>
        </select>
        
        <label>Details (e.g., "Complete Algebra Unit", "Finish 2023 Paper 4")</label>
        <input type="text" id="urgent-details" placeholder="Describe the mission...">
        
        <label>Deadline (Days)</label>
        <input type="number" id="urgent-days" value="1" min="1">
    </div>

    <div style="text-align:right; display:flex; gap:10px; justify-content:flex-end;">
        <button class="btn-outline" onclick="clearUrgent()">Clear Urgent</button>
        <button class="btn-primary" onclick="saveSettings()">Save & Activate</button>
    </div>
</dialog>

<!-- Start Mock Setup Modal -->
<dialog id="mock-setup-modal">
    <h3>üìù Start Mock Exam</h3>
    <label>Paper Code (e.g. 0580/22/M/J/24)</label>
    <input type="text" id="mock-code-input" placeholder="0000/00/S/W/YY">
    
    <label>Duration (Minutes)</label>
    <input type="number" id="mock-duration-input" value="90">
    
    <div style="text-align:right; margin-top:20px;">
        <button class="btn-primary" onclick="confirmStartMock()">Enter Exam Mode</button>
    </div>
</dialog>

<script>
    // --- 1. Syllabus Data ---
    const syllabusDB = {
        "0580 Math": {
            link: "https://www.savemyexams.com/igcse/maths/cie/25/extended/revision-notes/",
            units: [
                { title: "1. Number (Êï∞)", subs: ["1.1 Types of Number", "1.2 Sets & Venn", "1.3 Powers & Roots", "1.4 Fractions/Decimals", "1.5 Ratio", "1.6 Standard Form", "1.7 Money/Time", "1.8 Interest", "1.9 Bounds"] },
                { title: "2. Algebra (‰ª£Êï∞)", subs: ["2.1 Basic Algebra", "2.2 Fractions", "2.3 Brackets", "2.4 Quadratics", "2.5 Inequalities", "2.6 Sequences", "2.7 Functions", "2.8 Graphs"] },
                { title: "3. Coord Geometry", subs: ["3.1 Straight Lines"] },
                { title: "4. Geometry (Âá†‰Ωï)", subs: ["4.1 Vocab", "4.2 Similarity", "4.3 Symmetry", "4.4 Angles"] },
                { title: "5. Mensuration (ÊµãÈáè)", subs: ["5.1 Perimeter/Area/Volume"] },
                { title: "6. Trigonometry (‰∏âËßí)", subs: ["6.1 Right-Angled", "6.2 Further Trig", "6.3 Vectors"] },
                { title: "7. Probability (Ê¶ÇÁéá)", subs: ["7.1 Probability Theory"] },
                { title: "8. Statistics (ÁªüËÆ°)", subs: ["8.1 Mean/Median/Mode", "8.2 Data Display"] }
            ]
        },
        "0606 Add Math": {
            link: "https://www.savemyexams.com/igcse/further-maths/cie/additional-maths/25/revision-notes/",
            units: [
                { title: "1. Functions", subs: ["Notation", "Composite", "Inverse"] },
                { title: "2. Quadratics", subs: ["Discriminants", "Max/Min"] },
                { title: "3. Equations", subs: ["Simultaneous", "Polynomials"] },
                { title: "4. Indices & Surds", subs: ["Indices", "Surds"] },
                { title: "5. Polynomials", subs: ["Remainder/Factor Theorem"] },
                { title: "6. Log/Exp", subs: ["Logarithms", "Exponentials"] },
                { title: "7. Straight Line", subs: ["Linear Law"] },
                { title: "8. Circular Measure", subs: ["Radians", "Sector Area"] },
                { title: "9. Trigonometry", subs: ["Identities", "Equations", "Graphs"] },
                { title: "10. Perms & Combs", subs: ["Permutations", "Combinations"] },
                { title: "11. Series", subs: ["Arithmetic", "Geometric"] },
                { title: "12. Vectors 2D", subs: ["Vectors"] },
                { title: "13. Calculus", subs: ["Differentiation", "Integration", "Kinematics"] }
            ]
        },
        "0610 Biology": {
            link: "https://www.savemyexams.com/igcse/biology/cie/23/revision-notes/",
            units: [
                { title: "1. Characteristics", subs: ["Classification"] },
                { title: "2. Organisation", subs: ["Cell Structure", "Organisation"] },
                { title: "3. Movement", subs: ["Diffusion", "Osmosis", "Active Transport"] },
                { title: "4. Biological Molecules", subs: ["Carbs/Fats/Proteins", "DNA"] },
                { title: "5. Enzymes", subs: ["Enzyme Action"] },
                { title: "6. Plant Nutrition", subs: ["Photosynthesis", "Leaf Structure"] },
                { title: "7. Human Nutrition", subs: ["Diet", "Digestion"] },
                { title: "8. Transport Plants", subs: ["Xylem/Phloem"] },
                { title: "9. Transport Animals", subs: ["Heart", "Blood"] },
                { title: "10. Diseases", subs: ["Pathogens", "Immunity"] },
                { title: "11. Gas Exchange", subs: ["Lungs"] },
                { title: "12. Respiration", subs: ["Aerobic", "Anaerobic"] },
                { title: "13. Excretion", subs: ["Kidneys"] },
                { title: "14. Coordination", subs: ["Nervous System", "Hormones", "Homeostasis"] },
                { title: "15. Drugs", subs: ["Antibiotics"] },
                { title: "16. Reproduction", subs: ["Plants", "Humans"] },
                { title: "17. Inheritance", subs: ["Chromosomes", "Genes"] },
                { title: "18. Variation", subs: ["Selection"] },
                { title: "19. Environment", subs: ["Energy Flow", "Cycles"] },
                { title: "20. Biotechnology", subs: ["Bacteria", "Genetic Mod"] }
            ]
        },
        "0620 Chemistry": {
            link: "https://www.savemyexams.com/igcse/chemistry/cie/23/revision-notes/",
            units: [
                { title: "1. States of Matter", subs: ["Solids/Liquids/Gases"] },
                { title: "2. Atoms", subs: ["Atomic Structure", "Isotopes", "Bonding"] },
                { title: "3. Stoichiometry", subs: ["Formulae", "The Mole"] },
                { title: "4. Electrochemistry", subs: ["Electrolysis"] },
                { title: "5. Energetics", subs: ["Exo/Endothermic"] },
                { title: "6. Reactions", subs: ["Rate", "Redox", "Reversible"] },
                { title: "7. Acids/Bases", subs: ["Properties", "Oxides", "Salts"] },
                { title: "8. Periodic Table", subs: ["Trends", "Groups"] },
                { title: "9. Metals", subs: ["Properties", "Extraction"] },
                { title: "10. Environment", subs: ["Water", "Air"] },
                { title: "11. Organic", subs: ["Alkanes", "Alkenes", "Alcohols", "Polymers"] },
                { title: "12. Experiments", subs: ["Analysis", "Tests"] }
            ]
        },
        "0625 Physics": {
            link: "https://www.savemyexams.com/igcse/physics/cie/23/revision-notes/",
            units: [
                { title: "1. Motion & Forces", subs: ["Motion", "Mass/Density", "Forces", "Momentum", "Energy", "Pressure"] },
                { title: "2. Thermal", subs: ["Kinetic Model", "Properties", "Transfer"] },
                { title: "3. Waves", subs: ["General", "Light", "Sound", "Spectrum"] },
                { title: "4. Electricity", subs: ["Magnetism", "Quantities", "Circuits", "Safety", "Electromagnetism"] },
                { title: "5. Nuclear", subs: ["Atom", "Radioactivity"] },
                { title: "6. Space", subs: ["Earth/Solar System", "Stars"] }
            ]
        }
    };

    // --- 2. State & Persistence ---
    let progressDB = JSON.parse(localStorage.getItem('caie_progress_v2')) || {};
    let settings = JSON.parse(localStorage.getItem('caie_settings_v2')) || { 
        school: "2026-03-01", 
        exam: "2026-05-01",
        urgent: null // { subject, type, detail, due }
    };
    let mockDB = JSON.parse(localStorage.getItem('caie_mock_v2')) || {}; // { "Subject": [ {code, score, tasks...} ] }
    let logs = JSON.parse(localStorage.getItem('caie_logs')) || [];

    const QUEST_STEPS = [
        { id: "note", label: "Notes", icon: "menu_book", btn: "Read" },
        { id: "topical", label: "Topical", icon: "quiz", btn: "Do Qs" },
        { id: "model", label: "Answers", icon: "done_all", btn: "Check" },
        { id: "notion", label: "Log", icon: "edit_note", btn: "Notion" }
    ];

    // --- 3. Initialization ---
    function init() {
        renderSidebar();
        startDeadlineTimer();
        loadDailyQuests();
        
        // Settings form population
        document.getElementById('date-school').value = settings.school;
        document.getElementById('date-exam').value = settings.exam;
        if(settings.urgent) {
            document.getElementById('urgent-subject').value = settings.urgent.subject;
            document.getElementById('urgent-type').value = settings.urgent.type;
            document.getElementById('urgent-details').value = settings.urgent.detail;
        }
    }

    function addLog(action) {
        const time = new Date().toLocaleString();
        logs.push({time, action});
        localStorage.setItem('caie_logs', JSON.stringify(logs));
        console.log("LOG:", time, action);
    }

    // --- 4. Logic: Check Subject Completion ---
    function isSubjectComplete(subject) {
        const data = syllabusDB[subject];
        // For every unit, for every subunit, check if 'notion' (last step) is done
        for (const unit of data.units) {
            // Also check unit final task
            if (!progressDB[`${subject}|${unit.title}|FINAL|unit_done`]) return false;
        }
        return true;
    }

    // --- 5. Main View Rendering ---
    function renderMainView(subject) {
        const area = document.getElementById('active-subject-area');
        area.innerHTML = '';
        
        const data = syllabusDB[subject];
        const link = data.link;

        data.units.forEach((unit, unitIdx) => {
            const unitDiv = document.createElement('div');
            unitDiv.id = `unit-${unitIdx}`;
            unitDiv.style.marginBottom = '40px';
            unitDiv.innerHTML = `<h3 style="margin-bottom:15px; color:var(--primary); border-bottom:2px solid #eee; padding-bottom:10px;">${unit.title}</h3>`;

            // Subunits
            unit.subs.forEach((sub) => {
                const card = createQuestCard(subject, unit.title, sub, link);
                unitDiv.appendChild(card);
            });

            // Unit Boss
            const allSubsDone = unit.subs.every(sub => progressDB[`${subject}|${unit.title}|${sub}|notion`]);
            if (allSubsDone) {
                const finalCard = createUnitFinalCard(subject, unit.title);
                unitDiv.appendChild(finalCard);
            }
            area.appendChild(unitDiv);
        });

        // --- MOCK EXAM ZONE ---
        // Only show if Subject is complete
        if (isSubjectComplete(subject)) {
            renderMockZone(subject, area);
        }
    }

    function createQuestCard(subject, unit, sub, link) {
        const card = document.createElement('div');
        card.className = 'quest-card';
        
        let currentStepIndex = 0;
        for (let i = 0; i < QUEST_STEPS.length; i++) {
            const key = `${subject}|${unit}|${sub}|${QUEST_STEPS[i].id}`;
            if (progressDB[key]) currentStepIndex = i + 1;
            else break;
        }

        let stepsHtml = `<div class="chain-steps">`;
        let actionBtnHtml = '';

        QUEST_STEPS.forEach((step, idx) => {
            let status = ''; 
            if (idx < currentStepIndex) status = 'done';
            else if (idx === currentStepIndex) status = 'active';
            
            stepsHtml += `
                <div class="step-node ${status}">
                    <div class="step-icon"><span class="material-icons-round" style="font-size:18px;">${step.icon}</span></div>
                    <div class="step-label">${step.label}</div>
                </div>
            `;

            if (status === 'active') {
                let clickAction = '';
                if (step.id === 'note') clickAction = `window.open('${link}', '_blank'); completeStep('${subject}','${unit}','${sub}','${step.id}')`;
                else if (step.id === 'topical') clickAction = `alert('Find Topical Qs on SME!'); completeStep('${subject}','${unit}','${sub}','${step.id}')`; 
                else if (step.id === 'model') clickAction = `alert('Check Model Answers carefully!'); completeStep('${subject}','${unit}','${sub}','${step.id}')`;
                else if (step.id === 'notion') clickAction = `window.open('notion://'); completeStep('${subject}','${unit}','${sub}','${step.id}')`;

                actionBtnHtml = `
                    <div class="quest-action">
                        <span style="font-size:14px; color:#666;">Next: ${step.label}</span>
                        <button class="btn-primary" onclick="${clickAction}">
                            ${step.btn} <span class="material-icons-round">arrow_forward</span>
                        </button>
                    </div>
                `;
            }
        });
        stepsHtml += `</div>`;

        if (currentStepIndex >= QUEST_STEPS.length) {
            actionBtnHtml = `<div style="margin-top:20px; color:#2e7d32; font-weight:bold; text-align:right;">Sub-unit Complete <span class="material-icons-round" style="vertical-align:middle;">check_circle</span></div>`;
            card.style.background = "#f6fff6";
        }

        card.innerHTML = `
            <div class="quest-header">
                <div>
                    <div class="quest-breadcrumbs">${subject} > ${unit}</div>
                    <div class="quest-title">${sub}</div>
                </div>
            </div>
            ${stepsHtml}
            ${actionBtnHtml}
        `;
        return card;
    }

    function createUnitFinalCard(subject, unit) {
        const key = `${subject}|${unit}|FINAL|unit_done`;
        const isDone = progressDB[key];
        const div = document.createElement('div');
        div.className = 'quest-card';
        div.style.borderColor = "#ffd700";

        div.innerHTML = `
            <div class="quest-header">
                <div><div class="quest-breadcrumbs" style="color:#b8860b;">UNIT BOSS LEVEL</div><div class="quest-title">Past Paper Hunt: ${unit}</div></div>
                <span class="material-icons-round" style="color:#ffd700; font-size:32px;">military_tech</span>
            </div>
            ${!isDone ? `
                <div class="quest-action">
                    <span>Task: Search 2023/2024 Papers</span>
                    <button class="btn-primary" onclick="completeStep('${subject}','${unit}','FINAL','unit_done')">Complete Unit</button>
                </div>
            ` : `<div style="text-align:right; font-weight:bold; color:#b8860b;">UNIT CONQUERED</div>`}
        `;
        return div;
    }

    function completeStep(sub, unit, subName, stepId) {
        const key = `${sub}|${unit}|${subName}|${stepId}`;
        progressDB[key] = true;
        localStorage.setItem('caie_progress_v2', JSON.stringify(progressDB));
        addLog(`Completed Step: ${key}`);
        renderMainView(sub);
        loadDailyQuests();
    }

    // --- 6. MOCK EXAM SYSTEM ---
    
    let currentMockSubject = '';
    let currentMockDuration = 0;
    let mockTimerInterval;
    let mockSeconds = 0;
    let mockIsPaused = false;

    function renderMockZone(subject, container) {
        const zone = document.createElement('div');
        zone.id = 'mock-zone-container';
        
        let html = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; color:#ba1a1a;">üõë MOCK EXAM ZONE (Subject Mastered)</h2>
                <button class="btn-primary" style="background:#ba1a1a;" onclick="openMockSetup('${subject}')">
                    + Start New Mock
                </button>
            </div>
        `;

        // Render existing mock records
        const mocks = mockDB[subject] || [];
        mocks.forEach((mock, idx) => {
            html += createMockRecordHTML(subject, idx, mock);
        });

        zone.innerHTML = html;
        container.appendChild(zone);
    }

    function createMockRecordHTML(subject, idx, mock) {
        // mock object: { id, code, score, threshold, tasks: {qp, ms, er, gt, ci} }
        const tasks = mock.tasks;
        
        // Generate Checkboxes
        const createCheck = (key, label) => `
            <div class="check-item ${tasks[key] ? 'checked' : ''}" onclick="toggleMockTask('${subject}', ${idx}, '${key}')">
                <span class="material-icons-round">${tasks[key] ? 'check_box' : 'check_box_outline_blank'}</span>
                ${label}
            </div>
        `;

        return `
            <div class="mock-record">
                <div class="mock-meta">
                    <span>${mock.code}</span>
                    <span>${new Date(mock.id).toLocaleDateString()}</span>
                </div>
                
                <div class="mock-checklist">
                    ${createCheck('qp', '1. Question Paper (Exam)')}
                    ${createCheck('ms', '2. Mark Scheme')}
                    ${createCheck('er', '3. Examiner Report')}
                    ${createCheck('gt', '4. Grade Thresholds')}
                    ${createCheck('ci', '5. Confid. Instr.')}
                </div>

                <div class="mock-score-area">
                    <input type="number" placeholder="Your Score" style="width:100px; margin:0;" 
                        value="${mock.score || ''}" onchange="updateMockScore('${subject}', ${idx}, 'score', this.value)">
                    <span style="color:#aaa;">/</span>
                    <input type="number" placeholder="A* Score" style="width:100px; margin:0;"
                        value="${mock.threshold || ''}" onchange="updateMockScore('${subject}', ${idx}, 'threshold', this.value)">
                    
                    <button class="btn-outline" onclick="generateGeminiPrompt('${subject}', '${mock.code}', '${mock.score}', '${mock.threshold}')">
                        ü§ñ Send to Gemini
                    </button>
                    <button class="btn-outline" onclick="window.open('notion://')">
                        üìù Notion Log
                    </button>
                </div>
                ${mock.score && mock.threshold ? 
                    `<div style="margin-top:10px; font-weight:bold; color:${mock.score >= mock.threshold ? '#2e7d32' : '#ba1a1a'}">
                        Result: ${mock.score >= mock.threshold ? 'A* Achieved' : 'Below A* Target'} (${mock.score - mock.threshold})
                     </div>` : ''
                }
            </div>
        `;
    }

    function openMockSetup(subject) {
        currentMockSubject = subject;
        document.getElementById('mock-setup-modal').showModal();
    }

    function confirmStartMock() {
        const code = document.getElementById('mock-code-input').value;
        const dur = document.getElementById('mock-duration-input').value;
        if(!code) return alert("Code required!");
        
        currentMockDuration = parseInt(dur) * 60; // seconds
        
        // Create Mock Record immediately
        if(!mockDB[currentMockSubject]) mockDB[currentMockSubject] = [];
        mockDB[currentMockSubject].unshift({
            id: Date.now(),
            code: code,
            score: null,
            threshold: null,
            tasks: { qp: false, ms: false, er: false, gt: false, ci: false }
        });
        localStorage.setItem('caie_mock_v2', JSON.stringify(mockDB));
        addLog(`Started Mock Exam: ${code}`);

        document.getElementById('mock-setup-modal').close();
        enterMockMode(code);
    }

    // --- Full Screen Logic ---
    function enterMockMode(code) {
        const overlay = document.getElementById('mock-fs-overlay');
        document.getElementById('mock-fs-code').innerText = code;
        overlay.style.display = 'flex';
        // Go Full Screen Browser
        if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();

        // Start Timer
        mockSeconds = currentMockDuration;
        mockIsPaused = true; // Start paused
        updateMockTimerDisplay();
        document.getElementById('mock-btn-toggle').innerText = "START";
    }

    function exitMockMode() {
        if(confirm("Exit exam mode? Timer will stop.")) {
            clearInterval(mockTimerInterval);
            document.getElementById('mock-fs-overlay').style.display = 'none';
            if (document.exitFullscreen) document.exitFullscreen();
            // Refresh view
            renderMainView(currentMockSubject);
        }
    }

    function toggleMockTimer() {
        mockIsPaused = !mockIsPaused;
        const btn = document.getElementById('mock-btn-toggle');
        btn.innerText = mockIsPaused ? "RESUME" : "PAUSE";
        
        if(!mockIsPaused) {
            mockTimerInterval = setInterval(() => {
                if(mockSeconds > 0) {
                    mockSeconds--;
                    updateMockTimerDisplay();
                } else {
                    clearInterval(mockTimerInterval);
                    alert("TIME IS UP! PENS DOWN.");
                }
            }, 1000);
        } else {
            clearInterval(mockTimerInterval);
        }
    }

    function updateMockTimerDisplay() {
        const h = Math.floor(mockSeconds / 3600).toString().padStart(2,'0');
        const m = Math.floor((mockSeconds % 3600) / 60).toString().padStart(2,'0');
        const s = (mockSeconds % 60).toString().padStart(2,'0');
        document.getElementById('mock-timer-display').innerText = `${h}:${m}:${s}`;
    }

    function finishMockExam() {
        // Auto-check QP task
        const mocks = mockDB[currentMockSubject];
        if(mocks.length > 0) {
            mocks[0].tasks.qp = true;
            localStorage.setItem('caie_mock_v2', JSON.stringify(mockDB));
        }
        exitMockMode();
    }

    // --- Mock Interaction ---
    function toggleMockTask(subject, idx, taskKey) {
        mockDB[subject][idx].tasks[taskKey] = !mockDB[subject][idx].tasks[taskKey];
        localStorage.setItem('caie_mock_v2', JSON.stringify(mockDB));
        renderMainView(subject);
    }

    function updateMockScore(subject, idx, field, val) {
        mockDB[subject][idx][field] = val;
        localStorage.setItem('caie_mock_v2', JSON.stringify(mockDB));
        renderMainView(subject);
    }

    function generateGeminiPrompt(subject, code, score, thresh) {
        const prompt = `I just took a CAIE Mock Exam for ${subject}, Paper Code: ${code}. My Score: ${score}, A* Threshold: ${thresh}. Please analyze my performance gaps if I provide my wrong answers.`;
        navigator.clipboard.writeText(prompt);
        alert("Gemini Prompt copied to clipboard!");
    }

    // --- 7. Settings & Urgent Mission ---
    function saveSettings() {
        settings.school = document.getElementById('date-school').value;
        settings.exam = document.getElementById('date-exam').value;
        
        const uSubject = document.getElementById('urgent-subject').value;
        const uDetail = document.getElementById('urgent-details').value;
        
        if (uDetail) {
            settings.urgent = {
                subject: uSubject,
                type: document.getElementById('urgent-type').value,
                detail: uDetail,
                due: document.getElementById('urgent-days').value
            };
            addLog(`Set Urgent Mission: ${uSubject} - ${uDetail}`);
        }

        localStorage.setItem('caie_settings_v2', JSON.stringify(settings));
        document.getElementById('settings-modal').close();
        loadDailyQuests(); // Refresh home
    }

    function clearUrgent() {
        settings.urgent = null;
        document.getElementById('urgent-details').value = "";
        localStorage.setItem('caie_settings_v2', JSON.stringify(settings));
        document.getElementById('settings-modal').close();
        loadDailyQuests();
    }

    // --- 8. Daily / Urgent Logic ---
    function loadDailyQuests() {
        const container = document.getElementById('daily-quest-area');
        container.innerHTML = '';

        // 0. ALWAYS SHOW: Koolearn (New Oriental) - UPDATED
        const koolearnCard = document.createElement('div');
        koolearnCard.className = 'quest-card koolearn';
        koolearnCard.innerHTML = `
            <div class="quest-header">
                <div>
                    <div class="quest-breadcrumbs">üî• DAILY ROUTINE</div>
                    <div class="quest-title" style="color:#1976d2">Êñ∞‰∏úÊñπ (Koolearn)</div>
                </div>
                <span class="material-icons-round" style="color:#1976d2; font-size:32px;">school</span>
            </div>
            <div style="font-size:16px; font-weight:500; margin-bottom:15px;">Mandatory Daily Learning Task</div>
            <button class="btn-primary" style="width:100%; background:#1976d2;" 
                onclick="window.open('https://study.koolearn.com/fer/pc/zhixin/210172?orderNo=82195640430', '_blank')">
                Start Class <span class="material-icons-round">open_in_new</span>
            </button>
        `;
        container.appendChild(koolearnCard);

        // 1. Render Urgent Mission if exists
        if (settings.urgent) {
            const uCard = document.createElement('div');
            uCard.className = 'quest-card urgent';
            uCard.innerHTML = `
                <div class="quest-header">
                    <div>
                        <div class="quest-breadcrumbs">EMERGENCY PROTOCOL // ${settings.urgent.due} DAYS LEFT</div>
                        <div class="quest-title" style="color:#ba1a1a">${settings.urgent.type}: ${settings.urgent.subject}</div>
                    </div>
                    <span class="material-icons-round" style="color:#ba1a1a; font-size:32px;">warning</span>
                </div>
                <div style="font-size:16px; font-weight:500; margin-bottom:15px;">Target: ${settings.urgent.detail}</div>
                <button class="btn-primary" style="width:100%; background:#ba1a1a;" onclick="renderMainView('${settings.urgent.subject}')">Execute Mission</button>
            `;
            container.appendChild(uCard);
        }

        // 2. Standard Logic (First unfinished task)
        let count = 0;
        for (const [subject, data] of Object.entries(syllabusDB)) {
            if (count >= 2) break; // Max 2 standard suggestions
            
            // If subject is complete, suggest Mock
            if (isSubjectComplete(subject)) {
                // Check if user has done a mock recently? skipping complex logic
                continue;
            }

            for (const unit of data.units) {
                let found = false;
                for (const sub of unit.subs) {
                    if (!progressDB[`${subject}|${unit.title}|${sub}|notion`]) {
                        // Found incomplete
                        const mini = document.createElement('div');
                        mini.className = 'quest-card';
                        mini.style.padding = '15px';
                        mini.innerHTML = `
                            <div class="quest-breadcrumbs">${subject}</div>
                            <div class="quest-title" style="font-size:16px;">Continue: ${sub}</div>
                            <button class="btn-outline" style="margin-top:10px; font-size:12px;" onclick="renderMainView('${subject}')">Go</button>
                        `;
                        container.appendChild(mini);
                        count++;
                        found = true;
                        break;
                    }
                }
                if(found) break;
            }
        }
    }

    // --- 9. Timers & Sidebar ---
    function renderSidebar() {
        const container = document.getElementById('sidebar-content');
        container.innerHTML = '';
        for (const [subject, data] of Object.entries(syllabusDB)) {
            const div = document.createElement('div');
            div.className = 'nav-subject-header';
            div.innerHTML = `<span>${subject}</span>`;
            if (isSubjectComplete(subject)) div.innerHTML += ` <span class="material-icons-round" style="color:#2e7d32">check_circle</span>`;
            
            div.onclick = () => {
                document.querySelectorAll('.nav-subject-header').forEach(el => el.classList.remove('active'));
                div.classList.add('active');
                renderMainView(subject);
            };
            container.appendChild(div);
        }
    }

    function startDeadlineTimer() {
        setInterval(() => {
            const now = new Date();
            const deadline = new Date();
            deadline.setHours(23, 0, 0, 0); 
            if (now > deadline) {
                document.getElementById('time-left-text').innerText = "OVERTIME";
                document.querySelector('.time-warning').style.background = "#000";
            } else {
                const diff = deadline - now;
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                document.getElementById('time-left-text').innerText = `${h}h ${m}m`;
            }
        }, 1000);
    }

    // DEBUG FUNCTION
    function debugUnlockAll() {
        if(!confirm("Unlock ALL tasks for 0580 Math?")) return;
        const sub = "0580 Math";
        const units = syllabusDB[sub].units;
        units.forEach(u => {
            u.subs.forEach(s => {
                QUEST_STEPS.forEach(st => {
                    progressDB[`${sub}|${u.title}|${s}|${st.id}`] = true;
                });
            });
            progressDB[`${sub}|${u.title}|FINAL|unit_done`] = true;
        });
        localStorage.setItem('caie_progress_v2', JSON.stringify(progressDB));
        alert("0580 Unlocked. Check the Mock Zone.");
        location.reload();
    }

    // Start
    init();

</script>
</body>
</html>
