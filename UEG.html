
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UEG Terminal - Robust Sync</title>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505; --panel-color: #111111; --header-color: #1a1a1a;
            --neon-red: #ff2a2a; --neon-dim-red: rgba(255, 42, 42, 0.2);
            --text-white: #ffffff; --text-dim: #aaaaaa;
        }
        body {
            background-color: var(--bg-color); color: var(--text-white); font-family: 'Chakra Petch', sans-serif;
            display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0;
            background-image: linear-gradient(rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.2) 50%); background-size: 100% 4px;
        }
        .terminal-container { background-color: var(--panel-color); width: 90%; max-width: 800px; border: 2px solid #333; position: relative; }
        .countdown-header {
            background-color: var(--header-color); padding: 15px; border-bottom: 2px solid #2a2a2a;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-main { font-size: 2.5rem; font-weight: 700; letter-spacing: 2px; }
        
        .refresh-control { display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: var(--text-dim); border: 1px solid #333; padding: 5px 10px; }
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border: 1px solid var(--text-dim); }
        .slider:before { position: absolute; content: ""; height: 10px; width: 10px; left: 3px; bottom: 3px; background-color: var(--text-dim); transition: .4s; }
        input:checked + .slider { background-color: var(--neon-dim-red); border-color: var(--neon-red); }
        input:checked + .slider:before { transform: translateX(16px); background-color: var(--neon-red); }

        .timer-display-container { padding: 30px 20px; text-align: center; }
        .timer-numbers { font-size: 6rem; font-weight: 700; color: var(--neon-red); text-shadow: 0 0 15px var(--neon-red); letter-spacing: 5px; font-variant-numeric: tabular-nums; }
        .timer-colon { color: var(--neon-red); animation: blink 1s infinite; }

        .task-panel { padding: 30px; }
        .current-task-box { font-size: 2rem; font-weight: 600; background-color: var(--neon-dim-red); padding: 20px; border-left: 5px solid var(--neon-red); }
        .upcoming-tasks-container { display: flex; flex-direction: column; gap: 15px; border-top: 1px solid #333; margin-top: 25px; padding-top: 20px; }
        .upcoming-task-item { display: flex; align-items: center; background: rgba(255,255,255,0.05); padding: 10px; color: var(--text-dim); }

        .sync-info { position: absolute; bottom: -25px; left: 0; font-size: 0.7rem; color: #444; width: 100%; display: flex; justify-content: space-between; }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body>

    <div class="terminal-container">
        <div class="countdown-panel">
            <div class="countdown-header">
                <div>
                    <div id="sync-text" style="font-size: 0.8rem; color: #888;">MOSS // INITIALIZING SYSTEM...</div>
                    <div id="status-title" class="header-main">COUNTDOWN</div>
                </div>
                <div class="refresh-control">
                    <span>AUTO REFRESH</span>
                    <label class="switch">
                        <input type="checkbox" id="auto-refresh-toggle">
                        <span class="slider"></span>
                    </label>
                    <span id="refresh-timer-display" style="color: var(--neon-red); width: 25px; text-align: right;">60s</span>
                </div>
            </div>
            <div class="timer-display-container">
                <div class="timer-numbers">
                    <span id="hours">00</span><span class="timer-colon">:</span><span id="minutes">00</span><span class="timer-colon">:</span><span id="seconds">00</span>
                </div>
            </div>
        </div>

        <div class="task-panel">
            <div style="margin-bottom: 20px;">
                <span style="color: var(--neon-red); font-size: 0.8rem;">// CURRENT DIRECTIVE</span>
                <div id="display-current-task" class="current-task-box">---</div>
            </div>
            <div id="upcoming-container" class="upcoming-tasks-container"></div>
        </div>

        <div class="sync-info">
            <span id="server-source">SOURCE: SEARCHING...</span>
            <span id="offset-val">CALIBRATING...</span>
        </div>
    </div>

    <script>
        const TASK_LIBRARY = [
            { start: "08:00:00", end: "13:30:00", name: "Physics" },
            { start: "14:30:00", end: "15:00:00", name: "Computer Science" },
            { start: "15:00:00", end: "16:00:00", name: "Biology" },
            { start: "16:00:00", end: "17:00:00", name: "Chemistry" },
            { start: "17:00:00", end: "17:30:00", name: "History" },
            { start: "17:30:00", end: "19:00:00", name: "Math" },
            { start: "19:00:00", end: "21:00:00", name: "IELTS Lessons" }
        ];

        let timeOffset = 0;
        let refreshCounter = 60;
        let isSynced = false;

        // --- 容错式校准逻辑 ---
        async function calibrateTime() {
            const syncText = document.getElementById('sync-text');
            const offsetText = document.getElementById('offset-val');
            const sourceText = document.getElementById('server-source');
            
            // 备选接口列表（都是国内快速接口）
            const apis = [
                { url: 'https://quan.suning.com/getSysTime.do', type: 'suning' },
                { url: 'https://api.m.taobao.com/rest/api3.do?api=mtop.common.getTimestamp', type: 'taobao' }
            ];

            for (let api of apis) {
                try {
                    const startTime = Date.now();
                    // 设置 3 秒超时，防止卡死
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000);

                    const response = await fetch(api.url, { signal: controller.signal });
                    const data = await response.json();
                    clearTimeout(timeoutId);

                    let serverTime;
                    if (api.type === 'suning') {
                        serverTime = new Date(data.sysTime2.replace(/-/g, '/')).getTime();
                    } else if (api.type === 'taobao') {
                        serverTime = parseInt(data.data.t);
                    }

                    const endTime = Date.now();
                    const latency = (endTime - startTime) / 2;
                    timeOffset = (serverTime + latency) - endTime;

                    isSynced = true;
                    syncText.innerText = "MOSS // DOMESTIC SERVER SYNCED";
                    sourceText.innerText = `SOURCE: ${api.type.toUpperCase()}_NODE`;
                    offsetText.innerText = `OFFSET: ${Math.round(timeOffset)}ms | LATENCY: ${Math.round(latency)}ms`;
                    return; // 成功后跳出函数
                } catch (e) {
                    console.warn(`Sync failed with ${api.type}, trying next...`);
                }
            }

            // 如果运行到这里，说明所有 API 都失败了
            isSynced = false;
            syncText.innerText = "MOSS // SYNC FAILED - RETRYING IN 5S...";
            sourceText.innerText = "SOURCE: OFFLINE_RETRY_MODE";
            // 5秒后再次尝试，而不刷新界面
            setTimeout(calibrateTime, 5000);
        }

        const refreshToggle = document.getElementById('auto-refresh-toggle');
        refreshToggle.checked = localStorage.getItem('autoRefresh') !== 'false';
        refreshToggle.addEventListener('change', (e) => localStorage.setItem('autoRefresh', e.target.checked));

        function getTimeInSeconds(timeStr) {
            const [h, m, s] = timeStr.split(':').map(Number);
            return h * 3600 + m * 60 + s;
        }

        function update() {
            // 即便没同步成功，也先用本地时间跑着，避免界面空白
            const now = new Date(Date.now() + timeOffset);
            const nowInSec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();

            let idx = TASK_LIBRARY.findIndex(t => {
                const s = getTimeInSeconds(t.start);
                const e = getTimeInSeconds(t.end);
                return nowInSec >= s && nowInSec < e;
            });

            if (idx !== -1) {
                const t = TASK_LIBRARY[idx];
                document.getElementById('display-current-task').innerText = t.name;
                let diff = getTimeInSeconds(t.end) - nowInSec;
                
                const pad = (n) => n < 10 ? '0' + n : n;
                document.getElementById("hours").innerText = pad(Math.floor(diff / 3600));
                document.getElementById("minutes").innerText = pad(Math.floor((diff % 3600) / 60));
                document.getElementById("seconds").innerText = pad(diff % 60);

                let html = '';
                for(let i=1; i<=2; i++) {
                    const next = TASK_LIBRARY[idx + i];
                    if(next) html += `<div class="upcoming-task-item"><span>[NEXT ${i}] >> </span><span style="margin-left:10px">${next.name}</span></div>`;
                }
                document.getElementById('upcoming-container').innerHTML = html;
            } else {
                document.getElementById('display-current-task').innerHTML = '<span style="color:#444">[ NO ACTIVE DATA ]</span>';
                document.getElementById('upcoming-container').innerHTML = '';
            }

            if (refreshToggle.checked) {
                refreshCounter--;
                document.getElementById('refresh-timer-display').innerText = refreshCounter + "s";
                if (refreshCounter <= 0) window.location.reload();
            } else {
                document.getElementById('refresh-timer-display').innerText = "--";
            }
        }

        // 启动
        calibrateTime();
        setInterval(update, 1000);
    </script>
</body>
</html>
