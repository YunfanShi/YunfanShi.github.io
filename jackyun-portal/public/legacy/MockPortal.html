<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jack's Warden: Mock Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1A73E8',
            success: '#34A853',
            warning: '#FBBC04',
            danger: '#EA4335',
          }
        }
      }
    };
  </script>
  <style>
    :root {
      --primary: #1A73E8;
      --success: #34A853;
      --warning: #FBBC04;
      --danger: #EA4335;
      --text-main: #202124;
      --text-sub: #5F6368;
      --bg: #F8F9FA;
      --border: #E8EAED;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', 'Roboto', sans-serif;
      background: var(--bg);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .mi { font-family: 'Material Icons Round'; font-style: normal; font-size: 20px;
      line-height: 1; vertical-align: middle; display: inline-block; }

    .fchip {
      display: inline-flex; align-items: center; gap: 3px;
      padding: 3px 10px; border-radius: 20px; font-size: 12px;
      cursor: pointer; border: 1.5px solid var(--border);
      background: white; color: var(--text-sub);
      transition: all 0.15s ease; user-select: none; white-space: nowrap;
    }
    .fchip:hover { border-color: var(--primary); color: var(--primary); }
    .fchip.on { border-color: var(--primary); background: #E8F0FE; color: var(--primary); font-weight: 600; }

    .pcard {
      background: white; border-radius: 16px;
      border: 2px solid transparent;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08);
      transition: all 0.2s ease; cursor: pointer; position: relative; overflow: hidden;
    }
    .pcard:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.13), 0 4px 8px rgba(0,0,0,0.08); }
    .pcard.sel { border-color: var(--primary) !important; background: #F0F4FF; }
    .pcard.done { border-left: 4px solid var(--success) !important; opacity: 0.88; }
    .pcard.inprog { border-left: 4px solid var(--warning) !important; }

    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 4px;
      padding: 7px 18px; border-radius: 24px; font-size: 13px; font-weight: 500;
      cursor: pointer; border: none; transition: all 0.18s ease;
      user-select: none; font-family: inherit; outline: none; line-height: 1.4;
    }
    .btn:hover { filter: brightness(0.93); transform: translateY(-1px); }
    .btn:active { transform: translateY(0); filter: brightness(0.87); }
    .btn-p { background: var(--primary); color: white; }
    .btn-s { background: var(--success); color: white; }
    .btn-d { background: var(--danger); color: white; }
    .btn-o { background: transparent; border: 1.5px solid var(--border); color: var(--text-sub); }
    .btn-o:hover { border-color: var(--primary); color: var(--primary); background: #E8F0FE; filter: none; transform: none; }
    .btn-g { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .btn:disabled { opacity: 0.45; cursor: not-allowed; pointer-events: none; }

    @keyframes fabPop { 0%{transform:scale(1)} 40%{transform:scale(1.12)} 100%{transform:scale(1)} }
    .fab-pop { animation: fabPop .3s ease; }

    .cart-item {
      background: white; border-radius: 16px; border: 1.5px solid var(--border);
      margin-bottom: 10px; overflow: hidden; transition: all .2s ease;
      box-shadow: 0 1px 4px rgba(0,0,0,.06);
    }
    .cart-item:hover { border-color: #DADCE0; box-shadow: 0 2px 12px rgba(0,0,0,.1); }
    .cart-item.dragging { opacity: .45; transform: scale(.97); }
    .cart-item.dragover-top { border-top: 3px solid var(--primary); }

    .drag-handle { cursor: grab; color: #DADCE0; transition: color .15s; }
    .drag-handle:hover { color: #9AA0A6; }
    .drag-handle:active { cursor: grabbing; }

    .subj-chip {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;
    }

    .mbg { background: rgba(0,0,0,0.52); backdrop-filter: blur(5px); }

    #settingsDr {
      box-shadow: -6px 0 28px rgba(0,0,0,0.16);
      transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
      transform: translateX(100%);
    }
    #settingsDr.open { transform: translateX(0); }

    #examOv { background: #0A0A1E; }

    .timer-num {
      font-family: 'Roboto Mono', monospace;
      font-size: clamp(80px, 15vw, 160px);
      font-weight: 700; letter-spacing: -0.02em; line-height: 1;
      color: white;
    }
    .timer-warn { color: #F87171 !important; animation: twarn 1s ease-in-out infinite; }
    @keyframes twarn { 0%,100%{opacity:1}50%{opacity:.55} }

    .exam-prog { height: 6px; border-radius: 3px; background: rgba(255,255,255,0.14); overflow: hidden; }
    .exam-prog-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg,#4ade80,#22d3ee,#818cf8); transition: width 1s linear; }

    .wm {
      position: fixed; bottom: 36px; right: 36px;
      font-family: 'Roboto Mono', monospace; font-size: 13px;
      letter-spacing: .14em; opacity: .11; user-select: none;
      pointer-events: none; color: white;
    }

    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #DADCE0; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #BDC1C6; }

    #toast {
      position: fixed; bottom: 88px; left: 50%;
      transform: translateX(-50%) translateY(24px);
      background: #323232; color: white; padding: 10px 20px;
      border-radius: 24px; font-size: 13px; z-index: 400;
      transition: transform 0.28s ease, opacity 0.28s ease;
      opacity: 0; pointer-events: none; white-space: nowrap;
      max-width: 90vw; overflow: hidden; text-overflow: ellipsis;
    }
    #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    #filterPanel { border-right: 1px solid var(--border); }
    .fsec-hdr { cursor: pointer; user-select: none; transition: background .15s; }
    .fsec-hdr:hover { background: #F8F9FA; }
    .fsec-body { overflow: hidden; transition: max-height 0.3s ease; }

    #appbar { transition: box-shadow 0.3s ease; }
    #appbar.scrolled { box-shadow: 0 4px 12px rgba(0,0,0,0.12); }

    #gachaScroller { height: 68px; overflow: hidden; position: relative; border-radius: 12px; }
    #gachaTrack { position: absolute; width: 100%; transition: transform 2s cubic-bezier(0.25,0.1,0.25,1); }

    .tgl { width: 44px; height: 24px; border-radius: 12px; background: #DADCE0;
      position: relative; cursor: pointer; transition: background .2s; flex-shrink: 0; }
    .tgl.on { background: var(--primary); }
    .tgl::after { content:''; position:absolute; top:2px; left:2px; width:20px; height:20px;
      border-radius:50%; background:white; box-shadow:0 1px 3px rgba(0,0,0,.2); transition:transform .2s; }
    .tgl.on::after { transform: translateX(20px); }

    @media(max-width:767px) {
      #filterPanel { display: none; }
      #mainContent { margin-left: 0 !important; }
      #mobileFilterBtn { display: flex !important; }
    }

    .cbadge { background:#E8EAED; color:var(--text-sub); font-size:10px;
      padding:0 5px; border-radius:10px; font-weight:600; }
    .fchip.on .cbadge { background:rgba(26,115,232,.18); color:var(--primary); }

    .gcnt { width:40px;height:40px;border-radius:12px;border:2px solid var(--border);
      font-weight:700;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;
      font-size:15px;color:var(--text-sub);background:white;font-family:inherit;
    }
    .gcnt.on { border-color:var(--primary);background:var(--primary);color:white; }
    .gcnt:hover { border-color:var(--primary);color:var(--primary); }
    .gcnt.on:hover { color:white; }

    #warnBanner {
      position:fixed;top:0;left:0;right:0;z-index:200;
      background:#EA4335;color:white;text-align:center;
      padding:10px;font-weight:600;font-size:14px;
      transform:translateY(-100%);transition:transform .3s ease;
    }
    #warnBanner.show { transform:translateY(0); }

    .sbar { height:4px;border-radius:2px;background:#E8EAED;overflow:hidden; }
    .sbar-fill { height:100%;border-radius:2px;transition:width .3s ease; }

    .syllabus-note {
      background: #FEF7E0; border-left: 4px solid #FBBC04; padding: 12px;
      border-radius: 8px; margin: 16px 0; font-size: 12px; color: #5F6368;
    }
    .variant-badge {
      display: inline-block; font-size: 10px; padding: 2px 8px;
      border-radius: 12px; margin-left: 4px; font-weight: 600;
    }
    .new-badge {
      display: inline-block; font-size: 10px; padding: 2px 8px;
      border-radius: 12px; background: #E8F5E9; color: #2E7D32; font-weight: 700;
    }

    /* â”€â”€ Countdown Banner â”€â”€ */
    #countdownBanner {
      position: fixed; top: 0; left: 0; right: 0; z-index: 60;
      height: 38px;
      background: linear-gradient(90deg, #0D1B2A 0%, #1A1A2E 40%, #0D1B2A 100%);
      display: flex; align-items: center; justify-content: center; gap: 0;
      overflow: hidden;
    }
    #countdownBanner::before {
      content: ''; position: absolute; inset: 0;
      background: repeating-linear-gradient(90deg, transparent, transparent 120px, rgba(255,255,255,.018) 120px, rgba(255,255,255,.018) 121px);
      pointer-events: none;
    }
    .cd-block {
      display: flex; flex-direction: column; align-items: center;
      padding: 0 14px; position: relative;
    }
    .cd-block + .cd-block::before {
      content: ':';
      position: absolute; left: -2px; top: 50%; transform: translateY(-56%);
      font-size: 16px; font-weight: 700; color: rgba(255,255,255,.25);
      font-family: 'Roboto Mono', monospace;
    }
    .cd-num {
      font-family: 'Roboto Mono', monospace;
      font-size: 18px; font-weight: 700; line-height: 1;
      color: white; letter-spacing: .04em;
      transition: color .4s ease;
    }
    .cd-label {
      font-size: 8px; font-weight: 600; letter-spacing: .1em;
      color: rgba(255,255,255,.35); text-transform: uppercase; line-height: 1; margin-top: 1px;
    }
    .cd-num.urgent { color: #F87171; animation: cdpulse 1s ease-in-out infinite; }
    @keyframes cdpulse { 0%,100%{opacity:1}50%{opacity:.6} }

    .cd-divider {
      width: 1px; height: 22px; background: rgba(255,255,255,.1); margin: 0 4px;
    }

    #hitokobar {
      flex: 1; max-width: 340px; overflow: hidden;
      margin: 0 16px;
    }
    #hitokotext {
      font-size: 11px; color: rgba(255,255,255,.45);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      font-style: italic; transition: opacity .5s ease;
    }

    #examDateTag {
      font-size: 10px; color: rgba(255,255,255,.3);
      letter-spacing: .05em; white-space: nowrap; padding-right: 16px;
      cursor: pointer;
    }
    #examDateTag:hover { color: rgba(255,255,255,.6); }

    /* â”€â”€ Shift everything down by banner height â”€â”€ */
    #appbar { top: 38px !important; }
    #filterPanel { top: 52px !important; }
    #mainContent { padding-top: calc(3.5rem + 38px) !important; }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• COUNTDOWN BANNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="countdownBanner">
  <!-- Countdown blocks inserted by JS -->
  <div id="cdBlocks" class="flex items-center"></div>
  <div class="cd-divider hidden sm:block"></div>
  <div id="hitokobar" class="hidden sm:block">
    <div id="hitokotext">loading...</div>
  </div>
  <span id="examDateTag" onclick="openSettings()" title="ç‚¹å‡»è®¾ç½®è€ƒè¯•æ—¥æœŸ">ğŸ“… è®¾ç½®è€ƒè¯•æ—¥æœŸ</span>
</div>

<header id="appbar" class="fixed top-0 left-0 right-0 z-50 bg-white h-14 flex items-center px-4 gap-3 select-none" style="box-shadow:0 1px 3px rgba(0,0,0,0.12)">
  <span class="mi" style="color:var(--primary);font-size:24px">bolt</span>
  <span class="font-bold text-base" style="color:#202124;letter-spacing:-.3px">Warden Mock</span>
  <div style="flex:1"></div>
  <span id="dateDisp" class="text-xs hidden sm:block" style="color:var(--text-sub)"></span>
  <div class="relative cursor-pointer" style="width:34px;height:34px" id="progWrap" title="å®Œæˆè¿›åº¦">
    <svg viewBox="0 0 36 36" style="width:34px;height:34px;transform:rotate(-90deg)">
      <circle cx="18" cy="18" r="15.9" fill="none" stroke="#E8EAED" stroke-width="3"/>
      <circle id="progArc" cx="18" cy="18" r="15.9" fill="none" stroke="var(--primary)" stroke-width="3" stroke-dasharray="0 100" stroke-linecap="round" style="transition:stroke-dasharray .5s ease"/>
    </svg>
    <span id="progPct" class="absolute inset-0 flex items-center justify-center font-bold" style="font-size:8px;color:var(--primary)">0%</span>
  </div>
  <button onclick="openSettings()" class="p-2 rounded-full transition-colors hover:bg-gray-100" title="è®¾ç½®" style="border:none;background:transparent;cursor:pointer">
    <span class="mi" style="color:#5F6368">settings</span>
  </button>
  <button id="mobileFilterBtn" onclick="openMobileFilter()" class="p-2 rounded-full transition-colors hover:bg-gray-100" style="display:none;border:none;background:transparent;cursor:pointer" title="ç­›é€‰">
    <span class="mi" style="color:#5F6368">filter_list</span>
  </button>
</header>

<aside id="filterPanel" class="fixed left-0 top-14 bottom-0 bg-white z-40 overflow-y-auto" style="width:260px">
  <div class="sticky top-0 bg-white z-10 p-3" style="border-bottom:1px solid var(--border)">
    <button onclick="clearFilters()" class="btn btn-o w-full text-xs" style="padding:7px 10px">
      <span class="mi" style="font-size:16px">clear_all</span> æ¸…é™¤æ‰€æœ‰ç­›é€‰
    </button>
  </div>
  <div id="filterSections"></div>
</aside>

<main id="mainContent" class="pt-14" style="margin-left:260px;padding-bottom:100px">
  <div class="p-4">
    <div class="syllabus-note">
      <span class="mi" style="font-size:14px;vertical-align:middle">info</span>
      <strong>ğŸ“‹ è€ƒçº² & é¢˜åº“è¯´æ˜ï¼ˆ2020â€“2025ï¼‰ï¼š</strong>
      <ul style="margin-top:6px;margin-left:20px">
        <li>ğŸ“ <strong>0580 æ•°å­¦</strong>ï¼šP1/P2å„1 hour 30 minutes(70åˆ†)ï¼ŒP3å…±2 hours(104åˆ†)ï¼ŒP4å…±2 hours 30 minutes(130åˆ†)</li>
        <li>ğŸ”¬ <strong>ç†ç§‘(0610/0620/0625)</strong>ï¼šP1/P2å„45 minutes(40åˆ†)ï¼ŒP3/P4å„1 hour 15 minutes(80åˆ†)ï¼ŒP5å…±1 hour 15 minutes(40åˆ†)ï¼ŒP6å…±1 hour(40åˆ†)</li>
        <li>âš ï¸ <strong>2025æ–°è€ƒçº²(0580)</strong>ï¼šP2æ”¹ä¸º2 hours(100åˆ†)éè®¡ç®—å™¨ï¼›P4æ”¹ä¸º2 hours(100åˆ†)è®¡ç®—å™¨ï¼›P1/P3ä¸å˜</li>
        <li>ğŸ“… <strong>è€ƒå­£è§„å¾‹</strong>ï¼šMarchä»…æ—¶åŒº2ï¼›May/Juneå’ŒOct/Novå„æœ‰æ—¶åŒº1ã€2ã€3</li>
        <li>ğŸŸ¢ <strong>2025å¹´å·å­</strong>ï¼šæŒ‰è§„å¾‹æ¨ç®—ï¼ˆMarchå·²è€ƒï¼ŒMJ/ONé¢„æµ‹ï¼‰</li>
      </ul>
    </div>

    <div class="flex items-center flex-wrap gap-2 mb-4 px-4 py-3 bg-white rounded-2xl" style="box-shadow:0 1px 3px rgba(0,0,0,0.12)">
      <span id="filterCount" class="text-sm font-medium" style="color:#202124">ç­›é€‰åˆ° 0 å¼ å·å­</span>
      <div style="flex:1"></div>
      <select id="sortSel" onchange="applyFilters()" class="text-xs bg-white rounded-xl cursor-pointer focus:outline-none" style="border:1.5px solid var(--border);padding:6px 10px;color:var(--text-sub)">
        <option value="year-desc">å¹´ä»½ â†“ æœ€æ–°</option>
        <option value="year-asc">å¹´ä»½ â†‘ æœ€æ—©</option>
        <option value="dur-asc">æ—¶é•¿ â†‘ çŸ­â†’é•¿</option>
        <option value="dur-desc">æ—¶é•¿ â†“ é•¿â†’çŸ­</option>
        <option value="subj">æŒ‰ç§‘ç›®æ’åº</option>
      </select>
      <button onclick="selectAll()" class="btn btn-o text-xs" style="padding:6px 12px">å…¨é€‰</button>
      <button onclick="invertSel()" class="btn btn-o text-xs" style="padding:6px 12px">åé€‰</button>
      <button onclick="openGacha()" class="btn btn-g text-xs" style="padding:6px 16px">
        <span class="mi" style="font-size:16px">casino</span> éšæœºæŠ½å–
      </button>
      <button onclick="openSearch()" class="btn text-xs" style="padding:6px 16px;background:linear-gradient(135deg,#0F9D58,#34A853);color:white">
        <span class="mi" style="font-size:16px">search</span> è¾“å…¥ä»£ç 
      </button>
    </div>
    <div id="cardGrid" class="grid gap-4" style="grid-template-columns:repeat(auto-fill,minmax(240px,1fr))"></div>
    <div id="emptyState" class="hidden flex-col items-center justify-center py-20 text-center" style="display:none">
      <span class="mi" style="font-size:64px;color:#DADCE0">search_off</span>
      <p class="text-lg mt-4" style="color:#9AA0A6">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å·å­</p>
      <button onclick="clearFilters()" class="btn btn-o mt-4">æ¸…é™¤ç­›é€‰æ¡ä»¶</button>
    </div>
  </div>
</main>

<div id="cartOverlay" class="fixed inset-0 z-[60] hidden" style="background:rgba(0,0,0,0.45);backdrop-filter:blur(3px)" onclick="closeCartDrawer()"></div>

<div id="cartDrawer" class="fixed top-0 right-0 bottom-0 z-[70] flex flex-col bg-white" style="width:420px;max-width:100vw;transform:translateX(100%);transition:transform 0.35s cubic-bezier(0.4,0,0.2,1);box-shadow:-8px 0 40px rgba(0,0,0,0.18)">
  <div class="flex items-center justify-between px-5 py-4 flex-shrink-0" style="border-bottom:2px solid var(--border);background:white">
    <div class="flex items-center gap-3">
      <div style="width:36px;height:36px;border-radius:10px;background:#E8F0FE;display:flex;align-items:center;justify-content:center">
        <span class="mi" style="color:var(--primary);font-size:20px">shopping_cart</span>
      </div>
      <div>
        <h2 class="font-bold text-base" style="color:#202124;letter-spacing:-.3px">ä»Šæ—¥æ¸…å•</h2>
        <p id="cartDrawerSubtitle" class="text-xs" style="color:var(--text-sub)">æš‚æ— å·å­</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button onclick="clearCart()" id="cartClearBtn" class="btn btn-o" style="font-size:12px;padding:5px 12px;color:var(--danger);border-color:var(--danger)" disabled>
        <span class="mi" style="font-size:15px">delete_sweep</span> æ¸…ç©º
      </button>
      <button onclick="closeCartDrawer()" style="background:none;border:none;cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background .15s" onmouseover="this.style.background='#F1F3F4'" onmouseout="this.style.background='none'">
        <span class="mi" style="color:#5F6368">close</span>
      </button>
    </div>
  </div>

  <div id="cartSubjectSummary" class="flex-shrink-0 px-5 py-3" style="border-bottom:1px solid var(--border);background:#FAFAFA;display:none">
    <div id="cartSubjectTags" class="flex flex-wrap gap-2"></div>
  </div>

  <!-- Smart warnings panel -->
  <div id="cartWarnings" class="flex-shrink-0" style="display:none"></div>

  <div id="cartList" class="flex-1 overflow-y-auto" style="padding:16px 16px 0"></div>

  <div class="flex-shrink-0" style="border-top:2px solid var(--border);background:white">
    <div class="px-5 py-3" style="background:#F8F9FA;border-bottom:1px solid var(--border)">
      <div class="grid grid-cols-3 gap-3">
        <div class="text-center p-2 bg-white rounded-xl" style="box-shadow:0 1px 3px rgba(0,0,0,.07)">
          <div id="cartStatCount" class="font-bold text-lg" style="color:var(--primary)">0</div>
          <div class="text-xs" style="color:var(--text-sub)">å¼ å·å­</div>
        </div>
        <div class="text-center p-2 bg-white rounded-xl" style="box-shadow:0 1px 3px rgba(0,0,0,.07)">
          <div id="cartStatTime" class="font-bold text-lg" style="color:#9334E8">--</div>
          <div class="text-xs" style="color:var(--text-sub)">æ€»æ—¶é•¿</div>
        </div>
        <div class="text-center p-2 bg-white rounded-xl" style="box-shadow:0 1px 3px rgba(0,0,0,.07)">
          <div id="cartStatMarks" class="font-bold text-lg" style="color:var(--success)">0</div>
          <div class="text-xs" style="color:var(--text-sub)">æ€»åˆ†å€¼</div>
        </div>
      </div>
    </div>
    <div class="px-5 py-4">
      <button onclick="startExam()" id="startExamBtn" class="btn btn-p w-full" disabled style="font-size:15px;padding:14px;justify-content:center;border-radius:14px;letter-spacing:.3px">
        <span class="mi" style="font-size:20px">play_circle</span>&nbsp;å¼€å§‹æ¨¡è€ƒ
      </button>
      <p class="text-center text-xs mt-2" style="color:#9AA0A6">è¯•å·å°†æŒ‰æ¸…å•é¡ºåºä¾æ¬¡è¿›è¡Œï¼Œå¯æ‹–æ‹½è°ƒæ•´é¡ºåº</p>
    </div>
  </div>
</div>

<button onclick="openCartDrawer()" id="cartFab" class="fixed z-50 flex items-center gap-2 shadow-lg" style="bottom:28px;right:28px;background:var(--primary);color:white;border:none;cursor:pointer;border-radius:28px;padding:14px 20px;font-family:inherit;font-size:14px;font-weight:600;transition:all .2s ease;box-shadow:0 4px 20px rgba(26,115,232,.45)" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 28px rgba(26,115,232,.5)'" onmouseout="this.style.transform='';this.style.boxShadow='0 4px 20px rgba(26,115,232,.45)'">
  <span class="mi" style="font-size:22px">shopping_cart</span>
  <span>ä»Šæ—¥æ¸…å•</span>
  <span id="cartCount" style="background:white;color:var(--primary);border-radius:20px;padding:2px 9px;font-size:12px;font-weight:700;min-width:24px;text-align:center">0</span>
</button>

<div id="gachaModal" class="fixed inset-0 z-50 hidden items-center justify-center mbg" style="display:none">
  <div id="gachaBox" class="bg-white rounded-2xl p-6 mx-4 relative" style="width:440px;max-width:100%;max-height:92vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)"></div>
</div>

<div id="settingsOv" class="fixed inset-0 z-50 hidden mbg" onclick="closeSettings()"></div>
<div id="settingsDr" class="fixed top-0 right-0 bottom-0 z-50 bg-white overflow-y-auto" style="width:360px">
  <div class="flex items-center justify-between px-5 py-4 flex-shrink-0" style="border-bottom:1px solid var(--border);position:sticky;top:0;background:white;z-index:1">
    <h2 class="font-bold text-base" style="color:#202124">è®¾ç½®</h2>
    <button onclick="closeSettings()" style="background:none;border:none;cursor:pointer;padding:4px;border-radius:50%">
      <span class="mi" style="color:#5F6368">close</span>
    </button>
  </div>
  <div class="p-5 space-y-5">

    <!-- â‘  æŠ¥è€ƒä¿¡æ¯ (most important, top) -->
    <div style="background:linear-gradient(135deg,#1A1A2E,#16213E);border-radius:16px;padding:18px">
      <div class="flex items-center gap-2 mb-1">
        <span class="mi" style="color:#818cf8;font-size:18px">badge</span>
        <p class="font-bold text-sm" style="color:white">æˆ‘çš„æŠ¥è€ƒä¿¡æ¯</p>
      </div>
      <p class="text-xs mb-4" style="color:rgba(255,255,255,.4)">å¡«å†™åå°†è‡ªåŠ¨æ¨èå·å­å¹¶æ£€æµ‹æ¸…å•ä¸­çš„é—®é¢˜</p>

      <!-- Subjects -->
      <div class="mb-4">
        <label class="text-xs font-semibold mb-2 block" style="color:rgba(255,255,255,.6)">ğŸ“š æŠ¥è€ƒç§‘ç›®ï¼ˆå¯å¤šé€‰ï¼‰</label>
        <div class="flex flex-wrap gap-2" id="profileSubjects">
          <div class="fchip" data-v="0580" onclick="toggleProfileSubject('0580')" style="background:rgba(26,115,232,.15);border-color:rgba(26,115,232,.3);color:#93c5fd">0580 æ•°å­¦</div>
          <div class="fchip" data-v="0610" onclick="toggleProfileSubject('0610')" style="background:rgba(52,168,83,.15);border-color:rgba(52,168,83,.3);color:#86efac">0610 ç”Ÿç‰©</div>
          <div class="fchip" data-v="0620" onclick="toggleProfileSubject('0620')" style="background:rgba(255,109,0,.15);border-color:rgba(255,109,0,.3);color:#fdba74">0620 åŒ–å­¦</div>
          <div class="fchip" data-v="0625" onclick="toggleProfileSubject('0625')" style="background:rgba(147,52,232,.15);border-color:rgba(147,52,232,.3);color:#c4b5fd">0625 ç‰©ç†</div>
        </div>
      </div>

      <!-- Session -->
      <div class="mb-4">
        <label class="text-xs font-semibold mb-2 block" style="color:rgba(255,255,255,.6)">ğŸ—“ å‚åŠ è€ƒå­£</label>
        <div class="flex flex-wrap gap-2" id="profileSession">
          <div class="fchip" data-v="May/June" onclick="selectProfileSession('May/June')" style="background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.15);color:rgba(255,255,255,.7)">May/June</div>
          <div class="fchip" data-v="Oct/Nov" onclick="selectProfileSession('Oct/Nov')" style="background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.15);color:rgba(255,255,255,.7)">Oct/Nov</div>
          <div class="fchip" data-v="March" onclick="selectProfileSession('March')" style="background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.15);color:rgba(255,255,255,.7)">March</div>
        </div>
      </div>

      <!-- Year -->
      <div class="mb-4">
        <label class="text-xs font-semibold mb-2 block" style="color:rgba(255,255,255,.6)">ğŸ“… è€ƒè¯•å¹´ä»½</label>
        <div class="flex flex-wrap gap-2" id="profileYear">
          <div class="fchip" data-v="2026" onclick="selectProfileYear('2026')" style="background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.15);color:rgba(255,255,255,.7)">2026 ğŸŸ¢</div>
          <div class="fchip" data-v="2027" onclick="selectProfileYear('2027')" style="background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.15);color:rgba(255,255,255,.7)">2027</div>
        </div>
      </div>

      <!-- Region / Variant -->
      <div class="mb-4">
        <label class="text-xs font-semibold mb-2 block" style="color:rgba(255,255,255,.6)">ğŸŒ è€ƒè¯•åœ°åŒºï¼ˆå˜ä½“ï¼‰</label>
        <div class="flex flex-wrap gap-2" id="profileVariant">
          <div class="fchip" data-v="2" onclick="selectProfileVariant('2')" style="background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.15);color:rgba(255,255,255,.7)">ğŸ‡¨ğŸ‡³ V2 ä¸­å›½å¤§é™†/ä¸œäºš</div>
          <div class="fchip" data-v="1" onclick="selectProfileVariant('1')" style="background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.15);color:rgba(255,255,255,.7)">ğŸ‡¬ğŸ‡§ V1 è‹±å›½/æ¬§æ´²</div>
          <div class="fchip" data-v="3" onclick="selectProfileVariant('3')" style="background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.15);color:rgba(255,255,255,.7)">ğŸ‡¦ğŸ‡º V3 æ¾³æ´²/ä¸œå—äºš</div>
        </div>
      </div>

      <!-- Paper tiers per subject -->
      <div class="mb-4" id="profileTierSection">
        <label class="text-xs font-semibold mb-2 block" style="color:rgba(255,255,255,.6)">ğŸ“„ å‚åŠ çš„å·å‹ï¼ˆCore/Extendedï¼‰</label>
        <div id="profileTiers" class="flex flex-wrap gap-2">
          <!-- Rendered by JS -->
        </div>
        <p class="text-xs mt-1" style="color:rgba(255,255,255,.25)">Extended = P2/P4ï¼›Core = P1/P3ï¼›ç†ç§‘ P6 = Alt. to Practical</p>
      </div>

      <!-- Smart filter button -->
      <button onclick="applyProfileFilter()" class="btn w-full" style="background:linear-gradient(90deg,#4f46e5,#7c3aed);color:white;justify-content:center;padding:10px;font-size:13px;border-radius:10px">
        <span class="mi" style="font-size:16px">filter_alt</span>&nbsp;åªæ˜¾ç¤ºæˆ‘éœ€è¦çš„å·å­
      </button>
      <p class="text-xs text-center mt-2" style="color:rgba(255,255,255,.25)">å°†è‡ªåŠ¨ç­›é€‰ï¼šä½ çš„ç§‘ç›® + æ­£ç¡®è€ƒå­£ + æ­£ç¡®å˜ä½“ + æ–°è€ƒçº²</p>
    </div>

    <!-- â‘¡ Exam Mode -->
    <div>
      <p class="font-semibold text-sm mb-1" style="color:#202124">è€ƒè¯•æ¨¡å¼</p>
      <p class="text-xs mb-3" style="color:var(--text-sub)">ä¸¥æ ¼æ¨¡å¼ä¸‹ä¸å…è®¸æš‚åœï¼Œé€€å‡ºå…¨å±è‡ªåŠ¨æ¢å¤ï¼›ç»ƒä¹ æ¨¡å¼å¯éšæ—¶æš‚åœ</p>
      <div class="flex rounded-xl overflow-hidden" style="border:1.5px solid var(--border)">
        <button id="modeStrict" onclick="setMode('strict')" class="flex-1 py-2 text-sm font-medium transition-colors" style="background:var(--primary);color:white;border:none;cursor:pointer">âš¡ ä¸¥æ ¼æ¨¡å¼</button>
        <button id="modePrac" onclick="setMode('practice')" class="flex-1 py-2 text-sm font-medium transition-colors" style="background:white;color:var(--text-sub);border:none;cursor:pointer">ğŸ“ ç»ƒä¹ æ¨¡å¼</button>
      </div>
    </div>

    <!-- â‘¢ Stats -->
    <div style="background:#F8F9FA;border-radius:12px;padding:16px">
      <p class="font-semibold text-sm mb-3" style="color:#202124">å­¦ä¹ ç»Ÿè®¡</p>
      <div class="grid grid-cols-2 gap-3">
        <div class="text-center p-3 bg-white rounded-xl" style="box-shadow:0 1px 3px rgba(0,0,0,.08)">
          <p id="statDone" class="font-bold text-xl" style="color:var(--success)">0</p>
          <p class="text-xs mt-1" style="color:var(--text-sub)">å·²å®Œæˆ</p>
        </div>
        <div class="text-center p-3 bg-white rounded-xl" style="box-shadow:0 1px 3px rgba(0,0,0,.08)">
          <p id="statTotal" class="font-bold text-xl" style="color:var(--primary)">0</p>
          <p class="text-xs mt-1" style="color:var(--text-sub)">æ€»å·æ•°</p>
        </div>
        <div class="text-center p-3 bg-white rounded-xl col-span-2" style="box-shadow:0 1px 3px rgba(0,0,0,.08)">
          <p id="statTime" class="font-bold text-xl" style="color:#9334E8">0h 0min</p>
          <p class="text-xs mt-1" style="color:var(--text-sub)">ç´¯è®¡æ¨¡è€ƒæ—¶é•¿</p>
        </div>
      </div>
    </div>

    <!-- â‘£ Danger zone -->
    <div>
      <p class="font-semibold text-sm mb-2" style="color:#202124">å±é™©æ“ä½œ</p>
      <button onclick="confirmReset()" class="btn btn-d w-full" style="justify-content:center">
        <span class="mi" style="font-size:16px">delete_forever</span> é‡ç½®æ‰€æœ‰è¿›åº¦
      </button>
    </div>

    <!-- â‘¤ Countdown settings -->
    <div style="background:#0D1B2A;border-radius:12px;padding:16px">
      <p class="font-semibold text-sm mb-1" style="color:white">â³ è€ƒè¯•å€’è®¡æ—¶è®¾ç½®</p>
      <p class="text-xs mb-3" style="color:rgba(255,255,255,.4)">æ˜¾ç¤ºåœ¨é¡¶éƒ¨æ¨ªå¹…ï¼Œæ—¶åˆ»ä¿æŒç´§è¿«æ„Ÿ</p>
      <div class="mb-3">
        <label class="text-xs font-semibold mb-1 block" style="color:rgba(255,255,255,.6)">è€ƒè¯•æ—¥æœŸ</label>
        <input id="examDateInput" type="date"
          class="rounded-lg text-sm focus:outline-none w-full"
          style="border:1.5px solid rgba(255,255,255,.15);padding:7px 10px;font-family:inherit;color:white;background:rgba(255,255,255,.08);transition:border .15s"
          onfocus="this.style.borderColor='var(--primary)'"
          onblur="this.style.borderColor='rgba(255,255,255,.15)'"
          onchange="saveExamDate(this.value)" />
        <p class="text-xs mt-1" style="color:rgba(255,255,255,.3)">å‚è€ƒæ—¶é—´è¡¨ï¼šMay/June 2026 ä» 4æœˆ28æ—¥ å¼€å§‹</p>
      </div>
      <div>
        <label class="text-xs font-semibold mb-2 block" style="color:rgba(255,255,255,.6)">æ˜¾ç¤ºå•ä½</label>
        <div class="flex flex-wrap gap-2" id="cdUnitBtns">
          <button onclick="setCdUnit('wdh')" id="cdu-wdh" class="gcnt" style="font-size:11px;width:auto;padding:0 10px;height:32px">å‘¨/å¤©/æ—¶</button>
          <button onclick="setCdUnit('dh')"  id="cdu-dh"  class="gcnt" style="font-size:11px;width:auto;padding:0 10px;height:32px">å¤©/æ—¶</button>
          <button onclick="setCdUnit('d')"   id="cdu-d"   class="gcnt" style="font-size:11px;width:auto;padding:0 10px;height:32px">å¤©</button>
          <button onclick="setCdUnit('h')"   id="cdu-h"   class="gcnt" style="font-size:11px;width:auto;padding:0 10px;height:32px">å°æ—¶</button>
        </div>
      </div>
    </div>

  </div>
</div>

<div id="examOv" class="fixed inset-0 z-[100] hidden" style="display:none">
  <div id="warnBanner" style="position:fixed;top:0;left:0;right:0;z-index:200;background:#EA4335;color:white;text-align:center;padding:10px;font-weight:600;font-size:14px;transform:translateY(-100%);transition:transform .3s ease">âš ï¸ è­¦å‘Šï¼å·²é€€å‡ºå…¨å±ã€‚æ­£åœ¨è‡ªåŠ¨æ¢å¤â€¦</div>
  <div id="examContent" class="flex flex-col items-center justify-center h-full px-8 text-center relative" style="z-index:1"></div>
  <div class="wm" id="examWm"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SEARCH / CUSTOM PAPER MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="searchModal" class="fixed inset-0 z-50 hidden items-center justify-center mbg" style="display:none" onclick="handleSearchModalBg(event)">
  <div id="searchBox" class="bg-white rounded-2xl mx-4 relative flex flex-col" style="width:480px;max-width:100%;max-height:90vh;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
    <!-- Header -->
    <div class="flex items-center gap-3 px-5 py-4 flex-shrink-0" style="border-bottom:1.5px solid var(--border)">
      <div style="width:36px;height:36px;border-radius:10px;background:#E8F5E9;display:flex;align-items:center;justify-content:center;flex-shrink:0">
        <span class="mi" style="color:#34A853;font-size:20px">search</span>
      </div>
      <div>
        <h2 class="font-bold text-base" style="color:#202124">è¾“å…¥å·å­ä»£ç </h2>
        <p class="text-xs" style="color:var(--text-sub)">å¦‚ 0580/41ã€0625/62ã€0610/32</p>
      </div>
      <div style="flex:1"></div>
      <button onclick="closeSearch()" style="background:none;border:none;cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background .15s" onmouseover="this.style.background='#F1F3F4'" onmouseout="this.style.background='none'">
        <span class="mi" style="color:#5F6368">close</span>
      </button>
    </div>

    <!-- Search input -->
    <div class="px-5 pt-4 pb-3 flex-shrink-0">
      <div class="flex gap-2">
        <div class="relative flex-1">
          <span class="mi" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#9AA0A6;font-size:18px;pointer-events:none">tag</span>
          <input id="searchInput" type="text" placeholder="ä¾‹ï¼š0580/41 æˆ– 0625/62"
            class="w-full rounded-xl text-sm focus:outline-none"
            style="border:2px solid var(--border);padding:10px 12px 10px 38px;font-family:inherit;color:#202124;transition:border .15s"
            oninput="onSearchInput(this.value)"
            onkeydown="if(event.key==='Enter')doSearch()"
            onfocus="this.style.borderColor='var(--primary)'"
            onblur="this.style.borderColor='var(--border)'" />
        </div>
        <button onclick="doSearch()" class="btn btn-p" style="padding:10px 18px;flex-shrink:0">
          <span class="mi" style="font-size:18px">search</span>
        </button>
      </div>
      <p class="text-xs mt-2" style="color:#9AA0A6">æ ¼å¼ï¼šç§‘ç›®ä»£ç /å·å·å˜ä½“ï¼Œå¦‚ <code style="background:#F1F3F4;padding:1px 5px;border-radius:4px">0580/41</code> = æ•°å­¦ Paper 4 Variant 1</p>
    </div>

    <!-- Results / Add form area -->
    <div id="searchResults" class="flex-1 overflow-y-auto px-5 pb-5"></div>
  </div>
</div>

<div id="toast"></div>

<div id="mobileFilterOv" class="fixed inset-0 z-50 hidden mbg" onclick="closeMobileFilter()"></div>
<div id="mobileFilterSheet" class="fixed bottom-0 left-0 right-0 z-50 bg-white rounded-t-2xl overflow-y-auto transition-transform" style="max-height:80vh;transform:translateY(100%);box-shadow:0 -4px 24px rgba(0,0,0,.15)">
  <div class="flex items-center justify-between p-4" style="border-bottom:1px solid var(--border)">
    <h3 class="font-semibold">ç­›é€‰</h3>
    <button onclick="closeMobileFilter()" style="background:none;border:none;cursor:pointer">
      <span class="mi">close</span>
    </button>
  </div>
  <div id="mobileFilterSections" class="p-4"></div>
</div>

<script>
// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘              PAPER DATABASE â€” COMPLETE VERSION          â•‘
// â•‘  è§„å¾‹ï¼šæ¯å¹´ March(V2) + MJ(V1/2/3) + ON(V1/2/3)       â•‘
// â•‘  ç§‘ç›®ï¼š0580æ•°å­¦ + 0610ç”Ÿç‰© + 0620åŒ–å­¦ + 0625ç‰©ç†        â•‘
// â•‘  å¹´ä»½ï¼š2020-2025ï¼ˆ2025æŒ‰è§„å¾‹æ¨ç®—ï¼‰                       â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function generatePaperDB() {
  const db = [];

  const YEARS = [2025, 2024, 2023, 2022, 2021, 2020];

  const VARIANT_REGIONS = {
    1: { name: 'Variant 1', region: 'ğŸ‡¬ğŸ‡§ æ—¶åŒº1 è‹±/æ¬§/é/ç¾' },
    2: { name: 'Variant 2', region: 'ğŸ‡¨ğŸ‡³ æ—¶åŒº2 ä¸­/ä¸œäºš/å·´' },
    3: { name: 'Variant 3', region: 'ğŸ‡¦ğŸ‡º æ—¶åŒº3 æ¾³/æ–°/ä¸œå—äºš' },
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 0580 Mathematics
  // 2020-2024: P1 1h30m/70åˆ†, P2 1h30m/70åˆ†, P3 2h/104åˆ†, P4 2h30m/130åˆ†
  // 2025æ–°è€ƒçº²: P1 1h30m/70åˆ†(ä¸å˜), P2 2h/100åˆ†(éè®¡ç®—å™¨), P3 2h/104åˆ†(ä¸å˜), P4 2h/100åˆ†(è®¡ç®—å™¨)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function getMathPapers(year) {
    if (year >= 2025) {
      return [
        { code: 'P1', full: 'Paper 1', duration: 90,  marks: 70,  tier: 'Core',     note: 'éè®¡ç®—å™¨' },
        { code: 'P2', full: 'Paper 2', duration: 120, marks: 100, tier: 'Extended', note: 'éè®¡ç®—å™¨ [æ–°è€ƒçº²]' },
        { code: 'P3', full: 'Paper 3', duration: 120, marks: 104, tier: 'Core',     note: 'è®¡ç®—å™¨' },
        { code: 'P4', full: 'Paper 4', duration: 120, marks: 100, tier: 'Extended', note: 'è®¡ç®—å™¨ [æ–°è€ƒçº²]' },
      ];
    }
    return [
      { code: 'P1', full: 'Paper 1', duration: 90,  marks: 70,  tier: 'Core',     note: '' },
      { code: 'P2', full: 'Paper 2', duration: 90,  marks: 70,  tier: 'Extended', note: '' },
      { code: 'P3', full: 'Paper 3', duration: 120, marks: 104, tier: 'Core',     note: '' },
      { code: 'P4', full: 'Paper 4', duration: 150, marks: 130, tier: 'Extended', note: '' },
    ];
  }

  for (const year of YEARS) {
    const mathPapers = getMathPapers(year);
    const isNew = year >= 2025;
    const isPredict = year >= 2025;

    // March â€” ä»… Variant 2
    for (const pt of mathPapers) {
      db.push({
        id: `0580-${year}-MA-${pt.code}2`,
        subject: '0580', subjectName: 'Mathematics',
        subjectIcon: 'calculate', subjectColor: '#1A73E8',
        year, paper: `${pt.code}2`,
        paperFull: `${pt.full} (${VARIANT_REGIONS[2].name})`,
        variantRegion: VARIANT_REGIONS[2].region,
        session: 'March', duration: pt.duration,
        totalMarks: pt.marks, tier: pt.tier,
        locked: false,
        syllabusInfo: isNew ? pt.note : '',
        isPredicted: isPredict,
      });
    }

    // May/June â€” Variant 1, 2, 3
    for (const pt of mathPapers) {
      for (const v of [1, 2, 3]) {
        db.push({
          id: `0580-${year}-MJ-${pt.code}${v}`,
          subject: '0580', subjectName: 'Mathematics',
          subjectIcon: 'calculate', subjectColor: '#1A73E8',
          year, paper: `${pt.code}${v}`,
          paperFull: `${pt.full} (${VARIANT_REGIONS[v].name})`,
          variantRegion: VARIANT_REGIONS[v].region,
          session: 'May/June', duration: pt.duration,
          totalMarks: pt.marks, tier: pt.tier,
          locked: false,
          syllabusInfo: isNew ? pt.note : '',
          isPredicted: isPredict,
        });
      }
    }

    // Oct/Nov â€” Variant 1, 2, 3
    for (const pt of mathPapers) {
      for (const v of [1, 2, 3]) {
        db.push({
          id: `0580-${year}-ON-${pt.code}${v}`,
          subject: '0580', subjectName: 'Mathematics',
          subjectIcon: 'calculate', subjectColor: '#1A73E8',
          year, paper: `${pt.code}${v}`,
          paperFull: `${pt.full} (${VARIANT_REGIONS[v].name})`,
          variantRegion: VARIANT_REGIONS[v].region,
          session: 'Oct/Nov', duration: pt.duration,
          totalMarks: pt.marks, tier: pt.tier,
          locked: false,
          syllabusInfo: isNew ? pt.note : '',
          isPredicted: isPredict,
        });
      }
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ç†ç§‘ 0610 Biology / 0620 Chemistry / 0625 Physics
  // å®Œå…¨ç›¸åŒçš„ç»“æ„ï¼š
  //   P1: 45min / 40åˆ† (Core MCQ)
  //   P2: 45min / 40åˆ† (Extended MCQ)
  //   P3: 75min / 80åˆ† (Core Theory)
  //   P4: 75min / 80åˆ† (Extended Theory)
  //   P5: 75min / 40åˆ† (Practical)
  //   P6: 60min / 40åˆ† (Alt. to Practical)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const SCI_PAPERS = [
    { code: 'P1', full: 'Paper 1', duration: 45, marks: 40, tier: 'Core MCQ' },
    { code: 'P2', full: 'Paper 2', duration: 45, marks: 40, tier: 'Extended MCQ' },
    { code: 'P3', full: 'Paper 3', duration: 75, marks: 80, tier: 'Core Theory' },
    { code: 'P4', full: 'Paper 4', duration: 75, marks: 80, tier: 'Extended Theory' },
    { code: 'P5', full: 'Paper 5', duration: 75, marks: 40, tier: 'Practical' },
    { code: 'P6', full: 'Paper 6', duration: 60, marks: 40, tier: 'Alt. to Practical' },
  ];

  const SCI_SUBJECTS = [
    { subject: '0610', subjectName: 'Biology',   subjectIcon: 'biotech',   subjectColor: '#34A853' },
    { subject: '0620', subjectName: 'Chemistry', subjectIcon: 'science',   subjectColor: '#FF6D00' },
    { subject: '0625', subjectName: 'Physics',   subjectIcon: 'bolt',      subjectColor: '#9334E8' },
  ];

  for (const subj of SCI_SUBJECTS) {
    for (const year of YEARS) {
      const isPredict = year >= 2025;

      // March â€” Variant 2 only
      for (const pt of SCI_PAPERS) {
        db.push({
          id: `${subj.subject}-${year}-MA-${pt.code}2`,
          ...subj, year, paper: `${pt.code}2`,
          paperFull: `${pt.full} (${VARIANT_REGIONS[2].name})`,
          variantRegion: VARIANT_REGIONS[2].region,
          session: 'March', duration: pt.duration, totalMarks: pt.marks, tier: pt.tier,
          locked: false, syllabusInfo: '', isPredicted: isPredict,
        });
      }

      // May/June â€” Variant 1, 2, 3
      for (const pt of SCI_PAPERS) {
        for (const v of [1, 2, 3]) {
          db.push({
            id: `${subj.subject}-${year}-MJ-${pt.code}${v}`,
            ...subj, year, paper: `${pt.code}${v}`,
            paperFull: `${pt.full} (${VARIANT_REGIONS[v].name})`,
            variantRegion: VARIANT_REGIONS[v].region,
            session: 'May/June', duration: pt.duration, totalMarks: pt.marks, tier: pt.tier,
            locked: false, syllabusInfo: '', isPredicted: isPredict,
          });
        }
      }

      // Oct/Nov â€” Variant 1, 2, 3
      for (const pt of SCI_PAPERS) {
        for (const v of [1, 2, 3]) {
          db.push({
            id: `${subj.subject}-${year}-ON-${pt.code}${v}`,
            ...subj, year, paper: `${pt.code}${v}`,
            paperFull: `${pt.full} (${VARIANT_REGIONS[v].name})`,
            variantRegion: VARIANT_REGIONS[v].region,
            session: 'Oct/Nov', duration: pt.duration, totalMarks: pt.marks, tier: pt.tier,
            locked: false, syllabusInfo: '', isPredicted: isPredict,
          });
        }
      }
    }
  }

  return db;
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                    STATE & STORAGE                      â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const STORAGE_KEY = 'warden_mock_portal_v4';

let paperDB = [];
let filteredPapers = [];
let selectedSet = new Set();

let state = {
  filters: { subjects: [], years: [], papers: [], durations: [], statuses: [], sessions: [], variants: [] },
  cart: [],
  paperStatus: {},
  paperTimes: {},
  settings: { mode: 'strict', theme: 'light' },
};

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      const s = JSON.parse(raw);
      state.paperStatus = s.paperStatus || {};
      state.paperTimes  = s.paperTimes  || {};
      state.cart        = s.cart        || [];
      if (s.settings) state.settings = { ...state.settings, ...s.settings };
    }
  } catch (e) { console.warn('åŠ è½½çŠ¶æ€å¤±è´¥', e); }
}

function saveState() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      paperStatus: state.paperStatus,
      paperTimes:  state.paperTimes,
      cart:        state.cart,
      settings:    state.settings,
    }));
  } catch (e) { console.warn('ä¿å­˜çŠ¶æ€å¤±è´¥', e); }
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                   FILTER PANEL                          â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const FILTER_DEFS = [
  {
    key: 'subjects', label: 'ğŸ“š ç§‘ç›®',
    options: [
      { value: '0580', label: '0580 æ•°å­¦' },
      { value: '0610', label: '0610 ç”Ÿç‰©' },
      { value: '0620', label: '0620 åŒ–å­¦' },
      { value: '0625', label: '0625 ç‰©ç†' },
    ]
  },
  {
    key: 'years', label: 'ğŸ“… å¹´ä»½',
    options: [
      { value: 2025, label: '2025 ğŸŸ¢' },
      { value: 2024, label: '2024' },
      { value: 2023, label: '2023' },
      { value: 2022, label: '2022' },
      { value: 2021, label: '2021' },
      { value: 2020, label: '2020' },
    ]
  },
  {
    key: 'papers', label: 'ğŸ“„ å·å‹',
    options: [
      { value: 'P1', label: 'P1 (Core)' },
      { value: 'P2', label: 'P2 (Extended)' },
      { value: 'P3', label: 'P3 (Core Theory)' },
      { value: 'P4', label: 'P4 (Ext. Theory)' },
      { value: 'P5', label: 'P5 (Practical)' },
      { value: 'P6', label: 'P6 (Alt. Prac.)' },
    ]
  },
  {
    key: 'sessions', label: 'ğŸ—“ è€ƒå­£',
    options: [
      { value: 'March',    label: 'March (ä»…V2)' },
      { value: 'May/June', label: 'May/June (V1-3)' },
      { value: 'Oct/Nov',  label: 'Oct/Nov (V1-3)' },
    ]
  },
  {
    key: 'variants', label: 'ğŸŒ å˜ä½“/æ—¶åŒº',
    options: [
      { value: 1, label: 'ğŸ‡¬ğŸ‡§ V1 (è‹±/æ¬§/é/ç¾)' },
      { value: 2, label: 'ğŸ‡¨ğŸ‡³ V2 (ä¸­/ä¸œäºš/å·´)' },
      { value: 3, label: 'ğŸ‡¦ğŸ‡º V3 (æ¾³/æ–°/ä¸œå—äºš)' },
    ]
  },
  {
    key: 'durations', label: 'â± æ—¶é•¿',
    options: [
      { value: '45',  label: '45 minutes' },
      { value: '60',  label: '1 hour' },
      { value: '75',  label: '1 hour 15 minutes' },
      { value: '90',  label: '1 hour 30 minutes' },
      { value: '120', label: '2 hours' },
      { value: '150', label: '2 hours 30 minutes' },
    ]
  },
  {
    key: 'statuses', label: 'âœ… çŠ¶æ€',
    options: [
      { value: 'todo',   label: 'æœªåš' },
      { value: 'inprog', label: 'è¿›è¡Œä¸­' },
      { value: 'done',   label: 'å·²å®Œæˆ' },
    ]
  },
];

function renderFilterPanel() {
  const container = document.getElementById('filterSections');
  container.innerHTML = '';
  FILTER_DEFS.forEach((def, i) => {
    const sec = document.createElement('div');
    sec.style.borderBottom = '1px solid var(--border)';
    sec.innerHTML = `
      <div class="fsec-hdr flex items-center justify-between px-4 py-3" onclick="toggleFilterSec(${i})">
        <span class="text-sm font-semibold" style="color:#202124">${def.label}</span>
        <span class="mi" id="fsec-arrow-${i}" style="font-size:18px;color:var(--text-sub);transition:transform .25s">expand_more</span>
      </div>
      <div class="fsec-body" id="fsec-body-${i}" style="max-height:300px">
        <div class="flex flex-wrap gap-2 px-4 pb-3">
          ${def.options.map(opt => `
            <div class="fchip ${state.filters[def.key].includes(opt.value) ? 'on' : ''}"
              id="fc-${def.key}-${opt.value}"
              onclick="toggleFilter('${def.key}', ${typeof opt.value === 'number' ? opt.value : `'${opt.value}'`})">
              ${opt.label}
              <span class="cbadge" id="fcb-${def.key}-${opt.value}">0</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
    container.appendChild(sec);
  });
  updateFilterCounts();
  const mob = document.getElementById('mobileFilterSections');
  if (mob) mob.innerHTML = container.innerHTML;
}

function toggleFilterSec(i) {
  const body  = document.getElementById(`fsec-body-${i}`);
  const arrow = document.getElementById(`fsec-arrow-${i}`);
  const open  = body.style.maxHeight !== '0px' && body.style.maxHeight !== '';
  body.style.maxHeight  = open ? '0px' : '300px';
  arrow.style.transform = open ? 'rotate(-90deg)' : '';
}

function toggleFilter(key, value) {
  const arr = state.filters[key];
  const idx = arr.indexOf(value);
  if (idx === -1) arr.push(value);
  else arr.splice(idx, 1);
  document.querySelectorAll(`[id^="fc-${key}-"]`).forEach(el => {
    const v = el.id.replace(`fc-${key}-`, '');
    const parsed = isNaN(v) ? v : Number(v);
    el.classList.toggle('on', arr.includes(parsed) || arr.includes(v));
  });
  applyFilters();
}

function clearFilters() {
  FILTER_DEFS.forEach(d => { state.filters[d.key] = []; });
  renderFilterPanel();
  applyFilters();
  showToast('ç­›é€‰å·²æ¸…é™¤');
}

function updateFilterCounts() {
  FILTER_DEFS.forEach(def => {
    def.options.forEach(opt => {
      const el = document.getElementById(`fcb-${def.key}-${opt.value}`);
      if (!el) return;
      const count = paperDB.filter(p => {
        if (def.key === 'subjects')  return p.subject === opt.value;
        if (def.key === 'years')     return p.year === opt.value;
        if (def.key === 'papers')    return p.paper.startsWith(opt.value);
        if (def.key === 'durations') return p.duration === Number(opt.value);
        if (def.key === 'variants')  return String(p.paper).endsWith(String(opt.value));
        if (def.key === 'statuses')  return (state.paperStatus[p.id] || 'todo') === opt.value;
        if (def.key === 'sessions')  return p.session === opt.value;
        return false;
      }).length;
      el.textContent = count;
    });
  });
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                  FILTER & SORT LOGIC                    â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function applyFilters() {
  const { subjects, years, papers, durations, statuses, sessions, variants } = state.filters;
  const sort = document.getElementById('sortSel')?.value || 'year-desc';

  let result = paperDB.filter(p => {
    if (subjects.length  && !subjects.includes(p.subject))                           return false;
    if (years.length     && !years.includes(p.year))                                 return false;
    if (papers.length    && !papers.some(pt => p.paper.startsWith(pt)))              return false;
    if (durations.length && !durations.some(d => p.duration === Number(d)))          return false;
    if (variants.length  && !variants.some(v => String(p.paper).endsWith(String(v)))) return false;
    if (statuses.length  && !(statuses.includes(state.paperStatus[p.id] || 'todo'))) return false;
    if (sessions.length  && !sessions.includes(p.session))                           return false;
    return true;
  });

  result.sort((a, b) => {
    switch (sort) {
      case 'year-asc':  return a.year - b.year  || a.subject.localeCompare(b.subject);
      case 'year-desc': return b.year - a.year  || a.subject.localeCompare(b.subject);
      case 'dur-asc':   return a.duration - b.duration;
      case 'dur-desc':  return b.duration - a.duration;
      case 'subj':      return a.subject.localeCompare(b.subject) || b.year - a.year;
      default:          return 0;
    }
  });

  filteredPapers = result;
  renderCards();
  updateFilterCounts();
  updateProgress();
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                    CARD RENDERING                       â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const STATUS_MAP = {
  todo:   { color: '#9AA0A6', label: 'æœªåš',   bg: '#F1F3F4' },
  inprog: { color: '#FBBC04', label: 'è¿›è¡Œä¸­', bg: '#FEF9E7' },
  done:   { color: '#34A853', label: 'å·²å®Œæˆ', bg: '#E6F4EA' },
};

function renderCards() {
  const grid    = document.getElementById('cardGrid');
  const empty   = document.getElementById('emptyState');
  const countEl = document.getElementById('filterCount');

  grid.innerHTML = '';
  countEl.textContent = `ç­›é€‰åˆ° ${filteredPapers.length} å¼ å·å­`;

  if (filteredPapers.length === 0) {
    empty.style.display = 'flex';
  } else {
    empty.style.display = 'none';
    filteredPapers.forEach(p => grid.appendChild(makeCard(p)));
  }
}

function makeCard(p) {
  const status = state.paperStatus[p.id] || 'todo';
  const sc     = STATUS_MAP[status];
  const inCart = state.cart.includes(p.id);
  const isSel  = selectedSet.has(p.id);
  const sCode  = p.session === 'May/June' ? 'M/J' : p.session === 'March' ? 'Mar' : 'O/N';
  const tSec   = state.paperTimes[p.id];
  const tStr   = tSec ? fmtTime(tSec) : null;
  const barPct = status === 'done' ? 100 : status === 'inprog' ? 50 : 0;

  const div = document.createElement('div');
  div.className = `pcard p-4${isSel ? ' sel' : ''}${status === 'done' ? ' done' : status === 'inprog' ? ' inprog' : ''}`;
  div.dataset.id = p.id;

  div.innerHTML = `
    <div style="position:absolute;top:12px;left:12px;z-index:1" onclick="event.stopPropagation()">
      <div onclick="toggleSel('${p.id}')" style="width:20px;height:20px;border-radius:5px;border:2px solid ${isSel ? 'var(--primary)' : '#DADCE0'};background:${isSel ? 'var(--primary)' : 'white'};cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s">
        ${isSel ? '<span class="mi" style="font-size:13px;color:white">check</span>' : ''}
      </div>
    </div>

    ${p.isPredicted ? `<div style="position:absolute;top:10px;right:10px;font-size:9px;padding:2px 6px;border-radius:8px;background:#E8F5E9;color:#2E7D32;font-weight:700">ğŸŸ¢ 25é¢„æµ‹</div>` : ''}
    ${p.isCustom ? `<div style="position:absolute;top:10px;right:10px;font-size:9px;padding:2px 6px;border-radius:8px;background:#E8F0FE;color:var(--primary);font-weight:700">âœï¸ è‡ªæ·»åŠ </div>` : ''}

    <div class="flex items-start justify-between pt-5 mb-2">
      <div class="flex items-center gap-2">
        <div style="width:34px;height:34px;border-radius:10px;background:${p.subjectColor}1A;display:flex;align-items:center;justify-content:center;flex-shrink:0">
          <span class="mi" style="color:${p.subjectColor};font-size:18px">${p.subjectIcon}</span>
        </div>
        <div>
          <div class="font-bold text-sm" style="color:${p.subjectColor}">${p.subject}</div>
          <div style="font-size:10px;color:var(--text-sub)">${p.subjectName}</div>
        </div>
      </div>
      <div class="text-right" style="flex-shrink:0">
        <div class="font-semibold text-xs" style="color:var(--text-sub)">${p.year}</div>
        <div style="font-size:10px;color:#9AA0A6">${sCode}</div>
      </div>
    </div>

    <div class="mb-2">
      <div class="font-bold" style="font-size:22px;color:#202124;letter-spacing:-.5px">${p.paper}</div>
      <div style="font-size:11px;color:var(--text-sub)">${p.paperFull}</div>
      <div style="font-size:10px;color:#9AA0A6;margin-top:4px">${p.variantRegion}</div>
      <span style="display:inline-block;font-size:10px;padding:2px 8px;border-radius:20px;margin-top:4px;background:${p.subjectColor}15;color:${p.subjectColor}">${p.tier}</span>
      ${p.syllabusInfo ? `<span class="variant-badge" style="background:#FEF7E0;color:#D97706">âš ï¸ ${p.syllabusInfo}</span>` : ''}
    </div>

    <div class="flex gap-3 mb-2" style="font-size:11px;color:var(--text-sub)">
      <div class="flex items-center gap-1">
        <span class="mi" style="font-size:14px;color:#9AA0A6">timer</span>${fmtDurationMin(p.duration)}
      </div>
      <div class="flex items-center gap-1">
        <span class="mi" style="font-size:14px;color:#9AA0A6">grading</span>${p.totalMarks} åˆ†
      </div>
      ${tStr ? `<div class="flex items-center gap-1 ml-auto"><span class="mi" style="font-size:14px;color:#9AA0A6">history</span>${tStr}</div>` : ''}
    </div>

    <div class="sbar mb-2">
      <div class="sbar-fill" style="width:${barPct}%;background:${sc.color}"></div>
    </div>

    <div class="mb-3">
      <span style="font-size:11px;padding:3px 10px;border-radius:20px;font-weight:600;background:${sc.bg};color:${sc.color}">${sc.label}</span>
    </div>

    <div class="flex gap-2">
      <button onclick="event.stopPropagation();toggleCart('${p.id}')"
        class="btn ${inCart ? 'btn-p' : 'btn-o'} flex-1" style="font-size:11px;padding:6px 10px">
        <span class="mi" style="font-size:14px">${inCart ? 'playlist_add_check' : 'playlist_add'}</span>
        ${inCart ? 'å·²åŠ å…¥' : 'åŠ å…¥æ¸…å•'}
      </button>
      <button onclick="event.stopPropagation();markDone('${p.id}')"
        class="btn ${status === 'done' ? 'btn-s' : 'btn-o'}" style="font-size:11px;padding:6px 10px">
        <span class="mi" style="font-size:14px">${status === 'done' ? 'check_circle' : 'check'}</span>
        ${status === 'done' ? 'å®Œæˆ' : 'æ ‡è®°'}
      </button>
    </div>
  `;

  div.addEventListener('click', e => {
    if (!e.target.closest('button') && !e.target.closest('[onclick]')) {
      toggleSel(p.id);
    }
  });

  return div;
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                   SELECTION LOGIC                       â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toggleSel(id) {
  if (selectedSet.has(id)) selectedSet.delete(id);
  else selectedSet.add(id);
  const el = document.querySelector(`[data-id="${id}"]`);
  if (el) {
    const p = paperDB.find(x => x.id === id);
    if (p) el.replaceWith(makeCard(p));
  }
}

function selectAll() {
  filteredPapers.forEach(p => selectedSet.add(p.id));
  renderCards();
  showToast(`å·²é€‰ä¸­ ${selectedSet.size} å¼ å·å­`);
}

function invertSel() {
  filteredPapers.forEach(p => {
    if (selectedSet.has(p.id)) selectedSet.delete(p.id);
    else selectedSet.add(p.id);
  });
  renderCards();
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                     CART LOGIC                          â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let cartDrawerOpen = false;

function openCartDrawer() {
  cartDrawerOpen = true;
  document.getElementById('cartDrawer').style.transform = 'translateX(0)';
  document.getElementById('cartOverlay').classList.remove('hidden');
  renderCartList();
  renderCartWarnings();
}

function closeCartDrawer() {
  cartDrawerOpen = false;
  document.getElementById('cartDrawer').style.transform = 'translateX(100%)';
  document.getElementById('cartOverlay').classList.add('hidden');
}

function toggleCart(id) {
  const idx = state.cart.indexOf(id);
  if (idx === -1) {
    state.cart.push(id);
    showToast('âœ… å·²åŠ å…¥ä»Šæ—¥æ¸…å•');
    const fab = document.getElementById('cartFab');
    fab.classList.remove('fab-pop');
    void fab.offsetWidth;
    fab.classList.add('fab-pop');
  } else {
    state.cart.splice(idx, 1);
    showToast('ç§»å‡ºæ¸…å•');
  }
  saveState();
  updateCartBar();
  if (cartDrawerOpen) renderCartList();
  const el = document.querySelector(`[data-id="${id}"]`);
  if (el) { const p = paperDB.find(x => x.id === id); if (p) el.replaceWith(makeCard(p)); }
}

function removeFromCart(id) {
  state.cart = state.cart.filter(x => x !== id);
  saveState();
  updateCartBar();
  renderCartList();
  const el = document.querySelector(`[data-id="${id}"]`);
  if (el) { const p = paperDB.find(x => x.id === id); if (p) el.replaceWith(makeCard(p)); }
}

function clearCart() {
  if (state.cart.length === 0) return;
  if (!confirm(`ç¡®å®šæ¸…ç©ºæ¸…å•ä¸­çš„ ${state.cart.length} å¼ å·å­å—ï¼Ÿ`)) return;
  const ids = [...state.cart];
  state.cart = [];
  saveState();
  updateCartBar();
  renderCartList();
  ids.forEach(id => {
    const el = document.querySelector(`[data-id="${id}"]`);
    if (el) { const p = paperDB.find(x => x.id === id); if (p) el.replaceWith(makeCard(p)); }
  });
  showToast('ğŸ—‘ï¸ æ¸…å•å·²æ¸…ç©º');
}

function updateCartBar() {
  const n = state.cart.length;
  document.getElementById('cartCount').textContent = n;

  const total = state.cart.reduce((s, id) => {
    const p = paperDB.find(x => x.id === id);
    return s + (p ? p.duration : 0);
  }, 0);
  const totalMarks = state.cart.reduce((s, id) => {
    const p = paperDB.find(x => x.id === id);
    return s + (p ? p.totalMarks : 0);
  }, 0);

  document.getElementById('cartStatCount').textContent = n;
  document.getElementById('cartStatTime').textContent = n ? fmtDurationMin(total) : '--';
  document.getElementById('cartStatMarks').textContent = n ? totalMarks : '0';
  document.getElementById('cartDrawerSubtitle').textContent = n
    ? `${n} å¼ å·å­ Â· å…± ${fmtDurationMin(total)}`
    : 'æš‚æ— å·å­ï¼Œä»å¡ç‰‡åŠ å…¥';

  const clearBtn = document.getElementById('cartClearBtn');
  if (clearBtn) clearBtn.disabled = n === 0;

  const summaryDiv = document.getElementById('cartSubjectSummary');
  const tagsDiv = document.getElementById('cartSubjectTags');
  if (n > 0) {
    summaryDiv.style.display = '';
    const subjMap = {};
    state.cart.forEach(id => {
      const p = paperDB.find(x => x.id === id);
      if (!p) return;
      if (!subjMap[p.subject]) subjMap[p.subject] = { count: 0, color: p.subjectColor, name: p.subjectName, icon: p.subjectIcon };
      subjMap[p.subject].count++;
    });
    tagsDiv.innerHTML = Object.entries(subjMap).map(([subj, info]) => `
      <span class="subj-chip" style="background:${info.color}18;color:${info.color}">
        <span class="mi" style="font-size:13px">${info.icon}</span>
        ${subj} ${info.name} <strong>Ã—${info.count}</strong>
      </span>
    `).join('');
  } else {
    summaryDiv.style.display = 'none';
  }

  const btn = document.getElementById('startExamBtn');
  if (btn) btn.disabled = n === 0;
  if (cartDrawerOpen) renderCartWarnings();
}

function renderCartList() {
  const list = document.getElementById('cartList');
  list.innerHTML = '';

  if (state.cart.length === 0) {
    list.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;text-align:center">
        <span class="mi" style="font-size:64px;color:#E8EAED">shopping_cart</span>
        <p style="font-size:15px;color:#9AA0A6;margin-top:12px;font-weight:500">æ¸…å•è¿˜æ˜¯ç©ºçš„</p>
        <p style="font-size:12px;color:#BDC1C6;margin-top:4px">ç‚¹å‡»å·å­å¡ç‰‡ä¸Šçš„ã€ŒåŠ å…¥æ¸…å•ã€æŒ‰é’®</p>
      </div>
    `;
    return;
  }

  state.cart.forEach((id, i) => {
    const p = paperDB.find(x => x.id === id);
    if (!p) return;
    const status = state.paperStatus[p.id] || 'todo';
    const sc = STATUS_MAP[status];
    // IGCSE canonical code: 0580/41
    const variantNum = p.paper.slice(-1); // last char is variant
    const paperNum = p.paper.slice(1, -1); // middle is paper number
    const igcseCode = `${p.subject}/${paperNum}${variantNum}`;
    // IGCSE session format: May/June 2021
    const sessionFull = p.session === 'Oct/Nov' ? `October/November ${p.year}` : `${p.session} ${p.year}`;
    const tierColor = p.tier.includes('Extended') ? '#9334E8' : p.tier.includes('Practical') || p.tier.includes('Alt') ? '#EA4335' : '#34A853';

    const item = document.createElement('div');
    item.className = 'cart-item';
    item.draggable = true;
    item.dataset.id = id;

    item.innerHTML = `
      <div style="display:flex">
        <div style="width:5px;background:${p.subjectColor};border-radius:16px 0 0 16px;flex-shrink:0"></div>
        <div style="flex:1;padding:12px 14px 12px 12px">

          <!-- Row 1: drag + number + code + delete -->
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <div style="display:flex;align-items:center;gap:3px;flex-shrink:0">
              <span class="mi drag-handle" style="font-size:18px">drag_indicator</span>
              <span style="font-size:11px;font-weight:700;color:#BDC1C6;min-width:14px;text-align:center">${i+1}</span>
            </div>
            <!-- Subject icon -->
            <div style="width:32px;height:32px;border-radius:9px;background:${p.subjectColor}18;display:flex;align-items:center;justify-content:center;flex-shrink:0">
              <span class="mi" style="color:${p.subjectColor};font-size:16px">${p.subjectIcon}</span>
            </div>
            <!-- Main code -->
            <div style="flex:1;min-width:0">
              <div style="font-weight:800;font-size:16px;color:#202124;letter-spacing:-.3px;font-family:'Roboto Mono',monospace">${igcseCode}</div>
              <div style="font-size:11px;color:var(--text-sub);margin-top:1px">${p.subjectName}</div>
            </div>
            <!-- Status + delete -->
            <div style="display:flex;align-items:center;gap:4px;flex-shrink:0">
              <span style="font-size:10px;padding:2px 7px;border-radius:8px;background:${sc.bg};color:${sc.color};font-weight:600">${sc.label}</span>
              <button onclick="removeFromCart('${id}')" title="ç§»å‡ºæ¸…å•"
                style="background:none;border:none;cursor:pointer;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background .15s;color:#DADCE0"
                onmouseover="this.style.background='#FEE2E2';this.style.color='var(--danger)'"
                onmouseout="this.style.background='none';this.style.color='#DADCE0'">
                <span class="mi" style="font-size:16px">close</span>
              </button>
            </div>
          </div>

          <!-- Row 2: IGCSE info chips -->
          <div style="display:flex;flex-wrap:wrap;gap:5px;padding-left:55px">
            <span style="display:inline-flex;align-items:center;gap:3px;font-size:11px;padding:3px 9px;border-radius:6px;background:#F1F3F4;color:#5F6368;font-weight:600">
              ğŸ“… ${sessionFull}
            </span>
            <span style="display:inline-flex;align-items:center;gap:3px;font-size:11px;padding:3px 9px;border-radius:6px;background:#F1F3F4;color:#5F6368;font-weight:500">
              â± ${fmtDurationMin(p.duration)}
            </span>
            <span style="display:inline-flex;align-items:center;gap:3px;font-size:11px;padding:3px 9px;border-radius:6px;background:${tierColor}12;color:${tierColor};font-weight:600">
              ${p.tier}
            </span>
            <span style="display:inline-flex;align-items:center;gap:3px;font-size:11px;padding:3px 9px;border-radius:6px;background:#F1F3F4;color:#5F6368;font-weight:500">
              ${p.totalMarks} marks
            </span>
            ${p.isPredicted ? '<span style="font-size:11px;padding:3px 7px;border-radius:6px;background:#E8F5E9;color:#2E7D32;font-weight:600">ğŸŸ¢ é¢„æµ‹</span>' : ''}
            ${p.isCustom ? '<span style="font-size:11px;padding:3px 7px;border-radius:6px;background:#E8F0FE;color:var(--primary);font-weight:600">âœï¸ è‡ªæ·»åŠ </span>' : ''}
            ${(()=>{const ws=getPaperWarnings(p);const errs=ws.filter(w=>w.level==='error');const warns=ws.filter(w=>w.level==='warn'&&w.icon!=='ğŸŸ¢'&&w.msg!=='é¢„æµ‹å·');if(errs.length)return`<span style="font-size:11px;padding:3px 7px;border-radius:6px;background:#FEE2E2;color:#DC2626;font-weight:700">ğŸš¨ ${errs.length}ä¸ªé—®é¢˜</span>`;if(warns.length)return`<span style="font-size:11px;padding:3px 7px;border-radius:6px;background:#FEF9C3;color:#92400E;font-weight:600">âš ï¸ ${warns.length}ä¸ªæé†’</span>`;return'';})()}
          </div>
          ${p.syllabusInfo ? `<div style="margin-top:5px;padding-left:55px"><span style="font-size:10px;padding:2px 8px;border-radius:6px;background:#FEF7E0;color:#D97706;font-weight:600">âš ï¸ ${p.syllabusInfo}</span></div>` : ''}
        </div>
      </div>
    `;

    item.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', id);
      setTimeout(() => item.classList.add('dragging'), 0);
    });
    item.addEventListener('dragend', () => item.classList.remove('dragging'));
    item.addEventListener('dragover', e => { e.preventDefault(); item.classList.add('dragover-top'); });
    item.addEventListener('dragleave', () => item.classList.remove('dragover-top'));
    item.addEventListener('drop', e => {
      e.preventDefault();
      item.classList.remove('dragover-top');
      const fromId = e.dataTransfer.getData('text/plain');
      const fromIdx = state.cart.indexOf(fromId);
      const toIdx = state.cart.indexOf(id);
      if (fromIdx !== -1 && toIdx !== -1 && fromIdx !== toIdx) {
        state.cart.splice(fromIdx, 1);
        state.cart.splice(toIdx, 0, fromId);
        saveState();
        renderCartList();
        updateCartBar();
      }
    });

    list.appendChild(item);
  });
  renderCartWarnings();
}

function markDone(id) {
  const cur = state.paperStatus[id] || 'todo';
  state.paperStatus[id] = cur === 'done' ? 'todo' : 'done';
  saveState();
  const el = document.querySelector(`[data-id="${id}"]`);
  if (el) { const p = paperDB.find(x => x.id === id); if (p) el.replaceWith(makeCard(p)); }
  updateProgress();
  updateFilterCounts();
  showToast(state.paperStatus[id] === 'done' ? 'âœ… å·²æ ‡è®°ä¸ºå®Œæˆ' : 'â†© å·²å–æ¶ˆå®Œæˆæ ‡è®°');
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                   PROGRESS CIRCLE                       â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateProgress() {
  const total = paperDB.length;
  const done  = Object.values(state.paperStatus).filter(v => v === 'done').length;
  const pct   = total ? Math.round((done / total) * 100) : 0;
  document.getElementById('progArc').setAttribute('stroke-dasharray', `${pct} 100`);
  document.getElementById('progPct').textContent = pct + '%';
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                    GACHA SYSTEM                         â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let gachaCount = 3;
let lastGachaResults = [];

function openGacha() {
  const modal = document.getElementById('gachaModal');
  modal.style.display = 'flex';
  renderGachaConfig();
}

function closeGacha() {
  document.getElementById('gachaModal').style.display = 'none';
}

function renderGachaConfig() {
  const box = document.getElementById('gachaBox');
  box.innerHTML = `
    <div class="flex items-center justify-between mb-5">
      <h2 class="font-bold text-lg" style="color:#202124">ğŸ² éšæœºæŠ½å–</h2>
      <button onclick="closeGacha()" style="background:none;border:none;cursor:pointer;padding:4px;border-radius:50%">
        <span class="mi" style="color:#5F6368">close</span>
      </button>
    </div>

    <div class="mb-4">
      <p class="text-sm font-semibold mb-2" style="color:#202124">ç§‘ç›®</p>
      <div class="flex flex-wrap gap-2" id="gSubj">
        ${[['0580','æ•°å­¦'],['0610','ç”Ÿç‰©'],['0620','åŒ–å­¦'],['0625','ç‰©ç†']].map(([v,l]) =>
          `<div class="fchip on" data-v="${v}" onclick="this.classList.toggle('on')">${v} ${l}</div>`
        ).join('')}
      </div>
    </div>

    <div class="mb-4">
      <p class="text-sm font-semibold mb-2" style="color:#202124">æŠ½å–æ•°é‡</p>
      <div class="flex gap-2">
        ${[1,2,3,4,5].map(n =>
          `<button class="gcnt${n===gachaCount?' on':''}" onclick="setGachaCount(${n})" id="gcnt${n}">${n}</button>`
        ).join('')}
      </div>
    </div>

    <div class="mb-4">
      <p class="text-sm font-semibold mb-2" style="color:#202124">å¹´ä»½</p>
      <div class="flex flex-wrap gap-2" id="gYear">
        ${[2025,2024,2023,2022,2021,2020].map(y =>
          `<div class="fchip${y===2025?' on':' on'}" data-v="${y}" onclick="this.classList.toggle('on')">${y}${y===2025?' ğŸŸ¢':''}</div>`
        ).join('')}
      </div>
    </div>

    <div class="mb-4">
      <p class="text-sm font-semibold mb-2" style="color:#202124">å·å‹</p>
      <div class="flex flex-wrap gap-2" id="gPaper">
        ${['P1','P2','P3','P4','P5','P6'].map(p =>
          `<div class="fchip on" data-v="${p}" onclick="this.classList.toggle('on')">${p}</div>`
        ).join('')}
      </div>
    </div>

    <div class="flex items-center gap-3 mb-6">
      <div class="tgl on" id="gOnlyTodo" onclick="this.classList.toggle('on')"></div>
      <span class="text-sm" style="color:#202124">åªä» <b>æœªåš</b> çš„å·å­ä¸­æŠ½å–</span>
    </div>

    <button onclick="runGacha()" class="btn btn-p w-full" style="padding:12px;font-size:15px;justify-content:center">
      <span class="mi" style="font-size:18px">casino</span>&nbsp;å¼€å§‹æŠ½å–ï¼
    </button>
  `;
}

function setGachaCount(n) {
  gachaCount = n;
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById(`gcnt${i}`);
    if (el) el.classList.toggle('on', i === n);
  }
}

function runGacha() {
  const box = document.getElementById('gachaBox');
  const subjects  = [...document.querySelectorAll('#gSubj .fchip.on')].map(e => e.dataset.v);
  const years     = [...document.querySelectorAll('#gYear .fchip.on')].map(e => Number(e.dataset.v));
  const papers    = [...document.querySelectorAll('#gPaper .fchip.on')].map(e => e.dataset.v);
  const onlyTodo  = document.getElementById('gOnlyTodo')?.classList.contains('on');

  let pool = paperDB.filter(p => {
    if (!subjects.includes(p.subject))              return false;
    if (!years.includes(p.year))                    return false;
    if (!papers.some(pt => p.paper.startsWith(pt))) return false;
    if (onlyTodo && state.paperStatus[p.id] === 'done') return false;
    return true;
  });

  if (pool.length === 0) { showToast('ğŸ˜¢ æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å·å­ï¼'); return; }

  pool = pool.sort(() => Math.random() - 0.5);
  lastGachaResults = pool.slice(0, Math.min(gachaCount, pool.length));

  const allShuffled = [...paperDB].sort(() => Math.random() - 0.5);
  const scrollItems = [...allShuffled.slice(0, 24), ...lastGachaResults];
  const itemH = 68;

  box.innerHTML = `
    <div class="flex items-center justify-between mb-5">
      <h2 class="font-bold text-lg" style="color:#202124">ğŸ° æŠ½å–ä¸­â€¦</h2>
    </div>
    <div id="gachaScroller" style="height:${itemH}px;overflow:hidden;border-radius:12px;border:2px solid var(--border);background:#F8F9FA">
      <div id="gachaTrack" style="transition:transform 0s">
        ${scrollItems.map(p => `
          <div class="flex items-center gap-3 px-4" style="height:${itemH}px;border-bottom:1px solid var(--border)">
            <div style="width:36px;height:36px;border-radius:10px;background:${p.subjectColor}1A;display:flex;align-items:center;justify-content:center;flex-shrink:0">
              <span class="mi" style="color:${p.subjectColor};font-size:18px">${p.subjectIcon}</span>
            </div>
            <div>
              <div class="font-bold text-sm" style="color:#202124">${p.subject} Â· ${p.paper}</div>
              <div style="font-size:11px;color:var(--text-sub)">${p.year} ${p.session==='May/June'?'M/J':p.session==='March'?'Mar':'O/N'} Â· ${fmtDurationShort(p.duration)}</div>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
    <p class="text-center text-sm mt-4" style="color:var(--text-sub)">æ­£åœ¨ä¸ºä½ éšæœºæŠ½å–â€¦</p>
  `;

  const track = document.getElementById('gachaTrack');
  const endY   = -(scrollItems.length - lastGachaResults.length) * itemH;

  requestAnimationFrame(() => {
    track.style.transition = 'transform 2s cubic-bezier(0.25,0.1,0.25,1)';
    track.style.transform  = `translateY(${endY}px)`;
  });

  setTimeout(() => showGachaResults(), 2300);
}

function showGachaResults() {
  const box = document.getElementById('gachaBox');
  box.innerHTML = `
    <div class="flex items-center justify-between mb-4">
      <div>
        <p style="font-size:36px;line-height:1">ğŸ‰</p>
        <h2 class="font-bold text-lg mt-1" style="color:#202124">æŠ½å–ç»“æœ</h2>
        <p style="font-size:12px;color:var(--text-sub)">å…±æŠ½å– ${lastGachaResults.length} å¼ å·å­</p>
      </div>
      <button onclick="closeGacha()" style="background:none;border:none;cursor:pointer;padding:4px;border-radius:50%">
        <span class="mi" style="color:#5F6368">close</span>
      </button>
    </div>
    <div class="space-y-2 mb-5">
      ${lastGachaResults.map(p => `
        <div class="flex items-center gap-3 p-3 rounded-xl" style="background:#F8F9FA;border:1.5px solid var(--border)">
          <div style="width:38px;height:38px;border-radius:10px;background:${p.subjectColor}1A;display:flex;align-items:center;justify-content:center;flex-shrink:0">
            <span class="mi" style="color:${p.subjectColor}">${p.subjectIcon}</span>
          </div>
          <div style="flex:1">
            <div class="font-bold text-sm" style="color:#202124">${p.subject} Â· ${p.paper} ${p.isPredicted ? '<span style="font-size:10px;padding:1px 6px;border-radius:8px;background:#E8F5E9;color:#2E7D32">é¢„æµ‹</span>' : ''}</div>
            <div style="font-size:11px;color:var(--text-sub)">${p.paperFull} Â· ${p.year} ${p.session==='May/June'?'M/J':p.session==='March'?'Mar':'O/N'} Â· ${fmtDurationShort(p.duration)}</div>
          </div>
        </div>
      `).join('')}
    </div>
    <div class="flex gap-2">
      <button onclick="addGachaToCart()" class="btn btn-p flex-1" style="justify-content:center;padding:10px">
        <span class="mi" style="font-size:16px">playlist_add</span>&nbsp;åŠ å…¥æ¸…å•
      </button>
      <button id="gachaRedrawBtn" class="btn btn-o flex-1" style="justify-content:center;padding:10px">
        <span class="mi" style="font-size:16px">refresh</span>&nbsp;é‡æ–°æŠ½å–
      </button>
    </div>
  `;
  document.getElementById('gachaRedrawBtn').addEventListener('click', renderGachaConfig);
}

function addGachaToCart() {
  let added = 0;
  lastGachaResults.forEach(p => {
    if (!state.cart.includes(p.id)) { state.cart.push(p.id); added++; }
  });
  saveState();
  updateCartBar();
  renderCards();
  closeGacha();
  showToast(`âœ… å·²åŠ å…¥ ${added} å¼ å·å­åˆ°æ¸…å•`);
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                    EXAM TIMER                           â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let examState = {
  queue: [], currentIdx: 0,
  timer: null, timeLeft: 0, totalTime: 0,
  paused: false, results: [],
};

function startExam() {
  if (state.cart.length === 0) { showToast('æ¸…å•ä¸ºç©ºï¼'); return; }
  examState.queue      = [...state.cart];
  examState.currentIdx = 0;
  examState.results    = [];
  examState.paused     = false;

  if (cartDrawerOpen) closeCartDrawer();

  document.documentElement.requestFullscreen?.().catch(err => {
    console.warn('å…¨å±è¯·æ±‚å¤±è´¥:', err);
    showToast('âš ï¸ å…¨å±å¤±è´¥ï¼Œå»ºè®®æ‰‹åŠ¨æŒ‰ F11');
  });

  showExamOverlay();
  loadExamPaper();
}

function showExamOverlay() {
  const ov = document.getElementById('examOv');
  ov.style.display = 'flex';
  ov.style.flexDirection = 'column';
  ov.style.alignItems = 'center';
  ov.style.justifyContent = 'center';
  document.addEventListener('fullscreenchange', onFSChange);
}

function loadExamPaper() {
  const id = examState.queue[examState.currentIdx];
  const p  = paperDB.find(x => x.id === id);
  if (!p) { endAllExams(); return; }

  examState.timeLeft  = p.duration * 60;
  examState.totalTime = p.duration * 60;
  examState.paused    = false;

  state.paperStatus[id] = 'inprog';
  saveState();

  document.getElementById('examWm').textContent = id;
  renderExamUI(p);

  clearInterval(examState.timer);
  examState.timer = setInterval(examTick, 1000);
}

function renderExamUI(p) {
  const isStrict = state.settings.mode === 'strict';
  const content  = document.getElementById('examContent');
  const sCode    = p.session === 'May/June' ? 'May/June' : p.session === 'March' ? 'March' : 'Oct/Nov';

  content.innerHTML = `
    <div class="flex items-center gap-3 mb-4">
      <div style="width:48px;height:48px;border-radius:14px;background:${p.subjectColor}22;display:flex;align-items:center;justify-content:center">
        <span class="mi" style="color:${p.subjectColor};font-size:26px">${p.subjectIcon}</span>
      </div>
      <div class="text-left">
        <div class="font-bold text-lg" style="color:${p.subjectColor}">${p.subject} Â· ${p.paper}</div>
        <div style="font-size:13px;color:rgba(255,255,255,.55)">${p.subjectName} Â· ${sCode} ${p.year}</div>
      </div>
    </div>
    <div style="font-size:14px;color:rgba(255,255,255,.45);margin-bottom:24px">
      ${p.paperFull} &nbsp;Â·&nbsp; ${p.totalMarks} åˆ†
      ${p.isPredicted ? '<span style="font-size:11px;padding:2px 8px;border-radius:8px;background:#1B5E2033;color:#4ade80;margin-left:8px">ğŸŸ¢ é¢„æµ‹å·</span>' : ''}
    </div>
    <div class="timer-num" id="timerDisp">--:--</div>
    <div class="exam-prog mt-6 mb-4" style="width:min(480px,80vw)">
      <div class="exam-prog-fill" id="examProgFill" style="width:100%"></div>
    </div>
    <div style="font-size:13px;color:rgba(255,255,255,.4);margin-bottom:28px">
      ç¬¬ ${examState.currentIdx + 1} / ${examState.queue.length} å¼  &nbsp;Â·&nbsp; ${fmtDurationMin(p.duration)}
    </div>
    <div class="flex gap-3">
      ${!isStrict ? `
        <button id="pauseBtn" onclick="togglePause()" class="btn" style="background:rgba(255,255,255,.12);color:white;padding:10px 24px">
          <span class="mi" style="font-size:18px">pause</span>&nbsp;æš‚åœ
        </button>
        <button onclick="resetTimer()" class="btn" style="background:rgba(255,255,255,.12);color:white;padding:10px 24px">
          <span class="mi" style="font-size:18px">replay</span>&nbsp;é‡ç½®
        </button>
      ` : ''}
      <button onclick="skipPaper()" class="btn" style="background:rgba(255,255,255,.08);color:rgba(255,255,255,.55);padding:10px 20px;font-size:12px">è·³è¿‡</button>
      <button onclick="confirmExitExam()" class="btn" style="background:rgba(234,67,53,.25);color:#F87171;padding:10px 20px;font-size:12px">ç»“æŸæ¨¡è€ƒ</button>
    </div>
  `;
  updateTimerDisplay();
}

function examTick() {
  if (examState.paused) return;
  examState.timeLeft--;
  updateTimerDisplay();
  if (examState.timeLeft <= 0) { clearInterval(examState.timer); onTimeUp(); }
}

function updateTimerDisplay() {
  const el = document.getElementById('timerDisp');
  const pb = document.getElementById('examProgFill');
  if (!el) return;
  el.textContent = fmtTime(examState.timeLeft);
  if (examState.timeLeft <= 60) el.classList.add('timer-warn');
  else el.classList.remove('timer-warn');
  if (pb) {
    const pct = examState.totalTime > 0 ? (examState.timeLeft / examState.totalTime) * 100 : 0;
    pb.style.width = pct + '%';
  }
}

function togglePause() {
  examState.paused = !examState.paused;
  const btn = document.getElementById('pauseBtn');
  if (btn) btn.innerHTML = examState.paused
    ? '<span class="mi" style="font-size:18px">play_arrow</span>&nbsp;ç»§ç»­'
    : '<span class="mi" style="font-size:18px">pause</span>&nbsp;æš‚åœ';
}

function resetTimer() {
  const id = examState.queue[examState.currentIdx];
  const p  = paperDB.find(x => x.id === id);
  if (!p) return;
  examState.timeLeft = p.duration * 60;
  examState.paused   = false;
  updateTimerDisplay();
}

function onTimeUp() {
  playBeep();
  const id = examState.queue[examState.currentIdx];
  const p  = paperDB.find(x => x.id === id);
  const spent = p ? p.duration * 60 : 0;
  recordResult(id, spent);
  const content = document.getElementById('examContent');
  content.innerHTML = `
    <div style="font-size:72px">âœ…</div>
    <h2 class="font-bold mt-4" style="font-size:32px;color:#4ade80">Time's Up!</h2>
    <p style="color:rgba(255,255,255,.55);margin-top:8px">${p?.subject} ${p?.paper} å®Œæˆï¼</p>
  `;
  setTimeout(() => nextPaper(), 2200);
}

function recordResult(id, timeSpent) {
  state.paperStatus[id] = 'done';
  state.paperTimes[id]  = timeSpent;
  examState.results.push({ id, timeSpent });
  saveState();
}

function skipPaper() {
  const id = examState.queue[examState.currentIdx];
  const spent = examState.totalTime - examState.timeLeft;
  recordResult(id, spent);
  clearInterval(examState.timer);
  nextPaper();
}

function nextPaper() {
  examState.currentIdx++;
  if (examState.currentIdx >= examState.queue.length) endAllExams();
  else loadExamPaper();
}

function endAllExams() {
  clearInterval(examState.timer);
  document.removeEventListener('fullscreenchange', onFSChange);
  showSummary();
}

function showSummary() {
  const content = document.getElementById('examContent');
  const totalSec = examState.results.reduce((s, r) => s + r.timeSpent, 0);
  content.innerHTML = `
    <div style="font-size:56px;margin-bottom:16px">ğŸ†</div>
    <h1 class="font-bold mb-1" style="font-size:28px;color:white">æ¨¡è€ƒå®Œæˆï¼</h1>
    <p style="color:rgba(255,255,255,.5);margin-bottom:32px;font-size:14px">
      å…±å®Œæˆ ${examState.results.length} å¼ å·å­ &nbsp;Â·&nbsp; ç´¯è®¡ ${fmtDuration(totalSec)}
    </p>
    <div style="width:min(520px,90vw);margin-bottom:32px">
      ${examState.results.map(r => {
        const p   = paperDB.find(x => x.id === r.id);
        const pct = p ? Math.min(Math.round((r.timeSpent / (p.duration * 60)) * 100), 100) : 0;
        return `
          <div class="flex items-center gap-3 mb-3">
            <div class="text-right font-mono" style="width:72px;font-size:12px;color:rgba(255,255,255,.5);flex-shrink:0">${p?.subject} ${p?.paper}</div>
            <div style="flex:1;background:rgba(255,255,255,.1);border-radius:6px;height:28px;overflow:hidden">
              <div style="height:100%;border-radius:6px;width:${pct}%;background:${p?.subjectColor || '#1A73E8'};transition:width .7s ease"></div>
            </div>
            <div style="width:52px;font-size:11px;color:rgba(255,255,255,.45);flex-shrink:0">${fmtTime(r.timeSpent)}</div>
          </div>
        `;
      }).join('')}
    </div>
    <button onclick="closeExam()" class="btn btn-p" style="padding:12px 36px;font-size:15px">
      <span class="mi" style="font-size:18px">home</span>&nbsp;è¿”å›ä¸»é¡µ
    </button>
  `;
}

function closeExam() {
  clearInterval(examState.timer);
  document.removeEventListener('fullscreenchange', onFSChange);
  document.getElementById('examOv').style.display = 'none';
  document.exitFullscreen?.().catch(() => {});
  state.cart = [];
  saveState();
  updateCartBar();
  renderCards();
  updateProgress();
}

function confirmExitExam() {
  if (confirm('ç¡®å®šè¦æå‰ç»“æŸæ¨¡è€ƒå—ï¼Ÿå½“å‰è¿›åº¦å°†è¢«ä¿å­˜ã€‚')) {
    clearInterval(examState.timer);
    const id = examState.queue[examState.currentIdx];
    if (id) { const spent = examState.totalTime - examState.timeLeft; recordResult(id, spent); }
    endAllExams();
  }
}

function onFSChange() {
  if (!document.fullscreenElement) {
    const banner = document.getElementById('warnBanner');
    banner.style.transform = 'translateY(0)';
    setTimeout(() => {
      banner.style.transform = 'translateY(-100%)';
      if (state.settings.mode === 'strict') {
        document.documentElement.requestFullscreen?.().catch(() => {});
      }
    }, 2000);
  }
}

function playBeep() {
  try {
    const ctx  = new (window.AudioContext || window.webkitAudioContext)();
    const osc  = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.type = 'sine';
    osc.frequency.setValueAtTime(880, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.8);
    gain.gain.setValueAtTime(0.5, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.2);
    osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 1.2);
  } catch (e) {}
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘              EXAM PROFILE SYSTEM                        â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getProfile() {
  return state.settings.profile || {};
}

function saveProfile(patch) {
  state.settings.profile = { ...getProfile(), ...patch };
  saveState();
  renderProfileUI();
  renderCartWarnings();
}

function toggleProfileSubject(subj) {
  const p = getProfile();
  const subs = p.subjects || [];
  const idx = subs.indexOf(subj);
  if (idx === -1) subs.push(subj);
  else subs.splice(idx, 1);
  saveProfile({ subjects: subs });
}

function selectProfileSession(s) {
  saveProfile({ session: s });
}

function selectProfileYear(y) {
  saveProfile({ year: y });
}

function selectProfileVariant(v) {
  saveProfile({ variant: Number(v) });
}

function toggleProfileTier(subj, tier) {
  const p = getProfile();
  const key = `tier_${subj}`;
  const cur = p[key] || [];
  const idx = cur.indexOf(tier);
  if (idx === -1) cur.push(tier);
  else cur.splice(idx, 1);
  const patch = {}; patch[key] = cur;
  saveProfile(patch);
}

function renderProfileUI() {
  const p = getProfile();
  const subs = p.subjects || [];

  // Subjects
  document.querySelectorAll('#profileSubjects .fchip').forEach(el => {
    const v = el.dataset.v;
    const on = subs.includes(v);
    el.style.opacity = on ? '1' : '0.5';
    el.style.borderWidth = on ? '2px' : '1.5px';
    if (on) el.style.filter = 'brightness(1.3)';
    else el.style.filter = '';
  });

  // Session
  document.querySelectorAll('#profileSession .fchip').forEach(el => {
    const on = el.dataset.v === p.session;
    el.style.background = on ? 'rgba(99,102,241,.35)' : 'rgba(255,255,255,.06)';
    el.style.borderColor = on ? '#818cf8' : 'rgba(255,255,255,.15)';
    el.style.fontWeight = on ? '600' : '400';
  });

  // Year
  document.querySelectorAll('#profileYear .fchip').forEach(el => {
    const on = el.dataset.v === p.year;
    el.style.background = on ? 'rgba(99,102,241,.35)' : 'rgba(255,255,255,.06)';
    el.style.borderColor = on ? '#818cf8' : 'rgba(255,255,255,.15)';
    el.style.fontWeight = on ? '600' : '400';
  });

  // Variant
  document.querySelectorAll('#profileVariant .fchip').forEach(el => {
    const on = String(el.dataset.v) === String(p.variant);
    el.style.background = on ? 'rgba(99,102,241,.35)' : 'rgba(255,255,255,.06)';
    el.style.borderColor = on ? '#818cf8' : 'rgba(255,255,255,.15)';
    el.style.fontWeight = on ? '600' : '400';
  });

  // Tiers per subject
  const tiersDiv = document.getElementById('profileTiers');
  if (!tiersDiv) return;
  if (subs.length === 0) {
    tiersDiv.innerHTML = '<span style="font-size:11px;color:rgba(255,255,255,.3)">è¯·å…ˆé€‰æ‹©æŠ¥è€ƒç§‘ç›®</span>';
    return;
  }
  // For each subject, show tier options
  const mathTierOpts = [
    { v: 'core',     l: 'Core (P1/P3)' },
    { v: 'extended', l: 'Extended (P2/P4)' },
  ];
  const sciTierOpts = [
    { v: 'core',     l: 'Core (P1/P3)' },
    { v: 'extended', l: 'Extended (P2/P4)' },
    { v: 'p6',       l: 'P6 Alt. Practical' },
  ];

  tiersDiv.innerHTML = subs.map(subj => {
    const opts = subj === '0580' ? mathTierOpts : sciTierOpts;
    const cur = p[`tier_${subj}`] || [];
    const meta = { '0580':'æ•°å­¦','0610':'ç”Ÿç‰©','0620':'åŒ–å­¦','0625':'ç‰©ç†' };
    return `
      <div style="width:100%;margin-bottom:4px">
        <span style="font-size:10px;color:rgba(255,255,255,.4);display:block;margin-bottom:4px">${subj} ${meta[subj]}</span>
        <div style="display:flex;flex-wrap:wrap;gap:5px">
          ${opts.map(o => `
            <div class="fchip" onclick="toggleProfileTier('${subj}','${o.v}')"
              style="background:${cur.includes(o.v)?'rgba(99,102,241,.35)':'rgba(255,255,255,.06)'};border-color:${cur.includes(o.v)?'#818cf8':'rgba(255,255,255,.15)'};color:${cur.includes(o.v)?'white':'rgba(255,255,255,.6)'};font-weight:${cur.includes(o.v)?'600':'400'};font-size:11px">
              ${o.l}
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }).join('');
}

function applyProfileFilter() {
  const p = getProfile();
  const subs = p.subjects || [];
  if (subs.length === 0) { showToast('âš ï¸ è¯·å…ˆè®¾ç½®æŠ¥è€ƒç§‘ç›®'); return; }

  // Build filter state
  state.filters.subjects = [...subs];
  if (p.session) state.filters.sessions = [p.session];
  if (p.variant) state.filters.variants = [p.variant];

  // Paper filter based on tiers
  const papers = [];
  subs.forEach(subj => {
    const tiers = p[`tier_${subj}`] || ['extended']; // default extended
    if (tiers.includes('core')) { papers.push('P1'); papers.push('P3'); }
    if (tiers.includes('extended')) { papers.push('P2'); papers.push('P4'); }
    if (tiers.includes('p6')) papers.push('P6');
  });
  // Year/syllabus: if exam year â‰¥ 2026, only show 2025+ papers (new syllabus)
  const examYear = Number(p.year) || 2026;
  if (examYear >= 2026) {
    state.filters.years = [2025, 2024, 2023, 2022, 2021, 2020]; // keep all for practice, but warn
  }
  const uniquePapers = [...new Set(papers)];
  if (uniquePapers.length > 0) state.filters.papers = uniquePapers;

  renderFilterPanel();
  applyFilters();
  closeSettings();
  showToast(`âœ… å·²ç­›é€‰ï¼š${subs.join('/')} Â· ${p.session || 'å…¨è€ƒå­£'} Â· V${p.variant || '?'}`);
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘              CART SMART WARNING SYSTEM                  â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Generate warnings for a paper based on user profile.
 * Returns array of { level: 'error'|'warn'|'info', msg, detail }
 */
function getPaperWarnings(p) {
  const prof = getProfile();
  const warnings = [];
  const paperNum = p.paper.slice(1, -1); // e.g. '4' from 'P41'
  const variantNum = Number(p.paper.slice(-1)); // e.g. 1
  const examYear = Number(prof.year) || 2026;

  // â”€â”€ 1. WRONG VARIANT â”€â”€
  if (prof.variant && variantNum !== prof.variant) {
    warnings.push({
      level: 'warn',
      icon: 'ğŸŒ',
      msg: `å˜ä½“ä¸åŒ¹é…`,
      detail: `ä½ çš„è€ƒè¯•æ˜¯ Variant ${prof.variant}ï¼Œè¿™å¼ æ˜¯ Variant ${variantNum}ï¼ˆ${['','è‹±/æ¬§','ä¸­/ä¸œäºš','æ¾³/æ–°'][variantNum]}ï¼‰ã€‚ç»ƒä¹ æ—¶ä»æœ‰å‚è€ƒä»·å€¼ï¼Œä½†é¢˜å‹/åˆ†å¸ƒç•¥æœ‰å·®å¼‚ã€‚`,
    });
  }

  // â”€â”€ 2. WRONG SESSION â”€â”€
  if (prof.session && p.session !== prof.session) {
    warnings.push({
      level: 'info',
      icon: 'ğŸ—“',
      msg: `è€ƒå­£ä¸åŒ`,
      detail: `ä½ å‚åŠ  ${prof.session}ï¼Œè¿™æ˜¯ ${p.session} çš„å·å­ã€‚å†…å®¹ç›¸åŒï¼Œå¯æ­£å¸¸ç»ƒä¹ ã€‚`,
    });
  }

  // â”€â”€ 3. SUBJECT NOT IN PROFILE â”€â”€
  if (prof.subjects && prof.subjects.length > 0 && !prof.subjects.includes(p.subject)) {
    warnings.push({
      level: 'info',
      icon: 'ğŸ“š',
      msg: `éæŠ¥è€ƒç§‘ç›®`,
      detail: `ä½ æœªæŠ¥è€ƒ ${p.subject} ${p.subjectName}ï¼Œè¿™å¼ å·å­ä¸åœ¨ä½ çš„å¤‡è€ƒèŒƒå›´å†…ã€‚`,
    });
  }

  // â”€â”€ 4. MATH SYLLABUS CHANGE (0580) â”€â”€
  if (p.subject === '0580') {
    const isNewSyllabus = p.year >= 2025;
    const isOldSyllabus = p.year <= 2024;
    const pNum = Number(paperNum);

    if (examYear >= 2026 && isOldSyllabus && (pNum === 2 || pNum === 4)) {
      // OLD P2/P4: calculator allowed, old format â€” CRITICAL mismatch
      warnings.push({
        level: 'error',
        icon: 'âš ï¸',
        msg: `æ—§è€ƒçº²å·å­ï¼æ ¼å¼å·²æ”¹å˜`,
        detail: `2025å¹´èµ· 0580 P${pNum} è€ƒçº²å·²æ”¹ç‰ˆï¼š\nâ€¢ P2ï¼šæ”¹ä¸º 2 hours / 100 marks / ä¸å…è®¸ä½¿ç”¨è®¡ç®—å™¨\nâ€¢ P4ï¼šæ”¹ä¸º 2 hours / 100 marks / å…è®¸ä½¿ç”¨è®¡ç®—å™¨\nè¿™å¼  ${p.year} å¹´çš„æ—§å· P${pNum} æ ¼å¼ä¸åŒï¼ˆ${pNum===2?'1h30m/70åˆ†':'2h30m/130åˆ†'}ï¼‰ï¼Œä¸èƒ½ä½œä¸ºçœŸé¢˜æ¨¡æ‹Ÿï¼Œä»…ä¾›é¢˜å‹ç»ƒä¹ å‚è€ƒã€‚`,
      });
    }

    if (!isNewSyllabus && (pNum === 2 || pNum === 4)) {
      // Warn about calculator rules for old papers
      const canCalc = pNum === 4; // old P4 = calculator allowed; old P2 = no calc but short
      warnings.push({
        level: 'info',
        icon: 'ğŸ§®',
        msg: `è®¡ç®—å™¨è§„åˆ™ï¼ˆæ—§è€ƒçº²ï¼‰`,
        detail: `æ—§è€ƒçº² P${pNum}ï¼š${pNum === 2 ? 'âŒ ä¸å…è®¸ä½¿ç”¨è®¡ç®—å™¨ï¼ˆ1h30mï¼Œ70åˆ†ï¼‰' : 'âœ… å…è®¸ä½¿ç”¨è®¡ç®—å™¨ï¼ˆ2h30mï¼Œ130åˆ†ï¼‰'}`,
      });
    }

    if (isNewSyllabus) {
      if (pNum === 2) {
        warnings.push({
          level: 'info',
          icon: 'ğŸ§®',
          msg: `æ–°è€ƒçº² P2 â€” æ— è®¡ç®—å™¨`,
          detail: `2025æ–°è€ƒçº² P2ï¼šâŒ ä¸å…è®¸ä½¿ç”¨è®¡ç®—å™¨ï¼Œæ—¶é•¿ 2 hoursï¼Œæ»¡åˆ† 100 marks`,
        });
      }
      if (pNum === 4) {
        warnings.push({
          level: 'info',
          icon: 'ğŸ§®',
          msg: `æ–°è€ƒçº² P4 â€” æœ‰è®¡ç®—å™¨`,
          detail: `2025æ–°è€ƒçº² P4ï¼šâœ… å…è®¸ä½¿ç”¨è®¡ç®—å™¨ï¼Œæ—¶é•¿ 2 hoursï¼Œæ»¡åˆ† 100 marks`,
        });
      }
      if (pNum === 1 || pNum === 3) {
        warnings.push({
          level: 'info',
          icon: 'ğŸ§®',
          msg: pNum===1 ? 'P1 â€” æ— è®¡ç®—å™¨' : 'P3 â€” æœ‰è®¡ç®—å™¨',
          detail: pNum===1
            ? 'P1 Coreï¼šâŒ ä¸å…è®¸ä½¿ç”¨è®¡ç®—å™¨ï¼Œæ—¶é•¿ 1 hour 30 minutesï¼Œæ»¡åˆ† 70 marks'
            : 'P3 Coreï¼šâœ… å…è®¸ä½¿ç”¨è®¡ç®—å™¨ï¼Œæ—¶é•¿ 2 hoursï¼Œæ»¡åˆ† 104 marks',
        });
      }
    }
  }

  // â”€â”€ 5. SCIENCE PAPER TYPES â”€â”€
  if (['0610','0620','0625'].includes(p.subject)) {
    const pNum = Number(paperNum);
    const typeInfo = {
      1: { name: 'Paper 1 â€” Core MCQ',              desc: '40é“é€‰æ‹©é¢˜ï¼Œ45 minutesï¼Œ40 marksã€‚Core çº§åˆ«ï¼ˆè¾ƒæ˜“ï¼‰ã€‚' },
      2: { name: 'Paper 2 â€” Extended MCQ',           desc: '40é“é€‰æ‹©é¢˜ï¼Œ45 minutesï¼Œ40 marksã€‚Extended çº§åˆ«ï¼ˆæ ‡å‡†ï¼‰ã€‚' },
      3: { name: 'Paper 3 â€” Core Theory',            desc: 'ç»“æ„é¢˜/ç®€ç­”é¢˜ï¼Œ1 hour 15 minutesï¼Œ80 marksã€‚Core çº§åˆ«ã€‚' },
      4: { name: 'Paper 4 â€” Extended Theory',        desc: 'ç»“æ„é¢˜/ç®€ç­”é¢˜ï¼Œ1 hour 15 minutesï¼Œ80 marksã€‚Extended çº§åˆ«ï¼ˆæ ‡å‡†ï¼‰ã€‚' },
      5: { name: 'Paper 5 â€” Practical Exam',         desc: 'å®éªŒæ“ä½œè€ƒè¯•ï¼Œ1 hour 15 minutesï¼Œ40 marksã€‚éœ€è¦å®éªŒå®¤ã€‚' },
      6: { name: 'Paper 6 â€” Alt. to Practical',      desc: 'å®éªŒåˆ†æé¢˜ï¼ˆæ›¿ä»£å®éªŒè€ƒè¯•ï¼‰ï¼Œ1 hourï¼Œ40 marksã€‚å›½å†…è€ƒç”Ÿé€šå¸¸è€ƒè¿™ä¸ªã€‚' },
    };
    if (typeInfo[pNum]) {
      warnings.push({
        level: 'info',
        icon: 'ğŸ”¬',
        msg: typeInfo[pNum].name,
        detail: typeInfo[pNum].desc,
      });
    }

    // Check if user should be doing P5 vs P6
    const tiers = prof[`tier_${p.subject}`] || [];
    if (pNum === 5 && !tiers.includes('p5')) {
      warnings.push({
        level: 'warn',
        icon: 'ğŸ§ª',
        msg: `P5 éœ€è¦å®éªŒå®¤`,
        detail: `Paper 5 æ˜¯å®é™…æ“ä½œè€ƒè¯•ï¼Œåœ¨ä¸­å›½å¤§é™†é€šå¸¸ç”¨ Paper 6ï¼ˆAlt. to Practicalï¼‰æ›¿ä»£ã€‚å¦‚æœä½ å‚åŠ  P6ï¼Œè¿™å¼  P5 ä¸åœ¨è€ƒè¯•èŒƒå›´å†…ã€‚`,
      });
    }
    if (pNum === 6) {
      warnings.push({
        level: 'info',
        icon: 'âœ…',
        msg: `P6 â€” å›½å†…æ ‡å‡†æ›¿ä»£å®éªŒå·`,
        detail: `Paper 6 æ›¿ä»£å®éªŒè€ƒè¯•ï¼Œä¸­å›½å¤§é™†è€ƒç”Ÿé€šå¸¸å‚åŠ æ­¤å·ï¼Œæ— éœ€å®éªŒå®¤ã€‚1 hourï¼Œ40 marksã€‚`,
      });
    }

    // Tier check
    const profTiers = prof[`tier_${p.subject}`] || [];
    if (profTiers.length > 0) {
      const isExtended = pNum === 2 || pNum === 4;
      const isCore = pNum === 1 || pNum === 3;
      if (isExtended && !profTiers.includes('extended') && profTiers.includes('core')) {
        warnings.push({
          level: 'warn', icon: 'ğŸ“Š',
          msg: `ä½ æŠ¥è€ƒ Core çº§åˆ«`,
          detail: `ä½ è®¾ç½®çš„æ˜¯ Coreï¼ˆP1/P3ï¼‰ï¼Œä½†è¿™å¼ æ˜¯ Extended çº§åˆ«ï¼ˆP${pNum}ï¼‰ã€‚Extended éš¾åº¦æ›´é«˜ï¼Œè¯·ç¡®è®¤ä½ æ˜¯å¦éœ€è¦ç»ƒä¹ æ­¤å·ã€‚`,
        });
      }
      if (isCore && !profTiers.includes('core') && profTiers.includes('extended')) {
        warnings.push({
          level: 'info', icon: 'ğŸ“Š',
          msg: `ä½ æŠ¥è€ƒ Extended çº§åˆ«`,
          detail: `ä½ è®¾ç½®çš„æ˜¯ Extendedï¼ˆP2/P4ï¼‰ï¼Œè¿™å¼ æ˜¯ Core çº§åˆ«ï¼ˆP${pNum}ï¼‰ã€‚Extended è€ƒç”Ÿä¹Ÿå¯åš Core å·çƒ­èº«ï¼Œä½†æ³¨æ„å†…å®¹èŒƒå›´ä¸åŒã€‚`,
        });
      }
    }
  }

  // â”€â”€ 6. PREDICTED PAPER â”€â”€
  if (p.isPredicted) {
    warnings.push({
      level: 'info',
      icon: 'ğŸŸ¢',
      msg: `2025å¹´é¢„æµ‹å·`,
      detail: `è¿™æ˜¯æŒ‰è€ƒçº²è§„å¾‹æ¨ç®—çš„ 2025 å¹´å·å­ï¼Œå°šæœªæ­£å¼å…¬å¸ƒã€‚æ ¼å¼å‚æ•°æŒ‰è§„å¾‹å¡«å†™ï¼Œå®é™…çœŸé¢˜å¯èƒ½æœ‰å·®å¼‚ã€‚`,
    });
  }

  return warnings;
}

function renderCartWarnings() {
  const panel = document.getElementById('cartWarnings');
  if (!panel) return;
  if (state.cart.length === 0) { panel.style.display = 'none'; return; }

  const prof = getProfile();
  const hasProfile = (prof.subjects && prof.subjects.length > 0) || prof.variant || prof.session;

  // Collect all warnings across all cart items
  const allWarnings = [];
  state.cart.forEach(id => {
    const p = paperDB.find(x => x.id === id);
    if (!p) return;
    const ws = getPaperWarnings(p);
    ws.forEach(w => {
      if (w.level === 'error' || w.level === 'warn') {
        allWarnings.push({ paper: p, ...w });
      }
    });
  });

  const errorCount = allWarnings.filter(w => w.level === 'error').length;
  const warnCount  = allWarnings.filter(w => w.level === 'warn').length;

  if (allWarnings.length === 0 && hasProfile) {
    panel.style.display = '';
    panel.innerHTML = `
      <div style="margin:10px 16px;padding:10px 14px;border-radius:12px;background:#E6F4EA;border:1.5px solid #34A853;display:flex;align-items:center;gap:8px">
        <span style="font-size:18px">âœ…</span>
        <p style="font-size:12px;color:#1E8E3E;font-weight:600">æ¸…å•æ£€æŸ¥é€šè¿‡ï¼æ‰€æœ‰å·å­ä¸ä½ çš„æŠ¥è€ƒä¿¡æ¯åŒ¹é…ã€‚</p>
      </div>
    `;
    return;
  }

  if (allWarnings.length === 0) {
    panel.style.display = 'none';
    return;
  }

  panel.style.display = '';
  panel.innerHTML = `
    <div style="margin:10px 16px;border-radius:12px;overflow:hidden;border:1.5px solid ${errorCount>0?'#EA4335':'#FBBC04'}">
      <div style="background:${errorCount>0?'#EA4335':'#FBBC04'};padding:8px 14px;display:flex;align-items:center;gap:6px;cursor:pointer" onclick="toggleWarningDetail()">
        <span style="font-size:16px">${errorCount>0?'ğŸš¨':'âš ï¸'}</span>
        <span style="font-size:12px;font-weight:700;color:white;flex:1">
          æ¸…å•æé†’ï¼š${errorCount>0?`${errorCount} ä¸ªä¸¥é‡é—®é¢˜`:''}${errorCount>0&&warnCount>0?' Â· ':''}${warnCount>0?`${warnCount} ä¸ªè­¦å‘Š`:''}
        </span>
        <span class="mi" id="warnToggleIcon" style="color:white;font-size:16px">expand_more</span>
      </div>
      <div id="warnDetail" style="background:white;max-height:none">
        ${allWarnings.map((w,i) => `
          <div style="padding:10px 14px;${i<allWarnings.length-1?'border-bottom:1px solid #F1F3F4':''}">
            <div style="display:flex;align-items:flex-start;gap:8px">
              <span style="font-size:14px;flex-shrink:0;margin-top:1px">${w.icon}</span>
              <div style="flex:1">
                <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:3px">
                  <span style="font-size:10px;font-family:'Roboto Mono',monospace;font-weight:700;color:${w.paper.subjectColor}">${w.paper.subject}/${w.paper.paper.slice(1,-1)}${w.paper.paper.slice(-1)}</span>
                  <span style="font-size:11px;font-weight:700;color:${w.level==='error'?'#DC2626':'#D97706'}">${w.msg}</span>
                </div>
                <p style="font-size:11px;color:#5F6368;white-space:pre-line;line-height:1.5">${w.detail}</p>
              </div>
            </div>
          </div>
        `).join('')}
        ${!hasProfile ? `
          <div style="padding:10px 14px;background:#FEF7E0;border-top:1px solid #FDE68A">
            <p style="font-size:11px;color:#92400E">ğŸ’¡ åœ¨<strong>è®¾ç½®</strong>é‡Œå¡«å†™ä½ çš„æŠ¥è€ƒä¿¡æ¯ï¼Œå¯è·å¾—æ›´ç²¾å‡†çš„æ£€æŸ¥å’Œæ¨èã€‚</p>
            <button onclick="openSettings()" class="btn" style="font-size:11px;padding:4px 10px;margin-top:6px;background:#F59E0B;color:white;border-radius:8px">å»è®¾ç½®</button>
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

function toggleWarningDetail() {
  const detail = document.getElementById('warnDetail');
  const icon = document.getElementById('warnToggleIcon');
  if (!detail) return;
  const collapsed = detail.style.maxHeight === '0px';
  detail.style.maxHeight = collapsed ? 'none' : '0px';
  detail.style.overflow = collapsed ? 'visible' : 'hidden';
  if (icon) icon.textContent = collapsed ? 'expand_less' : 'expand_more';
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                     SETTINGS                            â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openSettings() {
  document.getElementById('settingsDr').classList.add('open');
  document.getElementById('settingsOv').classList.remove('hidden');
  updateSettingsUI();
}

function closeSettings() {
  document.getElementById('settingsDr').classList.remove('open');
  document.getElementById('settingsOv').classList.add('hidden');
}

function updateSettingsUI() {
  const mode = state.settings.mode;
  const ms = document.getElementById('modeStrict');
  const mp = document.getElementById('modePrac');
  if (ms && mp) {
    ms.style.background = mode === 'strict' ? 'var(--primary)' : 'white';
    ms.style.color = mode === 'strict' ? 'white' : 'var(--text-sub)';
    mp.style.background = mode === 'practice' ? 'var(--primary)' : 'white';
    mp.style.color = mode === 'practice' ? 'white' : 'var(--text-sub)';
  }
  const done = Object.values(state.paperStatus).filter(v => v === 'done').length;
  const secs = Object.values(state.paperTimes).reduce((a, b) => a + b, 0);
  const el1 = document.getElementById('statDone');
  const el2 = document.getElementById('statTotal');
  const el3 = document.getElementById('statTime');
  if (el1) el1.textContent = done;
  if (el2) el2.textContent = paperDB.length;
  if (el3) el3.textContent = fmtDuration(secs);

  // Restore countdown settings UI
  const dateInput = document.getElementById('examDateInput');
  if (dateInput) dateInput.value = state.settings.examDate || DEFAULT_EXAM_DATE;
  updateCdUnitUI();
  renderProfileUI();
}

function setMode(m) {
  state.settings.mode = m;
  saveState();
  updateSettingsUI();
  showToast(m === 'strict' ? 'âš¡ ä¸¥æ ¼æ¨¡å¼å·²å¯ç”¨' : 'ğŸ“ ç»ƒä¹ æ¨¡å¼å·²å¯ç”¨');
}

function toggleTheme() {}

function confirmReset() {
  if (confirm('âš ï¸ ç¡®å®šè¦é‡ç½®æ‰€æœ‰è¿›åº¦å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
    state.paperStatus = {}; state.paperTimes = {}; state.cart = [];
    saveState(); updateCartBar(); renderCards(); updateProgress(); updateSettingsUI(); closeSettings();
    showToast('âœ… æ‰€æœ‰è¿›åº¦å·²é‡ç½®');
  }
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                  MOBILE FILTER SHEET                    â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openMobileFilter() {
  document.getElementById('mobileFilterOv').classList.remove('hidden');
  const sheet = document.getElementById('mobileFilterSheet');
  sheet.style.transform = 'translateY(0)';
  const mob = document.getElementById('mobileFilterSections');
  mob.innerHTML = document.getElementById('filterSections').innerHTML;
}

function closeMobileFilter() {
  document.getElementById('mobileFilterOv').classList.add('hidden');
  document.getElementById('mobileFilterSheet').style.transform = 'translateY(100%)';
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                    UTILITIES                            â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** IGCSEæ ¼å¼: 45 minutes / 1 hour 30 minutes / 2 hours 30 minutes */
function fmtDurationMin(min) {
  const h = Math.floor(min / 60);
  const m = min % 60;
  if (h === 0) return `${m} minute${m !== 1 ? 's' : ''}`;
  const hStr = `${h} hour${h !== 1 ? 's' : ''}`;
  if (m === 0) return hStr;
  return `${hStr} ${m} minute${m !== 1 ? 's' : ''}`;
}

/** Short IGCSE format for tight spaces: 45m / 1h 30m / 2h 30m */
function fmtDurationShort(min) {
  const h = Math.floor(min / 60);
  const m = min % 60;
  if (h === 0) return `${m}m`;
  if (m === 0) return `${h}h`;
  return `${h}h ${m}m`;
}

function fmtTime(sec) {
  if (sec < 0) sec = 0;
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function fmtDuration(sec) {
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  if (h === 0) return `${m} minutes`;
  if (m === 0) return `${h} hour${h !== 1 ? 's' : ''}`;
  return `${h}h ${m}min`;
}

function updateDate() {
  const now = new Date();
  const opts = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' };
  document.getElementById('dateDisp').textContent = now.toLocaleDateString('zh-CN', opts);
}

let toastTimer = null;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2400);
}

function initScrollShadow() {
  window.addEventListener('scroll', () => {
    document.getElementById('appbar').classList.toggle('scrolled', window.scrollY > 4);
  }, { passive: true });
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                   INITIALIZATION                        â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘              SEARCH / CUSTOM PAPER SYSTEM               â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Parse a code like "0580/41" or "0625/62" â†’ { subject, paperCode, variant }
function parseCode(raw) {
  const s = raw.trim().toUpperCase().replace(/\s/g, '');
  // Match patterns: 0580/41, 0580/4/1, 058041 etc.
  const m = s.match(/^(0580|0610|0620|0625)\/?([1-6])([1-3])$/);
  if (!m) return null;
  return {
    subject: m[1],
    paperNum: m[2],   // 1-6
    variant: Number(m[3]),  // 1-3
    paperCode: `P${m[2]}${m[3]}`,  // e.g. P41
    displayCode: `${m[1]}/${m[2]}${m[3]}`,
  };
}

const SUBJECT_META = {
  '0580': { name: 'Mathematics',   icon: 'calculate', color: '#1A73E8' },
  '0610': { name: 'Biology',       icon: 'biotech',   color: '#34A853' },
  '0620': { name: 'Chemistry',     icon: 'science',   color: '#FF6D00' },
  '0625': { name: 'Physics',       icon: 'bolt',      color: '#9334E8' },
};

const VARIANT_REGIONS = {
  1: { name: 'Variant 1', region: 'ğŸ‡¬ğŸ‡§ æ—¶åŒº1 è‹±/æ¬§/é/ç¾' },
  2: { name: 'Variant 2', region: 'ğŸ‡¨ğŸ‡³ æ—¶åŒº2 ä¸­/ä¸œäºš/å·´' },
  3: { name: 'Variant 3', region: 'ğŸ‡¦ğŸ‡º æ—¶åŒº3 æ¾³/æ–°/ä¸œå—äºš' },
};

let searchState = {
  parsed: null,
  addMode: false,
  addYear: null,
  addSession: null,
  addDuration: null,
};

function openSearch() {
  document.getElementById('searchModal').style.display = 'flex';
  document.getElementById('searchInput').value = '';
  document.getElementById('searchResults').innerHTML = `
    <div style="text-align:center;padding:32px 0;color:#BDC1C6">
      <span class="mi" style="font-size:48px">search</span>
      <p class="text-sm mt-2">è¾“å…¥å·å­ä»£ç å¼€å§‹æœç´¢</p>
    </div>
  `;
  setTimeout(() => document.getElementById('searchInput').focus(), 100);
}

function closeSearch() {
  document.getElementById('searchModal').style.display = 'none';
}

function handleSearchModalBg(e) {
  if (e.target === document.getElementById('searchModal')) closeSearch();
}

function onSearchInput(val) {
  if (val.length >= 6) doSearch();
}

function doSearch() {
  const raw = document.getElementById('searchInput').value;
  const parsed = parseCode(raw);
  const results = document.getElementById('searchResults');

  if (!parsed) {
    results.innerHTML = `
      <div style="background:#FEF3F2;border:1.5px solid #FEE2E2;border-radius:12px;padding:16px;text-align:center;margin-top:8px">
        <span class="mi" style="color:#EA4335;font-size:24px">error_outline</span>
        <p class="text-sm font-semibold mt-2" style="color:#DC2626">æ ¼å¼ä¸æ­£ç¡®</p>
        <p class="text-xs mt-1" style="color:#9AA0A6">è¯·è¾“å…¥å¦‚ <code style="background:#F1F3F4;padding:1px 5px;border-radius:4px">0580/41</code> æ ¼å¼çš„ä»£ç </p>
        <div class="flex flex-wrap gap-2 justify-center mt-3">
          ${['0580/41','0580/22','0625/61','0610/32','0620/42'].map(ex =>
            `<span class="fchip" onclick="document.getElementById('searchInput').value='${ex}';doSearch()" style="cursor:pointer">${ex}</span>`
          ).join('')}
        </div>
      </div>
    `;
    return;
  }

  searchState.parsed = parsed;
  const { subject, paperNum, variant, paperCode, displayCode } = parsed;
  const meta = SUBJECT_META[subject];

  // Find matching papers in DB (same subject + paper code)
  const matches = paperDB.filter(p =>
    p.subject === subject && p.paper === paperCode
  );

  if (matches.length > 0) {
    // Show found papers
    const status = matches.map(p => state.paperStatus[p.id] || 'todo');
    results.innerHTML = `
      <div style="margin-bottom:12px">
        <div class="flex items-center gap-2 mb-3">
          <div style="width:32px;height:32px;border-radius:9px;background:${meta.color}18;display:flex;align-items:center;justify-content:center">
            <span class="mi" style="color:${meta.color};font-size:16px">${meta.icon}</span>
          </div>
          <div>
            <span class="font-bold text-sm" style="color:${meta.color}">${displayCode}</span>
            <span class="text-xs ml-2" style="color:var(--text-sub)">${meta.name} Â· Paper ${paperNum} Â· ${VARIANT_REGIONS[variant].name}</span>
          </div>
          <span class="text-xs ml-auto font-semibold" style="color:var(--success)">æ‰¾åˆ° ${matches.length} å¼ </span>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          ${matches.map(p => {
            const sc = STATUS_MAP[state.paperStatus[p.id] || 'todo'];
            const inCart = state.cart.includes(p.id);
            const sCode = p.session === 'May/June' ? 'M/J' : p.session === 'March' ? 'Mar' : 'O/N';
            return `
              <div class="flex items-center gap-3 p-3 rounded-xl" style="border:1.5px solid var(--border);background:white;transition:all .15s" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'">
                <div style="flex:1;min-width:0">
                  <div class="font-semibold text-sm" style="color:#202124">${p.year} ${p.session}</div>
                  <div class="flex items-center gap-2 mt-1 flex-wrap">
                    <span style="font-size:10px;padding:2px 7px;border-radius:8px;background:#F1F3F4;color:#5F6368">${fmtDurationMin(p.duration)}</span>
                    <span style="font-size:10px;padding:2px 7px;border-radius:8px;background:#F1F3F4;color:#5F6368">${p.totalMarks} åˆ†</span>
                    <span style="font-size:10px;padding:2px 7px;border-radius:8px;background:${sc.bg};color:${sc.color};font-weight:600">${sc.label}</span>
                    ${p.isPredicted ? '<span style="font-size:10px;padding:2px 7px;border-radius:8px;background:#E8F5E9;color:#2E7D32;font-weight:600">ğŸŸ¢ é¢„æµ‹</span>' : ''}
                  </div>
                </div>
                <button onclick="searchAddToCart('${p.id}')"
                  class="btn ${inCart ? 'btn-p' : 'btn-o'}" id="scart-${p.id}"
                  style="font-size:11px;padding:6px 12px;flex-shrink:0">
                  <span class="mi" style="font-size:14px">${inCart ? 'playlist_add_check' : 'playlist_add'}</span>
                  ${inCart ? 'å·²åœ¨æ¸…å•' : 'åŠ å…¥æ¸…å•'}
                </button>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  } else {
    // Not found â€” show add form
    results.innerHTML = `
      <div style="background:#FEF7E0;border:1.5px solid #FBBC04;border-radius:12px;padding:14px;margin-bottom:16px;display:flex;align-items:center;gap:10px">
        <span class="mi" style="color:#F59E0B;font-size:22px;flex-shrink:0">info</span>
        <div>
          <p class="font-semibold text-sm" style="color:#92400E">é¢˜åº“ä¸­æ²¡æœ‰ <code style="background:#FDE68A;padding:1px 6px;border-radius:4px">${displayCode}</code></p>
          <p class="text-xs mt-1" style="color:#B45309">å¯ä»¥æ‰‹åŠ¨æ·»åŠ æ­¤å·å­ï¼Œå¡«å†™è€ƒè¯•ä¿¡æ¯åç›´æ¥åŠ å…¥æ¸…å•å¼€å§‹æ¨¡è€ƒ</p>
        </div>
      </div>

      <div style="background:white;border:1.5px solid var(--border);border-radius:16px;padding:16px">
        <!-- Paper info header -->
        <div class="flex items-center gap-2 mb-4">
          <div style="width:36px;height:36px;border-radius:10px;background:${meta.color}18;display:flex;align-items:center;justify-content:center">
            <span class="mi" style="color:${meta.color}">${meta.icon}</span>
          </div>
          <div>
            <p class="font-bold text-sm" style="color:${meta.color}">${subject} Â· Paper ${paperNum} Â· ${VARIANT_REGIONS[variant].name}</p>
            <p class="text-xs" style="color:var(--text-sub)">${meta.name} Â· ${VARIANT_REGIONS[variant].region}</p>
          </div>
        </div>

        <!-- Year -->
        <div class="mb-4">
          <p class="text-sm font-semibold mb-2" style="color:#202124">ğŸ“… è€ƒè¯•å¹´ä»½</p>
          <div class="flex flex-wrap gap-2" id="addYear">
            ${[2025,2024,2023,2022,2021,2020].map(y =>
              `<div class="fchip" data-v="${y}" onclick="selectAddYear(${y})">${y}${y===2025?' ğŸŸ¢':''}</div>`
            ).join('')}
          </div>
        </div>

        <!-- Session -->
        <div class="mb-4">
          <p class="text-sm font-semibold mb-2" style="color:#202124">ğŸ—“ è€ƒå­£</p>
          <div class="flex flex-wrap gap-2" id="addSession">
            ${['March','May/June','Oct/Nov'].map(s =>
              `<div class="fchip" data-v="${s}" onclick="selectAddSession('${s}')">${s}</div>`
            ).join('')}
          </div>
          <p class="text-xs mt-1" style="color:#9AA0A6">March ä»… Variant 2ï¼›May/June å’Œ Oct/Nov æœ‰ Variant 1/2/3</p>
        </div>

        <!-- Duration -->
        <div class="mb-5">
          <p class="text-sm font-semibold mb-2" style="color:#202124">â± è€ƒè¯•æ—¶é•¿</p>
          <div class="flex flex-wrap gap-2" id="addDuration">
            ${[
              {v:45,  l:'45 minutes'},
              {v:60,  l:'1 hour'},
              {v:75,  l:'1 hour 15 minutes'},
              {v:90,  l:'1 hour 30 minutes'},
              {v:120, l:'2 hours'},
              {v:150, l:'2 hours 30 minutes'},
            ].map(d =>
              `<div class="fchip" data-v="${d.v}" onclick="selectAddDuration(${d.v})">${d.l}</div>`
            ).join('')}
          </div>
        </div>

        <!-- Marks (optional) -->
        <div class="mb-5">
          <p class="text-sm font-semibold mb-1" style="color:#202124">ğŸ“Š æ€»åˆ† <span style="font-weight:400;color:#9AA0A6">(å¯é€‰)</span></p>
          <input id="addMarks" type="number" min="1" max="200" placeholder="å¦‚ 130"
            class="rounded-xl text-sm focus:outline-none"
            style="border:2px solid var(--border);padding:8px 12px;font-family:inherit;color:#202124;transition:border .15s;width:120px"
            onfocus="this.style.borderColor='var(--primary)'"
            onblur="this.style.borderColor='var(--border)'" />
        </div>

        <button onclick="addCustomPaper()" id="addCustomBtn" class="btn btn-s w-full" style="justify-content:center;padding:12px;font-size:14px" disabled>
          <span class="mi" style="font-size:18px">add_circle</span>&nbsp;æ·»åŠ å¹¶åŠ å…¥æ¸…å• â†’ ç«‹å³å¼€å§‹
        </button>
        <p class="text-xs text-center mt-2" style="color:#9AA0A6">æ·»åŠ åä¼šè‡ªåŠ¨åŠ å…¥ä»Šæ—¥æ¸…å•ï¼Œå¯ç«‹å³å¼€å§‹æ¨¡è€ƒ</p>
      </div>
    `;

    // Reset add state
    searchState.addYear = null;
    searchState.addSession = null;
    searchState.addDuration = null;
  }
}

function searchAddToCart(id) {
  const inCart = state.cart.includes(id);
  if (!inCart) {
    state.cart.push(id);
    saveState();
    updateCartBar();
    const el = document.getElementById(`scart-${id}`);
    if (el) {
      el.className = 'btn btn-p';
      el.style.cssText += 'font-size:11px;padding:6px 12px;flex-shrink:0';
      el.innerHTML = '<span class="mi" style="font-size:14px">playlist_add_check</span> å·²åœ¨æ¸…å•';
    }
    const card = document.querySelector(`[data-id="${id}"]`);
    if (card) { const p = paperDB.find(x => x.id === id); if (p) card.replaceWith(makeCard(p)); }
    showToast('âœ… å·²åŠ å…¥æ¸…å•');
  } else {
    showToast('å·²åœ¨æ¸…å•ä¸­');
  }
}

function selectAddYear(y) {
  searchState.addYear = y;
  document.querySelectorAll('#addYear .fchip').forEach(el => {
    el.classList.toggle('on', Number(el.dataset.v) === y);
  });
  checkAddReady();
}

function selectAddSession(s) {
  searchState.addSession = s;
  document.querySelectorAll('#addSession .fchip').forEach(el => {
    el.classList.toggle('on', el.dataset.v === s);
  });
  checkAddReady();
}

function selectAddDuration(d) {
  searchState.addDuration = d;
  document.querySelectorAll('#addDuration .fchip').forEach(el => {
    el.classList.toggle('on', Number(el.dataset.v) === d);
  });
  checkAddReady();
}

function checkAddReady() {
  const btn = document.getElementById('addCustomBtn');
  if (btn) btn.disabled = !(searchState.addYear && searchState.addSession && searchState.addDuration);
}

function addCustomPaper() {
  const parsed = searchState.parsed;
  if (!parsed || !searchState.addYear || !searchState.addSession || !searchState.addDuration) return;

  const { subject, paperNum, variant, paperCode, displayCode } = parsed;
  const meta = SUBJECT_META[subject];
  const sc = { MA: 'MA', 'May/June': 'MJ', 'Oct/Nov': 'ON', March: 'MA' };
  const scCode = sc[searchState.addSession] || 'MJ';
  const marksInput = document.getElementById('addMarks');
  const marks = marksInput && marksInput.value ? Number(marksInput.value) : null;

  // Guess tier
  const tierMap = {
    '1': 'Core', '2': 'Extended', '3': 'Core Theory', '4': 'Extended Theory',
    '5': 'Practical', '6': 'Alt. to Practical',
  };
  const tier = tierMap[paperNum] || 'Unknown';

  const id = `${subject}-${searchState.addYear}-${scCode}-${paperCode}-custom`;

  // Check if already exists
  if (paperDB.find(p => p.id === id)) {
    showToast('âš ï¸ è¿™å¼ å·å­å·²å­˜åœ¨ï¼');
    searchAddToCart(id);
    closeSearch();
    return;
  }

  const newPaper = {
    id,
    subject, subjectName: meta.name, subjectIcon: meta.icon, subjectColor: meta.color,
    year: searchState.addYear,
    paper: paperCode,
    paperFull: `Paper ${paperNum} (${VARIANT_REGIONS[variant].name})`,
    variantRegion: VARIANT_REGIONS[variant].region,
    session: searchState.addSession,
    duration: searchState.addDuration,
    totalMarks: marks || defaultMarks(subject, paperNum),
    tier,
    locked: false,
    syllabusInfo: searchState.addYear >= 2025 ? 'æ–°è€ƒçº²' : '',
    isPredicted: false,
    isCustom: true,
  };

  // Add to DB
  paperDB.push(newPaper);

  // Add to cart
  state.cart.push(id);
  saveState();
  updateCartBar();

  // Refresh if visible
  applyFilters();
  updateProgress();

  closeSearch();
  showToast(`âœ… å·²æ·»åŠ  ${displayCode} å¹¶åŠ å…¥æ¸…å•ï¼`);

  // Auto open cart
  setTimeout(() => openCartDrawer(), 400);
}

function defaultMarks(subject, paperNum) {
  if (subject === '0580') {
    return { '1': 70, '2': 70, '3': 104, '4': 130 }[paperNum] || 70;
  }
  return { '1': 40, '2': 40, '3': 80, '4': 80, '5': 40, '6': 40 }[paperNum] || 40;
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘           COUNTDOWN + HITOKOTO SYSTEM                   â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let cdInterval = null;

// Default: May/June 2026 starts Apr 28
const DEFAULT_EXAM_DATE = '2026-04-28';

function getExamDate() {
  return state.settings.examDate || DEFAULT_EXAM_DATE;
}

function getCdUnit() {
  return state.settings.cdUnit || 'dh';
}

function saveExamDate(val) {
  state.settings.examDate = val;
  saveState();
  renderCountdown();
  showToast('âœ… è€ƒè¯•æ—¥æœŸå·²ä¿å­˜');
}

function setCdUnit(unit) {
  state.settings.cdUnit = unit;
  saveState();
  renderCountdown();
  updateCdUnitUI();
}

function updateCdUnitUI() {
  const unit = getCdUnit();
  ['wdh','dh','d','h'].forEach(u => {
    const el = document.getElementById(`cdu-${u}`);
    if (el) el.classList.toggle('on', u === unit);
  });
}

function renderCountdown() {
  const examDate = getExamDate();
  const unit = getCdUnit();
  const now = new Date();
  const target = new Date(examDate + 'T09:00:00');
  const diffMs = target - now;

  const cdBlocks = document.getElementById('cdBlocks');
  const examTag = document.getElementById('examDateTag');

  if (!cdBlocks) return;

  if (diffMs <= 0) {
    cdBlocks.innerHTML = `
      <div class="cd-block">
        <span class="cd-num" style="color:#4ade80;font-size:14px">EXAM DAY</span>
        <span class="cd-label">åŠ æ²¹ï¼</span>
      </div>
    `;
    if (examTag) examTag.textContent = 'ğŸ“… ä»Šå¤©è€ƒè¯•ï¼';
    return;
  }

  const totalSecs = Math.floor(diffMs / 1000);
  const totalMins = Math.floor(totalSecs / 60);
  const totalHours = Math.floor(totalMins / 60);
  const totalDays = Math.floor(totalHours / 24);
  const weeks = Math.floor(totalDays / 7);

  const remDays = totalDays % 7;
  const remHours = totalHours % 24;
  const remMins = totalMins % 60;

  const urgent = totalDays < 14;
  const cls = urgent ? 'cd-num urgent' : 'cd-num';

  let blocksHtml = '';

  if (unit === 'wdh') {
    blocksHtml = `
      <div class="cd-block">
        <span class="${cls}">${String(weeks).padStart(2,'0')}</span>
        <span class="cd-label">WEEKS</span>
      </div>
      <div class="cd-block">
        <span class="${cls}">${String(remDays).padStart(2,'0')}</span>
        <span class="cd-label">DAYS</span>
      </div>
      <div class="cd-block">
        <span class="${cls}">${String(remHours).padStart(2,'0')}</span>
        <span class="cd-label">HRS</span>
      </div>
    `;
  } else if (unit === 'dh') {
    blocksHtml = `
      <div class="cd-block">
        <span class="${cls}">${String(totalDays).padStart(3,'0')}</span>
        <span class="cd-label">DAYS</span>
      </div>
      <div class="cd-block">
        <span class="${cls}">${String(remHours).padStart(2,'0')}</span>
        <span class="cd-label">HRS</span>
      </div>
    `;
  } else if (unit === 'd') {
    blocksHtml = `
      <div class="cd-block">
        <span class="${cls}" style="font-size:22px">${totalDays}</span>
        <span class="cd-label">DAYS REMAINING</span>
      </div>
    `;
  } else { // h
    blocksHtml = `
      <div class="cd-block">
        <span class="${cls}" style="font-size:20px">${totalHours}</span>
        <span class="cd-label">HOURS REMAINING</span>
      </div>
    `;
  }

  cdBlocks.innerHTML = blocksHtml;

  // Update exam date tag
  if (examTag) {
    const d = target.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
    examTag.textContent = `ğŸ“… ${d}`;
  }
}

function startCountdown() {
  renderCountdown();
  clearInterval(cdInterval);
  cdInterval = setInterval(renderCountdown, 1000);
}

// â”€â”€ Hitokoto â”€â”€
let hitokoTimer = null;

async function fetchHitokoto() {
  const el = document.getElementById('hitokotext');
  if (!el) return;
  try {
    // Fetch philosophical / literary quotes â€” types k (å“²å­¦), d (æ–‡å­¦), e (åŸåˆ›), f (ç½‘ç»œ), i (è¯—è¯)
    const types = ['k','d','e','f','i'];
    const t = types[Math.floor(Math.random() * types.length)];
    const res = await fetch(`https://v1.hitokoto.cn?c=${t}&encode=json&max_length=50`);
    if (!res.ok) throw new Error('fetch fail');
    const data = await res.json();
    const text = data.hitokoto;
    const from = data.from ? ` â€”â€”ã€Š${data.from}ã€‹` : '';

    // Fade out
    el.style.opacity = '0';
    await new Promise(r => setTimeout(r, 500));
    el.textContent = text + from;
    el.style.opacity = '1';
  } catch (e) {
    // Fallback quotes
    const fallbacks = [
      'ä¸ç»ä¸€ç•ªå¯’å½»éª¨ï¼Œæ€å¾—æ¢…èŠ±æ‰‘é¼»é¦™ã€‚',
      'The secret of getting ahead is getting started.',
      'åƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹ã€‚',
      'Pressure is a privilege.',
      'åˆæŠ±ä¹‹æœ¨ï¼Œç”Ÿäºæ¯«æœ«ã€‚',
      'Do it now. Sometimes "later" becomes "never".',
    ];
    const el2 = document.getElementById('hitokotext');
    if (el2) {
      el2.style.opacity = '0';
      await new Promise(r => setTimeout(r, 400));
      el2.textContent = fallbacks[Math.floor(Math.random() * fallbacks.length)];
      el2.style.opacity = '1';
    }
  }
}

function startHitokoto() {
  fetchHitokoto();
  clearInterval(hitokoTimer);
  hitokoTimer = setInterval(fetchHitokoto, 18000); // rotate every 18s
}

function init() {
  paperDB = generatePaperDB();

  // Debug: log total count
  console.log(`ğŸ“š é¢˜åº“æ€»æ•°: ${paperDB.length} å¼ å·å­`);

  loadState();
  updateDate();
  renderFilterPanel();
  applyFilters();
  updateCartBar();
  updateProgress();
  initScrollShadow();
  startCountdown();
  startHitokoto();

  // Restore exam date input
  const dateInput = document.getElementById('examDateInput');
  if (dateInput) dateInput.value = state.settings.examDate || DEFAULT_EXAM_DATE;
  updateCdUnitUI();

  if (state.cart.length > 0) {
    showToast(`ğŸ“‹ æ¸…å•ä¸­è¿˜æœ‰ ${state.cart.length} å¼ å·å­`);
  }

  document.getElementById('gachaModal').addEventListener('click', e => {
    if (e.target === document.getElementById('gachaModal')) closeGacha();
  });
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
